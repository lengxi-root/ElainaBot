{% extends "pc/base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="mb-0">å¼€æ”¾å¹³å°ç®¡ç†</h5>
    <small class="text-muted">ç®¡ç†QQå¼€å‘è€…å¹³å°çš„æœºå™¨äººæ•°æ®</small>
</div>

<!-- ç™»å½•çŠ¶æ€å¡ç‰‡ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card" id="openapi-login-card">
            <div class="card-body">
                <div id="openapi-not-logged-in" class="text-center">
                    <h6 class="card-title"><i class="bi bi-shield-lock"></i> å¼€æ”¾å¹³å°ç™»å½•</h6>
                    <p class="text-muted mb-3">è¯·å…ˆç™»å½•QQå¼€å‘è€…å¹³å°ä»¥æŸ¥çœ‹å’Œç®¡ç†æœºå™¨äººæ•°æ®</p>
                    <button class="btn btn-primary" id="openapi-start-login">
                        <i class="bi bi-qr-code"></i> å¼€å§‹ç™»å½•
                    </button>
                    <div id="openapi-login-progress" class="mt-3" style="display: none;">
                        <div class="d-flex flex-column align-items-center">
                            <div id="openapi-login-loading" class="mb-3">
                                <div class="spinner-border text-primary mb-2" role="status">
                                    <span class="visually-hidden">ç”ŸæˆäºŒç»´ç ä¸­...</span>
            </div>
                                <p class="text-muted mb-2">æ­£åœ¨ç”Ÿæˆç™»å½•äºŒç»´ç ...</p>
        </div>
                            <div id="openapi-qr-container" style="display: none;">
                                <div class="card" style="max-width: 300px;">
                                    <div class="card-header text-center">
                                        <h6 class="mb-0"><i class="bi bi-qr-code"></i> æ‰«æäºŒç»´ç ç™»å½•</h6>
    </div>
            <div class="card-body text-center">
                                        <img id="openapi-qr-image" src="" alt="ç™»å½•äºŒç»´ç " class="img-fluid mb-3" style="max-width: 200px; border: 1px solid #ddd; border-radius: 8px;">
                                        <p class="text-muted small mb-2">è¯·ä½¿ç”¨æ‰‹æœºQQæ‰«æä¸Šæ–¹äºŒç»´ç </p>
                                        <button class="btn btn-outline-secondary btn-sm" id="openapi-login-url" target="_blank">
                                            <i class="bi bi-box-arrow-up-right"></i> æˆ–ç‚¹å‡»æ‰“å¼€ç™»å½•é¡µé¢
                </button>
            </div>
                    </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="openapi-logged-in" style="display: none;">
                    <div class="row align-items-center">
                        <div class="col">
                            <h6 class="card-title mb-1">
                                <i class="bi bi-person-check text-success"></i> å·²ç™»å½•å¼€æ”¾å¹³å°
                            </h6>
                            <div class="d-flex flex-wrap gap-3">
                                <span class="badge bg-primary">
                                    <i class="bi bi-hash"></i> UIN: <span id="openapi-uin">-</span>
                                </span>
                                <span class="badge bg-secondary">
                                    <i class="bi bi-tag"></i> ç±»å‹: <span id="openapi-app-type">-</span>
                                </span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-outline-danger btn-sm" id="openapi-logout">
                                <i class="bi bi-box-arrow-right"></i> é‡æ–°ç™»å½•
                            </button>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
<!-- æœºå™¨äººåˆ—è¡¨ -->
<div class="row" id="openapi-main-content" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-robot"></i> æœºå™¨äººåˆ—è¡¨</h6>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-info btn-sm" id="openapi-get-notifications">
                        <i class="bi bi-bell"></i> æŸ¥çœ‹é€šçŸ¥æ¶ˆæ¯
                    </button>
                    <button class="btn btn-outline-primary btn-sm" id="openapi-refresh-botlist">
                    <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                </button>
                </div>
            </div>
            <div class="card-body">
                <div id="openapi-botlist-loading" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="text-muted mt-2">æ­£åœ¨è·å–æœºå™¨äººåˆ—è¡¨...</p>
                </div>
                <div id="openapi-botlist-container" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 35%;">æœºå™¨äººåç§°</th>
                                    <th style="width: 30%;">AppID</th>
                                    <th style="width: 35%;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="openapi-botlist-table">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
<div class="row mt-4" id="openapi-data-section" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0" id="openapi-data-title"><i class="bi bi-table"></i> æ•°æ®è¯¦æƒ…</h6>
                <div class="d-flex gap-2">
                    <span class="badge bg-primary">30å¤©æ•°æ®</span>
                    <button class="btn btn-outline-secondary btn-sm" id="openapi-close-data">
                        <i class="bi bi-x-lg"></i> å…³é—­
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="openapi-data-loading" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="text-muted mt-2">æ­£åœ¨è·å–æ•°æ®...</p>
                </div>
                
                <!-- éšè—çš„æ•°æ®å­˜å‚¨ -->
                <div id="openapi-data-summary" style="display: none;">
                    <span id="openapi-data-appid" style="display: none;">-</span>
                    <span id="openapi-data-avg-dau" style="display: none;">-</span>
                </div>
                
                <!-- æ•°æ®è¡¨æ ¼ -->
                <div id="openapi-data-table-container" style="display: none;">
                        <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>ä¸Šè¡Œæ¶ˆæ¯</th>
                                    <th>æ´»è·ƒç”¨æˆ·</th>
                                    <th>ä¸‹è¡Œæ¶ˆæ¯</th>
                                    <th>æ€»æ¶ˆæ¯</th>
                                    <th>ç¾¤ç»„(æ–°å¢/ç°æœ‰)</th>
                                    <th>å¥½å‹(æ–°å¢/ç°æœ‰)</th>
                                </tr>
                                <tr class="table-info">
                                    <td colspan="7" class="text-center">
                                        <strong>å¹³å‡DAU: <span id="openapi-avg-dau-display">-</span></strong>
                                    </td>
                                    </tr>
                                </thead>
                            <tbody id="openapi-data-table">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- é€šçŸ¥æ¶ˆæ¯è¡¨æ ¼ -->
                <div id="openapi-notifications-container" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>æ ‡é¢˜</th>
                                    <th>å†…å®¹</th>
                                    <th>ç±»å‹</th>
                                    </tr>
                            </thead>
                            <tbody id="openapi-notifications-table">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- æ¨¡æ¿åˆ—è¡¨ -->
                <div id="openapi-templates-container" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3" id="template-list-title"><i class="bi bi-layout-text-sidebar-reverse"></i> æ¨¡æ¿åˆ—è¡¨</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="width: 40%;">æ¨¡æ¿åç§°</th>
                                            <th style="width: 25%;">ç±»å‹</th>
                                            <th style="width: 20%;">çŠ¶æ€</th>
                                            <th style="width: 15%;">æ“ä½œ</th>
                                    </tr>
                                    </thead>
                                    <tbody id="openapi-templates-table">
                                </tbody>
                            </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="openapi-template-detail" style="display: none;">
                                <h6 class="mb-3">
                                    <i class="bi bi-info-circle"></i> æ¨¡æ¿è¯¦æƒ…
                                    <span class="badge bg-primary ms-2" id="template-detail-index">1/1</span>
                                </h6>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <div class="row">
                                                <div class="col-sm-3"><strong>æ¨¡æ¿ID:</strong></div>
                                                <div class="col-sm-9" id="template-detail-id">-</div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="row">
                                                <div class="col-sm-3"><strong>åç§°:</strong></div>
                                                <div class="col-sm-9" id="template-detail-name">-</div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="row">
                                                <div class="col-sm-3"><strong>ç±»å‹:</strong></div>
                                                <div class="col-sm-9" id="template-detail-type">-</div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="row">
                                                <div class="col-sm-3"><strong>çŠ¶æ€:</strong></div>
                                                <div class="col-sm-9" id="template-detail-status">-</div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="row">
                                                <div class="col-sm-3"><strong>åˆ›å»ºæ—¶é—´:</strong></div>
                                                <div class="col-sm-9" id="template-detail-create-time">-</div>
                                            </div>
                        </div>
                        
                                        <!-- æ¨¡æ¿å†…å®¹å±•ç¤º -->
                                        <div class="mb-3">
                                            <strong>æ¨¡æ¿å†…å®¹:</strong>
                                            <div id="template-content-text" class="mt-2">
                                                <pre class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto; font-size: 12px;" id="template-detail-content">-</pre>
                                            </div>
                    </div>
                    
                                        <!-- æŒ‰é’®æ¨¡æ¿é¢„è§ˆ -->
                                        <div id="template-button-preview" style="display: none;">
                                            <strong>æŒ‰é’®é¢„è§ˆ:</strong>
                                            <div class="mt-2 p-3 bg-light rounded">
                                                <div id="template-button-rows"></div>
                                                <small class="text-muted mt-2 d-block">
                                                    <i class="bi bi-info-circle"></i> æŒ‰é’®ä»…ä¾›å‚è€ƒï¼Œå®é™…æ•ˆæœä»¥å®é™…ä¸ºå‡†<br>
                                                    ç±»å‹: 0=è·³è½¬é“¾æ¥, 1=å›è°ƒ, 2=å›è½¦å‘½ä»¤
                                                </small>
                                            </div>
                    </div>
                    
                                        <!-- å¯¼èˆªæŒ‰é’® -->
                                        <div class="mt-3 d-flex justify-content-between">
                                            <button class="btn btn-outline-secondary btn-sm" id="template-prev-btn" style="display: none;">
                                                <i class="bi bi-chevron-left"></i> ä¸Šä¸€ä¸ª
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm" id="template-next-btn" style="display: none;">
                                                ä¸‹ä¸€ä¸ª <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// =====================
// å¼€æ”¾å¹³å°é¡µé¢ç›¸å…³åŠŸèƒ½
// =====================
let openApiLoginCheckInterval = null;
let currentTemplates = [];
let currentTemplateIndex = 0;

// åˆå§‹åŒ–å¼€æ”¾å¹³å°
function initOpenAPI() {
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    checkOpenAPILoginStatus();
    
    // ç»‘å®šäº‹ä»¶
    document.getElementById('openapi-start-login').addEventListener('click', startOpenAPILogin);
    document.getElementById('openapi-logout').addEventListener('click', logoutOpenAPI);
    document.getElementById('openapi-refresh-botlist').addEventListener('click', refreshBotList);
    document.getElementById('openapi-get-notifications').addEventListener('click', getNotifications);
    document.getElementById('openapi-close-data').addEventListener('click', closeDataSection);
}

// æ£€æŸ¥ç™»å½•çŠ¶æ€
function checkOpenAPILoginStatus() {
    fetch('/web/openapi/get_login_status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            user_id: 'web_user'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.logged_in) {
            showLoggedInState(data);
            loadBotList();
        } else {
            showNotLoggedInState();
        }
    })
    .catch(error => {
        console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
        showNotLoggedInState();
    });
}

// æ˜¾ç¤ºå·²ç™»å½•çŠ¶æ€
function showLoggedInState(data) {
    document.getElementById('openapi-not-logged-in').style.display = 'none';
    document.getElementById('openapi-logged-in').style.display = 'block';
    document.getElementById('openapi-main-content').style.display = 'block';
    
    if (data.uin) {
        document.getElementById('openapi-uin').textContent = data.uin;
    }
    if (data.app_type) {
        document.getElementById('openapi-app-type').textContent = data.app_type;
    }
}

// æ˜¾ç¤ºæœªç™»å½•çŠ¶æ€
function showNotLoggedInState() {
    document.getElementById('openapi-not-logged-in').style.display = 'block';
    document.getElementById('openapi-logged-in').style.display = 'none';
    document.getElementById('openapi-main-content').style.display = 'none';
    document.getElementById('openapi-data-section').style.display = 'none';
}

// å¼€å§‹ç™»å½•
function startOpenAPILogin() {
    const progressDiv = document.getElementById('openapi-login-progress');
    const loadingDiv = document.getElementById('openapi-login-loading');
    const qrContainer = document.getElementById('openapi-qr-container');
    
    progressDiv.style.display = 'block';
    loadingDiv.style.display = 'block';
    qrContainer.style.display = 'none';
    
    fetch('/web/openapi/start_login', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            user_id: 'web_user'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ç”ŸæˆäºŒç»´ç ï¼ˆä½¿ç”¨è€ç‰ˆæœ¬çš„æ–¹å¼ï¼‰
            generateQRCode(data.login_url);
            document.getElementById('openapi-login-url').onclick = () => window.open(data.login_url, '_blank');
            
            // å¼€å§‹æ£€æŸ¥ç™»å½•çŠ¶æ€
            startLoginStatusCheck();
        } else {
            alert('è·å–ç™»å½•äºŒç»´ç å¤±è´¥ï¼š' + data.message);
            progressDiv.style.display = 'none';
        }
    })
    .catch(error => {
        console.error('å¼€å§‹ç™»å½•å¤±è´¥:', error);
        alert('å¼€å§‹ç™»å½•å¤±è´¥');
        progressDiv.style.display = 'none';
    });
}

// ç”ŸæˆäºŒç»´ç ï¼ˆç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function generateQRCode(loginUrl) {
    const qrApiUrl = `https://api.2dcode.biz/v1/create-qr-code?data=${encodeURIComponent(loginUrl)}`;
    const qrImage = document.getElementById('openapi-qr-image');
    const loadingDiv = document.getElementById('openapi-login-loading');
    const qrContainer = document.getElementById('openapi-qr-container');
    
    // è®¾ç½®äºŒç»´ç å›¾ç‰‡
    qrImage.onload = function() {
        // å›¾ç‰‡åŠ è½½æˆåŠŸï¼Œæ˜¾ç¤ºäºŒç»´ç å®¹å™¨ï¼Œéšè—åŠ è½½æç¤º
        loadingDiv.style.display = 'none';
        qrContainer.style.display = 'block';
    };
    
    qrImage.onerror = function() {
        console.warn('äºŒç»´ç ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
        
        // å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤ºå’Œå¤‡ç”¨æ–¹æ¡ˆ
        loadingDiv.innerHTML = `
            <div class="alert alert-warning text-center">
                <i class="bi bi-exclamation-triangle"></i> äºŒç»´ç ç”Ÿæˆå¤±è´¥<br>
                <small class="text-muted">è¯·ä½¿ç”¨ä¸‹æ–¹æŒ‰é’®æ‰“å¼€ç™»å½•é¡µé¢</small>
            </div>
        `;
        
        // æ˜¾ç¤ºå®¹å™¨
        qrContainer.style.display = 'block';
    };
    
    // è®¾ç½®äºŒç»´ç å›¾ç‰‡æº
    qrImage.src = qrApiUrl;
}

// å¼€å§‹æ£€æŸ¥ç™»å½•çŠ¶æ€
function startLoginStatusCheck() {
    if (openApiLoginCheckInterval) {
        clearInterval(openApiLoginCheckInterval);
    }
    
    openApiLoginCheckInterval = setInterval(() => {
        fetch('/web/openapi/check_login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: 'web_user'
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('ç™»å½•çŠ¶æ€æ£€æŸ¥ç»“æœ:', data);
            if (data.success && data.status === 'logged_in') {
                clearInterval(openApiLoginCheckInterval);
                document.getElementById('openapi-login-progress').style.display = 'none';
                showLoggedInState(data);
                loadBotList();
            } else if (data.status === 'not_started') {
                console.log('ç™»å½•ä»»åŠ¡æœªå¼€å§‹ï¼Œåœæ­¢æ£€æŸ¥');
                clearInterval(openApiLoginCheckInterval);
                document.getElementById('openapi-login-progress').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
        });
    }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
}

// é€€å‡ºç™»å½•
function logoutOpenAPI() {
    if (confirm('ç¡®å®šè¦é‡æ–°ç™»å½•å—ï¼Ÿ')) {
        fetch('/web/openapi/logout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: 'web_user'
            })
        })
        .then(response => response.json())
        .then(data => {
            showNotLoggedInState();
            if (openApiLoginCheckInterval) {
                clearInterval(openApiLoginCheckInterval);
            }
        })
        .catch(error => {
            console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
        });
    }
}

// åŠ è½½æœºå™¨äººåˆ—è¡¨ï¼ˆç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function loadBotList() {
    const loading = document.getElementById('openapi-botlist-loading');
    const container = document.getElementById('openapi-botlist-container');
    
    loading.style.display = 'block';
    container.style.display = 'none';
    
    fetch('/web/openapi/get_botlist', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            user_id: 'web_user'
        })
    })
    .then(response => response.json())
    .then(data => {
        loading.style.display = 'none';
        if (data.success) {
            displayBotList(data.data);
            container.style.display = 'block';
        } else {
            alert('è·å–æœºå™¨äººåˆ—è¡¨å¤±è´¥: ' + data.message);
            if (data.message && data.message.includes('ç™»å½•çŠ¶æ€å¤±æ•ˆ')) {
                showNotLoggedInState();
            }
        }
    })
    .catch(error => {
        console.error('è·å–æœºå™¨äººåˆ—è¡¨å¤±è´¥:', error);
        loading.style.display = 'none';
        alert('è·å–æœºå™¨äººåˆ—è¡¨å¤±è´¥');
    });
}

// æ˜¾ç¤ºæœºå™¨äººåˆ—è¡¨ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function displayBotList(data) {
    const tbody = document.getElementById('openapi-botlist-table');
    tbody.innerHTML = '';
    
    if (!data || !data.apps || data.apps.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">æš‚æ— æœºå™¨äºº</td></tr>';
        return;
    }
    
    data.apps.forEach(app => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>
                <strong>${app.app_name || 'æœªå‘½å'}</strong>
                <br><small class="text-muted">${app.app_desc || 'æ— æè¿°'}</small>
            </td>
            <td><code>${app.app_id}</code></td>
            <td>
                <div class="d-flex gap-1 flex-wrap">
                    <button class="btn btn-outline-primary btn-sm" onclick="getBotData('${app.app_id}')">
                        <i class="bi bi-graph-up"></i> æ•°æ®
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="getBotTemplates('${app.app_id}', '${app.app_name}')">
                        <i class="bi bi-layout-text-sidebar-reverse"></i> æ¨¡æ¿
                    </button>
                   <button class="btn btn-outline-warning btn-sm" onclick="importBotTemplates('${app.app_id}', '${app.app_name}')">
                       <i class="bi bi-download"></i> å¯¼å…¥
                   </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    document.getElementById('openapi-botlist-container').style.display = 'block';
}

// åˆ·æ–°æœºå™¨äººåˆ—è¡¨
function refreshBotList() {
    loadBotList();
}

// è·å–æœºå™¨äººæ•°æ®ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function getBotData(appid) {
    // å›ºå®šæŸ¥è¯¢30å¤©
    const days = 30;
    
    document.getElementById('openapi-data-section').style.display = 'block';
    document.getElementById('openapi-data-loading').style.display = 'block';
    document.getElementById('openapi-data-table-container').style.display = 'none';
    document.getElementById('openapi-notifications-container').style.display = 'none';
    
    document.getElementById('openapi-data-title').innerHTML = `<i class="bi bi-table"></i> æœºå™¨äººæ•°æ® - ${appid}`;
    
    fetch('/web/openapi/get_botdata', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            user_id: 'web_user',
            appid: appid,
            days: days
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayBotData(data);
        } else {
            alert('è·å–æœºå™¨äººæ•°æ®å¤±è´¥: ' + data.message);
            if (data.message && data.message.includes('ç™»å½•çŠ¶æ€å¤±æ•ˆ')) {
                showNotLoggedInState();
            }
        }
    })
    .catch(error => {
        console.error('è·å–æœºå™¨äººæ•°æ®å¤±è´¥:', error);
        alert('è·å–æœºå™¨äººæ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•');
    })
    .finally(() => {
        document.getElementById('openapi-data-loading').style.display = 'none';
    });
}

// æ˜¾ç¤ºæœºå™¨äººæ•°æ®ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function displayBotData(data) {
    // å­˜å‚¨æ•°æ®åˆ°éšè—å…ƒç´ 
    document.getElementById('openapi-data-appid').textContent = data.appid;
    document.getElementById('openapi-data-avg-dau').textContent = data.avg_dau;
    
    // æ›´æ–°è¡¨æ ¼ä¸­çš„å¹³å‡DAUæ˜¾ç¤º
    document.getElementById('openapi-avg-dau-display').textContent = Number(data.avg_dau).toLocaleString('zh-CN');
   
   // æ›´æ–°æ•°æ®è¡¨æ ¼
   const tbody = document.getElementById('openapi-data-table');
   tbody.innerHTML = '';
   
   data.days_data.forEach(dayData => {
       const row = document.createElement('tr');
       row.innerHTML = `
           <td><strong>${dayData.date}</strong></td>
           <td>${Number(dayData.up_messages).toLocaleString('zh-CN')}</td>
           <td><span class="badge bg-primary">${Number(dayData.up_users).toLocaleString('zh-CN')}</span></td>
           <td>${Number(dayData.down_messages).toLocaleString('zh-CN')}</td>
           <td><strong>${Number(dayData.total_messages).toLocaleString('zh-CN')}</strong></td>
           <td>
               <span class="text-success">+${Number(dayData.new_groups).toLocaleString('zh-CN')}</span> / 
               <span class="text-info">${Number(dayData.current_groups).toLocaleString('zh-CN')}</span>
           </td>
           <td>
               <span class="text-success">+${Number(dayData.new_friends).toLocaleString('zh-CN')}</span> / 
               <span class="text-info">${Number(dayData.current_friends).toLocaleString('zh-CN')}</span>
           </td>
       `;
       tbody.appendChild(row);
   });
   
   document.getElementById('openapi-data-table-container').style.display = 'block';
}

// è·å–æŒ‡å®šæœºå™¨äººçš„æ¨¡æ¿åˆ—è¡¨ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function getBotTemplates(appid, appName) {
    getTemplates(appid, appName);
}

// è·å–æ¨¡æ¿åˆ—è¡¨ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function getTemplates(appid = null, appName = null) {
    // éšè—å…¶ä»–åŒºåŸŸ
    document.getElementById('openapi-data-table-container').style.display = 'none';
    document.getElementById('openapi-notifications-container').style.display = 'none';
    const templateDetail = document.getElementById('openapi-template-detail');
    if (templateDetail) templateDetail.style.display = 'none';
    
    // æ›´æ–°æ ‡é¢˜ - åªæ›´æ–°åŒºåŸŸæ ‡é¢˜ï¼Œä¸æ”¹å˜é¡¶æ 
    document.getElementById('openapi-data-title').innerHTML = '<i class="bi bi-layout-text-sidebar-reverse"></i> æ¨¡æ¿ç®¡ç†';
    
    // æ˜¾ç¤ºæ•°æ®åŒºåŸŸå’ŒåŠ è½½çŠ¶æ€
    document.getElementById('openapi-data-section').style.display = 'block';
    document.getElementById('openapi-data-loading').style.display = 'block';
    
    // æ„å»ºè¯·æ±‚æ•°æ®
    const requestData = { user_id: 'web_user' };
    if (appid) {
        requestData.appid = appid;
    }
    
    fetch('/web/openapi/get_templates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('openapi-data-loading').style.display = 'none';
        
        if (data.success) {
            currentTemplates = data.data.templates;
            displayTemplates(data.data.templates, appName);
        } else {
            alert('è·å–æ¨¡æ¿åˆ—è¡¨å¤±è´¥: ' + data.message);
            if (data.message && data.message.includes('ç™»å½•çŠ¶æ€å¤±æ•ˆ')) {
                showNotLoggedInState();
            }
        }
    })
    .catch(error => {
        document.getElementById('openapi-data-loading').style.display = 'none';
        alert('è·å–æ¨¡æ¿åˆ—è¡¨å¤±è´¥: ' + error.message);
    });
}

// æ˜¾ç¤ºæ¨¡æ¿åˆ—è¡¨ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function displayTemplates(templates, appName = null) {
    // æ›´æ–°æ¨¡æ¿åˆ—è¡¨æ ‡é¢˜
    const titleElement = document.getElementById('template-list-title');
    const titleText = appName ? `${appName} - æ¨¡æ¿åˆ—è¡¨` : 'æ¨¡æ¿åˆ—è¡¨';
    if (titleElement) titleElement.innerHTML = `<i class="bi bi-layout-text-sidebar-reverse"></i> ${titleText}`;
    
    const tbody = document.getElementById('openapi-templates-table');
    tbody.innerHTML = '';
    
    if (templates.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="4" class="text-center text-muted">æš‚æ— æ¨¡æ¿</td>
        `;
        tbody.appendChild(row);
    } else {
        templates.forEach((template, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="max-width: 200px; word-break: break-word;">
                    <strong>${template.name}</strong>
                    <br><small class="text-muted">ID: ${template.id}</small>
                </td>
                <td><span class="badge ${template.type === 'æŒ‰é’®æ¨¡æ¿' ? 'bg-info' : 'bg-secondary'}">${template.type}</span></td>
                <td><span class="badge ${getStatusBadgeClass(template.status)}">${template.status}</span></td>
                <td>
                    <button class="btn btn-outline-primary btn-sm" onclick="viewTemplateDetail(${index})">
                        <i class="bi bi-eye"></i> æŸ¥çœ‹
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    document.getElementById('openapi-templates-container').style.display = 'block';
}

// è·å–çŠ¶æ€å¾½ç« æ ·å¼ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function getStatusBadgeClass(status) {
    switch (status) {
        case 'å®¡æ ¸é€šè¿‡': return 'bg-success';
        case 'æœªé€šè¿‡': return 'bg-danger';
        case 'å®¡æ ¸ä¸­': return 'bg-primary';
        case 'æœªæå®¡': return 'bg-warning';
        default: return 'bg-secondary';
    }
}

// æŸ¥çœ‹æ¨¡æ¿è¯¦æƒ…ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function viewTemplateDetail(index) {
    if (index < 0 || index >= currentTemplates.length) return;
    
    currentTemplateIndex = index;
    const template = currentTemplates[index];
    
    // æ›´æ–°æ¨¡æ¿è¯¦æƒ…
    document.getElementById('template-detail-index').textContent = `${index + 1}/${currentTemplates.length}`;
    document.getElementById('template-detail-id').textContent = template.id;
    document.getElementById('template-detail-name').textContent = template.name;
    document.getElementById('template-detail-type').innerHTML = `<span class="badge ${template.type === 'æŒ‰é’®æ¨¡æ¿' ? 'bg-info' : 'bg-secondary'}">${template.type}</span>`;
    document.getElementById('template-detail-status').innerHTML = `<span class="badge ${getStatusBadgeClass(template.status)}">${template.status}</span>`;
    document.getElementById('template-detail-create-time').textContent = template.create_time || '-';
    document.getElementById('template-detail-content').textContent = template.content;
    
    // æ›´æ–°å¯¼èˆªæŒ‰é’®
    const prevBtn = document.getElementById('template-prev-btn');
    const nextBtn = document.getElementById('template-next-btn');
    
    if (prevBtn) {
        if (index > 0) {
            prevBtn.style.display = 'inline-block';
        } else {
            prevBtn.style.display = 'none';
        }
    }
    
    if (nextBtn) {
        if (index < currentTemplates.length - 1) {
            nextBtn.style.display = 'inline-block';
        } else {
            nextBtn.style.display = 'none';
        }
    }
    
    // å¦‚æœæ˜¯æŒ‰é’®æ¨¡æ¿ï¼Œå°è¯•æ¸²æŸ“æŒ‰é’®é¢„è§ˆ
    if (template.type === 'æŒ‰é’®æ¨¡æ¿') {
        renderButtonPreview(template);
    } else {
        const buttonPreview = document.getElementById('template-button-preview');
        if (buttonPreview) buttonPreview.style.display = 'none';
    }
    
    // éšè—æ¨¡æ¿åˆ—è¡¨ï¼Œæ˜¾ç¤ºæ¨¡æ¿è¯¦æƒ…
    document.getElementById('openapi-templates-container').style.display = 'none';
    const templateDetail = document.getElementById('openapi-template-detail');
    if (templateDetail) templateDetail.style.display = 'block';
}

// å¯¼å…¥æŒ‡å®šæœºå™¨äººçš„æ¨¡æ¿åˆ°æ–‡ä»¶ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function importBotTemplates(appid, appName) {
    if (!confirm(`ç¡®å®šè¦å°†æœºå™¨äºº "${appName}" çš„æ¨¡æ¿å¯¼å…¥åˆ°markdown_templates.pyæ–‡ä»¶ä¸­å—ï¼Ÿ\n\nAppID: ${appid}\n\næ³¨æ„ï¼š\n- æ¨¡æ¿å°†ä»1å¼€å§‹å‘½å\n- æŒ‰é’®IDå°†ä»¥æ³¨é‡Šå½¢å¼æ·»åŠ `)) {
        return;
    }
    
    // é€šè¿‡äº‹ä»¶æ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> å¯¼å…¥ä¸­...';
    button.disabled = true;
    
    fetch('/web/openapi/import_templates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            user_id: 'web_user',
            appid: appid
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const result = data.data;
            let message = `âœ… æ¨¡æ¿å¯¼å…¥å®Œæˆï¼\n\n`;
            message += `ğŸ¤– æœºå™¨äºº: ${appName}\n`;
            message += `ğŸ“± AppID: ${appid}\n\n`;
            message += `ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š\n`;
            message += `â€¢ æ–°å¯¼å…¥æ¨¡æ¿ï¼š${result.imported_count} ä¸ª\n`;
            message += `â€¢ è·³è¿‡é‡å¤æ¨¡æ¿ï¼š${result.skipped_count} ä¸ª\n`;
            if (result.button_count > 0) {
                message += `â€¢ æŒ‰é’®æ¨¡æ¿æ³¨é‡Šï¼š${result.button_count} ä¸ª\n`;
            }
            message += `\nğŸ’¡ ${result.message}`;
            message += `\n\nâš ï¸ é‡è¦æç¤ºï¼šä½ éœ€è¦é‡å¯æ¡†æ¶æ¥é‡è½½æ¨¡æ¿æ–‡ä»¶ï¼`;
            
            alert(message);
            
            // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
            button.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i> å¯¼å…¥æˆåŠŸ';
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 3000);
        } else {
            alert('âŒ å¯¼å…¥æ¨¡æ¿å¤±è´¥: ' + data.message);
            if (data.message && data.message.includes('ç™»å½•çŠ¶æ€å¤±æ•ˆ')) {
                showNotLoggedInState();
            }
        }
    })
    .catch(error => {
        console.error('å¯¼å…¥æ¨¡æ¿å¤±è´¥:', error);
        alert('âŒ å¯¼å…¥æ¨¡æ¿å¤±è´¥ï¼Œè¯·é‡è¯•\n\né”™è¯¯ä¿¡æ¯: ' + error.message);
    })
    .finally(() => {
        if (button.innerHTML.includes('å¯¼å…¥ä¸­')) {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    });
}

// æ¸²æŸ“æŒ‰é’®é¢„è§ˆï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function renderButtonPreview(template) {
    try {
        let buttonData;
        
        // å°è¯•è§£ææŒ‰é’®æ•°æ®
        try {
            buttonData = JSON.parse(template.content);
        } catch (e) {
            // å¦‚æœæ˜¯@å¼€å¤´çš„æ ¼å¼
            if (template.content.startsWith('@')) {
                buttonData = JSON.parse(template.content.substring(1));
            } else {
                throw e;
            }
        }
        
        const rows = buttonData.rows || [];
        const buttonRowsContainer = document.getElementById('template-button-rows');
        if (!buttonRowsContainer) return;
        
        buttonRowsContainer.innerHTML = '';
        
        rows.slice(0, 5).forEach((row, rowIndex) => {
            const buttons = row.buttons || [];
            if (buttons.length === 0) return;
            
            const rowDiv = document.createElement('div');
            rowDiv.className = 'mb-2 d-flex gap-2 flex-wrap';
            
            buttons.slice(0, 5).forEach(button => {
                const renderData = button.render_data || {};
                const action = button.action || {};
                
                const btnElement = document.createElement('button');
                btnElement.className = `btn btn-sm ${getButtonStyleClass(renderData.style || 0)}`;
                btnElement.textContent = renderData.label || 'Button';
                btnElement.disabled = true;
                btnElement.style.minWidth = '80px';
                
                // æ·»åŠ ç±»å‹å›¾æ ‡
                const actionType = action.type || 2;
                let icon = '';
                if (actionType === 0) {
                    icon = '<i class="bi bi-box-arrow-up-right"></i> ';
                } else if (actionType === 1) {
                    icon = '<i class="bi bi-arrow-clockwise"></i> ';
                }
                
                btnElement.innerHTML = icon + btnElement.textContent;
                rowDiv.appendChild(btnElement);
            });
            
            buttonRowsContainer.appendChild(rowDiv);
        });
        
        const buttonPreview = document.getElementById('template-button-preview');
        if (buttonPreview) buttonPreview.style.display = 'block';
        
    } catch (error) {
        console.error('æŒ‰é’®é¢„è§ˆæ¸²æŸ“å¤±è´¥:', error);
        const buttonPreview = document.getElementById('template-button-preview');
        if (buttonPreview) buttonPreview.style.display = 'none';
    }
}

// è·å–æŒ‰é’®æ ·å¼ç±»ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function getButtonStyleClass(style) {
    switch (style) {
        case 0: return 'btn-outline-dark';
        case 1: return 'btn-outline-primary';
        case 2: return 'btn-outline-secondary';
        case 3: return 'btn-outline-danger';
        case 4: return 'btn-primary';
        default: return 'btn-outline-dark';
    }
}

// æ˜¾ç¤ºä¸Šä¸€ä¸ªæ¨¡æ¿ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function showPreviousTemplate() {
    if (currentTemplateIndex > 0) {
        viewTemplateDetail(currentTemplateIndex - 1);
    }
}

// æ˜¾ç¤ºä¸‹ä¸€ä¸ªæ¨¡æ¿ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function showNextTemplate() {
    if (currentTemplateIndex < currentTemplates.length - 1) {
        viewTemplateDetail(currentTemplateIndex + 1);
    }
}

// æŸ¥çœ‹é€šçŸ¥æ¶ˆæ¯
function getNotifications() {
    const dataSection = document.getElementById('openapi-data-section');
    const dataTitle = document.getElementById('openapi-data-title');
    const dataLoading = document.getElementById('openapi-data-loading');
    const dataContainer = document.getElementById('openapi-data-table-container');
    const notificationsContainer = document.getElementById('openapi-notifications-container');
    const templatesContainer = document.getElementById('openapi-templates-container');
    
    // æ˜¾ç¤ºæ•°æ®åŒºåŸŸ
    dataSection.style.display = 'block';
    dataTitle.innerHTML = `<i class="bi bi-bell"></i> é€šçŸ¥æ¶ˆæ¯`;
    
    // éšè—å…¶ä»–å®¹å™¨
    dataContainer.style.display = 'none';
    templatesContainer.style.display = 'none';
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    dataLoading.style.display = 'block';
    notificationsContainer.style.display = 'none';
    
    // è·å–é€šçŸ¥
    fetch('/web/openapi/get_notifications', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            user_id: 'web_user'
        })
    })
    .then(response => response.json())
    .then(data => {
        dataLoading.style.display = 'none';
        if (data.success) {
            displayNotifications(data.notifications || []);
            notificationsContainer.style.display = 'block';
        } else {
            alert('è·å–é€šçŸ¥æ¶ˆæ¯å¤±è´¥ï¼š' + data.message);
        }
    })
    .catch(error => {
        console.error('è·å–é€šçŸ¥æ¶ˆæ¯å¤±è´¥:', error);
        dataLoading.style.display = 'none';
        alert('è·å–é€šçŸ¥æ¶ˆæ¯å¤±è´¥');
    });
}

// æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
function displayNotifications(notifications) {
    const table = document.getElementById('openapi-notifications-table');
    
    if (!notifications || notifications.length === 0) {
        table.innerHTML = '<tr><td colspan="4" class="text-center text-muted">æš‚æ— é€šçŸ¥æ¶ˆæ¯</td></tr>';
        return;
    }
    
    table.innerHTML = notifications.map(notification => `
        <tr>
            <td>${notification.time || '-'}</td>
            <td>${notification.title || '-'}</td>
            <td style="max-width: 300px; word-break: break-word;">${notification.content || '-'}</td>
            <td><span class="badge bg-secondary">${notification.type || '-'}</span></td>
        </tr>
    `).join('');
}

// æŸ¥çœ‹æœºå™¨äººæ¨¡æ¿
function viewBotTemplates(appId, botName) {
    const dataSection = document.getElementById('openapi-data-section');
    const dataTitle = document.getElementById('openapi-data-title');
    const dataLoading = document.getElementById('openapi-data-loading');
    const dataContainer = document.getElementById('openapi-data-table-container');
    const notificationsContainer = document.getElementById('openapi-notifications-container');
    const templatesContainer = document.getElementById('openapi-templates-container');
    
    // æ˜¾ç¤ºæ•°æ®åŒºåŸŸ
    dataSection.style.display = 'block';
    dataTitle.innerHTML = `<i class="bi bi-layout-text-sidebar-reverse"></i> ${botName} - æ¨¡æ¿ç®¡ç†`;
    
    // éšè—å…¶ä»–å®¹å™¨
    dataContainer.style.display = 'none';
    notificationsContainer.style.display = 'none';
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    dataLoading.style.display = 'block';
    templatesContainer.style.display = 'none';
    
    // è·å–æ¨¡æ¿åˆ—è¡¨
    fetch('/web/openapi/get_templates', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
            user_id: 'web_user',
            appid: appId 
        })
    })
    .then(response => response.json())
    .then(data => {
        dataLoading.style.display = 'none';
        if (data.success) {
            currentTemplates = data.templates || [];
            displayTemplates(currentTemplates);
            templatesContainer.style.display = 'block';
        } else {
            alert('è·å–æ¨¡æ¿åˆ—è¡¨å¤±è´¥ï¼š' + data.message);
        }
    })
    .catch(error => {
        console.error('è·å–æ¨¡æ¿åˆ—è¡¨å¤±è´¥:', error);
        dataLoading.style.display = 'none';
        alert('è·å–æ¨¡æ¿åˆ—è¡¨å¤±è´¥');
    });
}



// æŸ¥çœ‹æ¨¡æ¿è¯¦æƒ…
function viewTemplateDetail(index) {
    if (!currentTemplates || index >= currentTemplates.length) return;
    
    currentTemplateIndex = index;
    const template = currentTemplates[index];
    const detailDiv = document.getElementById('openapi-template-detail');
    
    // æ›´æ–°æ¨¡æ¿è¯¦æƒ…
    document.getElementById('template-detail-index').textContent = `${index + 1}/${currentTemplates.length}`;
    document.getElementById('template-detail-id').textContent = template.id || '-';
    document.getElementById('template-detail-name').textContent = template.name || '-';
            document.getElementById('template-detail-type').innerHTML = `<span class="badge ${template.type === 'æŒ‰é’®æ¨¡æ¿' ? 'bg-info' : 'bg-secondary'}">${template.type}</span>`;
    document.getElementById('template-detail-status').textContent = template.status || '-';
    document.getElementById('template-detail-create-time').textContent = template.create_time || '-';
    document.getElementById('template-detail-content').textContent = JSON.stringify(template.content, null, 2) || '-';
    
    // æ˜¾ç¤ºæŒ‰é’®é¢„è§ˆï¼ˆå¦‚æœæ˜¯æŒ‰é’®æ¨¡æ¿ï¼‰
    const buttonPreview = document.getElementById('template-button-preview');
    if (template.type === 'button' && template.content && template.content.buttons) {
        displayButtonPreview(template.content.buttons);
        buttonPreview.style.display = 'block';
    } else {
        buttonPreview.style.display = 'none';
    }
    
    // æ›´æ–°å¯¼èˆªæŒ‰é’®
    const prevBtn = document.getElementById('template-prev-btn');
    const nextBtn = document.getElementById('template-next-btn');
    
    if (currentTemplates.length > 1) {
        prevBtn.style.display = index > 0 ? 'inline-block' : 'none';
        nextBtn.style.display = index < currentTemplates.length - 1 ? 'inline-block' : 'none';
        
        prevBtn.onclick = () => viewTemplateDetail(index - 1);
        nextBtn.onclick = () => viewTemplateDetail(index + 1);
    } else {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
    }
    
    // æ˜¾ç¤ºè¯¦æƒ…åŒºåŸŸ
    detailDiv.style.display = 'block';
}

// æ˜¾ç¤ºæŒ‰é’®é¢„è§ˆ
function displayButtonPreview(buttons) {
    const container = document.getElementById('template-button-rows');
    
    if (!buttons || !Array.isArray(buttons)) {
        container.innerHTML = '<p class="text-muted">æ— æŒ‰é’®æ•°æ®</p>';
        return;
    }
    
    let html = '';
    buttons.forEach(row => {
        if (Array.isArray(row)) {
            html += '<div class="mb-2">';
            row.forEach(button => {
                const typeText = button.type === 0 ? 'é“¾æ¥' : (button.type === 1 ? 'å›è°ƒ' : 'å‘½ä»¤');
                html += `
                    <button class="btn btn-outline-secondary btn-sm me-1" disabled>
                        ${button.label || 'æŒ‰é’®'} <small>(${typeText})</small>
                    </button>
                `;
            });
            html += '</div>';
        }
    });
    
    container.innerHTML = html || '<p class="text-muted">æ— æœ‰æ•ˆæŒ‰é’®</p>';
}

// å…³é—­æ•°æ®åŒºåŸŸ
function closeDataSection() {
    document.getElementById('openapi-data-section').style.display = 'none';
}

// æ•°å­—æ ¼å¼åŒ–
function formatNumber(num) {
    if (num >= 10000) {
        return (num / 10000).toFixed(2).replace(/\.?0+$/, '') + 'w';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(2).replace(/\.?0+$/, '') + 'k';
    } else {
        return num.toString();
    }
}

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initOpenAPI();
    
    // å¼€æ”¾å¹³å°é¡µé¢ä¸éœ€è¦å®æ—¶WebSocketè¿æ¥
    // initSocket('openapi');
});
</script>
{% endblock %}