{% extends "pc/base.html" %}

{% block content %}
<!-- 插件列表 -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="mb-0">插件列表</h5>
</div>

<div class="plugins-container-wrapper">
    <div class="plugins-main-content w-100">
        <div class="plugins-loading" id="plugins-loading">
            <div class="d-flex justify-content-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
            </div>
        </div>

        <div id="plugins-container"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let pluginsData = [];

function loadPlugins() {
    const container = document.getElementById('plugins-container');
    const loading = document.getElementById('plugins-loading');
    
    loading.style.display = 'block';
    container.innerHTML = '';
    
    if (window.socket) {
        window.socket.emit('get_plugins_info');
    } else {
        loading.style.display = 'none';
        container.innerHTML = '<div class="alert alert-warning">无法连接到服务器获取插件信息</div>';
    }
}

function updatePluginsInfo(plugins) {
    const pluginsContainer = document.getElementById('plugins-container');
    const pluginsLoading = document.getElementById('plugins-loading');
    
    pluginsLoading.style.display = 'none';
    
    if (!plugins || plugins.length === 0) {
        pluginsContainer.innerHTML = '<div class="alert alert-info">未发现任何插件</div>';
        return;
    }
    
    const pluginsByDirectory = {};
    plugins.forEach(plugin => {
        const directory = plugin.directory || (plugin.name.startsWith('example/') ? 'example' : 
                           plugin.name.startsWith('system/') ? 'system' : 'other');
        if (!pluginsByDirectory[directory]) {
            pluginsByDirectory[directory] = [];
        }
        pluginsByDirectory[directory].push(plugin);
    });
    
    const directoryOrder = ['system', 'example', 'alone'];
    const sortedDirectories = Object.keys(pluginsByDirectory).sort((a, b) => {
        const indexA = directoryOrder.indexOf(a);
        const indexB = directoryOrder.indexOf(b);
        if (indexA === -1 && indexB === -1) return a.localeCompare(b);
        if (indexA === -1) return 1;
        if (indexB === -1) return -1;
        return indexA - indexB;
    });
    
    let html = '';
    sortedDirectories.forEach(directory => {
        const directoryPlugins = pluginsByDirectory[directory];
        if (directoryPlugins && directoryPlugins.length > 0) {
            const directoryNames = {
                'system': '系统插件',
                'example': '示例插件', 
                'alone': '独立插件',
                'other': '其他插件'
            };
            const dirDisplayName = directoryNames[directory] || directory.toUpperCase();
            
            html += `
            <div class="mb-4">
                <div class="directory-title" onclick="togglePluginFolder('${directory}')">
                    <div class="directory-badge">
                        <i class="bi bi-chevron-right folder-chevron" id="folder-chevron-${directory}"></i>
                        <i class="bi bi-folder-fill"></i>
                        ${dirDisplayName}
                        <span class="count-badge">${directoryPlugins.length}</span>
                    </div>
                </div>
                <div class="directory-plugins" id="directory-plugins-${directory}">`;
            
            directoryPlugins.forEach(plugin => {
                const statusClass = plugin.status === 'loaded' ? 'loaded' : 'error';
                let statusBadge = plugin.status === 'loaded' 
                    ? `<span class="badge bg-success plugin-badge"><i class="bi bi-check-circle-fill"></i> 已加载</span>` 
                    : `<span class="badge bg-danger plugin-badge"><i class="bi bi-exclamation-triangle-fill"></i> 错误</span>`;
                let handlerCountBadge = '';
                if (plugin.status === 'loaded') {
                    const handlerCount = plugin.handlers || 0;
                    handlerCountBadge = `<span class="badge bg-secondary plugin-badge"><i class="bi bi-code-slash"></i> ${handlerCount}个处理器</span>`;
                }
                
                let errorHtml = '';
                if (plugin.status === 'error' && plugin.error) {
                    errorHtml = `<div class="plugin-error">${plugin.error}</div>`;
                    if (plugin.traceback) {
                        errorHtml += `<div class="plugin-error mt-2">${plugin.traceback}</div>`;
                    }
                }
                let handlersHtml = '';
                if (plugin.status === 'loaded' && plugin.handlers_list && plugin.handlers_list.length > 0) {
                    const handlers_owner_only = plugin.handlers_owner_only || {};
                    const handlers_group_only = plugin.handlers_group_only || {};
                    handlersHtml = `
                    <div class="plugin-handlers">
                        <div class="handlers-container">
                            ${plugin.handlers_list.map(handler => {
                                const isOwnerOnly = handlers_owner_only[handler] === true;
                                const isGroupOnly = handlers_group_only[handler] === true;
                                let handlerClass = 'handler-item handler-item-public';
                                let handlerIcon = '';
                                if (isOwnerOnly) {
                                    handlerClass = 'handler-item handler-item-owner';
                                    handlerIcon = '<i class="bi bi-shield-lock-fill"></i> ';
                                }
                                if (isGroupOnly) {
                                    handlerClass = 'handler-item handler-item-group';
                                    handlerIcon = '<i class="bi bi-people-fill"></i> ';
                                }
                                if (isOwnerOnly && isGroupOnly) {
                                    handlerIcon = '<i class="bi bi-shield-lock-fill"></i> <i class="bi bi-people-fill"></i> ';
                                }
                                let titleText = '所有人可用';
                                if (isOwnerOnly && isGroupOnly) {
                                    titleText = '主人专属且仅限群聊';
                                } else if (isOwnerOnly) {
                                    titleText = '主人专属命令';
                                } else if (isGroupOnly) {
                                    titleText = '仅限群聊使用';
                                }
                                return `<span class="${handlerClass}" title="${titleText}">${handlerIcon}${handler}</span>`;
                            }).join('')}
                        </div>
                    </div>`;
                }
                let displayName = plugin.name;
                if (displayName.includes('/')) {
                    const parts = displayName.split('/');
                    if (parts.length >= 3) {
                        displayName = `${parts[1]} <span class="text-secondary">(${parts[2]})</span>`;
                    } else {
                        displayName = parts[parts.length - 1];
                    }
                }
                let priorityDisplay = '';
                if (plugin.status === 'loaded') {
                    const priority = plugin.priority !== undefined ? plugin.priority : 10;
                    priorityDisplay = `<span class="plugin-priority"><i class="bi bi-sort-numeric-down"></i> ${priority}</span>`;
                }
                let pathDisplay = `<span class="plugin-path" title="${plugin.path}">${plugin.path.split('/').slice(-3).join('/')}</span>`;
                let timeDisplay = '';
                if (plugin.last_modified) {
                    timeDisplay = `<span class="plugin-path text-muted ms-2"><i class="bi bi-clock-history"></i> ${plugin.last_modified}</span>`;
                }
                html += `
                <div class="card plugin-card ${statusClass}">
                <div class="plugin-content">
                        <div class="plugin-info">
                            <div class="plugin-name-container">
                                <h6 class="mb-0 me-2">${displayName}</h6>
                                ${priorityDisplay}
                                ${pathDisplay}
                                ${timeDisplay}
                            </div>
                                <div class="plugin-badges">
                                    ${statusBadge}
                                ${handlerCountBadge}
                            </div>
                        </div>
                        ${handlersHtml}
                        ${errorHtml}
                    </div>
                </div>`;
            });
            
            html += `</div></div>`;
        }
    });
    
    pluginsContainer.innerHTML = html;
}

function togglePluginFolder(directory) {
    const header = document.querySelector(`[onclick="togglePluginFolder('${directory}')"]`);
    const content = document.getElementById(`directory-plugins-${directory}`);
    const chevron = document.getElementById(`folder-chevron-${directory}`);
    
    if (content && header && chevron) {
        const isExpanded = content.classList.contains('expanded');
        
        if (isExpanded) {
            content.classList.remove('expanded');
            header.classList.remove('expanded');
            chevron.classList.remove('bi-chevron-down');
            chevron.classList.add('bi-chevron-right');
        } else {
            content.classList.add('expanded');
            header.classList.add('expanded');
            chevron.classList.remove('bi-chevron-right');
            chevron.classList.add('bi-chevron-down');
        }
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

document.addEventListener('DOMContentLoaded', function() {
    window.updatePluginsInfo = updatePluginsInfo;
    initSocket('plugins');
});
</script>
{% endblock %}