{% extends "pc/base.html" %}

{% block content %}
<div class="message-container">
    <div class="message-layout">
        <!-- 左侧聊天列表 -->
        <div class="chat-list-panel">
            <div class="panel-header">
                <div class="header-title">
                    <i class="bi bi-chat-dots"></i>
                    <span>消息列表</span>
                </div>
                <div class="header-controls">
                    <div class="chat-type-toggle">
                        <button class="toggle-btn active" id="btn-users" onclick="switchChatType('user')">
                            <i class="bi bi-person"></i> 好友
                        </button>
                        <button class="toggle-btn" id="btn-groups" onclick="switchChatType('group')">
                            <i class="bi bi-people"></i> 群聊
                        </button>
                    </div>
                    <select class="days-select" id="days-range" onchange="changeDaysRange()">
                        <option value="1" selected>今天</option>
                        <option value="2">2天</option>
                        <option value="3">3天</option>
                        <option value="all">全部</option>
                    </select>
                </div>
            </div>
            <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" id="search-input" placeholder="搜索聊天...">
                <button class="search-btn" onclick="searchChats()">搜索</button>
            </div>
            <div class="chat-list" id="chat-list">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <span>加载中...</span>
                </div>
            </div>
        </div>

        <!-- 右侧聊天窗口 -->
        <div class="chat-window-panel">
            <div class="chat-header" id="chat-header">
                <div class="chat-avatar-wrap" id="current-chat-avatar">
                    <i class="bi bi-chat-square-dots"></i>
                </div>
                <div class="chat-info">
                    <div class="chat-name" id="current-chat-name">选择一个聊天</div>
                    <div class="chat-desc" id="current-chat-info">点击左侧列表选择聊天对象</div>
                </div>
            </div>

            <div class="message-area" id="message-area">
                <div class="empty-state">
                    <i class="bi bi-chat-text"></i>
                    <p>选择聊天对象开始对话</p>
                </div>
            </div>

            <div class="send-area" id="send-area" style="display: none;">
                <div class="send-method-row">
                    <label>发送方式:</label>
                    <select class="method-select" id="send-method" onchange="changeSendMethod()">
                        <option value="text">普通消息</option>
                        <option value="markdown">原生Markdown</option>
                        <option value="template_markdown">模板Markdown</option>
                        <option value="image">图片</option>
                        <option value="voice">语音</option>
                        <option value="video">视频</option>
                        <option value="ark">ARK卡片</option>
                    </select>
                    <div class="send-help" id="send-help" style="display: none;">
                        <i class="bi bi-info-circle"></i>
                        <span id="help-content"></span>
                    </div>
                </div>

                <!-- 普通消息/原生markdown输入 -->
                <div id="text-input-area" class="input-group-area">
                    <textarea id="message-input" placeholder="输入消息内容..." rows="2"></textarea>
                    <button class="send-btn" onclick="sendMessage()"><i class="bi bi-send"></i> 发送</button>
                </div>

                <!-- 模板markdown输入 -->
                <div id="template-markdown-input-area" class="input-group-area" style="display: none;">
                    <div class="template-row">
                        <div class="template-field">
                            <label>模板选择:</label>
                            <select id="markdown-template" onchange="updateTemplateHelp()">
                                <option value="">请选择模板</option>
                            </select>
                        </div>
                        <div class="template-field">
                            <label>按钮ID (可选):</label>
                            <input type="text" id="markdown-keyboard" placeholder="如: 102321943_1752737844">
                        </div>
                    </div>
                    <div class="template-params-row">
                        <label>模板参数 (用逗号分隔):</label>
                        <textarea id="markdown-params" rows="1" placeholder="参数1,参数2,参数3..."></textarea>
                        <button class="send-btn" onclick="sendMessage()"><i class="bi bi-send"></i> 发送模板</button>
                    </div>
                </div>

                <!-- 图片输入 -->
                <div id="image-input-area" class="input-group-area" style="display: none;">
                    <div class="media-row">
                        <div class="media-field"><label>图片URL:</label><input type="url" id="image-url" placeholder="https://example.com/image.jpg"></div>
                        <div class="media-field"><label>文本:</label><input type="text" id="image-text" placeholder="图片描述"></div>
                        <button class="send-btn" onclick="sendMessage()"><i class="bi bi-send"></i> 发送</button>
                    </div>
                </div>

                <!-- 语音输入 -->
                <div id="voice-input-area" class="input-group-area" style="display: none;">
                    <div class="media-row">
                        <div class="media-field flex-grow"><label>语音文件URL:</label><input type="url" id="voice-url" placeholder="https://example.com/voice.mp3"></div>
                        <button class="send-btn" onclick="sendMessage()"><i class="bi bi-mic"></i> 发送语音</button>
                    </div>
                </div>

                <!-- 视频输入 -->
                <div id="video-input-area" class="input-group-area" style="display: none;">
                    <div class="media-row">
                        <div class="media-field flex-grow"><label>视频文件URL:</label><input type="url" id="video-url" placeholder="https://example.com/video.mp4"></div>
                        <button class="send-btn" onclick="sendMessage()"><i class="bi bi-camera-video"></i> 发送视频</button>
                    </div>
                </div>

                <!-- ARK卡片输入 -->
                <div id="ark-input-area" class="input-group-area" style="display: none;">
                    <div class="ark-row">
                        <div class="ark-type-field"><label>ARK类型:</label>
                            <select id="ark-type" onchange="updateArkHelp()">
                                <option value="">请选择类型</option>
                                <option value="23">列表卡片 (23)</option>
                                <option value="24">信息卡片 (24)</option>
                                <option value="37">通知卡片 (37)</option>
                            </select>
                        </div>
                        <div class="ark-params-field"><label>卡片参数:</label><input type="text" id="ark-params" placeholder="描述,提示,(项1),(项2,链接)..."></div>
                        <button class="send-btn" onclick="sendMessage()"><i class="bi bi-send"></i> 发送</button>
                    </div>
                </div>

                <div class="send-status-row">
                    <span class="id-status"><i class="bi bi-info-circle"></i> <span id="id-expire-info">请选择聊天对象</span></span>
                    <div id="send-status" style="display: none;"><span id="send-status-content"></span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.message-container { height: calc(100vh - 60px); padding: 1rem; background: #f5f7fa; }
.message-layout { display: flex; height: 100%; gap: 1rem; }

/* 左侧聊天列表面板 */
.chat-list-panel {
    width: 280px; min-width: 280px; background: #fff; border-radius: 16px;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.1); display: flex; flex-direction: column; overflow: hidden;
}
.panel-header {
    background: var(--theme-gradient);
    padding: 1rem; color: #fff;
}
.header-title { display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; font-weight: 600; margin-bottom: 0.75rem; }
.header-controls { display: flex; gap: 0.5rem; align-items: center; }
.chat-type-toggle { display: flex; background: rgba(255,255,255,0.2); border-radius: 20px; padding: 3px; }
.toggle-btn {
    padding: 0.35rem 0.75rem; border: none; background: transparent; color: rgba(255,255,255,0.8);
    border-radius: 18px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;
}
.toggle-btn.active { background: #fff; color: var(--primary-color, #5865F2); }
.toggle-btn:hover:not(.active) { background: rgba(255,255,255,0.15); }
.days-select {
    padding: 0.35rem 0.5rem; border: none; background: rgba(255,255,255,0.2); color: #fff;
    border-radius: 8px; font-size: 0.8rem; cursor: pointer;
}
.days-select option { color: #333; }

.search-box {
    display: flex; align-items: center; padding: 0.5rem; gap: 0.4rem; border-bottom: 1px solid #eee;
}
.search-box i { color: #999; font-size: 0.85rem; flex-shrink: 0; }
.search-box input {
    flex: 1; min-width: 0; border: none; outline: none; font-size: 0.85rem; background: #f5f7fa;
    padding: 0.4rem 0.6rem; border-radius: 6px;
}
.search-btn {
    padding: 0.4rem 0.6rem; background: var(--theme-gradient);
    color: #fff; border: none; border-radius: 6px; font-size: 0.75rem; cursor: pointer; flex-shrink: 0;
}

.chat-list { flex: 1; overflow-y: auto; }
.chat-item {
    display: flex; align-items: center; padding: 0.75rem 1rem; gap: 0.75rem;
    cursor: pointer; transition: all 0.2s; border-bottom: 1px solid #f0f0f0;
}
.chat-item:hover { background: #f8f9ff; }
.chat-item.active { background: rgba(88,101,242,0.1); border-left: 3px solid var(--primary-color, #5865F2); }
.chat-avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; }
.chat-avatar-placeholder {
    width: 42px; height: 42px; border-radius: 50%; background: #1a1a2e;
    color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem;
}
.chat-item-info { flex: 1; min-width: 0; }
.chat-item-name { font-weight: 500; font-size: 0.9rem; color: #333; display: flex; align-items: center; gap: 0.5rem; }
.chat-item-name .time { font-size: 0.75rem; color: #999; font-weight: 400; }
.chat-item-id { font-size: 0.75rem; color: #999; margin-top: 2px; }

/* 右侧聊天窗口面板 */
.chat-window-panel {
    flex: 1; background: #fff; border-radius: 16px;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.1); display: flex; flex-direction: column; overflow: hidden;
}
.chat-header {
    display: flex; align-items: center; gap: 1rem; padding: 1rem 1.25rem;
    background: var(--theme-gradient); color: #fff;
}
.chat-avatar-wrap { font-size: 2rem; opacity: 0.9; }
.chat-avatar-wrap img { width: 48px; height: 48px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); }
.chat-avatar-wrap .chat-avatar-placeholder {
    width: 48px; height: 48px; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3);
}
.chat-info { flex: 1; }
.chat-name { font-size: 1.1rem; font-weight: 600; }
.chat-desc { font-size: 0.85rem; opacity: 0.85; margin-top: 2px; }

.message-area {
    flex: 1; padding: 1rem; overflow-y: auto; background: #f8f9ff;
}
.empty-state { text-align: center; color: #999; padding: 3rem; }
.empty-state i { font-size: 3rem; opacity: 0.5; }
.empty-state p { margin-top: 0.75rem; }
.loading-state { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding: 2rem; color: #999; }
.spinner { width: 32px; height: 32px; border: 3px solid #eee; border-top-color: var(--primary-color, #5865F2); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* 消息气泡 */
.message-bubble { max-width: 70%; margin-bottom: 1rem; }
.message-bubble.self { margin-left: auto; }
.message-bubble.other { margin-right: auto; }
.message-bubble .d-flex { display: flex; }
.message-bubble.self .d-flex { justify-content: flex-end; }
.message-content {
    padding: 0.6rem 1rem; border-radius: 16px; word-wrap: break-word; max-width: 100%;
}
.message-bubble.self .message-content { background: var(--theme-gradient); color: #fff; border-bottom-right-radius: 4px; }
.message-bubble.other .message-content { background: #fff; color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-bottom-left-radius: 4px; }
.message-content img { display: block; margin-top: 8px; border-radius: 8px; cursor: pointer; max-width: 300px; max-height: 400px; }
.message-content .small { font-size: 0.75rem; }
.me-2 { margin-right: 0.5rem; }
.ms-2 { margin-left: 0.5rem; }
.mb-1 { margin-bottom: 0.25rem; }
.text-muted { color: #999 !important; }
.text-primary { color: var(--primary-color, #5865F2) !important; }

/* 发送区域 */
.send-area { padding: 1rem; border-top: 1px solid #eee; background: #fff; }
.send-method-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
.send-method-row label { font-size: 0.85rem; color: #666; }
.method-select {
    padding: 0.4rem 0.75rem; border: 1px solid #e0e0e0; border-radius: 8px;
    font-size: 0.85rem; background: #fff; cursor: pointer; min-width: 140px;
}
.method-select:focus { border-color: var(--primary-color, #5865F2); outline: none; }
.send-help { display: flex; align-items: center; gap: 0.35rem; font-size: 0.8rem; color: var(--primary-color, #5865F2); }

.input-group-area {
    display: flex; gap: 0.75rem; align-items: flex-end; padding: 0.75rem;
    background: #f8f9ff; border-radius: 12px; border: 1px solid #e8e8e8;
}
.input-group-area textarea, .input-group-area input[type="text"], .input-group-area input[type="url"] {
    flex: 1; border: 1px solid #e0e0e0; border-radius: 8px; padding: 0.6rem 0.75rem;
    font-size: 0.9rem; resize: none; background: #fff;
}
.input-group-area textarea:focus, .input-group-area input:focus { border-color: var(--primary-color, #5865F2); outline: none; }
.send-btn {
    padding: 0.6rem 1.25rem; background: var(--theme-gradient);
    color: #fff; border: none; border-radius: 8px; font-size: 0.9rem; cursor: pointer;
    display: flex; align-items: center; gap: 0.4rem; white-space: nowrap; transition: all 0.2s;
}
.send-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102,126,234,0.3); }
.send-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

/* 模板/媒体/ARK输入样式 */
.template-row, .media-row, .ark-row { display: flex; gap: 0.75rem; align-items: flex-end; flex-wrap: wrap; width: 100%; }
.template-field, .media-field, .ark-type-field, .ark-params-field { display: flex; flex-direction: column; gap: 0.35rem; }
.template-field { flex: 1; min-width: 180px; }
.media-field { flex: 1; min-width: 150px; }
.media-field.flex-grow { flex: 2; }
.ark-type-field { min-width: 150px; }
.ark-params-field { flex: 1; }
.template-row label, .media-row label, .ark-row label { font-size: 0.8rem; color: #666; }
.template-row select, .ark-row select {
    padding: 0.5rem 0.75rem; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 0.85rem; background: #fff;
}
.template-params-row { display: flex; gap: 0.75rem; align-items: flex-end; margin-top: 0.75rem; width: 100%; }
.template-params-row label { font-size: 0.8rem; color: #666; margin-bottom: 0.35rem; display: block; }
.template-params-row textarea { flex: 1; }

.send-status-row { display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem; font-size: 0.8rem; }
.id-status { color: #999; }
.text-success { color: #28a745 !important; }
.text-danger { color: #dc3545 !important; }

/* 响应式 */
@media (max-width: 768px) {
    .message-layout { flex-direction: column; }
    .chat-list-panel { width: 100%; min-width: auto; height: 40vh; }
    .chat-window-panel { height: 60vh; }
    .header-controls { flex-wrap: wrap; }
    .message-bubble { max-width: 85%; }
}
</style>
{% endblock %}

{% block scripts %}
<script>
let currentChatType = 'user';
let currentChatId = null;
let searchQuery = '';
const ROBOT_QQ = '{{ ROBOT_QQ }}';
let currentSendMethod = 'text';
let chatRefreshTimer = null;
let isRefreshing = false;
let lastMessageSignature = '';
const avatarCache = new Map();
let renderedMessages = [];
let lastMessageId = null;
let markdownTemplates = {};
let currentDaysRange = 1;

const formatTimeWithoutYear = (t) => t ? t.replace(/^\d{4}[-\/年]/, '').replace(/^\d{4}\s+/, '') : '';
const getDatePart = (t) => t ? (formatTimeWithoutYear(t).match(/^(\d{1,2}[-\/月]\d{1,2}[日]?)/) || [])[1] || '' : '';
const getTimePart = (t) => t ? (t.match(/(\d{1,2}:\d{2})(:\d{2})?/) || [])[1] || '' : '';
const truncateNickname = (n) => n && n.length > 4 ? n.substring(0, 4) + '***' : n || '';
const escapeHtml = (text) => { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; };

function loadMarkdownTemplates() {
    const token = new URLSearchParams(window.location.search).get('token');
    if (!token) return;
    fetch(`/web/api/message/get_templates?token=${encodeURIComponent(token)}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('markdown-template');
                select.innerHTML = '<option value="">请选择模板</option>';
                data.data.templates.forEach(t => {
                    markdownTemplates[t.id] = t;
                    select.innerHTML += `<option value="${t.id}">模板${t.id} - ${t.param_count}个参数</option>`;
                });
            }
        }).catch(e => console.error('加载模板失败:', e));
}

document.addEventListener('DOMContentLoaded', function() {
    loadChatList();
    loadMarkdownTemplates();
    document.getElementById('send-method').value = currentSendMethod;
    changeSendMethod();
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });
    document.getElementById('search-input').addEventListener('input', function() {
        const value = this.value.trim();
        if (value !== searchQuery) {
            searchQuery = value;
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(() => loadChatList(), 300);
        }
    });
});

window.addEventListener('beforeunload', () => stopChatRefresh());
const stopChatRefresh = () => { if (chatRefreshTimer) clearInterval(chatRefreshTimer); chatRefreshTimer = null; isRefreshing = false; };
const startChatRefresh = () => { stopChatRefresh(); if (currentChatId) chatRefreshTimer = setInterval(refreshChatHistory, 1000); };

function refreshChatHistory() {
    if (!currentChatId || isRefreshing) return;
    isRefreshing = true;
    const token = new URLSearchParams(window.location.search).get('token');
    if (!token) { isRefreshing = false; return; }
    const requestData = { chat_type: currentChatType, chat_id: currentChatId, days_range: currentDaysRange === 'all' ? 30 : currentDaysRange, show_all: currentDaysRange === 'all' };
    if (lastMessageId) requestData.since_id = lastMessageId;
    fetch(`/web/api/message/get_chat_history?token=${encodeURIComponent(token)}`, {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(requestData)
    }).then(r => r.json()).then(data => {
        if (data.success) {
            const messageArea = document.getElementById('message-area');
            const isAtBottom = messageArea.scrollTop + messageArea.clientHeight >= messageArea.scrollHeight - 10;
            if (data.data.is_incremental) {
                if (data.data.messages.length > 0) {
                    data.data.messages.forEach(msg => {
                        messageArea.insertAdjacentHTML('beforeend', createMessageHtml(msg));
                        renderedMessages.push(msg);
                    });
                    lastMessageId = data.data.messages[data.data.messages.length - 1].id || lastMessageId;
                    lastMessageSignature = renderedMessages.map(m => `${m.user_id}-${m.content}-${m.timestamp}-${m.id || ''}`).join('|');
                    if (currentChatType === 'group') {
                        const newUserIds = [...new Set(data.data.messages.filter(msg => !msg.is_self).map(msg => msg.user_id))];
                        if (newUserIds.length > 0) loadNicknamesBatch(newUserIds).then(nicknames => {
                            newUserIds.forEach(userId => document.querySelectorAll(`[data-nickname-user-id="${userId}"]`).forEach(el => el.textContent = nicknames[userId] || `用户${userId.slice(-6)}`));
                        });
                    }
                }
            } else {
                renderChatHistory(data.data.messages);
                if (data.data.messages.length > 0) lastMessageId = data.data.messages[data.data.messages.length - 1].id || null;
            }
            if (isAtBottom) messageArea.scrollTop = messageArea.scrollHeight;
        }
    }).catch(e => console.error('刷新聊天记录失败:', e)).finally(() => isRefreshing = false);
}

function switchChatType(type) {
    stopChatRefresh();
    currentChatType = type;
    currentChatId = null;
    searchQuery = '';
    document.getElementById('search-input').value = '';
    document.getElementById('btn-users').classList.toggle('active', type === 'user');
    document.getElementById('btn-groups').classList.toggle('active', type === 'group');
    document.getElementById('send-area').style.display = 'none';
    resetChatWindow();
    loadChatList();
}

const resetChatWindow = () => {
    document.getElementById('current-chat-avatar').innerHTML = '<i class="bi bi-chat-square-dots"></i>';
    document.getElementById('current-chat-name').textContent = '选择一个聊天';
    document.getElementById('current-chat-info').textContent = '点击左侧列表选择聊天对象';
    document.getElementById('message-area').innerHTML = '<div class="empty-state"><i class="bi bi-chat-text"></i><p>选择聊天对象开始对话</p></div>';
    document.getElementById('id-expire-info').textContent = '请选择聊天对象';
    lastMessageSignature = '';
};

function changeDaysRange() {
    const daysValue = document.getElementById('days-range').value;
    currentDaysRange = daysValue === 'all' ? 'all' : parseInt(daysValue);
    lastMessageSignature = ''; renderedMessages = []; lastMessageId = null;
    if (currentChatId) loadChatHistory(currentChatId, currentChatType);
    loadChatList();
}

function changeSendMethod() {
    currentSendMethod = document.getElementById('send-method').value;
    document.querySelectorAll('.input-group-area').forEach(area => area.style.display = 'none');
    const areaMap = { 'text': 'text-input-area', 'markdown': 'text-input-area', 'template_markdown': 'template-markdown-input-area', 'image': 'image-input-area', 'voice': 'voice-input-area', 'video': 'video-input-area', 'ark': 'ark-input-area' };
    const targetArea = document.getElementById(areaMap[currentSendMethod]);
    if (targetArea) targetArea.style.display = 'flex';
    const messageInput = document.getElementById('message-input');
    if (messageInput && (currentSendMethod === 'text' || currentSendMethod === 'markdown')) {
        messageInput.placeholder = currentSendMethod === 'markdown' ? '输入Markdown格式消息...\n例如: **粗体** *斜体* `代码`' : '输入消息内容...';
    }
    updateHelpInfo();
}

function updateHelpInfo() {
    const helpArea = document.getElementById('send-help');
    const helpContent = document.getElementById('help-content');
    const helpTexts = { 'text': '', 'markdown': 'Markdown格式: **粗体** *斜体* `代码` [链接](url)', 'template_markdown': '选择模板并填入对应参数，参数用逗号分隔', 'image': '请输入图片URL和可选的描述文本', 'voice': '请输入语音文件URL，支持mp3、wav等格式', 'video': '请输入视频文件URL，支持mp4等格式', 'ark': '选择ARK卡片类型并填入对应参数' };
    const helpText = helpTexts[currentSendMethod] || '';
    if (helpText) { helpContent.textContent = helpText; helpArea.style.display = 'flex'; } else { helpArea.style.display = 'none'; }
}

function updateTemplateHelp() {
    const template = document.getElementById('markdown-template').value;
    const helpArea = document.getElementById('send-help');
    const helpContent = document.getElementById('help-content');
    if (template && markdownTemplates[template]) {
        const templateInfo = markdownTemplates[template];
        helpContent.textContent = `参数 (${templateInfo.param_count}个): ${templateInfo.params.join(', ')}`;
        helpArea.style.display = 'flex';
    } else updateHelpInfo();
}

function updateArkHelp() {
    const arkType = document.getElementById('ark-type').value;
    const helpArea = document.getElementById('send-help');
    const helpContent = document.getElementById('help-content');
    const arkHelp = { '23': '列表卡片示例: 这是列表卡片,卡片测试,(功能1),(功能2),(功能3,https://example.com)', '24': '信息卡片示例: 描述文本,提示文本,卡片标题,元描述,https://image.jpg,https://link.com,子标题', '37': '通知卡片示例: 系统通知,更新标题,子标题,https://cover.jpg,https://link.com' };
    if (arkType && arkHelp[arkType]) { helpContent.textContent = arkHelp[arkType]; helpArea.style.display = 'flex'; } else updateHelpInfo();
}

const searchChats = () => { searchQuery = document.getElementById('search-input').value.trim(); loadChatList(); };

function loadChatList() {
    const chatList = document.getElementById('chat-list');
    chatList.innerHTML = '<div class="loading-state"><div class="spinner"></div><span>加载中...</span></div>';
    const token = new URLSearchParams(window.location.search).get('token');
    if (!token) { chatList.innerHTML = '<div class="empty-state"><i class="bi bi-exclamation-circle"></i><p>未找到访问token</p></div>'; return; }
    fetch(`/web/api/message/get_chats?token=${encodeURIComponent(token)}`, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ type: currentChatType, search: searchQuery, days: currentDaysRange === 'all' ? 3 : currentDaysRange })
    }).then(r => r.json()).then(data => {
        if (data.success) renderChatList(data.data.chats);
        else chatList.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-circle"></i><p>加载失败: ${data.message}</p></div>`;
    }).catch(e => { chatList.innerHTML = '<div class="empty-state"><i class="bi bi-wifi-off"></i><p>网络错误</p></div>'; console.error('Error:', e); });
}

function renderChatList(chats) {
    const chatList = document.getElementById('chat-list');
    if (chats.length === 0) { chatList.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>暂无数据</p></div>'; return; }
    const html = chats.map(chat => {
        const avatar = currentChatType === 'user' 
            ? `<img src="${chat.avatar}" class="chat-avatar" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"><div class="chat-avatar-placeholder" style="display: none;">${chat.chat_id.slice(-2).toUpperCase()}</div>`
            : `<div class="chat-avatar-placeholder">${chat.avatar}</div>`;
        return `<div class="chat-item" onclick="selectChat('${chat.chat_id}', '${currentChatType}')">
            <div class="chat-avatar-wrap">${avatar}</div>
            <div class="chat-item-info">
                <div class="chat-item-name"><span data-user-id="${chat.chat_id}">Loading...</span><span class="time">${getDatePart(chat.last_time)}</span></div>
                <div class="chat-item-id">ID: ${chat.chat_id.slice(0, 6)}*** · ${getTimePart(chat.last_time)}</div>
            </div>
        </div>`;
    }).join('');
    chatList.innerHTML = html;
    if (currentChatType === 'user') {
        loadNicknamesBatch(chats.map(c => c.chat_id)).then(nicknames => {
            chats.forEach(chat => {
                const el = document.querySelector(`[data-user-id="${chat.chat_id}"]`);
                if (el) el.textContent = truncateNickname(nicknames[chat.chat_id] || `用户${chat.chat_id.slice(-6)}`);
            });
        });
    } else chats.forEach(chat => { const el = document.querySelector(`[data-user-id="${chat.chat_id}"]`); if (el) el.textContent = `${chat.chat_id.slice(0, 6)}***`; });
}

const apiCall = (endpoint, data) => {
    const token = new URLSearchParams(window.location.search).get('token');
    return fetch(`/web/api/${endpoint}?token=${encodeURIComponent(token)}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) }).then(r => r.json());
};

const loadNicknamesBatch = (userIds) => {
    if (!userIds || userIds.length === 0) return Promise.resolve({});
    return apiCall('message/get_nicknames_batch', {user_ids: userIds}).then(d => d.success ? d.data.nicknames : {}).catch(e => { console.error('批量加载昵称失败:', e); return {}; });
};

const loadNicknameForHeader = (userId) => {
    loadNicknamesBatch([userId]).then(nicknames => {
        const el = document.getElementById('current-chat-name');
        if (el && currentChatId === userId) el.textContent = nicknames[userId] || `用户 ${userId.slice(-6)}`;
    });
};

function selectChat(chatId, chatType) {
    stopChatRefresh();
    const isNewChat = currentChatId !== chatId || currentChatType !== chatType;
    if (isNewChat) { lastMessageSignature = ''; renderedMessages = []; lastMessageId = null; }
    currentChatId = chatId;
    document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
    event.currentTarget.classList.add('active');
    updateChatHeader(chatId, chatType);
    loadChatHistory(chatId, chatType);
    document.getElementById('send-area').style.display = 'block';
    updateIdStatus(chatType);
    setTimeout(startChatRefresh, 1000);
}

function updateChatHeader(chatId, chatType) {
    const avatarElement = document.getElementById('current-chat-avatar');
    const nameElement = document.getElementById('current-chat-name');
    const infoElement = document.getElementById('current-chat-info');
    if (chatType === 'user') {
        avatarElement.innerHTML = `<img src="https://q.qlogo.cn/qqapp/{{ appid }}/${chatId}/100" class="chat-avatar" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"><div class="chat-avatar-placeholder" style="display: none;">${chatId.slice(-2).toUpperCase()}</div>`;
        nameElement.textContent = 'Loading...';
        infoElement.textContent = `用户 ID: ${chatId}`;
        loadNicknameForHeader(chatId);
    } else {
        avatarElement.innerHTML = `<div class="chat-avatar-placeholder">${chatId[0].toUpperCase()}</div>`;
        nameElement.textContent = chatId;
        infoElement.textContent = `ID: ${chatId}`;
    }
}

const updateIdStatus = (type) => { document.getElementById('id-expire-info').textContent = `ID有效期：${type === 'group' ? '5分钟' : '1小时'}，超时后无法发送消息`; };

function loadChatHistory(chatId, chatType) {
    const messageArea = document.getElementById('message-area');
    messageArea.innerHTML = '<div class="loading-state"><div class="spinner"></div><span>加载中...</span></div>';
    const token = new URLSearchParams(window.location.search).get('token');
    if (!token) { messageArea.innerHTML = '<div class="empty-state"><i class="bi bi-exclamation-circle"></i><p>未找到访问token</p></div>'; return; }
    fetch(`/web/api/message/get_chat_history?token=${encodeURIComponent(token)}`, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ chat_type: chatType, chat_id: chatId, days_range: currentDaysRange === 'all' ? 30 : currentDaysRange, show_all: currentDaysRange === 'all' })
    }).then(r => r.json()).then(data => {
        if (data.success) {
            if (data.data.no_history) messageArea.innerHTML = '<div class="empty-state"><i class="bi bi-clock-history"></i><p>没有历史表</p></div>';
            else { renderChatHistory(data.data.messages); if (data.data.messages.length > 0) lastMessageId = data.data.messages[data.data.messages.length - 1].id || null; }
        } else messageArea.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-circle"></i><p>加载失败: ${data.message}</p></div>`;
    }).catch(e => { messageArea.innerHTML = '<div class="empty-state"><i class="bi bi-wifi-off"></i><p>网络错误</p></div>'; console.error('Error:', e); });
}

const getAvatarHtml = (isSelf, userId, avatarUrl) => {
    const cacheKey = isSelf ? 'robot' : `${userId}-${avatarUrl}`;
    if (avatarCache.has(cacheKey)) return avatarCache.get(cacheKey);
    let html;
    if (isSelf) html = `<img src="https://thirdqq.qlogo.cn/g?b=qq&nk=${ROBOT_QQ}&s=140" class="chat-avatar me-2" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"><div class="chat-avatar-placeholder me-2" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="bi bi-robot" style="color: white;"></i></div>`;
    else html = `<img src="${avatarUrl}" class="chat-avatar me-2" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"><div class="chat-avatar-placeholder me-2" style="display: none;">${(userId.slice(-2) || userId).toUpperCase()}</div>`;
    avatarCache.set(cacheKey, html);
    return html;
};

function renderChatHistory(messages) {
    const messageArea = document.getElementById('message-area');
    if (messages.length === 0) { lastMessageSignature = ''; renderedMessages = []; messageArea.innerHTML = '<div class="empty-state"><i class="bi bi-chat-text"></i><p>暂无聊天记录</p></div>'; return; }
    const signature = messages.map(m => `${m.user_id}-${m.content}-${m.timestamp}-${m.id || ''}`).join('|');
    if (signature === lastMessageSignature) return;
    lastMessageSignature = signature;
    if (renderedMessages.length > 0 && messages.length > renderedMessages.length) {
        const newMessages = messages.slice(renderedMessages.length);
        if (JSON.stringify(messages.slice(0, renderedMessages.length)) === JSON.stringify(renderedMessages)) {
            newMessages.forEach(msg => messageArea.insertAdjacentHTML('beforeend', createMessageHtml(msg)));
            renderedMessages = messages;
            return;
        }
    }
    messageArea.innerHTML = messages.map(msg => createMessageHtml(msg)).join('');
    renderedMessages = messages;
    if (messages.length > 0) lastMessageId = messages[messages.length - 1].id || null;
    if (currentChatType === 'group') {
        const uniqueUsers = [...new Set(messages.filter(msg => !msg.is_self).map(msg => msg.user_id))];
        if (uniqueUsers.length > 0) loadNicknamesBatch(uniqueUsers).then(nicknames => {
            uniqueUsers.forEach(userId => document.querySelectorAll(`[data-nickname-user-id="${userId}"]`).forEach(el => el.textContent = nicknames[userId] || `用户${userId.slice(-6)}`));
        });
    }
    messageArea.scrollTop = messageArea.scrollHeight;
}

function sendMessage() {
    if (!currentChatId) { alert('请先选择聊天对象'); return; }
    const sendData = collectSendData();
    if (!sendData) return;
    const originalSendMethod = currentSendMethod;
    const sendBtns = document.querySelectorAll('.send-btn');
    sendBtns.forEach(btn => { btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>发送中...'; });
    const token = new URLSearchParams(window.location.search).get('token');
    if (!token) { showSendStatus('未找到访问token', false); resetSendButtons(); return; }
    fetch(`/web/api/message/send?token=${encodeURIComponent(token)}`, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ chat_type: currentChatType, chat_id: currentChatId, send_method: currentSendMethod, ...sendData })
    }).then(r => r.json()).then(data => {
        if (data.success) {
            const msgId = data.data.message_id;
            const isError = msgId && /消息发送失败|code:|错误|失败/.test(msgId);
            if (isError) showSendStatus('发送失败: ' + getApiErrorMessage(msgId), false);
            else { clearCurrentInputs(); appendMessage(getDisplayContent(sendData), true, data.data.timestamp); showSendStatus('消息发送成功', true); setTimeout(refreshChatHistory, 200); }
        } else showSendStatus('发送失败: ' + data.message, false);
    }).catch(e => { showSendStatus('网络错误', false); console.error('Error:', e); })
    .finally(() => { currentSendMethod = originalSendMethod; document.getElementById('send-method').value = originalSendMethod; changeSendMethod(); resetSendButtons(); });
}

const getVal = (id) => document.getElementById(id)?.value.trim() || '';
const validate = (value, msg) => { if (!value) { alert(msg); return false; } return true; };

function collectSendData() {
    const handlers = {
        text: () => { const content = getVal('message-input'); return validate(content, '请输入消息内容') ? { content } : null; },
        markdown: () => { const content = getVal('message-input'); return validate(content, '请输入消息内容') ? { content } : null; },
        template_markdown: () => {
            const template = document.getElementById('markdown-template').value;
            const params = getVal('markdown-params');
            const keyboard = getVal('markdown-keyboard');
            if (!validate(template, '请选择模板') || !validate(params, '请输入模板参数')) return null;
            return { template, params: params.split(',').map(p => p.trim()), keyboard_id: keyboard || null };
        },
        image: () => { const imageUrl = getVal('image-url'); if (!validate(imageUrl, '请输入图片URL')) return null; return { image_url: imageUrl, image_text: getVal('image-text') }; },
        voice: () => { const voiceUrl = getVal('voice-url'); return validate(voiceUrl, '请输入语音文件URL') ? { voice_url: voiceUrl } : null; },
        video: () => { const videoUrl = getVal('video-url'); return validate(videoUrl, '请输入视频文件URL') ? { video_url: videoUrl } : null; },
        ark: () => {
            const arkType = document.getElementById('ark-type').value;
            const arkParams = getVal('ark-params');
            if (!validate(arkType, '请选择ARK卡片类型') || !validate(arkParams, '请输入卡片参数')) return null;
            const normalParams = [], listItems = [];
            let current = '', inBracket = false, bracketContent = [];
            for (let i = 0; i < arkParams.length; i++) {
                const char = arkParams[i];
                if (char === '(') { if (current.trim()) { normalParams.push(current.trim()); current = ''; } inBracket = true; bracketContent = []; }
                else if (char === ')') { if (inBracket) { if (current.trim()) bracketContent.push(current.trim()); listItems.push(bracketContent); bracketContent = []; current = ''; inBracket = false; } }
                else if (char === ',') { if (inBracket) { bracketContent.push(current.trim()); current = ''; } else if (current.trim()) { normalParams.push(current.trim()); current = ''; } }
                else current += char;
            }
            if (current.trim()) normalParams.push(current.trim());
            return { ark_type: parseInt(arkType), ark_params: listItems.length > 0 ? [...normalParams, listItems] : normalParams };
        }
    };
    return handlers[currentSendMethod]?.() || (alert('未知的发送方法'), null);
}

function clearCurrentInputs() {
    const clearMap = { 'text': ['message-input'], 'markdown': ['message-input'], 'template_markdown': ['markdown-params', 'markdown-keyboard'], 'image': ['image-url', 'image-text'], 'voice': ['voice-url'], 'video': ['video-url'], 'ark': ['ark-params'] };
    (clearMap[currentSendMethod] || []).forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
}

const getDisplayContent = (d) => ({ text: d.content, markdown: d.content, template_markdown: `[模板消息: ${d.template}]`, image: `[图片消息: ${d.image_text || '图片'}]`, voice: '[语音消息]', video: '[视频消息]', ark: `[ARK卡片: 类型${d.ark_type}]` }[currentSendMethod] || '[消息]');

function resetSendButtons() {
    document.querySelectorAll('.send-btn').forEach(btn => {
        btn.disabled = false;
        if (btn.closest('#text-input-area')) btn.innerHTML = '<i class="bi bi-send"></i> 发送';
        else if (btn.closest('#template-markdown-input-area')) btn.innerHTML = '<i class="bi bi-send"></i> 发送模板';
        else if (btn.closest('#voice-input-area')) btn.innerHTML = '<i class="bi bi-mic"></i> 发送语音';
        else if (btn.closest('#video-input-area')) btn.innerHTML = '<i class="bi bi-camera-video"></i> 发送视频';
        else btn.innerHTML = '<i class="bi bi-send"></i> 发送';
    });
}

const appendMessage = (content, isSelf, timestamp) => {
    const area = document.getElementById('message-area');
    const avatarHtml = isSelf ? getAvatarHtml(true, '', '') : `<div class="chat-avatar-placeholder me-2">U</div>`;
    const timeHtml = `<span class="small text-muted ms-2">${formatTimeWithoutYear(timestamp)}</span>`;
    area.insertAdjacentHTML('beforeend', `<div class="message-bubble ${isSelf ? 'self' : 'other'}"><div class="d-flex ${isSelf ? 'justify-content-end' : ''}">${!isSelf ? avatarHtml : ''}<div class="message-content"><div class="small text-muted mb-1">${timeHtml}</div>${content}</div>${isSelf ? avatarHtml : ''}</div></div>`);
    area.scrollTop = area.scrollHeight;
};

const getApiErrorMessage = (msg) => {
    if (!msg) return '未知错误';
    const code = (msg.match(/code:(\d+)/) || [])[1];
    const trace = (msg.match(/trace_id:([a-f0-9]+)/) || [])[1];
    return code || trace ? `${code ? 'code:'+code : ''}${trace ? ' trace_id:'+trace : ''}`.trim() : msg.replace(/消息发送失败\s*/g, '').replace(/>\s*/g, '').replace(/注：出现错误，请截图进行反馈\s*/g, '').replace(/\s+/g, ' ').trim() || '未知错误';
};

const showSendStatus = (msg, success) => {
    const div = document.getElementById('send-status');
    const content = document.getElementById('send-status-content');
    if (div && content) {
        content.innerHTML = `<span class="text-${success ? 'success' : 'danger'}"><i class="bi bi-${success ? 'check' : 'x'}-circle"></i> ${msg}</span>`;
        div.style.display = 'block';
        setTimeout(() => div.style.display = 'none', 5000);
    }
};

function createMessageHtml(msg) {
    const isSelf = msg.is_self;
    const avatarHtml = getAvatarHtml(isSelf, msg.user_id, msg.avatar);
    const timeHtml = `<span class="small text-muted ms-2">${formatTimeWithoutYear(msg.timestamp)}</span>`;
    const nicknameHtml = !isSelf && currentChatType === 'group' 
        ? `<div class="small mb-1"><span class="text-primary" data-nickname-user-id="${msg.user_id}">用户${msg.user_id.slice(-6)}</span>${timeHtml}</div>` 
        : `<div class="small text-muted mb-1">${timeHtml}</div>`;
    let textContent = msg.content || '';
    let imagesHtml = '';
    const imageUrlRegex = /<(https?:\/\/[^>]+)>/g;
    const imageUrls = [];
    let match;
    while ((match = imageUrlRegex.exec(textContent)) !== null) imageUrls.push(match[1]);
    textContent = textContent.replace(imageUrlRegex, '').trim();
    const escapedText = escapeHtml(textContent);
    if (imageUrls.length > 0) {
        imagesHtml = imageUrls.map(url => `<img src="${url}" referrerpolicy="no-referrer" style="max-width: 300px; max-height: 400px; border-radius: 8px; margin-top: 8px; cursor: pointer; display: block;" onclick="window.open('${url}', '_blank')" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" title="图片" alt="图片"><div style="display: none; padding: 10px; background: #f0f0f0; border-radius: 8px; margin-top: 8px;"><i class="bi bi-image"></i> 图片加载失败</div>`).join('');
    }
    return `<div class="message-bubble ${isSelf ? 'self' : 'other'}"><div class="d-flex ${isSelf ? 'justify-content-end' : ''}">${!isSelf ? avatarHtml : ''}<div class="message-content">${nicknameHtml}${escapedText}${imagesHtml}</div>${isSelf ? avatarHtml : ''}</div></div>`;
}
</script>
{% endblock %}
