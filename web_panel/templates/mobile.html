<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elaina手机仪表盘</title>
    <base href="{{ prefix }}/">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        // 全局配置将由后端API提供
        window.websocketEnabled = false; // 将由API更新
    </script>
    <style>
        /* 基础样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', 'PingFang SC', 'Hiragino Sans GB', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* 顶部导航栏 */
        .mobile-header {
            background: linear-gradient(135deg, #4361ee, #3f37c9);
            color: white;
            padding: 10px 15px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .mobile-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 100%;
        }
        
        .mobile-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .connection-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .connection-status.connected {
            background-color: #4cd137;
            box-shadow: 0 0 5px #4cd137;
        }
        
        .connection-status.disconnected {
            background-color: #e84118;
            box-shadow: 0 0 5px #e84118;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .pc-switch-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .pc-switch-btn:hover {
            background: rgba(255,255,255,0.3);
            color: white;
        }
        
        /* 主内容区域 */
        .mobile-content {
            padding: 80px 15px 70px; /* 增加底部padding避免被导航覆盖 */
            max-width: 100%;
        }
        
        /* 底部导航 */
        .mobile-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 8px 0;
            z-index: 9999; /* 确保导航栏始终在最顶层 */
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            padding: 5px 15px;
            border-radius: 8px;
            transition: all 0.3s;
            font-size: 12px;
        }
        
        .nav-item.active {
            color: #4361ee;
        }
        
        .nav-item i {
            font-size: 18px;
            margin-bottom: 2px;
        }
        
        .nav-item span {
            font-size: 10px;
        }
        
        /* 仪表板容器 */
        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            max-width: 100%;
        }
        
        /* 卡片通用样式 */
        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }
        
        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }
        
        /* 状态卡片 */
        .status-card {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }
        
        .status-card .card-title {
            font-size: 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .uptime-text {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* 统计卡片 */
        .stats-card {
            padding: 15px 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        
        .stat-text {
            flex: 1;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        /* 机器人信息卡片 */
        .mobile-robot-card {
            background: linear-gradient(135deg, #4361ee 0%, #3f37c9 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(67, 97, 238, 0.15);
        }
        
        .mobile-robot-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .mobile-robot-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid white;
            margin-right: 15px;
            object-fit: cover;
        }
        
        .mobile-robot-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .mobile-robot-desc {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .mobile-robot-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 12px;
        }
        
        .mobile-robot-info-item {
            display: flex;
            align-items: center;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .mobile-robot-info-item i {
            margin-right: 6px;
            width: 16px;
        }
        
        .mobile-robot-badge {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 5px;
        }
        
        /* 系统信息卡片 */
        .system-cards {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 每行显示2个 */
            gap: 10px;
        }
        
        .system-mini-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .system-icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }
        
        .cpu-icon { color: #2196F3; }
        .memory-icon { color: #4CAF50; }
        .storage-icon { color: #FF9800; }
        .disk-icon { color: #9C27B0; }
        
        .system-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .system-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .system-sub {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
        }
        
        /* 进度条样式 */
        .progress-container {
            margin-top: 10px;
        }
        
        .progress-bar-custom {
            width: 100%;
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .cpu-progress { background: linear-gradient(to right, #4cc9f0, #4361ee); }
        .memory-progress { background: linear-gradient(to right, #4895ef, #3f37c9); }
        .storage-progress { background: linear-gradient(to right, #f72585, #e63946); }
        .disk-progress { background: linear-gradient(to right, #4cc9f0, #4895ef); }
        
        /* 日志卡片 */
        .logs-card {
            max-height: none;
        }
        
        .logs-tabs {
            display: flex;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 4px;
        }
        
        .log-tab {
            flex: 1;
            padding: 8px 12px;
            text-align: center;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: none;
        }
        
        .log-tab.active {
            background: #4361ee;
            color: white;
        }
        
        .logs-container {
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: white;
        }
        
        .log-entry {
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
            color: #333; /* 设置日志文字为黑色 */
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-timestamp {
            color: #888;
            font-size: 10px;
        }
        
        .log-content {
            margin-top: 2px;
            line-height: 1.4;
        }
        
        /* 底部导航 */
        .mobile-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 10px 0 5px;
            z-index: 999;
        }
        
        .nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: #666;
            text-decoration: none;
            font-size: 10px;
            padding: 5px 10px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .nav-item.active {
            color: #4361ee;
            background: rgba(67, 97, 238, 0.1);
        }
        
        .nav-item i {
            font-size: 16px;
        }
        
        /* 内存分配详情 */
        .memory-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .memory-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .memory-item i {
            font-size: 14px;
        }
        
        .memory-label {
            font-size: 11px;
            color: #666;
        }
        
        .memory-value {
            font-size: 12px;
            font-weight: 600;
            color: #333;
        }
        
        /* 刷新按钮 */
        .refresh-btn {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            padding: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        /* 隐藏类 */
        .hidden {
            display: none;
        }
        
        /* 页面切换 */
        .page-section {
            display: none;
        }
        
        .page-section.active {
            display: block;
        }
        
        /* 文件夹样式 */
        .plugin-folder {
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .folder-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        
        .folder-header:hover {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
        }
        
        .folder-header.expanded {
            background: linear-gradient(135deg, #4361ee, #3f37c9);
            color: white;
        }
        
        .folder-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .folder-icon {
            font-size: 16px;
            transition: transform 0.3s ease;
        }
        
        .folder-header.expanded .folder-icon {
            transform: rotate(90deg);
        }
        
        .folder-count {
            background: rgba(0,0,0,0.1);
            color: #666;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 8px;
        }
        
        .folder-header.expanded .folder-count {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .folder-content {
            display: none;
            padding: 10px;
            animation: slideDown 0.3s ease;
        }
        
        .folder-content.expanded {
            display: block;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 1000px;
            }
        }

        /* 插件卡片样式 */
        .plugin-card {
            margin-bottom: 8px;
            border-radius: 6px;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
            border-left: 3px solid #ccc;
        }
        
        .plugin-card.loaded {
            border-left-color: #4CAF50;
        }
        
        .plugin-card.error {
            border-left-color: #f44336;
        }
        
        .plugin-content {
            padding: 12px 15px;
        }
        
        .plugin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .plugin-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        
        .plugin-badges {
            display: flex;
            gap: 5px;
        }
        
        .plugin-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .plugin-handlers {
            margin-top: 8px;
        }
        
        .handlers-container {
            max-height: 60px;
            overflow-y: auto;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .handler-item {
            display: inline-block;
            font-size: 10px;
            padding: 2px 5px;
            margin: 2px;
            border-radius: 3px;
            font-family: monospace;
        }
        
        .handler-item-public {
            background: #e7f7ee;
            color: #28a745;
        }
        
        .handler-item-owner {
            background: #e7f3ff;
            color: #007bff;
        }
        
        .handler-item-group {
            background: #fff3e0;
            color: #ff9800;
        }
        
        /* 加载动画 */
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        /* 统计页面样式 */
        .mobile-date-selector {
            font-size: 14px;
            padding: 6px 10px;
            border-radius: 6px;
        }
        
        .mobile-date-selector option {
            padding: 6px 10px;
        }
        
        /* 手机端图表样式 */
        .mobile-chart-container {
            position: relative;
            height: 230px;
            margin-top: 10px;
            padding-top: 30px;
        }
        
        #mobileStatisticsChart {
            width: 100% !important;
            height: 200px !important;
        }
        
        .mobile-chart-average-display {
            position: absolute;
            top: 35px;
            right: 10px;
            z-index: 10;
            font-size: 11px;
            font-weight: bold;
            color: #666;
            background: rgba(255, 255, 255, 0.9);
            padding: 3px 6px;
            border-radius: 3px;
            border: 1px solid #e0e0e0;
            backdrop-filter: blur(2px);
            pointer-events: none;
            display: none;
        }
        
        .mobile-chart-controls {
            margin-bottom: 15px;
        }
        
        .mobile-chart-toggle {
            font-size: 11px;
            padding: 6px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }
        
        .mobile-chart-toggle.active {
            background-color: #4361ee;
            border-color: #4361ee;
            color: white;
        }
        
        .mobile-chart-toggle:hover {
            background-color: #3f37c9;
            border-color: #3f37c9;
            color: white;
        }
        
        /* 活跃排行切换按钮 */
        .btn-group .btn {
            font-size: 12px;
            padding: 6px 12px;
        }
        
        .btn-group .btn.active {
            background-color: #4361ee;
            border-color: #4361ee;
            color: white;
        }
        
        /* 表格优化 */
        .table th, .table td {
            padding: 8px;
            font-size: 13px;
            vertical-align: middle;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        
        /* 用户昵称样式 */
        .mobile-nickname-loading {
            color: #007bff;
            font-size: 0.7em;
            animation: pulse 1.5s infinite;
        }
        
        .mobile-nickname-display {
            color: #28a745;
            font-size: 0.75em;
            font-style: italic;
        }
        
        /* 数据源标识样式 */
        .table-info td, .table-warning td, .table-success td {
            font-size: 11px;
            font-style: italic;
        }
        
        .table-info td {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .table-warning td {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .table-success td {
            background-color: #d4edda;
            color: #155724;
        }

        /* 响应式调整 */
        @media (max-width: 360px) {
            .mobile-content {
                padding: 75px 10px 70px; /* 修正底部padding */
            }
            
            .dashboard-card {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            /* 系统性能保持每行2个，不改为1列 */
            .system-cards {
                grid-template-columns: 1fr 1fr;
                gap: 8px; /* 小屏幕稍微减少间距 */
            }
            
            .system-mini-card {
                padding: 12px; /* 小屏幕减少内边距 */
            }
            
            /* 统计页面手机端优化 */
            .mobile-date-selector {
                font-size: 12px;
                max-width: 150px;
            }
            
            .btn-group .btn {
                font-size: 11px;
                padding: 5px 8px;
            }
            
            .table th, .table td {
                padding: 6px;
                font-size: 12px;
            }
            
            /* 小屏幕图表优化 */
            .mobile-chart-container {
                height: 210px;
                padding-top: 30px;
            }
            
            .mobile-chart-toggle {
                font-size: 10px;
                padding: 4px 6px;
            }
            
            #mobileStatisticsChart {
                height: 180px !important;
            }
        }
        
        /* 沙盒测试专用样式 */
        .sandbox-markdown {
            line-height: 1.6;
        }
        
        .sandbox-markdown pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 8px;
            margin: 6px 0;
            overflow-x: auto;
            font-size: 11px;
        }
        
        .sandbox-markdown code {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 3px;
            padding: 1px 4px;
            font-size: 11px;
            color: #e83e8c;
        }
        
        .sandbox-markdown pre code {
            background: none;
            border: none;
            padding: 0;
            color: #333;
        }
        
        .sandbox-markdown h1, .sandbox-markdown h2, .sandbox-markdown h3 {
            margin: 12px 0 6px 0;
            font-weight: 600;
            color: #333;
        }
        
        .sandbox-markdown h1 { font-size: 16px; }
        .sandbox-markdown h2 { font-size: 15px; }
        .sandbox-markdown h3 { font-size: 14px; }
        
        .sandbox-markdown ul {
            margin: 6px 0;
            padding-left: 16px;
        }
        
        .sandbox-markdown li {
            margin: 2px 0;
        }
        
        .sandbox-markdown .image-placeholder-small {
            display: inline-block;
            border: 1px dashed #dee2e6;
            border-radius: 2px;
            padding: 2px 4px;
            margin: 1px 0;
            background: #f8f9fa;
            vertical-align: middle;
        }
        
        .sandbox-markdown a {
            color: #007bff;
            text-decoration: none;
        }
        
        .sandbox-markdown a:hover {
            text-decoration: underline;
        }
        
        .sandbox-markdown .blockquote-custom {
            border-left: 3px solid #007bff;
            padding-left: 8px;
            margin: 8px 0;
            background: #f8f9fa;
            font-style: italic;
            font-size: 12px;
            opacity: 0.7;
            color: #6c757d;
        }
        
        .sandbox-markdown del {
            color: #6c757d;
            text-decoration: line-through;
        }
        
        .sandbox-markdown hr {
            border: none;
            border-top: 1px solid #e9ecef;
            margin: 12px 0;
        }
        
        .sandbox-markdown table {
            margin: 8px 0;
            font-size: 10px;
        }
        
        .sandbox-markdown kbd {
            font-size: 9px;
            padding: 1px 3px;
        }
        
        .sandbox-markdown ol, .sandbox-markdown ul {
            margin: 6px 0;
            padding-left: 16px;
        }
        
        .sandbox-markdown h4 { 
            font-size: 13px;
            margin: 10px 0 4px 0;
            font-weight: 600;
            color: #333;
        }
        
        /* QQ特有语法样式 */
        .sandbox-markdown .qq-at-user {
            color: #007bff;
            font-weight: 500;
            font-size: 12px;
        }
        
        .sandbox-markdown .qq-cmd-text {
            color: #007bff;
            font-weight: 500;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <div class="mobile-header">
        <div class="mobile-header-content">
            <div class="mobile-title">
                <i class="bi bi-phone"></i>
                <span>Elaina仪表盘</span>
            </div>
            <div class="header-actions">
                <span class="connection-status disconnected" id="connection-indicator"></span>
                <span id="connection-text" style="font-size: 12px;">未连接</span>
                <button class="refresh-btn" id="refresh-btn" title="刷新数据">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
                <a href="#" id="pc-switch-btn" class="pc-switch-btn me-2">
                    <i class="bi bi-laptop"></i> 切换PC
                </a>
            </div>
        </div>
    </div>

    <!-- 主内容区域 -->
    <div class="mobile-content">
        <!-- 仪表盘页面 -->
        <div class="page-section active" id="mobile-dashboard-section">
            <div class="dashboard-container">
            <!-- 运行状态卡片 -->
            <div class="dashboard-card status-card">
                <div class="card-title">
                    <i class="bi bi-activity"></i>
                    <span>运行状态</span>
                </div>
                <div class="status-info">
                    <div>
                        <div class="uptime-text">运行时间: <span id="mobile-uptime">0天 0小时</span></div>
                        <div class="uptime-text">启动时间: <span id="mobile-start-time">未知</span></div>
                    </div>
                    <div style="text-align: right;">
                        <div class="uptime-text" id="current-time"></div>
                    </div>
                </div>
            </div>



            <!-- 机器人信息卡片 -->
            <div class="mobile-robot-card">
                <div class="mobile-robot-header">
                    <img id="mobile-robot-avatar" src="" alt="机器人头像" class="mobile-robot-avatar" style="display: none;">
                    <div>
                        <div class="mobile-robot-name" id="mobile-robot-name">加载中...</div>
                        <div>
                            <span id="mobile-connection-type" class="mobile-robot-badge">WebHook</span>
                            <span id="mobile-connection-status" class="mobile-robot-badge">检测中...</span>
                        </div>
                    </div>
                </div>
                <div class="mobile-robot-desc" id="mobile-robot-desc">正在获取机器人信息...</div>
                <div class="mobile-robot-info">
                    <div class="mobile-robot-info-item">
                        <i class="bi bi-hash"></i>
                        QQ: <span id="mobile-robot-qq">{{ ROBOT_QQ }}</span>
                    </div>
                    <div class="mobile-robot-info-item">
                        <i class="bi bi-key"></i>
                        ID: <span id="mobile-robot-appid">{{ appid }}</span>
                    </div>
                    <div class="mobile-robot-info-item">
                        <i class="bi bi-tag"></i>
                        类型: <span id="mobile-robot-type">-</span>
                    </div>
                    <div class="mobile-robot-info-item">
                        <i class="bi bi-person"></i>
                        开发者: <span id="mobile-robot-developer">-</span>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <a id="mobile-robot-link" href="#" target="_blank" class="btn btn-outline-light btn-sm me-2">
                        <i class="bi bi-link-45deg"></i> 机器人链接
                    </a>
                    <button onclick="refreshMobileRobotInfo()" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-arrow-clockwise"></i> 刷新
                    </button>
                </div>
            </div>
            
            <!-- 系统性能卡片 -->
            <div class="dashboard-card">
                <h6 style="margin-bottom: 15px; color: #333;">
                    <i class="bi bi-speedometer2"></i> 系统性能
                </h6>
                <div class="system-cards">
                    <div class="system-mini-card">
                        <i class="fas fa-microchip system-icon cpu-icon"></i>
                        <div class="system-title">CPU使用率</div>
                        <div class="system-value" id="mobile-cpu-text">0%</div>
                        <div class="system-sub">框架: <span id="mobile-framework-cpu">0%</span></div>
                        <div class="progress-container">
                            <div class="progress-bar-custom">
                                <div id="mobile-cpu-progress" class="progress-fill cpu-progress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="system-mini-card">
                        <i class="fas fa-memory system-icon memory-icon"></i>
                        <div class="system-title">内存使用率</div>
                        <div class="system-value" id="mobile-memory-text">0%</div>
                        <div class="system-sub">框架: <span id="mobile-framework-memory">0%</span></div>
                        <div class="progress-container">
                            <div class="progress-bar-custom">
                                <div id="mobile-memory-progress" class="progress-fill memory-progress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="system-mini-card">
                        <i class="fas fa-hdd system-icon storage-icon"></i>
                        <div class="system-title">硬盘空间</div>
                        <div class="system-value" id="mobile-disk-used">0 GB</div>
                        <div class="system-sub">框架: <span id="mobile-framework-disk">0 GB</span></div>
                        <div class="progress-container">
                            <div class="progress-bar-custom">
                                <div id="mobile-disk-progress" class="progress-fill storage-progress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="system-mini-card">
                        <i class="fas fa-server system-icon disk-icon"></i>
                        <div class="system-title">总内存</div>
                        <div class="system-value" id="mobile-total-memory">0 MB</div>
                        <div class="system-sub">系统: <span id="mobile-system-memory">0 GB</span></div>
                        <div class="progress-container">
                            <div class="progress-bar-custom">
                                <div id="mobile-total-progress" class="progress-fill disk-progress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 内存分配详情 -->
            <div class="dashboard-card">
                <h6 style="margin-bottom: 15px; color: #333;">
                    <i class="bi bi-bar-chart-fill"></i> 内存分配详情
                </h6>
                <div class="memory-details">
                    <div class="memory-item">
                        <i class="bi bi-puzzle text-primary"></i>
                        <div>
                            <div class="memory-label">插件</div>
                            <div class="memory-value" id="mobile-plugins-memory">0 MB</div>
                        </div>
                    </div>
                    <div class="memory-item">
                        <i class="bi bi-bricks text-info"></i>
                        <div>
                            <div class="memory-label">框架</div>
                            <div class="memory-value" id="mobile-framework-memory-detail">0 MB</div>
                        </div>
                    </div>
                    <div class="memory-item">
                        <i class="bi bi-window text-success"></i>
                        <div>
                            <div class="memory-label">面板</div>
                            <div class="memory-value" id="mobile-webpanel-memory">0 MB</div>
                        </div>
                    </div>
                    <div class="memory-item">
                        <i class="bi bi-box text-secondary"></i>
                        <div>
                            <div class="memory-label">其他</div>
                            <div class="memory-value" id="mobile-other-memory">0 MB</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                    <span><i class="bi bi-recycle"></i> GC计数: <span id="mobile-gc-count">0/0/0</span></span>
                    <span><i class="bi bi-boxes"></i> 对象数: <span id="mobile-objects-count">0</span></span>
                </div>
            </div>

        </div>
    </div>
    
    <!-- 日志页面 -->
    <div class="page-section" id="mobile-logs-section">
        <div class="dashboard-container">
            <div class="dashboard-card logs-card">
                <h6 style="margin-bottom: 15px; color: #333;">
                    <i class="bi bi-journal-text"></i> 实时日志
                </h6>
                <div class="logs-tabs">
                    <button class="log-tab active" data-type="received">接收消息</button>
                    <button class="log-tab" data-type="plugin">插件日志</button>
                    <button class="log-tab" data-type="framework">框架日志</button>
                    <button class="log-tab" data-type="error">错误日志</button>
                </div>
                <div class="logs-container" id="mobile-logs-container">
                    <div class="loading"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 插件页面 -->
    <div class="page-section" id="mobile-plugins-section">
        <div class="dashboard-container">
            <div class="dashboard-card">
                <h6 style="margin-bottom: 15px; color: #333;">
                    <i class="bi bi-grid"></i> 插件列表
                    <button class="btn btn-sm btn-outline-primary float-end" id="mobile-refresh-plugins">
                        <i class="bi bi-arrow-clockwise"></i> 刷新
                    </button>
                </h6>
                <div id="mobile-plugins-container">
                    <div class="loading"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 统计页面 -->
    <div class="page-section" id="mobile-statistics-section">
        <div class="dashboard-container">
            <!-- 日期选择器 -->
            <div class="dashboard-card">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <label for="mobile-date-selector" style="font-size: 14px; font-weight: 600; color: #333;">查看日期:</label>
                    <select class="form-select mobile-date-selector" id="mobile-date-selector" style="flex: 1; max-width: 200px;">
                        <option value="today">今日数据</option>
                    </select>
                    <button class="btn btn-warning btn-sm" id="mobile-complete-dau">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                    <button class="btn btn-primary btn-sm" id="mobile-refresh-statistics">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>

            <!-- 数据趋势图表 -->
            <div class="dashboard-card">
                <h6 style="margin-bottom: 15px; color: #333;">
                    <i class="bi bi-graph-up"></i> 数据趋势 (近15天)
                </h6>
                
                <!-- 指标切换按钮 -->
                <div class="mobile-chart-controls mb-3">
                    <div class="btn-group-vertical w-100" role="group">
                        <div class="btn-group mb-2" role="group">
                            <button class="btn btn-outline-primary btn-sm mobile-chart-toggle active" data-metric="total_messages">总消息量</button>
                            <button class="btn btn-outline-primary btn-sm mobile-chart-toggle" data-metric="active_users">活跃用户</button>
                            <button class="btn btn-outline-primary btn-sm mobile-chart-toggle" data-metric="active_groups">活跃群聊</button>
                        </div>
                        <div class="btn-group mb-2" role="group">
                            <button class="btn btn-outline-primary btn-sm mobile-chart-toggle" data-metric="private_messages">私聊消息</button>
                            <button class="btn btn-outline-primary btn-sm mobile-chart-toggle" data-metric="total_users">总用户数</button>
                            <button class="btn btn-outline-primary btn-sm mobile-chart-toggle" data-metric="total_groups">总群组数</button>
                        </div>

                    </div>
                </div>
                
                <!-- 图表容器 -->
                <div class="mobile-chart-container">
                    <div id="mobile-chart-average-display" class="mobile-chart-average-display"></div>
                    <canvas id="mobileStatisticsChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- 今日数据概览 -->
            <div class="dashboard-card">
                <h6 style="margin-bottom: 15px; color: #333;" id="mobile-stats-table-title">
                    <i class="bi bi-bar-chart-fill"></i> 今日数据概览
                </h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <tbody id="mobile-today-stats-table">
                            <tr><td colspan="2" class="text-center text-muted">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 最活跃群组和用户 -->
            <div class="dashboard-card">
                <h6 style="margin-bottom: 15px; color: #333;">
                    <i class="bi bi-people-fill"></i> 活跃排行
                </h6>
                
                <!-- 切换按钮 -->
                <div class="btn-group w-100 mb-3" role="group">
                    <button class="btn btn-outline-primary active" id="mobile-groups-tab">最活跃群组</button>
                    <button class="btn btn-outline-primary" id="mobile-users-tab">最活跃用户</button>
                </div>
                
                <!-- 群组表格 -->
                <div class="table-responsive" id="mobile-groups-table-container">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>群组ID</th>
                                <th>消息数</th>
                            </tr>
                        </thead>
                        <tbody id="mobile-top-groups-table">
                            <tr><td colspan="2" class="text-center text-muted">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 用户表格 -->
                <div class="table-responsive" id="mobile-users-table-container" style="display: none;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>用户ID</th>
                                <th>消息数</th>
                            </tr>
                        </thead>
                        <tbody id="mobile-top-users-table">
                            <tr><td colspan="2" class="text-center text-muted">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 指令使用排行 -->
            <div class="dashboard-card">
                <h6 style="margin-bottom: 15px; color: #333;">
                    <i class="bi bi-terminal-fill"></i> 指令使用排行
                </h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>指令</th>
                                <th>使用次数</th>
                            </tr>
                        </thead>
                        <tbody id="mobile-command-stats-table">
                            <tr><td colspan="2" class="text-center text-muted">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 沙盒测试页面 -->
    <div class="page-section" id="mobile-sandbox-section">
        <div class="mobile-content">
            <!-- 页面标题 -->
            <div class="dashboard-card">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">沙盒测试</h5>
                    <i class="bi bi-play-circle text-primary"></i>
                </div>
                <p class="text-muted small mb-0">在此测试插件功能，无需真实消息</p>
            </div>
            
            <!-- 测试配置 -->
            <div class="dashboard-card">
                <h6 style="margin-bottom: 15px; color: #333;">
                    <i class="bi bi-gear-fill"></i> 测试配置
                </h6>
                <form id="mobile-sandbox-form">
                    <div class="mb-3">
                        <label for="mobile-sandbox-message" class="form-label">消息内容 <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="mobile-sandbox-message" rows="3" placeholder="输入要测试的消息内容，如：菜单、签到、今日运势等"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="mobile-sandbox-group" class="form-label">群组ID <small class="text-muted">(可留空)</small></label>
                                <input type="text" class="form-control" id="mobile-sandbox-group" placeholder="群聊时填写" value="">
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="mobile-sandbox-user" class="form-label">用户ID <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="mobile-sandbox-user" placeholder="987654321" value="987654321">
                            </div>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-play-circle"></i> 开始测试
                        </button>
                        <button type="button" class="btn btn-secondary" id="mobile-sandbox-clear">
                            <i class="bi bi-arrow-clockwise"></i> 清空结果
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- 使用说明 -->
            <div class="dashboard-card">
                <h6 style="margin-bottom: 15px; color: #333;">
                    <i class="bi bi-info-circle-fill"></i> 使用说明
                </h6>
                <div class="small text-muted">
                    <p><strong>消息类型：</strong></p>
                    <ul class="mb-0">
                        <li><strong>群聊：</strong> 需群组ID+用户ID</li>
                        <li><strong>私聊：</strong> 只需用户ID</li>
                    </ul>
                </div>
            </div>
            
            <!-- 测试结果 -->
            <div class="dashboard-card">
                <h6 style="margin-bottom: 15px; color: #333;">
                    <i class="bi bi-clipboard-data-fill"></i> 测试结果
                </h6>
                <div id="mobile-sandbox-results">
                    <div class="empty-results text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        <p>尚未进行测试，请配置参数后点击"开始测试"</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- 底部导航 -->
    <div class="mobile-bottom-nav">
        <div class="nav-items">
            <a href="#" class="nav-item active" data-section="dashboard">
                <i class="bi bi-speedometer2"></i>
                <span>仪表盘</span>
            </a>
            <a href="#" class="nav-item" data-section="logs">
                <i class="bi bi-journal-text"></i>
                <span>日志</span>
            </a>
            <a href="#" class="nav-item" data-section="plugins">
                <i class="bi bi-grid"></i>
                <span>插件</span>
            </a>
            <a href="#" class="nav-item" data-section="statistics">
                <i class="bi bi-bar-chart-fill"></i>
                <span>统计</span>
            </a>
            <a href="#" class="nav-item" data-section="sandbox">
                <i class="bi bi-play-circle"></i>
                <span>沙盒</span>
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.5.1/dist/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script>
        // 全局变量
        const URL_PREFIX = "{{ prefix }}";
        let socket;
        let autoRefreshTimer = null;
        let currentLogType = 'received';
        const connectionIndicator = document.getElementById('connection-indicator');
        const connectionText = document.getElementById('connection-text');
        
        // 统计相关全局变量
        let mobileStatisticsData = null;
        const mobileNicknameCache = new Map();
        let mobileChart = null;
        let mobileCurrentMetric = 'total_messages';

        // 设置连接状态
        function setConnectionStatus(connected) {
            if (connected) {
                connectionIndicator.classList.remove('disconnected');
                connectionIndicator.classList.add('connected');
                connectionText.textContent = '已连接';
            } else {
                connectionIndicator.classList.remove('connected');
                connectionIndicator.classList.add('disconnected');
                connectionText.textContent = '未连接';
            }
        }

        // 初始化Socket连接
        function initSocket() {
            try {
                const currentUrl = new URL(window.location.href);
                const host = currentUrl.hostname;
                const port = currentUrl.port || (currentUrl.protocol === 'https:' ? '443' : '80');
                const protocol = currentUrl.protocol === 'https:' ? 'https' : 'http';
                
                // 获取token参数
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');
                
                socket = io(`${protocol}://${host}:${port}${URL_PREFIX}`, {
                    path: "/socket.io",
                    reconnectionAttempts: 10,
                    reconnectionDelay: 1000,
                    timeout: 20000,
                    forceNew: true,
                    transports: ['polling', 'websocket'],
                    query: {
                        token: token
                    }
                });

                socket.on('connect', () => {
                    setConnectionStatus(true);
                    startAutoRefresh();
                });

                socket.on('disconnect', () => {
                    setConnectionStatus(false);
                    stopAutoRefresh();
                });

                socket.on('connect_error', (error) => {
                    setConnectionStatus(false);
                    stopAutoRefresh();
                });

                // 接收系统信息
                socket.on('system_info', updateSystemInfo);
                
                // 接收新消息
                socket.on('new_message', (data) => {
                    if (data.type === currentLogType) {
                        addLogEntry(data.data);
                    }
                });

                // 接收日志批量数据
                socket.on('logs_batch', (data) => {
                    if (data[currentLogType]) {
                        displayLogs(data[currentLogType].logs);
                    }
                    
                    // 不再更新日志统计显示，因为已删除消息统计卡片
                });

                // 接收插件信息
                socket.on('plugins_update', (data) => {
                    if (data && Array.isArray(data)) {
                        // 不再更新插件计数显示，因为已删除消息统计卡片
                        updateMobilePluginsInfo(data);
                    }
                });

            } catch (error) {
                setConnectionStatus(false);
                stopAutoRefresh();
            }
        }

        // 更新系统信息
        function updateSystemInfo(data) {
            if (!data) return;

            // CPU信息
            const cpuUsage = data.cpu_percent || 0;
            const frameworkCpu = data.framework_cpu_percent || 0;
            document.getElementById('mobile-cpu-text').textContent = cpuUsage.toFixed(1) + '%';
            document.getElementById('mobile-framework-cpu').textContent = frameworkCpu.toFixed(1) + '%';
            document.getElementById('mobile-cpu-progress').style.width = cpuUsage + '%';

            // 内存信息
            const memPercent = data.memory_percent || 0;
            const frameworkMemPercent = data.framework_memory_percent || 0;
            document.getElementById('mobile-memory-text').textContent = memPercent.toFixed(1) + '%';
            document.getElementById('mobile-framework-memory').textContent = frameworkMemPercent.toFixed(1) + '%';
            document.getElementById('mobile-memory-progress').style.width = memPercent + '%';

            // 总内存
            const memUsedValue = data.memory_used || 0;
            const totalMemValue = data.total_memory || 0;
            document.getElementById('mobile-total-memory').textContent = formatMemory(memUsedValue * 1024 * 1024);
            document.getElementById('mobile-system-memory').textContent = formatDiskSize(data.system_memory_total_bytes || totalMemValue * 1024 * 1024);
            document.getElementById('mobile-total-progress').style.width = memPercent + '%';

            // 硬盘信息
            if (data.disk_info) {
                const diskInfo = data.disk_info;
                document.getElementById('mobile-disk-used').textContent = formatDiskSize(diskInfo.used || 0);
                document.getElementById('mobile-framework-disk').textContent = formatDiskSize(diskInfo.framework_usage || 0);
                if (diskInfo.total && diskInfo.used) {
                    const diskUsagePercent = (diskInfo.used / diskInfo.total * 100);
                    document.getElementById('mobile-disk-progress').style.width = diskUsagePercent + '%';
                }
            }

            // 内存分配详情
            document.getElementById('mobile-plugins-memory').textContent = formatMemory(data.plugins_memory || 0);
            document.getElementById('mobile-framework-memory-detail').textContent = formatMemory(data.framework_memory || 0);
            document.getElementById('mobile-webpanel-memory').textContent = formatMemory(data.webpanel_memory || 0);
            document.getElementById('mobile-other-memory').textContent = formatMemory(data.other_memory || 0);

            // GC和对象数
            const gcCounts = data.gc_counts || [0, 0, 0];
            document.getElementById('mobile-gc-count').textContent = `${gcCounts[0]}/${gcCounts[1]}/${gcCounts[2]}`;
            document.getElementById('mobile-objects-count').textContent = data.objects_count || '0';

            // 运行时间
            if (data.uptime) {
                const uptime = Number(data.uptime);
                const days = Math.floor(uptime / 86400);
                const hours = Math.floor((uptime % 86400) / 3600);
                const minutes = Math.floor((uptime % 3600) / 60);
                
                let uptimeText = '';
                if (days > 0) uptimeText += days + '天 ';
                uptimeText += hours + '小时 ' + minutes + '分钟';
                
                document.getElementById('mobile-uptime').textContent = uptimeText;
            }

            // 启动时间
            if (data.start_time) {
                try {
                    const startDate = new Date(data.start_time);
                    if (!isNaN(startDate.getTime())) {
                        const formattedDate = startDate.toLocaleString('zh-CN', {
                            month: '2-digit', 
                            day: '2-digit',
                            hour: '2-digit', 
                            minute: '2-digit'
                        });
                        document.getElementById('mobile-start-time').textContent = formattedDate;
                    } else {
                        document.getElementById('mobile-start-time').textContent = data.start_time;
                    }
                } catch(e) {
                    document.getElementById('mobile-start-time').textContent = data.start_time;
                }
            }
        }

        // 格式化内存显示
        function formatMemory(bytesOrMb) {
            if (bytesOrMb === undefined || bytesOrMb === null || bytesOrMb === 0) {
                return '0 MB';
            }
            
            if (typeof bytesOrMb === 'string') {
                if (bytesOrMb.includes('MB') || bytesOrMb.includes('GB')) {
                    return bytesOrMb;
                }
                bytesOrMb = parseFloat(bytesOrMb);
            }
            
            if (bytesOrMb > 0 && bytesOrMb < 1000) {
                return Math.round(bytesOrMb) + ' MB';
            }
            
            let mb = bytesOrMb / (1024 * 1024);
            
            if (mb >= 1024) {
                const gb = mb / 1024;
                return gb.toFixed(2) + ' GB';
            }
            
            return Math.round(mb) + ' MB';
        }

        // 格式化硬盘大小
        function formatDiskSize(bytes) {
            if (bytes === undefined || bytes === null || bytes === 0) {
                return '0 GB';
            }
            
            const mb = bytes / (1024 * 1024);
            if (mb >= 1024) {
                const gb = mb / 1024;
                return gb.toFixed(2) + ' GB';
            } else {
                return Math.round(mb) + ' MB';
            }
        }

        // 显示日志
        function displayLogs(logs) {
            const container = document.getElementById('mobile-logs-container');
            container.innerHTML = '';
            
            if (!logs || logs.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">暂无日志</div>';
                return;
            }
            
            logs.forEach(log => {
                addLogEntry(log, false);
            });
        }

        // 添加日志条目
        function addLogEntry(log, prepend = true) {
            const container = document.getElementById('mobile-logs-container');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const timestamp = log.timestamp || new Date().toLocaleString('zh-CN');
            const content = log.content || log;
            
            entry.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div class="log-content">${content}</div>
            `;
            
            if (prepend && container.firstChild) {
                container.insertBefore(entry, container.firstChild);
            } else {
                container.appendChild(entry);
            }
            
            // 限制日志数量
            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        // 切换日志标签
        function switchLogTab(type) {
            currentLogType = type;
            
            // 更新标签状态
            document.querySelectorAll('.log-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            // 清空日志容器并显示加载状态
            const container = document.getElementById('mobile-logs-container');
            container.innerHTML = '<div class="loading"></div>';
            
            // 请求日志数据
            if (socket && socket.connected) {
                socket.emit('request_logs', {
                    type: type,
                    page: 1,
                    page_size: 30
                });
            }
        }

        // 开始自动刷新
        function startAutoRefresh() {
            if (autoRefreshTimer === null) {
                autoRefreshTimer = setInterval(() => {
                    if (socket && socket.connected) {
                        socket.emit('get_system_info');
                    }
                }, 5000);
            }
        }

        // 停止自动刷新
        function stopAutoRefresh() {
            if (autoRefreshTimer !== null) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
        }

        // 更新时间
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString('zh-CN');
        }



        // 初始化设备切换链接
        function initDeviceSwitchLinks() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            if (token) {
                const pcSwitchBtn = document.getElementById('pc-switch-btn');
                if (pcSwitchBtn) {
                    pcSwitchBtn.href = `?device=pc&token=${token}`;
                }
            }
        }

        // 页面切换功能
        function switchToPage(pageId) {
            console.log('切换到页面:', pageId);
            
            // 隐藏所有页面
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
                console.log('隐藏页面:', section.id);
            });
            
            // 显示目标页面
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                console.log('显示页面:', pageId);
            } else {
                console.error('找不到页面:', pageId);
            }
            
            // 更新导航状态
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const sectionName = pageId.replace('mobile-', '').replace('-section', '');
            const navItem = document.querySelector(`[data-section="${sectionName}"]`);
            if (navItem) {
                navItem.classList.add('active');
                console.log('激活导航:', sectionName);
            } else {
                console.error('找不到导航项:', sectionName);
            }
        }

        // 更新插件信息
        function updateMobilePluginsInfo(plugins) {
            const container = document.getElementById('mobile-plugins-container');
            
            if (!plugins || plugins.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">未发现任何插件</div>';
                return;
            }
            
            // 按目录分组插件
            const pluginsByDirectory = {};
            plugins.forEach(plugin => {
                const directory = plugin.directory || (plugin.name.startsWith('example/') ? 'example' : 
                               plugin.name.startsWith('system/') ? 'system' : 'other');
                if (!pluginsByDirectory[directory]) {
                    pluginsByDirectory[directory] = [];
                }
                pluginsByDirectory[directory].push(plugin);
            });
            
            // 按组顺序排序
            const directoryOrder = ['system', 'example', 'alone'];
            const sortedDirectories = Object.keys(pluginsByDirectory).sort((a, b) => {
                const indexA = directoryOrder.indexOf(a);
                const indexB = directoryOrder.indexOf(b);
                if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
            
            let html = '';
            sortedDirectories.forEach(directory => {
                const directoryPlugins = pluginsByDirectory[directory];
                if (directoryPlugins && directoryPlugins.length > 0) {
                    // 获取目录中文名
                    const directoryNames = {
                        'system': '系统插件',
                        'example': '示例插件', 
                        'alone': '独立插件',
                        'other': '其他插件'
                    };
                    const dirDisplayName = directoryNames[directory] || directory.toUpperCase();
                    
                    // 添加文件夹容器
                    html += `
                    <div class="plugin-folder">
                        <div class="folder-header" onclick="toggleFolder('${directory}')">
                            <div class="folder-title">
                                <i class="bi bi-chevron-right folder-icon" id="folder-icon-${directory}"></i>
                                <i class="bi bi-folder-fill"></i>
                                <span>${dirDisplayName}</span>
                                <span class="folder-count">${directoryPlugins.length}</span>
                            </div>
                        </div>
                        <div class="folder-content" id="folder-content-${directory}">`;
                    
                    // 添加该目录的所有插件
                    directoryPlugins.forEach(plugin => {
                const statusClass = plugin.status === 'loaded' ? 'loaded' : 'error';
                let statusBadge = plugin.status === 'loaded' 
                    ? `<span class="badge bg-success plugin-badge">已加载</span>` 
                    : `<span class="badge bg-danger plugin-badge">错误</span>`;
                
                let handlerCountBadge = '';
                if (plugin.status === 'loaded') {
                    const handlerCount = plugin.handlers || 0;
                    handlerCountBadge = `<span class="badge bg-secondary plugin-badge">${handlerCount}个处理器</span>`;
                }
                
                let handlersHtml = '';
                if (plugin.status === 'loaded' && plugin.handlers_list && plugin.handlers_list.length > 0) {
                    const handlers_owner_only = plugin.handlers_owner_only || {};
                    const handlers_group_only = plugin.handlers_group_only || {};
                    
                    handlersHtml = `
                    <div class="plugin-handlers">
                        <div class="handlers-container">
                            ${plugin.handlers_list.map(handler => {
                                const isOwnerOnly = handlers_owner_only[handler] === true;
                                const isGroupOnly = handlers_group_only[handler] === true;
                                let handlerClass = 'handler-item handler-item-public';
                                
                                if (isOwnerOnly) {
                                    handlerClass = 'handler-item handler-item-owner';
                                }
                                if (isGroupOnly) {
                                    handlerClass = 'handler-item handler-item-group';
                                }
                                
                                return `<span class="${handlerClass}">${handler}</span>`;
                            }).join('')}
                        </div>
                    </div>`;
                }
                
                let displayName = plugin.name;
                if (displayName.includes('/')) {
                    const parts = displayName.split('/');
                    if (parts.length >= 3) {
                        displayName = `${parts[1]} (${parts[2]})`;
                    } else {
                        displayName = parts[parts.length - 1];
                    }
                }
                
                html += `
                <div class="plugin-card ${statusClass}">
                    <div class="plugin-content">
                        <div class="plugin-header">
                            <div class="plugin-name">${displayName}</div>
                            <div class="plugin-badges">
                                ${statusBadge}
                                ${handlerCountBadge}
                            </div>
                        </div>
                        ${handlersHtml}
                    </div>
                </div>`;
                    });
                    
                    html += `</div></div>`;
                }
            });
            
            container.innerHTML = html;
        }
        
        // 文件夹展开/折叠功能
        function toggleFolder(directory) {
            const header = document.querySelector(`[onclick="toggleFolder('${directory}')"]`);
            const content = document.getElementById(`folder-content-${directory}`);
            const icon = document.getElementById(`folder-icon-${directory}`);
            
            if (content && header && icon) {
                const isExpanded = content.classList.contains('expanded');
                
                if (isExpanded) {
                    // 折叠
                    content.classList.remove('expanded');
                    header.classList.remove('expanded');
                    icon.classList.remove('bi-chevron-down');
                    icon.classList.add('bi-chevron-right');
                } else {
                    // 展开
                    content.classList.add('expanded');
                    header.classList.add('expanded');
                    icon.classList.remove('bi-chevron-right');
                    icon.classList.add('bi-chevron-down');
                }
            }
        }

        // ===== 统计功能相关函数 =====
        
        // 手机端自定义平均值显示插件
        const mobileAverageDisplayPlugin = {
            id: 'mobileAverageDisplay',
            beforeDraw: function(chart) {
                const options = chart.options.plugins.mobileAverageDisplay;
                if (!options || !options.display) return;
                
                const ctx = chart.ctx;
                const chartArea = chart.chartArea;
                
                ctx.save();
                
                // 绘制指标名称
                ctx.font = 'bold 14px Arial';
                ctx.fillStyle = options.color || '#333';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'bottom';
                
                const metricName = chart.data.datasets[0].label || '';
                const x = chartArea.left;
                const y = chartArea.top - 25;
                
                ctx.fillText(metricName, x, y);
                
                // 绘制平均值
                ctx.font = 'normal 12px Arial';
                ctx.fillStyle = '#666';
                const avgText = ` (${options.text})`;
                const metricWidth = ctx.measureText(metricName).width;
                
                ctx.fillText(avgText, x + metricWidth, y);
                
                ctx.restore();
            }
        };
        
        // 初始化手机端图表
        function initMobileChart() {
            // 检查Chart.js是否已加载
            if (typeof Chart === 'undefined') {
                console.error('Chart.js未加载');
                return;
            }
            
            // 检查ChartDataLabels插件是否已加载
            if (typeof ChartDataLabels === 'undefined') {
                console.error('ChartDataLabels插件未加载');
                return;
            }
            
            const ctx = document.getElementById('mobileStatisticsChart').getContext('2d');
            
            try {
                mobileChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '总消息量',
                        data: [],
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.15)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                plugins: [ChartDataLabels, mobileAverageDisplayPlugin],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false  // 手机端隐藏图例
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            cornerRadius: 6,
                            displayColors: false
                        },
                        datalabels: {
                            display: function(context) {
                                // 只在数据点较少时显示标签
                                return context.chart.data.labels.length <= 10;
                            },
                            backgroundColor: 'rgba(67, 97, 238, 0.8)',
                            borderColor: 'white',
                            borderWidth: 1,
                            borderRadius: 4,
                            color: 'white',
                            font: {
                                size: 9,
                                weight: 'bold'
                            },
                            padding: {
                                top: 2,
                                bottom: 2,
                                left: 4,
                                right: 4
                            },
                            formatter: function(value) {
                                return formatMobileNumber(value);
                            },
                            anchor: 'end',
                            align: 'top',
                            offset: 4
                        },
                        mobileAverageDisplay: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 10
                                },
                                maxRotation: 45,
                                minRotation: 0
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 10
                                },
                                callback: function(value) {
                                    return formatMobileNumber(value);
                                }
                            }
                        }
                    }
                }
            });
            } catch (error) {
                console.error('初始化图表失败:', error);
                // 在图表容器中显示错误信息
                const container = document.querySelector('.mobile-chart-container');
                if (container) {
                    container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #666; font-size: 14px;">图表加载失败</div>';
                }
            }
        }
        
        // 更新手机端图表
        function updateMobileChart(metric = mobileCurrentMetric) {
            if (!mobileChart || !mobileStatisticsData || !mobileStatisticsData.historical) {
                console.log('图表未初始化或数据未加载，跳过更新');
                return;
            }
            
            // 检查图表是否仍然有效
            if (mobileChart.destroyed) {
                console.log('图表已被销毁，跳过更新');
                return;
            }
            
            mobileCurrentMetric = metric;
            
            // 获取近15天数据
            const historical = mobileStatisticsData.historical.slice(-15);
            const today = mobileStatisticsData.today;
            
            // 合并数据（历史数据 + 今日数据）
            let allData = [...historical];
            if (today) {
                allData.push(today);
            }
            
            const labels = allData.map(item => {
                const date = new Date(item.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            
            const metricLabels = {
                'total_messages': '总消息量',
                'active_users': '活跃用户数',
                'active_groups': '活跃群聊数',
                'private_messages': '私聊消息数',
                'total_users': '总用户数',
                'total_groups': '总群组数',
                'total_friends': '总好友数'
            };
            
            let data;
            if (['total_messages', 'active_users', 'active_groups', 'private_messages'].includes(metric)) {
                data = allData.map(item => item.message_stats ? item.message_stats[metric] || 0 : 0);
            } else {
                data = allData.map(item => item.user_stats ? item.user_stats[metric] || 0 : 0);
            }
            
            // 计算平均值（只对前4个指标）
            let averageText = '';
            const shouldShowAverage = ['total_messages', 'active_users', 'active_groups', 'private_messages'].includes(metric);
            if (shouldShowAverage && data.length > 0) {
                const average = data.reduce((sum, val) => sum + val, 0) / data.length;
                averageText = `平均: ${formatMobileNumber(Math.round(average))}`;
            }
            
            mobileChart.data.labels = labels;
            mobileChart.data.datasets[0].label = metricLabels[metric] || metric;
            mobileChart.data.datasets[0].data = data;
            
            // 根据数据类型调整颜色
            const colors = {
                'total_messages': { border: '#4361ee', bg: 'rgba(67, 97, 238, 0.15)' },
                'active_users': { border: '#f72585', bg: 'rgba(247, 37, 133, 0.15)' },
                'active_groups': { border: '#4cc9f0', bg: 'rgba(76, 201, 240, 0.15)' },
                'private_messages': { border: '#7209b7', bg: 'rgba(114, 9, 183, 0.15)' },
                'total_users': { border: '#f77f00', bg: 'rgba(247, 127, 0, 0.15)' },
                'total_groups': { border: '#fcbf49', bg: 'rgba(252, 191, 73, 0.15)' },
                'total_friends': { border: '#606c38', bg: 'rgba(96, 108, 56, 0.15)' }
            };
            
            const color = colors[metric] || colors['total_messages'];
            mobileChart.data.datasets[0].borderColor = color.border;
            mobileChart.data.datasets[0].backgroundColor = color.bg;
            
            // 更新图表外部的平均值显示
            const mobileAverageDisplayElement = document.getElementById('mobile-chart-average-display');
            if (shouldShowAverage && mobileAverageDisplayElement) {
                mobileAverageDisplayElement.textContent = averageText;
                mobileAverageDisplayElement.style.color = color.border;
                mobileAverageDisplayElement.style.display = 'block';
            } else if (mobileAverageDisplayElement) {
                mobileAverageDisplayElement.style.display = 'none';
            }
            
            // 禁用原来的插件显示
            mobileChart.options.plugins.mobileAverageDisplay = {
                display: false
            };
            
            try {
                mobileChart.update();
            } catch (error) {
                console.error('更新图表失败:', error);
            }
        }
        
        // 手机端数字格式化函数
        function formatMobileNumber(num) {
            if (num === undefined || num === null || num === 0) return '0';
            
            const absNum = Math.abs(num);
            
            if (absNum >= 10000) {
                const wValue = absNum / 10000;
                if (wValue >= 10) {
                    return Math.round(wValue) + 'w';
                } else {
                    const rounded = Math.round(wValue * 100) / 100;
                    return (rounded % 1 === 0) ? rounded + 'w' : rounded.toFixed(1).replace(/\.0$/, '') + 'w';
                }
            } else if (absNum >= 1000) {
                const kValue = absNum / 1000;
                if (kValue >= 10) {
                    return Math.round(kValue) + 'k';
                } else {
                    const rounded = Math.round(kValue * 100) / 100;
                    return (rounded % 1 === 0) ? rounded + 'k' : rounded.toFixed(1).replace(/\.0$/, '') + 'k';
                }
            }
            
            return Math.round(absNum).toString();
        }
        
        // 加载可用日期列表
        function loadMobileAvailableDates() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (!token) {
                console.error('未找到访问token');
                return;
            }
            
            fetch(`${URL_PREFIX}/api/available_dates?token=${encodeURIComponent(token)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        populateMobileDateSelector(data.dates);
                    } else {
                        console.error('加载可用日期失败:', data.error);
                    }
                })
                .catch(error => {
                    console.error('获取可用日期时出错:', error);
                });
        }
        
        // 填充日期选择器
        function populateMobileDateSelector(dates) {
            const selector = document.getElementById('mobile-date-selector');
            selector.innerHTML = ''; // 清空现有选项
            
            dates.forEach(dateItem => {
                const option = document.createElement('option');
                option.value = dateItem.value;
                option.textContent = dateItem.display;
                if (dateItem.is_today) {
                    option.selected = true; // 默认选中今日
                }
                selector.appendChild(option);
            });
        }
        
        // 加载统计数据
        function loadMobileStatisticsData(forceRefresh = false) {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (!token) {
                console.error('未找到访问token');
                return;
            }
            
            // 构建API URL，如果需要强制刷新则添加参数
            let apiUrl = `${URL_PREFIX}/api/statistics?token=${encodeURIComponent(token)}`;
            if (forceRefresh) {
                apiUrl += '&force_refresh=true';
            }
            
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        mobileStatisticsData = data;
                        // 只有在加载完整统计数据时才更新表格和图表
                        if (data.historical && data.today) {
                            updateMobileTables(data.today || {});
                            updateMobileChart(mobileCurrentMetric); // 更新图表
                        } else if (data.selected_date_data) {
                            // 这是历史日期数据，只更新表格
                            updateMobileTables(data.selected_date_data);
                        }
                    } else {
                        console.error('加载统计数据失败:', data.error);
                        showMobileStatisticsError('加载统计数据失败: ' + (data.error || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('获取统计数据时出错:', error);
                    showMobileStatisticsError('获取统计数据时出错: ' + error.message);
                });
        }
        
        // 加载特定日期的数据
        function loadMobileDateSpecificData(selectedDate) {
            if (selectedDate === 'today') {
                // 加载今日数据
                loadMobileStatisticsData();
            } else {
                // 加载历史数据
                loadMobileHistoricalDateData(selectedDate);
            }
        }
        
        // 加载历史日期数据
        function loadMobileHistoricalDateData(dateStr) {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (!token) {
                console.error('未找到访问token');
                return;
            }
            
            // 构建API URL查询特定日期
            const apiUrl = `${URL_PREFIX}/api/statistics?token=${encodeURIComponent(token)}&date=${dateStr}`;
            
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // 更新表格数据
                        if (data.selected_date_data) {
                            updateMobileTables(data.selected_date_data);
                        } else {
                            showMobileStatisticsError('该日期没有可用数据');
                        }
                    } else {
                        console.error('加载历史数据失败:', data.error);
                        showMobileStatisticsError('加载历史数据失败: ' + (data.error || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('获取历史数据时出错:', error);
                    showMobileStatisticsError('获取历史数据时出错: ' + error.message);
                });
        }
        
        // 更新表格数据
        function updateMobileTables(todayData) {
            // 更新今日数据概览表格
            const todayStatsTable = document.getElementById('mobile-today-stats-table');
            const messageStats = todayData.message_stats || {};
            const userStats = todayData.user_stats || {};
            
            // 确定数据源信息
            let dataSourceInfo = '';
            if (todayData.is_historical) {
                dataSourceInfo = `<tr class="table-info"><td colspan="2" class="text-center"><small>📁 数据源: 本地文件</small></td></tr>`;
                if (todayData.generated_at) {
                    try {
                        const genTime = new Date(todayData.generated_at);
                        const timeStr = genTime.toLocaleString('zh-CN', { 
                            month: '2-digit', 
                            day: '2-digit', 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                        dataSourceInfo += `<tr class="table-info"><td colspan="2" class="text-center"><small>🕒 生成时间: ${timeStr}</small></td></tr>`;
                    } catch (e) {
                        // 时间解析失败，忽略
                    }
                }
            } else if (todayData.is_realtime) {
                dataSourceInfo = `<tr class="table-warning"><td colspan="2" class="text-center"><small>📊 数据源: 实时数据库查询</small></td></tr>`;
            } else {
                dataSourceInfo = `<tr class="table-success"><td colspan="2" class="text-center"><small>📁 数据源: 本地文件</small></td></tr>`;
            }

            todayStatsTable.innerHTML = `
                <tr><td>总消息量</td><td>${messageStats.total_messages || 0}</td></tr>
                <tr><td>活跃用户数</td><td>${messageStats.active_users || 0}</td></tr>
                <tr><td>活跃群聊数</td><td>${messageStats.active_groups || 0}</td></tr>
                <tr><td>私聊消息数</td><td>${messageStats.private_messages || 0}</td></tr>
                <tr><td>最活跃时段</td><td>${messageStats.peak_hour || 0}点 (${messageStats.peak_hour_count || 0}条)</td></tr>
                <tr><td>总用户数</td><td>${userStats.total_users || 0}</td></tr>
                <tr><td>总群组数</td><td>${userStats.total_groups || 0}</td></tr>
                <tr><td>总好友数</td><td>${userStats.total_friends || 0}</td></tr>
                ${dataSourceInfo}
            `;
            
            // 更新最活跃群组表格
            const topGroupsTable = document.getElementById('mobile-top-groups-table');
            const topGroups = messageStats.top_groups || [];
            if (topGroups.length > 0) {
                topGroupsTable.innerHTML = topGroups.slice(0, 5).map(group => 
                    `<tr><td>${maskMobileId(group.group_id)}</td><td>${group.message_count}</td></tr>`
                ).join('');
            } else {
                topGroupsTable.innerHTML = '<tr><td colspan="2" class="text-center text-muted">暂无数据</td></tr>';
            }
            
            // 更新最活跃用户表格
            const topUsersTable = document.getElementById('mobile-top-users-table');
            const topUsers = messageStats.top_users || [];
            if (topUsers.length > 0) {
                topUsersTable.innerHTML = topUsers.slice(0, 5).map(user => 
                    `<tr><td><span class="mobile-user-id-with-nickname" data-user-id="${user.user_id}">${maskMobileId(user.user_id)} <span class="mobile-nickname-loading">📝</span></span></td><td>${user.message_count}</td></tr>`
                ).join('');
                
                // 异步加载昵称
                loadMobileNicknamesForUsers(topUsers.slice(0, 5));
            } else {
                topUsersTable.innerHTML = '<tr><td colspan="2" class="text-center text-muted">暂无数据</td></tr>';
            }
            
            // 更新指令使用排行表格
            const commandStatsTable = document.getElementById('mobile-command-stats-table');
            const commandStats = todayData.command_stats || [];
            if (commandStats.length > 0) {
                commandStatsTable.innerHTML = commandStats.slice(0, 5).map(cmd => 
                    `<tr><td>${cmd.command}</td><td>${cmd.count}</td></tr>`
                ).join('');
            } else {
                commandStatsTable.innerHTML = '<tr><td colspan="2" class="text-center text-muted">暂无数据</td></tr>';
            }
        }
        
        // 脱敏处理ID
        function maskMobileId(id) {
            if (!id || typeof id !== 'string') return '未知';
            if (id.length <= 6) return id;
            return id.substring(0, 3) + '***' + id.substring(id.length - 3);
        }
        
        // 为用户列表加载昵称
        function loadMobileNicknamesForUsers(users) {
            users.forEach(user => {
                if (user.user_id && !mobileNicknameCache.has(user.user_id)) {
                    fetchMobileUserNickname(user.user_id);
                } else if (mobileNicknameCache.has(user.user_id)) {
                    updateMobileUserNickname(user.user_id, mobileNicknameCache.get(user.user_id));
                }
            });
        }
        
        // 获取单个用户昵称
        function fetchMobileUserNickname(userId) {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (!token) {
                return;
            }
            
            fetch(`${URL_PREFIX}/api/get_nickname/${encodeURIComponent(userId)}?token=${encodeURIComponent(token)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.nickname) {
                        mobileNicknameCache.set(userId, data.nickname);
                        updateMobileUserNickname(userId, data.nickname);
                    } else {
                        // 获取失败，移除加载图标
                        const elements = document.querySelectorAll(`[data-user-id="${userId}"] .mobile-nickname-loading`);
                        elements.forEach(el => el.remove());
                    }
                })
                .catch(error => {
                    // 错误处理，移除加载图标
                    const elements = document.querySelectorAll(`[data-user-id="${userId}"] .mobile-nickname-loading`);
                    elements.forEach(el => el.remove());
                });
        }
        
        // 更新页面上的用户昵称显示
        function updateMobileUserNickname(userId, nickname) {
            const elements = document.querySelectorAll(`[data-user-id="${userId}"]`);
            elements.forEach(element => {
                const loadingEl = element.querySelector('.mobile-nickname-loading');
                if (loadingEl) {
                    loadingEl.textContent = `(${nickname})`;
                    loadingEl.classList.remove('mobile-nickname-loading');
                    loadingEl.classList.add('mobile-nickname-display');
                }
            });
        }
        
        // 显示统计错误信息
        function showMobileStatisticsError(message) {
            const tables = ['mobile-today-stats-table', 'mobile-top-groups-table', 'mobile-top-users-table', 'mobile-command-stats-table'];
            tables.forEach(tableId => {
                const table = document.getElementById(tableId);
                if (table) {
                    table.innerHTML = `<tr><td colspan="2" class="text-center text-danger">${message}</td></tr>`;
                }
            });
        }
        
        // 补全DAU数据
        function completeMobileDauData() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (!token) {
                console.error('未找到访问token');
                return;
            }
            
            // 禁用按钮，显示加载状态
            const btn = document.getElementById('mobile-complete-dau');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
            
            fetch(`${URL_PREFIX}/api/complete_dau?token=${encodeURIComponent(token)}`, {
                method: 'POST'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const result = data.result;
                        let message = `📊 DAU数据补全完成！\n\n`;
                        message += `📈 处理结果:\n`;
                        message += `✅ 成功生成: ${result.generated_count}天\n`;
                        message += `❌ 生成失败: ${result.failed_count}天\n`;
                        message += `📅 总计处理: ${result.total_missing}天`;
                        
                        if (result.generated_dates && result.generated_dates.length > 0) {
                            message += `\n\n✅ 新生成的日期:\n`;
                            const displayDates = result.generated_dates.slice(-3);
                            displayDates.forEach(date => {
                                message += `• ${date}\n`;
                            });
                            if (result.generated_dates.length > 3) {
                                message += `• ... 等共${result.generated_dates.length}个日期\n`;
                            }
                        }
                        
                        alert(message);
                        
                        // 如果有新数据生成，自动刷新统计数据
                        if (result.generated_count > 0) {
                            loadMobileStatisticsData(true);
                            loadMobileAvailableDates(); // 重新加载可用日期
                        }
                    } else {
                        alert('补全DAU数据失败: ' + (data.error || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('补全DAU数据时出错:', error);
                    alert('补全DAU数据时出错: ' + error.message);
                })
                .finally(() => {
                    // 恢复按钮状态
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                });
        }
        
        // 切换活跃排行表格
        function switchMobileActiveTable(type) {
            const groupsTab = document.getElementById('mobile-groups-tab');
            const usersTab = document.getElementById('mobile-users-tab');
            const groupsContainer = document.getElementById('mobile-groups-table-container');
            const usersContainer = document.getElementById('mobile-users-table-container');
            
            if (type === 'groups') {
                groupsTab.classList.add('active');
                usersTab.classList.remove('active');
                groupsContainer.style.display = 'block';
                usersContainer.style.display = 'none';
            } else {
                usersTab.classList.add('active');
                groupsTab.classList.remove('active');
                usersContainer.style.display = 'block';
                groupsContainer.style.display = 'none';
            }
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化时间
            updateTime();
            setInterval(updateTime, 1000);
            
            // 初始化Socket连接
            initSocket();
            
            // 初始化设备切换链接
            initDeviceSwitchLinks();
            
            // 日志标签切换事件
            document.querySelectorAll('.log-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchLogTab(tab.dataset.type);
                });
            });
            
            // 刷新按钮事件
            document.getElementById('refresh-btn').addEventListener('click', () => {
                if (socket && socket.connected) {
                    socket.emit('get_system_info');
                    socket.emit('request_logs', {
                        type: currentLogType,
                        page: 1,
                        page_size: 30
                    });
                }
            });
            
            // 底部导航切换
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = item.dataset.section;
                    switchToPage(`mobile-${section}-section`);
                    
                    // 如果切换到统计页面，初始化图表并加载统计数据
                    if (section === 'statistics') {
                        setTimeout(() => {
                            // 初始化图表（如果还没有初始化）
                            if (!mobileChart) {
                                // 等待Chart.js完全加载后再初始化
                                const tryInitChart = () => {
                                    if (typeof Chart !== 'undefined' && typeof ChartDataLabels !== 'undefined') {
                                        initMobileChart();
                                    } else {
                                        console.log('等待Chart.js和插件加载...');
                                        setTimeout(tryInitChart, 200);
                                    }
                                };
                                tryInitChart();
                            }
                            
                            loadMobileAvailableDates(); // 先加载可用日期
                            setTimeout(() => {
                                loadMobileStatisticsData(); // 然后加载统计数据
                            }, 500); // 增加延迟确保图表初始化完成
                        }, 100);
                    }
                });
            });

            // 插件刷新按钮
            document.getElementById('mobile-refresh-plugins').addEventListener('click', () => {
                if (socket && socket.connected) {
                    const container = document.getElementById('mobile-plugins-container');
                    container.innerHTML = '<div class="loading"></div>';
                    socket.emit('refresh_plugins');
                }
            });

            // ===== 统计功能事件监听器 =====
            
            // 日期选择器变化事件
            document.getElementById('mobile-date-selector').addEventListener('change', function() {
                const selectedDate = this.value;
                const selectedText = this.options[this.selectedIndex].text;
                
                // 更新表格标题
                document.getElementById('mobile-stats-table-title').innerHTML = 
                    selectedDate === 'today' ? '<i class="bi bi-bar-chart-fill"></i> 今日数据概览' : `<i class="bi bi-bar-chart-fill"></i> ${selectedText.split(' ')[0]} 数据概览`;
                
                // 显示加载状态
                const tables = ['mobile-today-stats-table', 'mobile-top-groups-table', 'mobile-top-users-table', 'mobile-command-stats-table'];
                tables.forEach(tableId => {
                    const table = document.getElementById(tableId);
                    if (table) {
                        table.innerHTML = '<tr><td colspan="2" class="text-center text-muted">加载中...</td></tr>';
                    }
                });
                
                // 加载选中日期的数据
                loadMobileDateSpecificData(selectedDate);
            });
            
            // 补全DAU按钮
            document.getElementById('mobile-complete-dau').addEventListener('click', completeMobileDauData);
            
            // 刷新统计数据按钮
            document.getElementById('mobile-refresh-statistics').addEventListener('click', function() {
                const btn = this;
                const originalText = btn.innerHTML;
                
                // 显示加载状态
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                
                // 强制刷新数据
                loadMobileStatisticsData(true);
                
                // 2秒后恢复按钮状态
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }, 2000);
            });
            
            // 活跃排行切换按钮
            document.getElementById('mobile-groups-tab').addEventListener('click', () => {
                switchMobileActiveTable('groups');
            });
            
            document.getElementById('mobile-users-tab').addEventListener('click', () => {
                switchMobileActiveTable('users');
            });
            
            // 图表指标切换按钮
            document.querySelectorAll('.mobile-chart-toggle').forEach(button => {
                button.addEventListener('click', function() {
                    // 移除所有按钮的active状态
                    document.querySelectorAll('.mobile-chart-toggle').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // 激活当前按钮
                    this.classList.add('active');
                    
                    // 更新图表
                    const metric = this.dataset.metric;
                    updateMobileChart(metric);
                });
            });

            // 初始加载日志
            setTimeout(() => {
                switchLogTab('received');
            }, 1000);
            
            // =====================
            // 沙盒测试功能 (Mobile)
            // =====================
            function initMobileSandbox() {
                const sandboxForm = document.getElementById('mobile-sandbox-form');
                const sandboxMessage = document.getElementById('mobile-sandbox-message');
                const sandboxGroup = document.getElementById('mobile-sandbox-group');
                const sandboxUser = document.getElementById('mobile-sandbox-user');
                const sandboxResults = document.getElementById('mobile-sandbox-results');
                const sandboxClear = document.getElementById('mobile-sandbox-clear');
                
                // 移除快速配置功能
                
                // 清空结果
                sandboxClear.addEventListener('click', function() {
                    sandboxResults.innerHTML = `
                        <div class="empty-results text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            <p>尚未进行测试，请配置参数后点击"开始测试"</p>
                        </div>
                    `;
                });
                
                // 表单提交
                sandboxForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const message = sandboxMessage.value.trim();
                    const groupId = sandboxGroup.value.trim();
                    const userId = sandboxUser.value.trim();
                    
                    if (!message) {
                        alert('请输入消息内容');
                        return;
                    }
                    if (!userId) {
                        alert('请输入用户ID');
                        return;
                    }
                    // 群组ID可以为空（私聊模式）
                    
                    // 显示加载状态
                    sandboxResults.innerHTML = `
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">测试中...</span>
                            </div>
                            <p class="mt-2 text-muted">正在处理消息，请稍候...</p>
                        </div>
                    `;
                    
                    // 获取token
                    const urlParams = new URLSearchParams(window.location.search);
                    const token = urlParams.get('token');
                    
                    if (!token) {
                        sandboxResults.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle"></i> 未找到访问token
                            </div>
                        `;
                        return;
                    }
                    
                    // 发送测试请求
                    fetch(`${URL_PREFIX}/api/sandbox/test?token=${encodeURIComponent(token)}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            group_id: groupId,
                            user_id: userId
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        displayMobileSandboxResults(data);
                    })
                    .catch(error => {
                        console.error('沙盒测试错误:', error);
                        sandboxResults.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle"></i> 测试请求失败: ${error.message}
                            </div>
                        `;
                    });
                });
            }
            
            // 显示移动端沙盒测试结果
            function displayMobileSandboxResults(data) {
                const sandboxResults = document.getElementById('mobile-sandbox-results');
                let html; // 在函数开头声明html变量
                
                if (data.success) {
                    html = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> 测试完成！插件正常响应
                        </div>
                    `;
                    
                    // 显示消息信息
                    if (data.message_info) {
                        html += `
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0">测试信息</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2"><strong>消息:</strong> ${escapeHtml(data.message_info.content)}</div>
                                    <div class="mb-2"><strong>类型:</strong> ${escapeHtml(data.message_info.message_type || '群聊消息')}</div>
                                    <div class="mb-2"><strong>群组ID:</strong> ${escapeHtml(data.message_info.group_id)}</div>
                                    <div class="mb-2"><strong>用户ID:</strong> ${escapeHtml(data.message_info.user_id)}</div>
                                    <div><strong>时间:</strong> ${escapeHtml(data.message_info.timestamp)}</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // 显示回复结果
                    if (data.replies && data.replies.length > 0) {
                        html += `
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">插件回复 (共${data.replies.length}条)</h6>
                                </div>
                                <div class="card-body">
                        `;
                        
                        data.replies.forEach((reply, index) => {
                            html += `
                                <div class="border rounded p-2 mb-2 bg-light">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="badge bg-secondary">回复消息</span>
                                        <small class="text-muted">#${index + 1}</small>
                                    </div>
                                    <div class="content small sandbox-markdown">
                                        ${reply.content ? renderMarkdown(reply.content) : '<em>(无内容)</em>'}
                                        
                                        ${reply.buttons && reply.buttons.content && Array.isArray(reply.buttons.content.rows) ? `
                                            <div class="mt-2">
                                                <small class="text-muted d-block mb-1">交互按钮:</small>
                                                ${reply.buttons.content.rows.map(row => {
                                                    if (row && row.buttons && Array.isArray(row.buttons)) {
                                                        return `<div class="d-flex flex-wrap gap-1 mb-1">
                                                            ${row.buttons.map(btn => {
                                                                const buttonText = btn.render_data?.label || btn.action?.data || '';
                                                                const buttonStyle = btn.render_data?.style || 0;
                                                                const actionType = btn.action?.type || 2;
                                                                
                                                                // 根据样式设置按钮类
                                                                let btnClass = 'btn btn-sm ';
                                                                let iconClass = '';
                                                                
                                                                switch(buttonStyle) {
                                                                    case 0: btnClass += 'btn-outline-secondary'; break;
                                                                    case 1: btnClass += 'btn-outline-primary'; break;
                                                                    case 2: btnClass += 'btn-outline-secondary'; break;
                                                                    case 3: btnClass += 'btn-outline-danger'; break;
                                                                    case 4: btnClass += 'btn-primary'; break;
                                                                    default: btnClass += 'btn-outline-secondary'; break;
                                                                }
                                                                
                                                                // 根据动作类型设置图标
                                                                switch(actionType) {
                                                                    case 0: iconClass = 'bi bi-box-arrow-up-right'; break; // 跳转
                                                                    case 1: iconClass = 'bi bi-arrow-clockwise'; break; // 回调
                                                                    case 2: iconClass = 'bi bi-cursor-text'; break; // 回车
                                                                    default: iconClass = 'bi bi-gear'; break;
                                                                }
                                                                
                                                                return `<button class="${btnClass}" disabled style="cursor: default; font-size: 11px;">
                                                                    <i class="${iconClass}"></i> ${escapeHtml(buttonText)}
                                                                </button>`;
                                                            }).join('')}
                                                        </div>`;
                                                    }
                                                    return '';
                                                }).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                            `;
                            
                            // 显示媒体信息
                            if (reply.media) {
                                html += `
                                    <div class="mt-1">
                                        <small class="text-muted d-block mb-1">媒体:</small>
                                        <span class="badge bg-info small">包含媒体</span>
                                    </div>
                                `;
                            }
                            
                            html += `</div>`;
                        });
                        
                        html += `</div></div>`;
                    } else {
                        html += `
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 插件已处理消息，但没有返回任何回复内容
                            </div>
                        `;
                    }
                } else {
                    // 显示错误信息
                    html = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> 测试失败: ${escapeHtml(data.error || '未知错误')}
                        </div>
                    `;
                    
                    // 显示消息信息（如果有）
                    if (data.message_info) {
                        html += `
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0">测试信息</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2"><strong>消息:</strong> ${escapeHtml(data.message_info.content)}</div>
                                    <div class="mb-2"><strong>类型:</strong> ${escapeHtml(data.message_info.message_type || '群聊消息')}</div>
                                    <div class="mb-2"><strong>群组ID:</strong> ${escapeHtml(data.message_info.group_id)}</div>
                                    <div class="mb-2"><strong>用户ID:</strong> ${escapeHtml(data.message_info.user_id)}</div>
                                    <div><strong>时间:</strong> ${escapeHtml(data.message_info.timestamp)}</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // 显示详细错误信息
                    if (data.traceback) {
                        html += `
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">错误详情</h6>
                                </div>
                                <div class="card-body">
                                    <pre class="text-danger small" style="max-height: 200px; overflow-y: auto; font-size: 10px;">${escapeHtml(data.traceback)}</pre>
                                </div>
                            </div>
                        `;
                    }
                }
                
                sandboxResults.innerHTML = html;
            }
            
            // HTML转义函数
            function escapeHtml(text) {
                if (typeof text !== 'string') return '';
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, function(m) { return map[m]; });
            }
            
            // 扩展的Markdown渲染函数
            function renderMarkdown(text) {
                if (typeof text !== 'string') return '';
                
                // 先转义HTML
                let html = escapeHtml(text);
                
                // 处理代码块（包含语言标识）
                html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>');
                html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
                
                // 处理删除线
                html = html.replace(/~~([^~]+)~~/g, '<del>$1</del>');
                
                // 处理粗体和斜体
                html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
                
                // ⚠️ 重要：图片处理必须在链接处理之前，避免 ![text](url) 被误识别为链接
                // 处理图片（客户端加载模式）
                html = html.replace(/!\[([^\]]*)\]\(([^)]+?)(?:\s+"([^"]+)")?\)/g, function(match, alt, src, title) {
                    const titleAttr = title ? ` title="${title}"` : '';
                    return `<div class="image-placeholder-small">
                        <i class="bi bi-image" style="font-size: 10px; color: #6c757d;"></i>
                        <small class="text-muted" style="font-size: 9px;">图片: ${alt || '未命名图片'}</small>
                        <a href="${src}" target="_blank" class="btn btn-outline-primary" style="font-size: 8px; padding: 1px 3px; margin-left: 3px;">
                            <i class="bi bi-box-arrow-up-right"></i> 打开
                        </a>
                    </div>`;
                });
                
                // 处理链接（支持title属性）
                html = html.replace(/\[([^\]]+)\]\(([^)]+?)(?:\s+"([^"]+)")?\)/g, function(match, text, url, title) {
                    const titleAttr = title ? ` title="${title}"` : '';
                    return `<a href="${url}" target="_blank"${titleAttr} style="color: #007bff; text-decoration: none;">${text}</a>`;
                });
                
                // 处理QQ特有语法
                // 处理@用户：<@用户ID> 
                html = html.replace(/<@(\d+)>/g, '<span class="qq-at-user">@$1</span>');
                html = html.replace(/<@\{([^}]+)\}>/g, '<span class="qq-at-user">@$1</span>');
                
                // 处理QQ Bot交互组件：<qqbot-cmd-input text='xxx' show='xxx' />
                html = html.replace(/<qqbot-cmd-input\s+text=['"]([^'"]+)['"]\s+show=['"]([^'"]+)['"]\s*\/>/g, 
                    '$2(<span class="qq-cmd-text">$1</span>)');
                
                // 处理标题（支持更多级别）
                html = html.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
                html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
                html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
                html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
                
                // 处理引用
                html = html.replace(/^> (.+)$/gm, '<blockquote class="blockquote-custom">$1</blockquote>');
                
                // 处理分割线
                html = html.replace(/^---$/gm, '<hr>');
                html = html.replace(/^\*\*\*$/gm, '<hr>');
                html = html.replace(/^___$/gm, '<hr>');
                
                // 处理有序列表
                html = html.replace(/^(\d+)\. (.+)$/gm, '::OLI::$2::ENDOLI::');
                html = html.replace(/(::OLI::.*?::ENDOLI::(\s*::OLI::.*?::ENDOLI::)*)/g, '<ol>$1</ol>');
                html = html.replace(/::OLI::(.*?)::ENDOLI::/g, '<li>$1</li>');
                
                // 处理无序列表
                html = html.replace(/^[\*\-\+] (.+)$/gm, '::ULI::$1::ENDULI::');
                html = html.replace(/(::ULI::.*?::ENDULI::(\s*::ULI::.*?::ENDULI::)*)/g, '<ul>$1</ul>');
                html = html.replace(/::ULI::(.*?)::ENDULI::/g, '<li>$1</li>');
                
                // 处理表格（简单支持）
                html = html.replace(/\|(.+)\|/g, function(match, content) {
                    const cells = content.split('|').map(cell => cell.trim());
                    const cellElements = cells.map(cell => `<td>${cell}</td>`).join('');
                    return `<tr>${cellElements}</tr>`;
                });
                html = html.replace(/(<tr>.*<\/tr>(\s*<tr>.*<\/tr>)*)/g, '<table class="table table-sm table-bordered">$1</table>');
                
                // 处理键盘按键
                html = html.replace(/<kbd>([^<]+)<\/kbd>/g, '<kbd class="badge bg-secondary">$1</kbd>');
                
                // 处理换行（保留双换行为段落）
                html = html.replace(/\n\n/g, '::PARAGRAPH::');
                html = html.replace(/\n/g, '<br>');
                html = html.replace(/::PARAGRAPH::/g, '</p><p>');
                
                // 包装段落
                if (html.indexOf('<p>') === -1 && html.trim()) {
                    html = '<p>' + html + '</p>';
                }
                
                return html;
            }
            
            // 移动端机器人信息相关函数
            
            function loadMobileRobotInfo() {
                // 获取机器人信息
                const apiUrl = `{{ prefix }}/api/robot_info`;
                
                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        updateMobileRobotInfo(data);
                        
                        // 显示数据来源信息
                        if (data.data_source === 'api') {
                            console.log('移动端机器人信息加载成功（来自API）:', data);
                        } else if (data.data_source === 'expired_cache') {
                            console.log('移动端机器人信息加载成功（来自过期缓存）:', data);
                        } else {
                            console.log('移动端机器人信息加载成功，数据来源:', data.data_source);
                        }
                    })
                    .catch(error => {
                        console.error('获取机器人信息异常:', error);
                        
                        // 显示错误状态
                        document.getElementById('mobile-robot-name').textContent = '网络错误';
                        document.getElementById('mobile-robot-desc').textContent = '无法连接到服务器获取机器人信息';
                        document.getElementById('mobile-robot-qq').textContent = '{{ ROBOT_QQ }}';
                        document.getElementById('mobile-robot-appid').textContent = '{{ appid }}';
                        document.getElementById('mobile-robot-type').textContent = '未知';
                        document.getElementById('mobile-robot-developer').textContent = '未知';
                        
                        // 设置默认连接状态
                        const connectionTypeEl = document.getElementById('mobile-connection-type');
                        const connectionStatusEl = document.getElementById('mobile-connection-status');
                        connectionTypeEl.textContent = window.websocketEnabled ? 'WebSocket' : 'WebHook';
                        if (window.websocketEnabled) {
                            connectionTypeEl.style.backgroundColor = 'rgba(40, 167, 69, 0.3)';
                            connectionStatusEl.textContent = '检测中...';
                            connectionStatusEl.style.backgroundColor = 'rgba(255, 193, 7, 0.3)';
                        } else {
                            connectionTypeEl.style.backgroundColor = 'rgba(0, 123, 255, 0.3)';
                            connectionStatusEl.textContent = '接收中';
                            connectionStatusEl.style.backgroundColor = 'rgba(40, 167, 69, 0.3)';
                        }
                    });
            }
            
                        // 将updateMobileRobotInfo也暴露到全局作用域
            window.updateMobileRobotInfo = function(data) {
                // 统一的移动端机器人信息更新函数
                const connectionTypeEl = document.getElementById('mobile-connection-type');
                const connectionStatusEl = document.getElementById('mobile-connection-status');
                
                // 更新全局WebSocket状态
                window.websocketEnabled = data.connection_type === 'WebSocket';
                
                connectionTypeEl.textContent = data.connection_type;
                if (data.connection_type === 'WebSocket') {
                    connectionTypeEl.style.backgroundColor = 'rgba(40, 167, 69, 0.3)';
                    // 显示实际的WebSocket连接状态
                    connectionStatusEl.textContent = data.connection_status || '检测中...';
                    if (data.connection_status === '连接中') {
                        connectionStatusEl.style.backgroundColor = 'rgba(40, 167, 69, 0.3)';
                    } else if (data.connection_status === '连接失败') {
                        connectionStatusEl.style.backgroundColor = 'rgba(220, 53, 69, 0.3)';
                    } else {
                        connectionStatusEl.style.backgroundColor = 'rgba(255, 193, 7, 0.3)';
                    }
                } else {
                    connectionTypeEl.style.backgroundColor = 'rgba(0, 123, 255, 0.3)';
                    connectionStatusEl.textContent = '接收中';
                    connectionStatusEl.style.backgroundColor = 'rgba(40, 167, 69, 0.3)';
                }
                
                if (data.success) {
                    // 更新机器人基本信息
                    document.getElementById('mobile-robot-name').textContent = data.name;
                    // 处理介绍中的换行符，将\n转换为<br>标签
                    document.getElementById('mobile-robot-desc').innerHTML = (data.description || '').replace(/\n/g, '<br>');
                    document.getElementById('mobile-robot-qq').textContent = data.qq;
                    document.getElementById('mobile-robot-appid').textContent = data.appid;
                    document.getElementById('mobile-robot-type').textContent = data.type;
                    document.getElementById('mobile-robot-developer').textContent = data.developer;
                    
                    // 更新机器人头像
                    const avatarEl = document.getElementById('mobile-robot-avatar');
                    if (data.avatar) {
                        avatarEl.onerror = function() {
                            console.warn('移动端机器人头像加载失败，隐藏头像');
                            this.style.display = 'none';
                        };
                        avatarEl.onload = function() {
                            console.log('移动端机器人头像加载成功');
                        };
                        avatarEl.src = data.avatar;
                        avatarEl.style.display = 'block';
                    }
                    
                    // 设置机器人链接
                    const mobileRobotLinkEl = document.getElementById('mobile-robot-link');
                    if (data.link) {
                        mobileRobotLinkEl.href = data.link;
                        mobileRobotLinkEl.style.display = 'inline-block';
                    } else {
                        mobileRobotLinkEl.href = '#';
                        mobileRobotLinkEl.style.display = 'none';
                    }
                    
                    // 显示数据来源提示
                    if (data.warning) {
                        console.warn('移动端数据警告:', data.warning);
                    }
                } else {
                    // 显示错误信息，但仍然显示基本配置信息
                    document.getElementById('mobile-robot-name').textContent = data.name || '加载失败';
                    // 错误情况下也要处理换行符
                    document.getElementById('mobile-robot-desc').innerHTML = (data.description || '无法获取机器人信息').replace(/\n/g, '<br>');
                    document.getElementById('mobile-robot-qq').textContent = data.qq || '{{ ROBOT_QQ }}';
                    document.getElementById('mobile-robot-appid').textContent = data.appid || '{{ appid }}';
                    document.getElementById('mobile-robot-type').textContent = data.type || '未知';
                    document.getElementById('mobile-robot-developer').textContent = data.developer || '未知';
                }
            };
            
            // 为了向后兼容，在DOMContentLoaded内部也定义一个别名
            function updateMobileRobotInfo(data) {
                window.updateMobileRobotInfo(data);
            }
            

            
            // 初始化移动端沙盒测试功能
            initMobileSandbox();
            
            // 加载移动端机器人信息
            loadMobileRobotInfo();
        });
        
        // 全局函数定义 - 需要在HTML onclick中使用
        window.refreshMobileRobotInfo = function() {
            // 显示加载状态
            document.getElementById('mobile-robot-name').textContent = '刷新中...';
            document.getElementById('mobile-robot-desc').innerHTML = '正在强制刷新机器人信息...';
            
            // 调用刷新API，强制更新缓存
            const refreshUrl = `{{ prefix }}/api/robot_info/refresh`;
            
            fetch(refreshUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                // 刷新API直接返回新的机器人信息
                if (window.updateMobileRobotInfo) {
                    window.updateMobileRobotInfo(data);
                } else {
                    console.error('updateMobileRobotInfo函数不可用，重新加载页面');
                    location.reload();
                }
                
                if (data.data_source === 'api') {
                    console.log('移动端机器人信息已强制刷新，获取最新数据');
                } else {
                    console.log('移动端刷新完成，数据来源:', data.data_source);
                }
            })
            .catch(error => {
                console.error('移动端强制刷新失败，重新加载页面:', error);
                location.reload();
            });
        };
    </script>
</body>
</html> 