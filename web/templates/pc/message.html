{% extends "pc/base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- 左侧：聊天列表 -->
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-people me-2"></i>
                        <span id="chat-list-title">聊天列表</span>
                    </h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary active" id="btn-users" onclick="switchChatType('user')">
                            <i class="bi bi-person"></i> 好友
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="btn-groups" onclick="switchChatType('group')">
                            <i class="bi bi-people"></i> 群聊
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- 搜索框 -->
                    <div class="p-3 border-bottom">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control" id="search-input" placeholder="搜索聊天...">
                            <button class="btn btn-outline-secondary" type="button" onclick="searchChats()">
                                搜索
                            </button>
                        </div>
                    </div>
                    
                    <!-- 聊天列表 -->
                    <div id="chat-list" class="list-group list-group-flush" style="max-height: 500px; overflow-y: auto;">
                        <div class="text-center p-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 分页 -->
                    <div class="p-3 border-top">
                        <nav>
                            <ul class="pagination pagination-sm justify-content-center mb-0" id="pagination">
                                <!-- 分页将通过JS动态生成 -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右侧：聊天窗口 -->
        <div class="col-md-9">
            <div class="card h-100">
                <div class="card-header" id="chat-header">
                    <div class="d-flex align-items-center">
                        <div id="current-chat-avatar" class="me-3">
                            <i class="bi bi-chat-square-dots text-muted" style="font-size: 2rem;"></i>
                        </div>
                        <div>
                            <h5 class="mb-0" id="current-chat-name">选择一个聊天</h5>
                            <small class="text-muted" id="current-chat-info">点击左侧列表选择聊天对象</small>
                        </div>
                    </div>
                </div>
                
                <!-- 聊天记录区域 -->
                <div class="card-body p-0 d-flex flex-column" style="height: 400px;">
                    <div id="message-area" class="flex-grow-1 p-3" style="overflow-y: auto; background-color: #f8f9fa;">
                        <div class="text-center text-muted">
                            <i class="bi bi-chat-text" style="font-size: 3rem;"></i>
                            <p class="mt-2">选择聊天对象开始对话</p>
                        </div>
                    </div>
                    
                    <!-- 发送消息区域 -->
                    <div class="border-top p-3" id="send-area" style="display: none;">
                        <div class="row g-2">
                            <div class="col">
                                <textarea class="form-control" id="message-input" rows="2" placeholder="输入消息内容..." style="resize: none;"></textarea>
                            </div>
                            <div class="col-auto d-flex flex-column justify-content-end">
                                <button class="btn btn-primary" onclick="sendMessage()" id="send-btn">
                                    <i class="bi bi-send"></i> 发送
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted" id="id-status">
                                <i class="bi bi-info-circle"></i> 
                                <span id="id-expire-info">请选择聊天对象</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 自定义样式 -->
<style>
.chat-item {
    cursor: pointer;
    transition: background-color 0.2s;
}
.chat-item:hover {
    background-color: #f8f9fa;
}
.chat-item.active {
    background-color: #e7f3ff;
    border-left: 4px solid #0d6efd;
}

.message-bubble {
    max-width: 70%;
    margin-bottom: 1rem;
}
.message-bubble.self {
    margin-left: auto;
}
.message-bubble.other {
    margin-right: auto;
}

.message-content {
    padding: 0.5rem 1rem;
    border-radius: 1rem;
    word-wrap: break-word;
}
.message-bubble.self .message-content {
    background-color: #0d6efd;
    color: white;
}
.message-bubble.other .message-content {
    background-color: #e9ecef;
    color: #333;
}

.chat-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.chat-avatar-placeholder {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #6c757d;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// 全局变量
let currentChatType = 'user';
let currentChatId = null;
let messagePage = 1;
let totalPages = 1;
let searchQuery = '';

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadChatList();
    
    // 回车发送消息
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
});

// 切换聊天类型（好友/群聊）
function switchChatType(type) {
    currentChatType = type;
    messagePage = 1;
    searchQuery = '';
    document.getElementById('search-input').value = '';
    
    // 更新按钮状态
    document.getElementById('btn-users').classList.toggle('active', type === 'user');
    document.getElementById('btn-groups').classList.toggle('active', type === 'group');
    
    // 更新标题
    document.getElementById('chat-list-title').textContent = type === 'user' ? '好友列表' : '群聊列表';
    
    loadChatList();
}

// 搜索聊天
function searchChats() {
    searchQuery = document.getElementById('search-input').value.trim();
    messagePage = 1;
    loadChatList();
}

// 加载聊天列表
function loadChatList() {
    const chatList = document.getElementById('chat-list');
    chatList.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">加载中...</span></div></div>';
    
    // 获取token
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (!token) {
        chatList.innerHTML = '<div class="text-center p-3 text-danger">未找到访问token</div>';
        return;
    }
    
    fetch(`/web/api/message/get_chats?token=${encodeURIComponent(token)}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: currentChatType,
            page: messagePage,
            search: searchQuery
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderChatList(data.data.chats);
            renderPagination(data.data.page, data.data.total_pages);
        } else {
            chatList.innerHTML = '<div class="text-center p-3 text-danger">加载失败: ' + data.message + '</div>';
        }
    })
    .catch(error => {
        chatList.innerHTML = '<div class="text-center p-3 text-danger">网络错误</div>';
        console.error('Error:', error);
    });
}

// 渲染聊天列表
function renderChatList(chats) {
    const chatList = document.getElementById('chat-list');
    
    if (chats.length === 0) {
        chatList.innerHTML = '<div class="text-center p-3 text-muted">暂无数据</div>';
        return;
    }
    
    const html = chats.map(chat => {
        const avatar = currentChatType === 'user' 
            ? `<img src="${chat.avatar}" class="chat-avatar" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
               <div class="chat-avatar-placeholder" style="display: none;">${chat.chat_id.slice(-2).toUpperCase()}</div>`
            : `<div class="chat-avatar-placeholder">${chat.avatar}</div>`;
            
        return `
            <div class="list-group-item chat-item" onclick="selectChat('${chat.chat_id}', '${currentChatType}')">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        ${avatar}
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-1" data-user-id="${chat.chat_id}">Loading...</h6>
                            <small class="text-muted">${chat.last_time}</small>
                        </div>
                        <small class="text-muted">ID: ${chat.chat_id.slice(0, 6)}***</small>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    chatList.innerHTML = html;
    
    // 异步加载昵称
    if (currentChatType === 'user') {
        chats.forEach(chat => {
            loadNickname(chat.chat_id);
        });
    } else {
        // 群聊直接显示群ID（缩短显示）
        chats.forEach(chat => {
            const nameElement = document.querySelector(`[data-user-id="${chat.chat_id}"]`);
            if (nameElement) {
                nameElement.textContent = `群聊 ${chat.chat_id.slice(0, 6)}***`;
            }
        });
    }
}

// 加载用户昵称
function loadNickname(userId) {
    // 获取token
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (!token) {
        console.error('未找到访问token');
        return;
    }
    
    fetch(`/web/api/message/get_nickname?token=${encodeURIComponent(token)}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            user_id: userId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const nameElement = document.querySelector(`[data-user-id="${userId}"]`);
            if (nameElement) {
                nameElement.textContent = data.data.nickname;
            }
        }
    })
    .catch(error => {
        console.error('加载昵称失败:', error);
    });
}

// 为聊天窗口头部加载用户昵称
function loadNicknameForHeader(userId) {
    // 获取token
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (!token) {
        console.error('未找到访问token');
        const nameElement = document.getElementById('current-chat-name');
        if (nameElement && currentChatId === userId) {
            nameElement.textContent = `用户 ${userId.slice(-6)}`;
        }
        return;
    }
    
    fetch(`/web/api/message/get_nickname?token=${encodeURIComponent(token)}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            user_id: userId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const nameElement = document.getElementById('current-chat-name');
            if (nameElement && currentChatId === userId) {
                nameElement.textContent = data.data.nickname;
            }
        }
    })
    .catch(error => {
        console.error('加载昵称失败:', error);
        const nameElement = document.getElementById('current-chat-name');
        if (nameElement && currentChatId === userId) {
            nameElement.textContent = `用户 ${userId.slice(-6)}`;
        }
    });
}

// 为聊天记录中的消息加载用户昵称
function loadNicknameForMessage(userId) {
    // 获取token
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (!token) {
        console.error('未找到访问token');
        return;
    }
    
    fetch(`/web/api/message/get_nickname?token=${encodeURIComponent(token)}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            user_id: userId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 更新聊天记录中该用户的所有昵称显示
            const nicknameElements = document.querySelectorAll(`[data-nickname-user-id="${userId}"]`);
            nicknameElements.forEach(element => {
                element.textContent = data.data.nickname;
            });
        }
    })
    .catch(error => {
        console.error('加载消息昵称失败:', error);
    });
}

// 渲染分页
function renderPagination(page, totalPages) {
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // 上一页
    html += `<li class="page-item ${page <= 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${page - 1})">上一页</a>
    </li>`;
    
    // 页码
    for (let i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++) {
        html += `<li class="page-item ${i === page ? 'active' : ''}">
            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
        </li>`;
    }
    
    // 下一页
    html += `<li class="page-item ${page >= totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${page + 1})">下一页</a>
    </li>`;
    
    pagination.innerHTML = html;
}

// 切换页面
function changePage(page) {
    if (page < 1 || page > totalPages) return;
    messagePage = page;
    loadChatList();
}

// 选择聊天
function selectChat(chatId, chatType) {
    currentChatId = chatId;
    
    // 更新选中状态
    document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    // 更新聊天窗口头部
    updateChatHeader(chatId, chatType);
    
    // 加载聊天记录
    loadChatHistory(chatId, chatType);
    
    // 显示发送区域
    document.getElementById('send-area').style.display = 'block';
    
    // 更新ID状态
    updateIdStatus(chatType);
}

// 更新聊天窗口头部
function updateChatHeader(chatId, chatType) {
    const avatarElement = document.getElementById('current-chat-avatar');
    const nameElement = document.getElementById('current-chat-name');
    const infoElement = document.getElementById('current-chat-info');
    
    if (chatType === 'user') {
        avatarElement.innerHTML = `<img src="https://q.qlogo.cn/qqapp/{{ appid }}/${chatId}/100" class="chat-avatar" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"><div class="chat-avatar-placeholder" style="display: none;">${chatId.slice(-2).toUpperCase()}</div>`;
        nameElement.textContent = 'Loading...';
        infoElement.textContent = `用户 ID: ${chatId}`;
        
        // 异步加载昵称到聊天窗口头部
        loadNicknameForHeader(chatId);
    } else {
        avatarElement.innerHTML = `<div class="chat-avatar-placeholder">${chatId[0].toUpperCase()}</div>`;
        nameElement.textContent = `群聊 ${chatId}`;
        infoElement.textContent = `群聊 ID: ${chatId}`;
    }
}

// 更新ID状态信息
function updateIdStatus(chatType) {
    const expireInfo = document.getElementById('id-expire-info');
            const expireTime = chatType === 'group' ? '5分钟' : '1小时';
    expireInfo.textContent = `ID有效期：${expireTime}，超时后无法发送消息`;
}

// 加载聊天记录
function loadChatHistory(chatId, chatType) {
    const messageArea = document.getElementById('message-area');
    messageArea.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">加载中...</span></div></div>';
    
    // 获取token
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (!token) {
        messageArea.innerHTML = '<div class="text-center p-3 text-danger">未找到访问token</div>';
        return;
    }
    
    fetch(`/web/api/message/get_chat_history?token=${encodeURIComponent(token)}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            chat_type: chatType,
            chat_id: chatId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderChatHistory(data.data.messages);
        } else {
            messageArea.innerHTML = '<div class="text-center p-3 text-danger">加载聊天记录失败: ' + data.message + '</div>';
        }
    })
    .catch(error => {
        messageArea.innerHTML = '<div class="text-center p-3 text-danger">网络错误</div>';
        console.error('Error:', error);
    });
}

// 渲染聊天记录
function renderChatHistory(messages) {
    const messageArea = document.getElementById('message-area');
    
    if (messages.length === 0) {
        messageArea.innerHTML = '<div class="text-center text-muted"><i class="bi bi-chat-text" style="font-size: 3rem;"></i><p class="mt-2">暂无聊天记录</p></div>';
        return;
    }
    
    const html = messages.map(msg => {
        const isSelf = msg.is_self;
        const avatarHtml = `<img src="${msg.avatar}" class="chat-avatar me-2" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"><div class="chat-avatar-placeholder me-2" style="display: none;">${msg.user_id.slice(-2).toUpperCase()}</div>`;
        
        return `
            <div class="message-bubble ${isSelf ? 'self' : 'other'}">
                <div class="d-flex ${isSelf ? 'justify-content-end' : ''}">
                    ${!isSelf ? avatarHtml : ''}
                    <div class="message-content">
                        ${!isSelf && currentChatType === 'group' ? `<div class="small text-primary mb-1" data-nickname-user-id="${msg.user_id}">用户${msg.user_id.slice(-6)}</div>` : ''}
                        ${msg.content}
                        <div class="small text-muted mt-1">${msg.timestamp}</div>
                    </div>
                    ${isSelf ? avatarHtml : ''}
                </div>
            </div>
        `;
    }).join('');
    
    messageArea.innerHTML = html;
    
    // 异步加载群聊中的用户昵称
    if (currentChatType === 'group') {
        const uniqueUsers = [...new Set(messages.filter(msg => !msg.is_self).map(msg => msg.user_id))];
        uniqueUsers.forEach(userId => {
            loadNicknameForMessage(userId);
        });
    }
    
    // 滚动到底部
    messageArea.scrollTop = messageArea.scrollHeight;
}

// 发送消息
function sendMessage() {
    if (!currentChatId) {
        alert('请先选择聊天对象');
        return;
    }
    
    const messageInput = document.getElementById('message-input');
    const content = messageInput.value.trim();
    
    if (!content) {
        alert('请输入消息内容');
        return;
    }
    
    const sendBtn = document.getElementById('send-btn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>发送中...';
    
    // 获取token
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (!token) {
        showAlert('未找到访问token', 'danger');
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="bi bi-send"></i> 发送';
        return;
    }
    
    fetch(`/web/api/message/send?token=${encodeURIComponent(token)}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            chat_type: currentChatType,
            chat_id: currentChatId,
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            // 添加消息到聊天记录
            appendMessage(content, true, data.data.timestamp);
            showAlert('消息发送成功', 'success');
        } else {
            showAlert('发送失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        showAlert('网络错误', 'danger');
        console.error('Error:', error);
    })
    .finally(() => {
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="bi bi-send"></i> 发送';
    });
}

// 添加消息到聊天记录
function appendMessage(content, isSelf, timestamp) {
    const messageArea = document.getElementById('message-area');
    
    const messageHtml = `
        <div class="message-bubble ${isSelf ? 'self' : 'other'}">
            <div class="d-flex ${isSelf ? 'justify-content-end' : ''}">
                <div class="message-content">
                    ${content}
                    <div class="small text-muted mt-1">${timestamp}</div>
                </div>
            </div>
        </div>
    `;
    
    messageArea.insertAdjacentHTML('beforeend', messageHtml);
    messageArea.scrollTop = messageArea.scrollHeight;
}

// 显示提示消息
function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // 在页面顶部显示提示
    const container = document.querySelector('.container-fluid');
    container.insertAdjacentHTML('afterbegin', alertHtml);
    
    // 3秒后自动关闭
    setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 3000);
}
</script>
{% endblock %}