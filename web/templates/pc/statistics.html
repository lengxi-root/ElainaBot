{% extends "pc/base.html" %}

{% block content %}
<!-- ç»Ÿè®¡é¡µé¢ -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="mb-0">æ•°æ®ç»Ÿè®¡</h5>
    <div class="d-flex gap-2">
        <button class="btn-control btn-warning" id="complete-dau">
            <i class="bi bi-plus-circle"></i> è¡¥å…¨DAU
        </button>
        <button class="btn-control" id="refresh-statistics">
            <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°æ•°æ®
        </button>
    </div>
</div>

<!-- ç»Ÿè®¡å›¾è¡¨ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">æ•°æ®è¶‹åŠ¿å›¾è¡¨ (æœ€è¿‘30å¤©)</h6>
                <div class="d-flex flex-wrap gap-2 mb-3">
                    <button class="btn btn-sm btn-outline-primary chart-toggle active" data-metric="messages_combined">æ¶ˆæ¯æ•°æ®</button>
                    <button class="btn btn-sm btn-outline-primary chart-toggle" data-metric="active_combined">æ´»è·ƒæ•°æ®</button>
                    <button class="btn btn-sm btn-outline-success chart-toggle" data-metric="total_combined">ç”¨æˆ·æ•°æ®</button>
                    <button class="btn btn-sm btn-outline-info chart-toggle" data-metric="group_events">ç¾¤ç»„å˜åŒ–</button>
                    <button class="btn btn-sm btn-outline-warning chart-toggle" data-metric="friend_events">å¥½å‹å˜åŒ–</button>
                </div>
                <div class="chart-container position-relative">
                    <div id="chart-average-display" class="chart-average-display"></div>
                    <canvas id="statisticsChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ—¥æœŸé€‰æ‹©å™¨ -->
<div class="row mb-3 date-selector-container">
    <div class="col-12">
        <div class="card">
            <div class="card-body" style="padding-bottom: 20px; position: relative; z-index: 100;">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                        <label for="date-selector" class="form-label mb-0">æŸ¥çœ‹æ—¥æœŸ:</label>
                        <select class="form-select date-selector-dropdown" id="date-selector" style="width: 200px;">
                            <option value="today">ä»Šæ—¥æ•°æ®</option>
                        </select>
                        <small class="text-muted">é€‰æ‹©è¦æŸ¥çœ‹çš„æ—¥æœŸæ•°æ®</small>
            </div>
                    <div id="data-source-info" class="data-source-info">
                        <span class="badge bg-secondary">
                            <i class="bi bi-hourglass-split"></i> åŠ è½½ä¸­...
                        </span>
        </div>
    </div>
            </div>
        </div>
    </div>
</div>

<!-- è¯¦ç»†æ•°æ®è¡¨æ ¼ -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title" id="stats-table-title">ä»Šæ—¥æ•°æ®æ¦‚è§ˆ</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <tbody id="today-stats-table">
                            <tr><td colspan="2" class="text-center text-muted">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- æŒ‡ä»¤ä½¿ç”¨æ’è¡Œæ”¾åœ¨ä»Šæ—¥æ•°æ®ä¸‹é¢ -->
                <hr class="my-3">
                <h6 class="card-title">æŒ‡ä»¤ä½¿ç”¨æ’è¡Œ</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>æŒ‡ä»¤</th>
                                <th>ä½¿ç”¨æ¬¡æ•°</th>
                            </tr>
                        </thead>
                        <tbody id="command-stats-table">
                            <tr><td colspan="2" class="text-center text-muted">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <!-- æœ€æ´»è·ƒç”¨æˆ·åœ¨ä¸Šæ–¹ -->
                <h6 class="card-title">æœ€æ´»è·ƒç”¨æˆ·</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ç”¨æˆ·ID</th>
                                <th>æ¶ˆæ¯æ•°</th>
                            </tr>
                        </thead>
                        <tbody id="top-users-table">
                            <tr><td colspan="2" class="text-center text-muted">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- æœ€æ´»è·ƒç¾¤ç»„åœ¨ä¸‹æ–¹ -->
                <hr class="my-3">
                <h6 class="card-title">æœ€æ´»è·ƒç¾¤ç»„</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ç¾¤ç»„ID</th>
                                <th>æ¶ˆæ¯æ•°</th>
                            </tr>
                        </thead>
                        <tbody id="top-groups-table">
                            <tr><td colspan="2" class="text-center text-muted">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_styles %}
<style>
.chart-container {
    height: 400px !important;
    position: relative;
}

.chart-average-display {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(255, 255, 255, 0.9);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    z-index: 10;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .chart-container {
        height: 300px !important;
    }
    
    .d-flex.flex-wrap.gap-2.mb-3 {
        gap: 0.5rem !important;
    }
    
    .btn-sm {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
let statisticsChart = null;
let statisticsData = null;

const averageDisplayPlugin = {
    id: 'averageDisplay',
    afterDraw: function(chart) {
        const options = chart.options.plugins.averageDisplay;
        if (!options || !options.display) return;
        
        const ctx = chart.ctx;
        const legend = chart.legend;
        
        if (!legend || !legend.legendItems || legend.legendItems.length === 0) return;
        
        ctx.save();
        ctx.font = 'normal 12px Arial';
        ctx.fillStyle = options.color || '#666';
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        
        const text = ` (${options.text})`;
        
        const legendItem = legend.legendItems[0];
        if (legendItem) {
            const labelWidth = ctx.measureText(legendItem.text).width;
            const x = legend.left + 35 + labelWidth;
            const y = legend.top + legend.height / 2;
            
            ctx.fillText(text, x, y);
        }
        
        ctx.restore();
    }
};

function debounce(func, delay) {
    let timeoutId;
    return function (...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
    };
}

function formatNumber(num) {
    if (num === null || num === undefined) return '0';
    if (typeof num === 'object') {
        num = num.value ?? num.count ?? 0;
    }
    const numValue = Number(num);
    if (isNaN(numValue)) return '0';
    if (numValue >= 10000) return (numValue / 10000).toFixed(2).replace(/\.?0+$/, '') + 'w';
    if (numValue >= 1000) return (numValue / 1000).toFixed(2).replace(/\.?0+$/, '') + 'k';
    return numValue.toString();
}

function getStatValue(data, path, defaultValue = 0) {
    return data?.[path.split('.')[0]]?.[path.split('.')[1]] || defaultValue;
}

function getStat(item, statType, field) {
    return item?.[statType]?.[field] || 0;
}

function extractDataArrays(data, fields, statType = 'message_stats') {
    const arrays = fields.map(() => []);
    
    if (data.historical && Array.isArray(data.historical)) {
        data.historical.forEach(item => {
            fields.forEach((field, i) => {
                const value = typeof field === 'function' ? field(item) : getStat(item, statType, field);
                arrays[i].push(value);
            });
        });
    }
    
    if (data.today) {
        fields.forEach((field, i) => {
            const value = typeof field === 'function' ? field(data.today) : getStat(data.today, statType, field);
            arrays[i].push(value);
        });
    }
    
    return arrays;
}

function createDataset(label, data, color, bgColor) {
    return {
        label,
        data,
        borderColor: color,
        backgroundColor: bgColor,
        tension: 0.4,
        fill: false,
        pointRadius: 4,
        pointHoverRadius: 6
    };
}

const EMPTY_TABLE_ROW = '<tr><td colspan="2" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';

function getToken() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('token');
}

function initStatistics() {
    const ctx = document.getElementById('statisticsChart');
    if (!ctx) return;
    
    statisticsChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'æ€»æ¶ˆæ¯é‡',
                data: [],
                borderColor: '#4361ee',
                backgroundColor: 'rgba(67, 97, 238, 0.15)',
                tension: 0.3,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
                    plugins: {
            legend: {
                display: true,
                position: 'top',
                align: 'start'
            },
            datalabels: {
                display: true,
                align: 'top',
                anchor: 'end',
                color: 'rgba(0, 0, 0, 0.6)',
                font: {
                    size: 10,
                    weight: 'normal'
                },
                formatter: function(value, context) {
                    return formatNumber(value);
                },
                padding: {
                    bottom: 4
                },
                clip: false
            },
            averageDisplay: {
                display: false
            }
        },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'æ—¥æœŸ'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'æ•°é‡'
                    },
                    beginAtZero: true
                }
            }
        },
        plugins: [ChartDataLabels, averageDisplayPlugin]
    });
}

function loadStatistics(forceRefresh = false) {
    const token = getToken();
    if (!token) {
        console.error('æœªæ‰¾åˆ°è®¿é—®token');
        return;
    }
    
    updateDataSourceInfo({
        data_source_info: {
            source: 'loading',
            update_time: 'åŠ è½½ä¸­...'
        }
    });
    
    let apiUrl = `/web/api/statistics?token=${encodeURIComponent(token)}&async=true`;
    if (forceRefresh) {
        apiUrl += '&force_refresh=true';
    }
    
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                if (data.task_id && data.status === 'started') {
                    pollTaskStatus(data.task_id, token);
                } else {
                    handleStatisticsData(data);
                }
            } else {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', data.error);
                showStatisticsError('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            console.error('è·å–ç»Ÿè®¡æ•°æ®æ—¶å‡ºé”™:', error);
            showStatisticsError('è·å–ç»Ÿè®¡æ•°æ®æ—¶å‡ºé”™: ' + error.message);
        });
}

function pollTaskStatus(taskId, token, maxAttempts = 60) {
    let attempts = 0;
    
    const checkStatus = () => {
        attempts++;
        if (attempts > maxAttempts) {
            showStatisticsError('ç»Ÿè®¡ä»»åŠ¡è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
            return;
        }
        
        fetch(`/web/api/statistics/task/${taskId}?token=${encodeURIComponent(token)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const taskData = data;
                    
                    if (taskData.progress !== undefined) {
                        updateDataSourceInfo({
                            data_source_info: {
                                source: 'processing',
                                update_time: `${taskData.message || 'å¤„ç†ä¸­'} (${taskData.progress}%)`
                            }
                        });
                    }
                    
                    if (taskData.status === 'completed') {
                        if (taskData.data) {
                            handleStatisticsData(taskData.data);
                        } else {
                            showStatisticsError('ç»Ÿè®¡ä»»åŠ¡å®Œæˆä½†æ— æ•°æ®è¿”å›');
                        }
                    } else if (taskData.status === 'failed') {
                        showStatisticsError('ç»Ÿè®¡ä»»åŠ¡å¤±è´¥: ' + (taskData.error || 'æœªçŸ¥é”™è¯¯'));
                    } else {
                        setTimeout(checkStatus, 1000);
                    }
                } else {
                    showStatisticsError('æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                console.error('æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å‡ºé”™:', error);
                showStatisticsError('æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å‡ºé”™: ' + error.message);
            });
    };
    
    setTimeout(checkStatus, 1000);
}

function handleStatisticsData(data) {
    statisticsData = data;
    
    if (data.data_source_info) {
        updateDataSourceInfo(data);
    }
    
    if (data.historical && data.today) {
        updateChart('messages_combined');
        updateTables(data.today || {});
    } else if (data.selected_date_data) {
        updateTables(data.selected_date_data);
    }
}

function updateChart(metric) {
    if (!statisticsChart || !statisticsData) return;
    
    const labels = [];
    const data = [];
    let total = 0;
    let count = 0;
    
    if (statisticsData.historical && Array.isArray(statisticsData.historical)) {
        statisticsData.historical.forEach(item => {
            const displayLabel = item.display_date || item.date || 'æœªçŸ¥';
            labels.push(displayLabel);
            
            let value = 0;
            switch(metric) {
                case 'total_messages':
                case 'active_users':
                case 'active_groups':
                case 'private_messages':
                    value = item.message_stats ? item.message_stats[metric] || 0 : 0;
                    break;
                case 'total_users':
                case 'total_groups':
                case 'total_friends':
                    value = item.user_stats ? item.user_stats[metric] || 0 : 0;
                    break;
                default:
                    value = 0;
            }
            
        data.push(value);
        total += value;
        count++;
    });
    }
    
    if (statisticsData.today) {
        labels.push('ä»Šæ—¥');
        
        let todayValue = 0;
        switch(metric) {
            case 'total_messages':
            case 'active_users':
            case 'active_groups':
            case 'private_messages':
                todayValue = statisticsData.today.message_stats ? statisticsData.today.message_stats[metric] || 0 : 0;
                break;
            case 'total_users':
            case 'total_groups':
            case 'total_friends':
                todayValue = statisticsData.today.user_stats ? statisticsData.today.user_stats[metric] || 0 : 0;
                break;
            default:
                todayValue = 0;
        }
        
        data.push(todayValue);
        total += todayValue;
        count++;
    }
    
    let datasets = [];
    
    if (metric === 'messages_combined') {
        const [totalMessagesData, privateMessagesData, groupMessagesData] = extractDataArrays(
            statisticsData,
            ['total_messages', 'private_messages', item => getStat(item, 'message_stats', 'total_messages') - getStat(item, 'message_stats', 'private_messages')]
        );
        
        datasets = [
            createDataset('æ€»æ¶ˆæ¯é‡', totalMessagesData, '#4361ee', 'rgba(67, 97, 238, 0.15)'),
            createDataset('ç§èŠæ¶ˆæ¯æ•°', privateMessagesData, '#7209b7', 'rgba(114, 9, 183, 0.15)'),
            createDataset('ç¾¤èŠæ¶ˆæ¯æ•°', groupMessagesData, '#f72585', 'rgba(247, 37, 133, 0.15)')
        ];
    } else if (metric === 'active_combined') {
        const [activeUsersData, activeGroupsData] = extractDataArrays(statisticsData, ['active_users', 'active_groups']);
        
        datasets = [
            createDataset('æ´»è·ƒç”¨æˆ·æ•°', activeUsersData, '#f72585', 'rgba(247, 37, 133, 0.15)'),
            createDataset('æ´»è·ƒç¾¤èŠæ•°', activeGroupsData, '#4cc9f0', 'rgba(76, 201, 240, 0.15)')
        ];
    } else if (metric === 'total_combined') {
        const [totalUsersData, totalGroupsData, totalFriendsData] = extractDataArrays(
            statisticsData, 
            ['total_users', 'total_groups', 'total_friends'], 
            'user_stats'
        );
        
        datasets = [
            createDataset('æ€»ç”¨æˆ·æ•°', totalUsersData, '#f77f00', 'rgba(247, 127, 0, 0.15)'),
            createDataset('æ€»ç¾¤ç»„æ•°', totalGroupsData, '#fcbf49', 'rgba(252, 191, 73, 0.15)'),
            createDataset('æ€»å¥½å‹æ•°', totalFriendsData, '#606c38', 'rgba(96, 108, 56, 0.15)')
        ];
    } else if (metric === 'group_events') {
        const [joinData, leaveData] = extractDataArrays(
            statisticsData, 
            ['group_join_count', 'group_leave_count'], 
            'event_stats'
        );
        
        datasets = [
            createDataset('è¿›ç¾¤æ•°', joinData, '#28a745', 'rgba(40, 167, 69, 0.15)'),
            createDataset('é€€ç¾¤æ•°', leaveData, '#dc3545', 'rgba(220, 53, 69, 0.15)')
        ];
    } else if (metric === 'friend_events') {
        const [addData, removeData] = extractDataArrays(
            statisticsData, 
            ['friend_add_count', 'friend_remove_count'], 
            'event_stats'
        );
        
        datasets = [
            createDataset('åŠ å¥½å‹æ•°', addData, '#17a2b8', 'rgba(23, 162, 184, 0.15)'),
            createDataset('åˆ å¥½å‹æ•°', removeData, '#ffc107', 'rgba(255, 193, 7, 0.15)')
        ];
    } else {
        const average = count > 0 ? (total / count) : 0;
        
        const metricInfo = {
            'total_messages': { label: 'æ€»æ¶ˆæ¯é‡', color: '#4361ee', bg: 'rgba(67, 97, 238, 0.15)' },
            'active_users': { label: 'æ´»è·ƒç”¨æˆ·æ•°', color: '#f72585', bg: 'rgba(247, 37, 133, 0.15)' },
            'active_groups': { label: 'æ´»è·ƒç¾¤èŠæ•°', color: '#4cc9f0', bg: 'rgba(76, 201, 240, 0.15)' },
            'private_messages': { label: 'ç§èŠæ¶ˆæ¯æ•°', color: '#7209b7', bg: 'rgba(114, 9, 183, 0.15)' },
            'total_users': { label: 'æ€»ç”¨æˆ·æ•°', color: '#f77f00', bg: 'rgba(247, 127, 0, 0.15)' },
            'total_groups': { label: 'æ€»ç¾¤ç»„æ•°', color: '#fcbf49', bg: 'rgba(252, 191, 73, 0.15)' },
            'total_friends': { label: 'æ€»å¥½å‹æ•°', color: '#606c38', bg: 'rgba(96, 108, 56, 0.15)' }
        };
        
        const info = metricInfo[metric] || metricInfo['total_messages'];
        datasets = [createDataset(info.label, data, info.color, info.bg)];
        
        const averageElement = document.getElementById('chart-average-display');
        if (averageElement && count > 0) {
            averageElement.textContent = `30å¤©å¹³å‡: ${formatNumber(Math.round(average))}`;
            averageElement.style.color = info.color;
            averageElement.style.display = 'block';
        }
    }
    
    statisticsChart.data.labels = labels;
    statisticsChart.data.datasets = datasets;
    
    if (metric === 'messages_combined' || metric === 'active_combined' || metric === 'total_combined' || 
        metric === 'group_events' || metric === 'friend_events') {
        const averageElement = document.getElementById('chart-average-display');
        if (averageElement) {
            averageElement.style.display = 'none';
        }
    }
    
    statisticsChart.update();
    updateButtonState(metric);
}

function updateDataSourceInfo(data) {
    const infoElement = document.getElementById('data-source-info');
    if (!infoElement || !data.data_source_info) return;
    
    const sourceMap = {
        loading: { badge: 'bg-warning', icon: 'hourglass-split', text: 'åŠ è½½ä¸­' },
        processing: { badge: 'bg-info', icon: 'gear-fill', text: 'è®¡ç®—ä¸­' },
        api: { badge: 'bg-success', icon: 'cloud-check', text: 'å®æ—¶æ•°æ®' },
        cache: { badge: 'bg-info', icon: 'clock-history', text: 'ç¼“å­˜æ•°æ®' }
    };
    
    const sourceInfo = data.data_source_info;
    const { badge = 'bg-secondary', icon = 'hourglass-split', text = 'æœªçŸ¥' } = sourceMap[sourceInfo.source] || {};
    
    infoElement.innerHTML = `
        <span class="badge ${badge}">
            <i class="bi bi-${icon}"></i> ${text}
        </span>
        <small>${sourceInfo.update_time || ''}</small>
    `;
}

function populateDateSelector(dates) {
    const selector = document.getElementById('date-selector');
    selector.innerHTML = '';
    
    dates.forEach(dateItem => {
        const option = document.createElement('option');
        option.value = dateItem.value;
        option.textContent = dateItem.display;
        if (dateItem.is_today) {
            option.selected = true;
        }
        selector.appendChild(option);
    });
}

function loadAvailableDates() {
    const token = getToken();
    if (!token) return;
    
    fetch(`/web/api/available_dates?token=${encodeURIComponent(token)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.dates) {
                populateDateSelector(data.dates);
            }
        })
        .catch(error => {
            console.error('Error loading available dates:', error);
        });
}

function loadDateData(date) {
    loadDateSpecificData(date);
}

function updateTodayStats(data) {
    const table = document.getElementById('today-stats-table');
    if (!data) {
        table.innerHTML = '<tr><td colspan="2" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    const statsItems = [
        { label: 'æ€»æ¶ˆæ¯é‡', value: data.total_messages || 0 },
        { label: 'æ´»è·ƒç”¨æˆ·æ•°', value: data.active_users || 0 },
        { label: 'æ´»è·ƒç¾¤èŠæ•°', value: data.active_groups || 0 },
        { label: 'ç§èŠæ¶ˆæ¯æ•°', value: data.private_messages || 0 },
        { label: 'ç¾¤èŠæ¶ˆæ¯æ•°', value: data.group_messages || 0 },
        { label: 'æ€»ç”¨æˆ·æ•°', value: data.total_users || 0 },
        { label: 'æ€»ç¾¤ç»„æ•°', value: data.total_groups || 0 },
        { label: 'æ€»å¥½å‹æ•°', value: data.total_friends || 0 }
    ];
    
    table.innerHTML = statsItems.map(item => 
        `<tr><td>${item.label}</td><td class="fw-bold">${formatNumber(item.value)}</td></tr>`
    ).join('');
}

function updateTable(tableId, items, rowMapper) {
    const table = document.getElementById(tableId);
    if (!items || items.length === 0) {
        table.innerHTML = EMPTY_TABLE_ROW;
        return;
    }
    table.innerHTML = items.map(rowMapper).join('');
}

function updateTopUsers(users) {
    updateTable('top-users-table', users, user => 
        `<tr><td>${user.user_id}</td><td class="fw-bold">${formatNumber(user.message_count)}</td></tr>`
    );
}

function updateTopGroups(groups) {
    updateTable('top-groups-table', groups, group => 
        `<tr><td>${group.group_id}</td><td class="fw-bold">${formatNumber(group.message_count)}</td></tr>`
    );
}

function updateCommandStats(commands) {
    updateTable('command-stats-table', commands, cmd => 
        `<tr><td>${cmd.command}</td><td class="fw-bold">${formatNumber(cmd.count)}</td></tr>`
    );
}

function completeDau() {
    const token = getToken();
    if (!token) return;
    
    const button = document.getElementById('complete-dau');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> å¤„ç†ä¸­...';
    button.disabled = true;
    
    fetch(`/web/api/complete_dau?token=${encodeURIComponent(token)}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('DAUè¡¥å…¨æˆåŠŸï¼');
                loadStatistics();
            } else {
                alert('DAUè¡¥å…¨å¤±è´¥ï¼š' + data.message);
            }
        })
        .catch(error => {
            console.error('Error completing DAU:', error);
            alert('DAUè¡¥å…¨å¤±è´¥');
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
}

function showStatisticsError(message) {
    const container = document.getElementById('statistics-container');
    if (container) {
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> ${message}
            </div>
        `;
    }
}

function updateButtonState(metric) {
    document.querySelectorAll('.chart-toggle').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.metric === metric) {
            btn.classList.add('active');
        }
    });
}

function updateTables(todayData) {
    const todayStatsTable = document.getElementById('today-stats-table');
    const messageStats = todayData.message_stats || {};
    const userStats = todayData.user_stats || {};
    
    const dataSourceInfoElement = document.getElementById('data-source-info');
    if (dataSourceInfoElement) {
        let sourceHtml = '';
        if (todayData.is_historical) {
            sourceHtml = `<span class="badge bg-info">
                <i class="bi bi-folder"></i> æœ¬åœ°æ–‡ä»¶
            </span>`;
            if (todayData.generated_at) {
                try {
                    const genTime = new Date(todayData.generated_at);
                    const timeStr = genTime.toLocaleString('zh-CN', { 
                        month: '2-digit', 
                        day: '2-digit', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    sourceHtml += `<br><small class="text-muted">
                        <i class="bi bi-clock"></i> ${timeStr}
                    </small>`;
                } catch (e) {
                    // æ—¶é—´è§£æå¤±è´¥ï¼Œå¿½ç•¥
                }
            }
        } else if (todayData.is_realtime) {
            sourceHtml = `<span class="badge bg-warning text-dark">
                <i class="bi bi-database"></i> å®æ—¶æŸ¥è¯¢
            </span>`;
        } else {
            sourceHtml = `<span class="badge bg-success">
                <i class="bi bi-folder"></i> æœ¬åœ°æ–‡ä»¶
            </span>`;
        }
        dataSourceInfoElement.innerHTML = sourceHtml;
    }

    if (todayStatsTable) {
        const eventStats = todayData.event_stats || {};
        todayStatsTable.innerHTML = `
            <tr><td>æ€»æ¶ˆæ¯é‡</td><td>${messageStats.total_messages || 0}</td></tr>
            <tr><td>æ´»è·ƒç”¨æˆ·æ•°</td><td>${messageStats.active_users || 0}</td></tr>
            <tr><td>æ´»è·ƒç¾¤èŠæ•°</td><td>${messageStats.active_groups || 0}</td></tr>
            <tr><td>ç§èŠæ¶ˆæ¯æ•°</td><td>${messageStats.private_messages || 0}</td></tr>
            <tr><td>æœ€æ´»è·ƒæ—¶æ®µ</td><td>${messageStats.peak_hour || 0}ç‚¹ (${messageStats.peak_hour_count || 0}æ¡)</td></tr>
            <tr><td>æ€»ç”¨æˆ·æ•°</td><td>${userStats.total_users || 0}</td></tr>
            <tr><td>æ€»ç¾¤ç»„æ•°</td><td>${userStats.total_groups || 0}</td></tr>
            <tr><td>æ€»å¥½å‹æ•°</td><td>${userStats.total_friends || 0}</td></tr>
            <tr><td colspan="2" style="font-weight: bold; background-color: #f8f9fa;">äº‹ä»¶ç»Ÿè®¡</td></tr>
            <tr><td>è¿›ç¾¤æ•°</td><td>${eventStats.group_join_count || 0}</td></tr>
            <tr><td>é€€ç¾¤æ•°</td><td>${eventStats.group_leave_count || 0}</td></tr>
            <tr><td>ç¾¤ç»„å‡€å¢é‡</td><td>${(eventStats.group_join_count || 0) - (eventStats.group_leave_count || 0)}</td></tr>
            <tr><td>åŠ å¥½å‹æ•°</td><td>${eventStats.friend_add_count || 0}</td></tr>
            <tr><td>åˆ å¥½å‹æ•°</td><td>${eventStats.friend_remove_count || 0}</td></tr>
            <tr><td>å¥½å‹å‡€å¢é‡</td><td>${(eventStats.friend_add_count || 0) - (eventStats.friend_remove_count || 0)}</td></tr>
        `;
    }
    
    const topGroups = messageStats.top_groups || [];
    updateTable('top-groups-table', topGroups.slice(0, 5), group => 
        `<tr><td>${maskId(group.group_id)}</td><td>${group.message_count}</td></tr>`
    );
    
    const topUsers = messageStats.top_users || [];
    if (topUsers.length > 0) {
        updateTable('top-users-table', topUsers.slice(0, 5), user => 
            `<tr><td><span class="user-id-with-nickname" data-user-id="${user.user_id}">${maskId(user.user_id)} <span class="nickname-loading">ğŸ“</span></span></td><td>${user.message_count}</td></tr>`
        );
        loadNicknamesForUsers(topUsers.slice(0, 5));
    } else {
        document.getElementById('top-users-table').innerHTML = EMPTY_TABLE_ROW;
    }
    
    const commandStats = todayData.command_stats || [];
    updateTable('command-stats-table', commandStats.slice(0, 5), cmd => 
        `<tr><td>${cmd.command}</td><td>${cmd.count}</td></tr>`
    );
}

function maskId(id) {
    if (!id || typeof id !== 'string') return 'æœªçŸ¥';
    if (id.length <= 6) return id;
    return id.substring(0, 3) + '***' + id.substring(id.length - 3);
}

const nicknameCache = new Map();

function loadNicknamesForUsers(users) {
    users.forEach(user => {
        if (user.user_id && !nicknameCache.has(user.user_id)) {
            fetchUserNickname(user.user_id);
        } else if (nicknameCache.has(user.user_id)) {
            updateUserNickname(user.user_id, nicknameCache.get(user.user_id));
        }
    });
}

function fetchUserNickname(userId) {
    const token = getToken();
    if (!token) return;
    
    fetch(`/web/api/get_nickname/${encodeURIComponent(userId)}?token=${encodeURIComponent(token)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.nickname) {
                nicknameCache.set(userId, data.nickname);
                updateUserNickname(userId, data.nickname);
            }
        })
        .catch(error => {
            console.error('è·å–æ˜µç§°å¤±è´¥:', error);
        });
}

function updateUserNickname(userId, nickname) {
    const elements = document.querySelectorAll(`[data-user-id="${userId}"]`);
    elements.forEach(element => {
        const loadingEl = element.querySelector('.nickname-loading');
        if (loadingEl) {
            loadingEl.textContent = `(${nickname})`;
            loadingEl.classList.remove('nickname-loading');
            loadingEl.classList.add('nickname-display');
        }
    });
}

function loadDateSpecificData(selectedDate) {
    if (selectedDate === 'today') {
        loadStatisticsData();
    } else {
        loadHistoricalDateData(selectedDate);
    }
}

function loadStatisticsData(forceRefresh = false) {
    loadStatistics(forceRefresh);
}

function loadHistoricalDateData(dateStr) {
    const token = getToken();
    if (!token) {
        console.error('æœªæ‰¾åˆ°è®¿é—®token');
        return;
    }
    
    updateDataSourceInfo({
        data_source_info: {
            source: 'loading',
            update_time: 'åŠ è½½å†å²æ•°æ®...'
        }
    });
    
    const apiUrl = `/web/api/statistics?token=${encodeURIComponent(token)}&date=${dateStr}&async=false`;
    
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                if (data.selected_date_data) {
                    updateTables(data.selected_date_data);
                } else {
                    showStatisticsError('è¯¥æ—¥æœŸæ²¡æœ‰å¯ç”¨æ•°æ®');
                }
            } else {
                console.error('åŠ è½½å†å²æ•°æ®å¤±è´¥:', data.error);
                showStatisticsError('åŠ è½½å†å²æ•°æ®å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            console.error('è·å–å†å²æ•°æ®æ—¶å‡ºé”™:', error);
            showStatisticsError('è·å–å†å²æ•°æ®æ—¶å‡ºé”™: ' + error.message);
        });
}

document.addEventListener('DOMContentLoaded', function() {
    const initTasks = [
        { fn: initStatistics, delay: 50 },
        { fn: loadStatistics, delay: 100 },
        { fn: loadAvailableDates, delay: 150 }
    ];
    
    const events = [
        { selector: '.chart-toggle', event: 'click', handler: (e) => updateChart(e.target.dataset.metric), debounce: 200 },
        { selector: '#refresh-statistics', event: 'click', handler: () => {
            loadStatistics();
            loadDateSpecificData(document.getElementById('date-selector').value);
        }, debounce: 1000 },
        { selector: '#complete-dau', event: 'click', handler: completeDau, debounce: 500 },
        { selector: '#date-selector', event: 'change', handler: (e) => loadDateSpecificData(e.target.value), debounce: 300 }
    ];
    
    events.forEach(({ selector, event, handler, debounce: delay }) => {
        const debouncedHandler = delay ? debounce(handler, delay) : handler;
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => el.addEventListener(event, debouncedHandler));
    });
    
    const initAsync = () => initTasks.forEach(({ fn, delay }) => setTimeout(fn, delay));
    
    ('requestIdleCallback' in window) 
        ? requestIdleCallback(initAsync, { timeout: 300 })
        : setTimeout(initAsync, 100);
});
</script>
{% endblock %}