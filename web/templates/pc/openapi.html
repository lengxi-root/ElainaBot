{% extends "pc/base.html" %}

{% block content %}
<style>
/* æ¨¡æ€æ¡†ç¦ç”¨åŠ¨ç”» */
.modal, .modal.fade, .modal-backdrop, .modal-backdrop.fade { transition: none !important; animation: none !important; transform: none !important; }
.modal.fade { opacity: 1 !important; }
.modal-backdrop.fade { opacity: 0.5 !important; }
.modal.show .modal-dialog { transform: none !important; transition: none !important; }
.modal.show { display: block !important; position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; z-index: 1050 !important; overflow: auto !important; }
.modal-dialog { position: relative !important; margin: 50px auto !important; max-width: 500px !important; transform: none !important; }
#deleteIpQrModal, #deleteIpQrModal * { -webkit-transform: none !important; -moz-transform: none !important; -ms-transform: none !important; -o-transform: none !important; transition: none !important; animation: none !important; }
.modal-backdrop { position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background-color: rgba(0, 0, 0, 0.5) !important; z-index: 1040 !important; }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="mb-0">å¼€æ”¾å¹³å°ç®¡ç†</h5>
    <small class="text-muted">ç®¡ç†QQå¼€å‘è€…å¹³å°çš„æœºå™¨äººæ•°æ®</small>
</div>

<!-- ç™»å½•çŠ¶æ€å¡ç‰‡ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card" id="openapi-login-card">
            <div class="card-body">
                <div id="openapi-not-logged-in" class="text-center">
                    <h6 class="card-title"><i class="bi bi-shield-lock"></i> å¼€æ”¾å¹³å°ç™»å½•</h6>
                    <p class="text-muted mb-3">è¯·å…ˆç™»å½•QQå¼€å‘è€…å¹³å°ä»¥æŸ¥çœ‹å’Œç®¡ç†æœºå™¨äººæ•°æ®</p>
                    <button class="btn btn-primary" id="openapi-start-login"><i class="bi bi-qr-code"></i> å¼€å§‹ç™»å½•</button>
                    <div id="openapi-login-progress" class="mt-3" style="display: none;">
                        <div class="d-flex flex-column align-items-center">
                            <div id="openapi-login-loading" class="mb-3">
                                <div class="spinner-border text-primary mb-2" role="status"><span class="visually-hidden">ç”ŸæˆäºŒç»´ç ä¸­...</span></div>
                                <p class="text-muted mb-2">æ­£åœ¨ç”Ÿæˆç™»å½•äºŒç»´ç ...</p>
        </div>
                            <div id="openapi-qr-container" style="display: none;">
                                <div class="card" style="max-width: 300px;">
                                    <div class="card-header text-center"><h6 class="mb-0"><i class="bi bi-qr-code"></i> æ‰«æäºŒç»´ç ç™»å½•</h6></div>
            <div class="card-body text-center">
                                        <img id="openapi-qr-image" src="" alt="ç™»å½•äºŒç»´ç " class="img-fluid mb-3" style="max-width: 200px; border: 1px solid #ddd; border-radius: 8px;">
                                        <p class="text-muted small mb-2">è¯·ä½¿ç”¨æ‰‹æœºQQæ‰«æä¸Šæ–¹äºŒç»´ç </p>
                                        <button class="btn btn-outline-secondary btn-sm" id="openapi-login-url" target="_blank"><i class="bi bi-box-arrow-up-right"></i> æˆ–ç‚¹å‡»æ‰“å¼€ç™»å½•é¡µé¢</button>
            </div>
                    </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="openapi-logged-in" style="display: none;">
                    <div class="row align-items-center">
                        <div class="col">
                            <h6 class="card-title mb-1"><i class="bi bi-person-check text-success"></i> å·²ç™»å½•å¼€æ”¾å¹³å°</h6>
                            <div class="d-flex flex-wrap gap-3"><span class="badge bg-primary"><i class="bi bi-hash"></i> UIN: <span id="openapi-uin">-</span></span></div>
                            </div>
                        <div class="col-auto"><button class="btn btn-outline-danger btn-sm" id="openapi-logout"><i class="bi bi-box-arrow-right"></i> é‡æ–°ç™»å½•</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
<!-- æœºå™¨äººåˆ—è¡¨ -->
<div class="row" id="openapi-main-content" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-robot"></i> æœºå™¨äººåˆ—è¡¨</h6>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-info btn-sm" id="openapi-get-notifications"><i class="bi bi-bell"></i> æŸ¥çœ‹é€šçŸ¥æ¶ˆæ¯</button>
                    <button class="btn btn-outline-primary btn-sm" id="openapi-refresh-botlist"><i class="bi bi-arrow-clockwise"></i> åˆ·æ–°</button>
                </div>
            </div>
            <div class="card-body">
                <div id="openapi-botlist-loading" class="text-center">
                    <div class="spinner-border text-primary" role="status"><span class="visually-hidden">åŠ è½½ä¸­...</span></div>
                    <p class="text-muted mt-2">æ­£åœ¨è·å–æœºå™¨äººåˆ—è¡¨...</p>
                </div>
                <div id="openapi-botlist-container" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead><tr><th style="width: 35%;">æœºå™¨äººåç§°</th><th style="width: 30%;">AppID</th><th style="width: 35%;">æ“ä½œ</th></tr></thead>
                            <tbody id="openapi-botlist-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
<div class="row mt-4" id="openapi-data-section" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0" id="openapi-data-title"><i class="bi bi-table"></i> æ•°æ®è¯¦æƒ…</h6>
                <div class="d-flex gap-2">
                    <span class="badge bg-primary">30å¤©æ•°æ®</span>
                    <button class="btn btn-outline-secondary btn-sm" id="openapi-close-data"><i class="bi bi-x-lg"></i> å…³é—­</button>
                </div>
            </div>
            <div class="card-body">
                <div id="openapi-data-loading" class="text-center">
                    <div class="spinner-border text-primary" role="status"><span class="visually-hidden">åŠ è½½ä¸­...</span></div>
                    <p class="text-muted mt-2">æ­£åœ¨è·å–æ•°æ®...</p>
                </div>
                
                <div id="openapi-data-summary" style="display: none;">
                    <span id="openapi-data-appid" style="display: none;">-</span>
                    <span id="openapi-data-avg-dau" style="display: none;">-</span>
                </div>
                
                <!-- æ•°æ®è¡¨æ ¼ -->
                <div id="openapi-data-table-container" style="display: none;">
                        <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr><th>æ—¥æœŸ</th><th>ä¸Šè¡Œæ¶ˆæ¯</th><th>æ´»è·ƒç”¨æˆ·</th><th>ä¸‹è¡Œæ¶ˆæ¯</th><th>æ€»æ¶ˆæ¯</th><th>ç¾¤ç»„(æ–°å¢/ç°æœ‰)</th><th>å¥½å‹(æ–°å¢/ç°æœ‰)</th></tr>
                                <tr class="table-info"><td colspan="7" class="text-center"><strong>å¹³å‡DAU: <span id="openapi-avg-dau-display">-</span></strong></td></tr>
                                </thead>
                            <tbody id="openapi-data-table"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- é€šçŸ¥æ¶ˆæ¯è¡¨æ ¼ -->
                <div id="openapi-notifications-container" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark"><tr><th style="width: 15%;">æ—¶é—´</th><th style="width: 20%;">æ ‡é¢˜</th><th style="width: 65%;">å†…å®¹</th></tr></thead>
                            <tbody id="openapi-notifications-table"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- ç™½åå•è¡¨æ ¼ -->
                <div id="openapi-whitelist-container" style="display: none;">
                    <div class="mb-3 d-flex gap-2">
                        <button class="btn btn-outline-success btn-sm" onclick="addNewIpInput()"><i class="bi bi-plus-lg"></i> æ·»åŠ IPè¾“å…¥æ¡†</button>
                        <button class="btn btn-success btn-sm" id="batch-add-ips-btn" onclick="batchAddIps()" style="display: none;"><i class="bi bi-shield-check"></i> æ‰¹é‡æ·»åŠ IP (éœ€è¦æˆæƒ)</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearAllInputs()"><i class="bi bi-x-lg"></i> æ¸…ç©ºè¾“å…¥</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark"><tr><th style="width: 70%;">IPåœ°å€</th><th style="width: 30%;">æ“ä½œ</th></tr></thead>
                            <tbody id="openapi-whitelist-table"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- æ¨¡æ¿åˆ—è¡¨ -->
                <div id="openapi-templates-container" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3" id="template-list-title"><i class="bi bi-layout-text-sidebar-reverse"></i> æ¨¡æ¿åˆ—è¡¨</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark"><tr><th style="width: 40%;">æ¨¡æ¿åç§°</th><th style="width: 25%;">ç±»å‹</th><th style="width: 20%;">çŠ¶æ€</th><th style="width: 15%;">æ“ä½œ</th></tr></thead>
                                    <tbody id="openapi-templates-table"></tbody>
                            </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="openapi-template-detail" style="display: none;">
                                <h6 class="mb-3"><i class="bi bi-info-circle"></i> æ¨¡æ¿è¯¦æƒ… <span class="badge bg-primary ms-2" id="template-detail-index">1/1</span></h6>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="mb-3"><div class="row"><div class="col-sm-3"><strong>æ¨¡æ¿ID:</strong></div><div class="col-sm-9" id="template-detail-id">-</div></div></div>
                                        <div class="mb-3"><div class="row"><div class="col-sm-3"><strong>åç§°:</strong></div><div class="col-sm-9" id="template-detail-name">-</div></div></div>
                                        <div class="mb-3"><div class="row"><div class="col-sm-3"><strong>ç±»å‹:</strong></div><div class="col-sm-9" id="template-detail-type">-</div></div></div>
                                        <div class="mb-3"><div class="row"><div class="col-sm-3"><strong>çŠ¶æ€:</strong></div><div class="col-sm-9" id="template-detail-status">-</div></div></div>
                                        <div class="mb-3"><div class="row"><div class="col-sm-3"><strong>åˆ›å»ºæ—¶é—´:</strong></div><div class="col-sm-9" id="template-detail-create-time">-</div></div></div>
                                        <div class="mb-3"><strong>æ¨¡æ¿å†…å®¹:</strong><div class="mt-2"><pre class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto; font-size: 12px;" id="template-detail-content">-</pre></div></div>
                                        <div id="template-button-preview" style="display: none;">
                                            <strong>æŒ‰é’®é¢„è§ˆ:</strong>
                                            <div class="mt-2 p-3 bg-light rounded">
                                                <div id="template-button-rows"></div>
                                                <small class="text-muted mt-2 d-block"><i class="bi bi-info-circle"></i> æŒ‰é’®ä»…ä¾›å‚è€ƒï¼Œå®é™…æ•ˆæœä»¥å®é™…ä¸ºå‡†<br>ç±»å‹: 0=è·³è½¬é“¾æ¥, 1=å›è°ƒ, 2=å›è½¦å‘½ä»¤</small>
                                            </div>
                    </div>
                                        <div class="mt-3 d-flex justify-content-between">
                                            <button class="btn btn-outline-secondary btn-sm" id="template-prev-btn" style="display: none;"><i class="bi bi-chevron-left"></i> ä¸Šä¸€ä¸ª</button>
                                            <button class="btn btn-outline-secondary btn-sm" id="template-next-btn" style="display: none;">ä¸‹ä¸€ä¸ª <i class="bi bi-chevron-right"></i></button>
                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const $ = {
    get: id => document.getElementById(id),
    show: id => { const el = document.getElementById(id); if (el) el.style.display = 'block'; },
    hide: id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; },
    setText: (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; },
    setHtml: (id, html) => { const el = document.getElementById(id); if (el) el.innerHTML = html; },
    toggleVisibility: (showIds, hideIds) => { showIds.forEach(id => $.show(id)); hideIds.forEach(id => $.hide(id)); }
};

const API = {
    async request(endpoint, data = {}) {
        return fetch(`/web/openapi${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: 'web_user', ...data })
        }).then(r => r.json());
    },
    handleError(data, defaultMsg = 'æ“ä½œå¤±è´¥') {
        if (data.message && data.message.includes('ç™»å½•çŠ¶æ€å¤±æ•ˆ')) showNotLoggedInState();
        return data.message || defaultMsg;
    }
};

const DataArea = {
    show(title) { $.toggleVisibility(['openapi-data-section', 'openapi-data-loading'], []); $.setHtml('openapi-data-title', title); this.hideAllContainers(); },
    hideAllContainers() {
        $.toggleVisibility([], ['openapi-data-table-container', 'openapi-notifications-container', 'openapi-whitelist-container', 'openapi-templates-container']);
        const td = $.get('openapi-template-detail'); if (td) td.style.display = 'none';
    },
    showContainer(type) { $.hide('openapi-data-loading'); $.show(`openapi-${type}-container`); }
};

const IPValidator = {
    isValid(ip) {
        const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
        return ipRegex.test(ip) && ip.split('.').every(p => parseInt(p) <= 255);
    },
    getValidIps() {
        const inputs = document.querySelectorAll('.new-ip-input');
        const validIps = [], invalidIps = [];
        inputs.forEach(input => {
            const ip = input.value.trim();
            if (!ip) return;
            if (this.isValid(ip) && !existingIpList.includes(ip) && !validIps.includes(ip)) validIps.push(ip);
            else if (!this.isValid(ip)) invalidIps.push(ip);
        });
        return { validIps, invalidIps };
    }
};

let openApiLoginCheckInterval = null, currentTemplates = [], currentTemplateIndex = 0;
let currentWhitelistAppId = '', currentWhitelistAppName = '', existingIpList = [], newIpInputCount = 0;
let deleteIpData = { ip: '', qrcode: '', authCheckInterval: null, batchIpList: [] };
let customModal = { element: null, isVisible: false };

function initOpenAPI() {
    checkOpenAPILoginStatus();
    $.get('openapi-start-login').addEventListener('click', startOpenAPILogin);
    $.get('openapi-logout').addEventListener('click', logoutOpenAPI);
    $.get('openapi-refresh-botlist').addEventListener('click', refreshBotList);
    $.get('openapi-get-notifications').addEventListener('click', getNotifications);
    $.get('openapi-close-data').addEventListener('click', closeDataSection);
}

async function checkOpenAPILoginStatus() {
    try {
        const data = await API.request('/get_login_status');
        if (data.success && data.logged_in) { showLoggedInState(data); loadBotList(); }
        else showNotLoggedInState();
    } catch (error) {
        console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
        showNotLoggedInState();
    }
}

function showLoggedInState(data) {
    $.toggleVisibility(['openapi-logged-in', 'openapi-main-content'], ['openapi-not-logged-in']);
    if (data.uin) $.setText('openapi-uin', data.uin);
}

function showNotLoggedInState() {
    $.toggleVisibility(['openapi-not-logged-in'], ['openapi-logged-in', 'openapi-main-content', 'openapi-data-section']);
}

async function startOpenAPILogin() {
    $.toggleVisibility(['openapi-login-progress', 'openapi-login-loading'], ['openapi-qr-container']);
    try {
        const data = await API.request('/start_login');
        if (data.success) {
            generateQRCode(data.login_url);
            $.get('openapi-login-url').onclick = () => window.open(data.login_url, '_blank');
            startLoginStatusCheck();
        } else {
            alert('è·å–ç™»å½•äºŒç»´ç å¤±è´¥ï¼š' + data.message);
            $.hide('openapi-login-progress');
        }
    } catch (error) {
        console.error('å¼€å§‹ç™»å½•å¤±è´¥:', error);
        alert('å¼€å§‹ç™»å½•å¤±è´¥');
        $.hide('openapi-login-progress');
    }
}

function generateQRCode(loginUrl) {
    const qrImage = $.get('openapi-qr-image');
    const qrApiUrl = `https://api.2dcode.biz/v1/create-qr-code?data=${encodeURIComponent(loginUrl)}`;
    qrImage.onload = () => $.toggleVisibility(['openapi-qr-container'], ['openapi-login-loading']);
    qrImage.onerror = () => {
        $.setHtml('openapi-login-loading', '<div class="alert alert-warning text-center"><i class="bi bi-exclamation-triangle"></i> äºŒç»´ç ç”Ÿæˆå¤±è´¥<br><small class="text-muted">è¯·ä½¿ç”¨ä¸‹æ–¹æŒ‰é’®æ‰“å¼€ç™»å½•é¡µé¢</small></div>');
        $.show('openapi-qr-container');
    };
    qrImage.src = qrApiUrl;
}

function startLoginStatusCheck() {
    if (openApiLoginCheckInterval) clearInterval(openApiLoginCheckInterval);
    openApiLoginCheckInterval = setInterval(async () => {
        try {
            const data = await API.request('/check_login');
            console.log('ç™»å½•çŠ¶æ€æ£€æŸ¥ç»“æœ:', data);
            if (data.success && data.status === 'logged_in') {
                clearInterval(openApiLoginCheckInterval);
                $.hide('openapi-login-progress');
                showLoggedInState({ success: true, logged_in: true, uin: data.uin });
                loadBotList();
            } else if (data.status === 'not_started') {
                clearInterval(openApiLoginCheckInterval);
                $.hide('openapi-login-progress');
            }
        } catch (error) {
            console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
        }
    }, 2000);
}

function logoutOpenAPI() {
    if (confirm('ç¡®å®šè¦é‡æ–°ç™»å½•å—ï¼Ÿ')) {
        API.request('/logout').then(() => {
            showNotLoggedInState();
            if (openApiLoginCheckInterval) clearInterval(openApiLoginCheckInterval);
        }).catch(error => console.error('é€€å‡ºç™»å½•å¤±è´¥:', error));
    }
}

async function loadBotList() {
    $.toggleVisibility(['openapi-botlist-loading'], ['openapi-botlist-container']);
    try {
        const data = await API.request('/get_botlist');
        $.hide('openapi-botlist-loading');
        if (data.success) { displayBotList(data.data); $.show('openapi-botlist-container'); }
        else alert('è·å–æœºå™¨äººåˆ—è¡¨å¤±è´¥: ' + API.handleError(data));
    } catch (error) {
        console.error('è·å–æœºå™¨äººåˆ—è¡¨å¤±è´¥:', error);
        $.hide('openapi-botlist-loading');
        alert('è·å–æœºå™¨äººåˆ—è¡¨å¤±è´¥');
    }
}

function displayBotList(data) {
    const tbody = $.get('openapi-botlist-table');
    if (!data || !data.apps || !data.apps.length) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">æš‚æ— æœºå™¨äºº</td></tr>';
        return;
    }
    tbody.innerHTML = data.apps.map(app => `
        <tr>
            <td><strong>${app.app_name || 'æœªå‘½å'}</strong><br><small class="text-muted">${app.app_desc || 'æ— æè¿°'}</small></td>
            <td><code>${app.app_id}</code></td>
            <td>
                <div class="d-flex gap-1 flex-wrap">
                    <button class="btn btn-outline-primary btn-sm" onclick="getBotData('${app.app_id}')"><i class="bi bi-graph-up"></i> æ•°æ®</button>
                    <button class="btn btn-outline-success btn-sm" onclick="getBotTemplates('${app.app_id}', '${app.app_name}')"><i class="bi bi-layout-text-sidebar-reverse"></i> æ¨¡æ¿</button>
                    <button class="btn btn-outline-warning btn-sm" onclick="getBotWhitelist('${app.app_id}', '${app.app_name}')"><i class="bi bi-shield-check"></i> ç™½åå•</button>
                    <button class="btn btn-outline-info btn-sm" onclick="importBotTemplates('${app.app_id}', '${app.app_name}')"><i class="bi bi-download"></i> å¯¼å…¥</button>
                </div>
            </td>
        </tr>
    `).join('');
}

function refreshBotList() { loadBotList(); }

async function getBotData(appid) {
    DataArea.show(`<i class="bi bi-table"></i> æœºå™¨äººæ•°æ® - ${appid}`);
    try {
        const data = await API.request('/get_botdata', { appid, days: 30 });
        if (data.success) displayBotData(data);
        else alert('è·å–æœºå™¨äººæ•°æ®å¤±è´¥: ' + API.handleError(data));
    } catch (error) {
        console.error('è·å–æœºå™¨äººæ•°æ®å¤±è´¥:', error);
        alert('è·å–æœºå™¨äººæ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
        $.hide('openapi-data-loading');
    }
}

function displayBotData(data) {
    $.setText('openapi-data-appid', data.appid);
    $.setText('openapi-data-avg-dau', data.avg_dau);
    $.setText('openapi-avg-dau-display', Number(data.avg_dau).toLocaleString('zh-CN'));
   
   const tbody = $.get('openapi-data-table');
    tbody.innerHTML = data.days_data.map(d => `
        <tr>
            <td><strong>${d.date}</strong></td>
            <td>${Number(d.up_messages).toLocaleString('zh-CN')}</td>
            <td><span class="badge bg-primary">${Number(d.up_users).toLocaleString('zh-CN')}</span></td>
            <td>${Number(d.down_messages).toLocaleString('zh-CN')}</td>
            <td><strong>${Number(d.total_messages).toLocaleString('zh-CN')}</strong></td>
            <td><span class="text-success">+${Number(d.new_groups).toLocaleString('zh-CN')}</span> / <span class="text-info">${Number(d.current_groups).toLocaleString('zh-CN')}</span></td>
            <td><span class="text-success">+${Number(d.new_friends).toLocaleString('zh-CN')}</span> / <span class="text-info">${Number(d.current_friends).toLocaleString('zh-CN')}</span></td>
        </tr>
    `).join('');
   DataArea.showContainer('data-table');
}

function getBotTemplates(appid, appName) { getTemplates(appid, appName); }

async function getTemplates(appid = null, appName = null) {
    DataArea.show('<i class="bi bi-layout-text-sidebar-reverse"></i> æ¨¡æ¿ç®¡ç†');
    try {
        const data = await API.request('/get_templates', appid ? { appid } : {});
        $.hide('openapi-data-loading');
        if (data.success) { currentTemplates = data.data.templates; displayTemplates(data.data.templates, appName); }
        else alert('è·å–æ¨¡æ¿åˆ—è¡¨å¤±è´¥: ' + API.handleError(data, 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–é‡æ–°ç™»å½•'));
    } catch (error) {
        $.hide('openapi-data-loading');
        alert('è·å–æ¨¡æ¿åˆ—è¡¨å¤±è´¥: ' + (error.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•'));
    }
}

function displayTemplates(templates, appName = null) {
    $.setHtml('template-list-title', `<i class="bi bi-layout-text-sidebar-reverse"></i> ${appName ? appName + ' - ' : ''}æ¨¡æ¿åˆ—è¡¨`);
    const tbody = $.get('openapi-templates-table');
    if (!templates.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">æš‚æ— æ¨¡æ¿</td></tr>';
    } else {
        tbody.innerHTML = templates.map((t, i) => `
            <tr>
                <td style="max-width: 200px; word-break: break-word;"><strong>${t.name}</strong><br><small class="text-muted">ID: ${t.id}</small></td>
                <td><span class="badge ${t.type === 'æŒ‰é’®æ¨¡æ¿' ? 'bg-info' : 'bg-secondary'}">${t.type}</span></td>
                <td><span class="badge ${getStatusBadgeClass(t.status)}">${t.status}</span></td>
                <td><button class="btn btn-outline-primary btn-sm" onclick="viewTemplateDetail(${i})"><i class="bi bi-eye"></i> æŸ¥çœ‹</button></td>
            </tr>
        `).join('');
    }
    DataArea.showContainer('templates');
}

function getStatusBadgeClass(status) {
    const classes = { 'å®¡æ ¸é€šè¿‡': 'bg-success', 'æœªé€šè¿‡': 'bg-danger', 'å®¡æ ¸ä¸­': 'bg-primary', 'æœªæå®¡': 'bg-warning' };
    return classes[status] || 'bg-secondary';
}

function viewTemplateDetail(index) {
    if (index < 0 || index >= currentTemplates.length) return;
    currentTemplateIndex = index;
    const t = currentTemplates[index];
    
    $.setText('template-detail-index', `${index + 1}/${currentTemplates.length}`);
    $.setText('template-detail-id', t.id);
    $.setText('template-detail-name', t.name);
    $.setHtml('template-detail-type', `<span class="badge ${t.type === 'æŒ‰é’®æ¨¡æ¿' ? 'bg-info' : 'bg-secondary'}">${t.type}</span>`);
    $.setHtml('template-detail-status', `<span class="badge ${getStatusBadgeClass(t.status)}">${t.status}</span>`);
    $.setText('template-detail-create-time', t.create_time || '-');
    $.setText('template-detail-content', t.content);
    
    const prevBtn = $.get('template-prev-btn'), nextBtn = $.get('template-next-btn');
    if (prevBtn) {
        prevBtn.style.display = index > 0 ? 'inline-block' : 'none';
        prevBtn.onclick = () => viewTemplateDetail(index - 1);
    }
    if (nextBtn) {
        nextBtn.style.display = index < currentTemplates.length - 1 ? 'inline-block' : 'none';
        nextBtn.onclick = () => viewTemplateDetail(index + 1);
    }
    
    if (t.type === 'æŒ‰é’®æ¨¡æ¿') renderButtonPreview(t);
    else { const bp = $.get('template-button-preview'); if (bp) bp.style.display = 'none'; }
    
    $.show('openapi-template-detail');
}

function importBotTemplates(appid, appName) {
    if (!confirm(`ç¡®å®šè¦å°†æœºå™¨äºº "${appName}" çš„æ¨¡æ¿å¯¼å…¥åˆ°markdown_templates.pyæ–‡ä»¶ä¸­å—ï¼Ÿ\n\nAppID: ${appid}\n\næ³¨æ„ï¼š\n- æ¨¡æ¿å°†ä»1å¼€å§‹å‘½å\n- æŒ‰é’®IDå°†ä»¥æ³¨é‡Šå½¢å¼æ·»åŠ `)) return;
    
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> å¯¼å…¥ä¸­...';
    button.disabled = true;
    
    API.request('/import_templates', { appid }).then(data => {
        if (data.success) {
            const r = data.data;
            alert(`âœ… æ¨¡æ¿å¯¼å…¥å®Œæˆï¼\n\nğŸ¤– æœºå™¨äºº: ${appName}\nğŸ“± AppID: ${appid}\n\nğŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š\nâ€¢ æ–°å¯¼å…¥æ¨¡æ¿ï¼š${r.imported_count} ä¸ª\nâ€¢ è·³è¿‡é‡å¤æ¨¡æ¿ï¼š${r.skipped_count} ä¸ª${r.button_count > 0 ? `\nâ€¢ æŒ‰é’®æ¨¡æ¿æ³¨é‡Šï¼š${r.button_count} ä¸ª` : ''}\n\nğŸ’¡ ${r.message}\n\nâš ï¸ é‡è¦æç¤ºï¼šä½ éœ€è¦é‡å¯æ¡†æ¶æ¥é‡è½½æ¨¡æ¿æ–‡ä»¶ï¼`);
            button.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i> å¯¼å…¥æˆåŠŸ';
            setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 3000);
        } else {
            alert('âŒ å¯¼å…¥æ¨¡æ¿å¤±è´¥: ' + data.message);
            if (data.message && data.message.includes('ç™»å½•çŠ¶æ€å¤±æ•ˆ')) showNotLoggedInState();
            }
    }).catch(error => {
        console.error('å¯¼å…¥æ¨¡æ¿å¤±è´¥:', error);
        alert('âŒ å¯¼å…¥æ¨¡æ¿å¤±è´¥ï¼Œè¯·é‡è¯•\n\né”™è¯¯ä¿¡æ¯: ' + error.message);
    }).finally(() => {
        if (button.innerHTML.includes('å¯¼å…¥ä¸­')) { button.innerHTML = originalText; button.disabled = false; }
    });
}

function renderButtonPreview(template) {
    try {
        let buttonData = template.content.startsWith('@') ? JSON.parse(template.content.substring(1)) : JSON.parse(template.content);
        const rows = buttonData.rows || [];
        const container = $.get('template-button-rows');
        if (!container) return;
        
        container.innerHTML = rows.slice(0, 5).map(row => {
            const buttons = row.buttons || [];
            if (!buttons.length) return '';
            const btnHtml = buttons.slice(0, 5).map(btn => {
                const rd = btn.render_data || {}, action = btn.action || {}, actionType = action.type || 2;
                const icon = actionType === 0 ? '<i class="bi bi-box-arrow-up-right"></i> ' : actionType === 1 ? '<i class="bi bi-arrow-clockwise"></i> ' : '';
                return `<button class="btn btn-sm ${getButtonStyleClass(rd.style || 0)}" disabled style="min-width: 80px;">${icon}${rd.label || 'Button'}</button>`;
            }).join('');
            return `<div class="mb-2 d-flex gap-2 flex-wrap">${btnHtml}</div>`;
        }).join('');
        
        const bp = $.get('template-button-preview'); if (bp) bp.style.display = 'block';
    } catch (error) {
        console.error('æŒ‰é’®é¢„è§ˆæ¸²æŸ“å¤±è´¥:', error);
        const bp = $.get('template-button-preview'); if (bp) bp.style.display = 'none';
    }
}

function getButtonStyleClass(style) {
    const classes = ['btn-outline-dark', 'btn-outline-primary', 'btn-outline-secondary', 'btn-outline-danger', 'btn-primary'];
    return classes[style] || 'btn-outline-dark';
}

async function getNotifications() {
    DataArea.show(`<i class="bi bi-bell"></i> é€šçŸ¥æ¶ˆæ¯`);
    try {
        const data = await API.request('/get_notifications');
        if (data.success) {
            displayNotifications(data.messages || data.notifications || []);
            DataArea.showContainer('notifications');
        } else alert('è·å–é€šçŸ¥æ¶ˆæ¯å¤±è´¥ï¼š' + API.handleError(data, 'æœªçŸ¥é”™è¯¯'));
    } catch (error) {
        console.error('è·å–é€šçŸ¥æ¶ˆæ¯å¤±è´¥:', error);
        $.hide('openapi-data-loading');
        alert('è·å–é€šçŸ¥æ¶ˆæ¯å¤±è´¥');
    }
}

async function getBotWhitelist(appid, appName) {
    currentWhitelistAppId = appid;
    currentWhitelistAppName = appName;
    DataArea.show(`<i class="bi bi-shield-check"></i> ${appName} - IPç™½åå•`);
    try {
        const data = await API.request('/get_whitelist', { appid });
        if (data.success) { displayWhitelist(data.data.ip_list || []); DataArea.showContainer('whitelist'); }
        else alert('è·å–ç™½åå•å¤±è´¥ï¼š' + API.handleError(data, 'è·å–ç™½åå•å¤±è´¥'));
    } catch (error) {
        console.error('è·å–ç™½åå•å¤±è´¥:', error);
        $.hide('openapi-data-loading');
        alert('è·å–ç™½åå•å¤±è´¥ï¼š' + (error.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•'));
    }
}

function displayNotifications(notifications) {
    const table = $.get('openapi-notifications-table');
    if (!notifications || !notifications.length) {
        table.innerHTML = '<tr><td colspan="3" class="text-center text-muted">æš‚æ— é€šçŸ¥æ¶ˆæ¯</td></tr>';
        return;
    }
    table.innerHTML = notifications.map(n => `<tr><td>${n.send_time || n.time || '-'}</td><td>${n.title || '-'}</td><td style="max-width: 300px; word-break: break-word;">${n.content || '-'}</td></tr>`).join('');
}

function displayWhitelist(ipList) {
    const table = $.get('openapi-whitelist-table');
    existingIpList = ipList ? ipList.map(ip => typeof ip === 'string' ? ip : (ip.ip || ip)) : [];
    clearAllInputs();
    
    if (!ipList || !ipList.length) {
        table.innerHTML = '<tr><td colspan="2" class="text-center text-muted"><i class="bi bi-inbox"></i> æš‚æ— IPç™½åå•ï¼Œç‚¹å‡»ä¸Šæ–¹"æ·»åŠ IPè¾“å…¥æ¡†"å¼€å§‹æ·»åŠ </td></tr>';
        return;
    }
    table.innerHTML = ipList.map((ip, i) => {
        const ipAddress = typeof ip === 'string' ? ip : (ip.ip || ip);
        return `<tr class="existing-ip-row"><td><span class="badge bg-primary me-2">å·²æœ‰</span><code>${ipAddress}</code></td><td><button class="btn btn-danger btn-sm" onclick="deleteWhitelistIp('${ipAddress}', ${i}, this)"><i class="bi bi-trash"></i> åˆ é™¤</button></td></tr>`;
    }).join('');
}

function addNewIpInput() {
    newIpInputCount++;
    const table = $.get('openapi-whitelist-table');
    const row = document.createElement('tr');
    row.className = 'new-ip-input-row';
    row.id = `new-ip-row-${newIpInputCount}`;
    row.innerHTML = `
        <td><div class="input-group"><input type="text" class="form-control new-ip-input" placeholder="è¯·è¾“å…¥IPåœ°å€ï¼Œå¦‚ï¼š192.168.1.100" id="new-ip-${newIpInputCount}" onkeypress="handleIpInputKeypress(event, ${newIpInputCount})"><span class="input-group-text bg-success text-white"><i class="bi bi-plus-lg"></i></span></div></td>
        <td><button class="btn btn-outline-danger btn-sm" onclick="removeIpInput(${newIpInputCount})"><i class="bi bi-x-lg"></i> ç§»é™¤</button></td>
    `;
    table.insertBefore(row, table.firstChild);
    setTimeout(() => $.get(`new-ip-${newIpInputCount}`).focus(), 100);
    updateBatchAddButtonVisibility();
}

function removeIpInput(inputId) {
    const row = $.get(`new-ip-row-${inputId}`);
    if (row) row.remove();
    updateBatchAddButtonVisibility();
}

function handleIpInputKeypress(event, inputId) {
    if (event.key === 'Enter') addNewIpInput();
}

function updateBatchAddButtonVisibility() {
    const batchButton = $.get('batch-add-ips-btn');
    batchButton.style.display = document.querySelectorAll('.new-ip-input-row').length > 0 ? 'inline-block' : 'none';
}

function clearAllInputs() {
    document.querySelectorAll('.new-ip-input-row').forEach(row => row.remove());
    newIpInputCount = 0;
    updateBatchAddButtonVisibility();
}

function batchAddIps() {
    const { validIps: newIps, invalidIps } = IPValidator.getValidIps();
    if (!newIps.length) return alert('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„IPåœ°å€');
    if (invalidIps.length) return alert(`ä»¥ä¸‹IPåœ°å€æ ¼å¼æ— æ•ˆï¼š\n${invalidIps.join('\n')}\n\nè¯·ä¿®æ­£åé‡è¯•ã€‚`);
    
    const duplicateIps = newIps.filter(ip => existingIpList.includes(ip));
    if (duplicateIps.length) alert(`ä»¥ä¸‹IPåœ°å€å·²å­˜åœ¨ï¼š\n${duplicateIps.join('\n')}\n\nå°†è·³è¿‡è¿™äº›IPåœ°å€ã€‚`);
    
    const finalIpList = newIps.filter(ip => !existingIpList.includes(ip));
    if (!finalIpList.length) return alert('æ²¡æœ‰æ–°çš„IPåœ°å€éœ€è¦æ·»åŠ ');
    if (!confirm(`ç¡®è®¤æ‰¹é‡æ·»åŠ ä»¥ä¸‹ ${finalIpList.length} ä¸ªIPåœ°å€å—ï¼Ÿ\n\n${finalIpList.join('\n')}\n\næ³¨æ„ï¼šæ­¤æ“ä½œéœ€è¦äºŒç»´ç æˆæƒã€‚`)) return;
    
    const batchButton = $.get('batch-add-ips-btn');
    batchButton.disabled = true;
    batchButton.innerHTML = '<i class="bi bi-hourglass"></i> è·å–æˆæƒä¸­...';
    startBatchAddProcess(finalIpList);
}

function startBatchAddProcess(newIpList) {
    deleteIpData.batchIpList = newIpList;
    showCustomModal('<i class="bi bi-shield-check"></i> æ‰¹é‡æ·»åŠ IPæˆæƒ', `<div class="mb-3"><strong>æ‰¹é‡æ·»åŠ  ${newIpList.length} ä¸ªIPåœ°å€ï¼š</strong><br><small class="text-muted">${newIpList.join(', ')}</small></div><div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">æ­£åœ¨è·å–æˆæƒäºŒç»´ç ...</span></div><div class="mt-2">æ­£åœ¨è·å–æˆæƒäºŒç»´ç ...</div></div>`);
    getBatchAddQrCode();
}

async function getBatchAddQrCode() {
    try {
        const data = await API.request('/get_delete_qr', { appid: currentWhitelistAppId });
        if (data.success) { deleteIpData.qrcode = data.qrcode; showDeleteQrCode(data.url); startBatchAddAuthCheck(); }
        else showDeleteQrError(API.handleError(data, 'è·å–æˆæƒäºŒç»´ç å¤±è´¥'));
    } catch (error) {
        console.error('è·å–æ‰¹é‡æ·»åŠ æˆæƒäºŒç»´ç å¤±è´¥:', error);
        showDeleteQrError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
    }
}

function startBatchAddAuthCheck() {
    if (deleteIpData.authCheckInterval) clearInterval(deleteIpData.authCheckInterval);
    deleteIpData.authCheckInterval = setInterval(checkBatchAddAuthStatus, 3000);
}

async function checkBatchAddAuthStatus() {
    if (!deleteIpData.qrcode) return;
    try {
        const data = await API.request('/check_delete_auth', { appid: currentWhitelistAppId, qrcode: deleteIpData.qrcode });
        if (data.success && data.authorized) {
            clearInterval(deleteIpData.authCheckInterval);
            deleteIpData.authCheckInterval = null;
            showAuthSuccess('æˆæƒæˆåŠŸï¼Œæ­£åœ¨æ‰¹é‡æ·»åŠ IP...');
            executeBatchAddIp();
        } else if (data.error) {
            clearInterval(deleteIpData.authCheckInterval);
            deleteIpData.authCheckInterval = null;
            showDeleteQrError(API.handleError(data, 'æˆæƒå¤±è´¥ï¼Œè¯·é‡è¯•'));
        }
    } catch (error) {
        console.error('æ£€æŸ¥æ‰¹é‡æ·»åŠ æˆæƒçŠ¶æ€å¤±è´¥:', error);
    }
}

async function executeBatchAddIp() {
    const allIpList = [...existingIpList, ...deleteIpData.batchIpList];
    try {
        const data = await API.request('/batch_add_whitelist', { appid: currentWhitelistAppId, ip_list: allIpList, qrcode: deleteIpData.qrcode });
        if (data.success) {
            showAuthSuccess(`æˆåŠŸæ·»åŠ  ${deleteIpData.batchIpList.length} ä¸ªIPåœ°å€ï¼`);
            setTimeout(() => {
                destroyCustomModal();
                clearAllInputs();
                const batchButton = $.get('batch-add-ips-btn');
                batchButton.disabled = false;
                batchButton.innerHTML = '<i class="bi bi-shield-check"></i> æ‰¹é‡æ·»åŠ IP (éœ€è¦æˆæƒ)';
                getBotWhitelist(currentWhitelistAppId, currentWhitelistAppName);
            }, 1500);
        } else showDeleteQrError(API.handleError(data, 'æ‰¹é‡æ·»åŠ IPå¤±è´¥'));
    } catch (error) {
        console.error('æ‰¹é‡æ·»åŠ IPå¤±è´¥:', error);
        showDeleteQrError('æ‰¹é‡æ·»åŠ IPæ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯');
    }
}

function deleteWhitelistIp(ipAddress, index, buttonElement) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤IP "${ipAddress}" å—ï¼Ÿ\n\néœ€è¦æ‰«æäºŒç»´ç è¿›è¡Œæˆæƒç¡®è®¤ã€‚`)) return;
    deleteIpData.ip = ipAddress;
    deleteIpData.qrcode = '';
    showCustomModal('<i class="bi bi-trash"></i> åˆ é™¤IPæˆæƒ', `<div class="mb-3"><strong>ç¡®è®¤åˆ é™¤IPåœ°å€ï¼š<span class="text-danger">${ipAddress}</span></strong></div><div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">æ­£åœ¨è·å–æˆæƒäºŒç»´ç ...</span></div><div class="mt-2">æ­£åœ¨è·å–æˆæƒäºŒç»´ç ...</div></div>`);
    getDeleteQrCode();
}

async function getDeleteQrCode() {
    try {
        const data = await API.request('/get_delete_qr', { appid: currentWhitelistAppId });
        if (data.success) { deleteIpData.qrcode = data.qrcode; showDeleteQrCode(data.url); startDeleteAuthCheck(); }
        else showDeleteQrError(API.handleError(data, 'è·å–æˆæƒäºŒç»´ç å¤±è´¥'));
    } catch (error) {
        console.error('è·å–åˆ é™¤æˆæƒäºŒç»´ç å¤±è´¥:', error);
        showDeleteQrError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
    }
}

function generateQRCodeToElement(url, targetElement, options = {}) {
    const { size = 200, failureText = 'äºŒç»´ç ç”Ÿæˆå¤±è´¥', linkButtonText = 'æ‰“å¼€æˆæƒé“¾æ¥' } = options;
    targetElement.innerHTML = '';
    const qrImg = document.createElement('img');
    qrImg.src = `https://api.2dcode.biz/v1/create-qr-code?data=${encodeURIComponent(url)}`;
    qrImg.alt = 'äºŒç»´ç ';
    Object.assign(qrImg.style, { width: size + 'px', height: size + 'px', border: '1px solid #ddd', borderRadius: '8px', display: 'block', margin: '0 auto' });
    qrImg.onload = () => targetElement.appendChild(qrImg);
    qrImg.onerror = () => {
        targetElement.innerHTML = `<div class="border p-3" style="width: ${size}px; height: ${size}px; background: #f8f9fa; margin: 0 auto;"><div class="text-center h-100 d-flex align-items-center justify-content-center"><div><i class="bi bi-qr-code text-muted" style="font-size: 3rem;"></i><div class="mt-2 text-muted">${failureText}</div><div class="mt-2"><a href="${url}" target="_blank" class="btn btn-primary btn-sm"><i class="bi bi-box-arrow-up-right"></i> ${linkButtonText}</a></div></div></div></div>`;
    };
}

function showDeleteQrCode(qrUrl) {
    if (!customModal.element) return;
    updateModalContent(`<div class="mb-3"><div class="d-flex justify-content-center mb-3"><div id="qrCodeContainer"></div></div><div class="alert alert-info"><i class="bi bi-info-circle"></i> è¯·ä½¿ç”¨QQæ‰«æäºŒç»´ç è¿›è¡Œæˆæƒ</div><div class="text-muted"><i class="bi bi-hourglass"></i> ç­‰å¾…æˆæƒä¸­...</div></div>`);
    hideRetryButton();
    const qrCodeDiv = customModal.element.querySelector('#qrCodeContainer');
    generateQRCodeToElement(qrUrl, qrCodeDiv, { size: 200, failureText: 'æˆæƒäºŒç»´ç ç”Ÿæˆå¤±è´¥', linkButtonText: 'æ‰“å¼€æˆæƒé“¾æ¥' });
}

function showDeleteQrError(message) {
    if (!customModal.element) return;
    updateModalContent(`<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${message}</div>`);
    showRetryButton();
}

function startDeleteAuthCheck() {
    if (deleteIpData.authCheckInterval) clearInterval(deleteIpData.authCheckInterval);
    deleteIpData.authCheckInterval = setInterval(checkDeleteAuthStatus, 3000);
    }
    
async function checkDeleteAuthStatus() {
    if (!deleteIpData.qrcode) return;
    try {
        const data = await API.request('/check_delete_auth', { appid: currentWhitelistAppId, qrcode: deleteIpData.qrcode });
        if (data.success && data.authorized) {
            clearInterval(deleteIpData.authCheckInterval);
            deleteIpData.authCheckInterval = null;
            showAuthSuccess('æˆæƒæˆåŠŸï¼Œæ­£åœ¨åˆ é™¤IP...');
            executeDeleteIp();
        } else if (data.error) {
            clearInterval(deleteIpData.authCheckInterval);
            deleteIpData.authCheckInterval = null;
            showDeleteQrError(API.handleError(data, 'æˆæƒå¤±è´¥ï¼Œè¯·é‡è¯•'));
        }
    } catch (error) {
        console.error('æ£€æŸ¥åˆ é™¤æˆæƒçŠ¶æ€å¤±è´¥:', error);
    }
}

async function executeDeleteIp() {
    try {
        const data = await API.request('/execute_delete_ip', { appid: currentWhitelistAppId, ip: deleteIpData.ip, qrcode: deleteIpData.qrcode });
        if (data.success) {
            showAuthSuccess('IPåˆ é™¤æˆåŠŸï¼');
            setTimeout(() => { destroyCustomModal(); getBotWhitelist(currentWhitelistAppId, currentWhitelistAppName); }, 1000);
        } else showDeleteQrError(API.handleError(data, 'åˆ é™¤IPå¤±è´¥'));
    } catch (error) {
        console.error('åˆ é™¤IPå¤±è´¥:', error);
        showDeleteQrError('åˆ é™¤IPæ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯');
    }
}

function createCustomModal() {
    destroyCustomModal();
    const modalHTML = `<div id="customAuthModal" style="position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background-color: rgba(0, 0, 0, 0.6) !important; z-index: 9999 !important; display: flex !important; align-items: center !important; justify-content: center !important;"><div id="customModalDialog" style="background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative; margin: 20px;"><div id="customModalHeader" style="padding: 15px 20px; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;"><h5 id="customModalTitle" style="margin: 0; font-size: 1.1rem;"><i class="bi bi-shield-check"></i> IPæˆæƒ</h5><button id="customModalClose" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;" title="å…³é—­">Ã—</button></div><div id="customModalBody" style="padding: 20px; text-align: center;"><div id="modalContent"></div></div><div id="customModalFooter" style="padding: 15px 20px; border-top: 1px solid #dee2e6; text-align: right;"><button id="customModalCancel" class="btn btn-secondary" style="margin-right: 10px;">å–æ¶ˆ</button><button id="customModalRetry" class="btn btn-primary" style="display: none;"><i class="bi bi-arrow-clockwise"></i> é‡è¯•</button></div></div></div>`;
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    const modalElement = modalContainer.firstElementChild;
    modalElement.querySelector('#customModalClose').addEventListener('click', destroyCustomModal);
    modalElement.querySelector('#customModalCancel').addEventListener('click', destroyCustomModal);
    modalElement.querySelector('#customModalRetry').addEventListener('click', retryCurrentOperation);
    modalElement.addEventListener('click', e => { if (e.target === modalElement) destroyCustomModal(); });
    modalElement.querySelector('#customModalDialog').addEventListener('click', e => e.stopPropagation());
    document.body.appendChild(modalElement);
    document.body.style.overflow = 'hidden';
    customModal.element = modalElement;
    customModal.isVisible = true;
    return modalElement;
}

function destroyCustomModal() {
    if (customModal.element) {
        if (deleteIpData.authCheckInterval) { clearInterval(deleteIpData.authCheckInterval); deleteIpData.authCheckInterval = null; }
        customModal.element.remove();
        customModal.element = null;
        customModal.isVisible = false;
        document.body.style.overflow = '';
    }
}

function showCustomModal(title, content) {
    const modal = createCustomModal();
    modal.querySelector('#customModalTitle').innerHTML = title;
    modal.querySelector('#modalContent').innerHTML = content;
    return modal;
}

function updateModalContent(content) {
    if (customModal.element) customModal.element.querySelector('#modalContent').innerHTML = content;
}

function showRetryButton() {
    if (customModal.element) customModal.element.querySelector('#customModalRetry').style.display = 'inline-block';
}

function hideRetryButton() {
    if (customModal.element) customModal.element.querySelector('#customModalRetry').style.display = 'none';
}

function retryCurrentOperation() {
    if (deleteIpData.ip) { showAuthLoading('æ­£åœ¨é‡æ–°è·å–åˆ é™¤æˆæƒäºŒç»´ç ...'); getDeleteQrCode(); }
    else if (deleteIpData.batchIpList && deleteIpData.batchIpList.length > 0) { showAuthLoading('æ­£åœ¨é‡æ–°è·å–æ‰¹é‡æ·»åŠ æˆæƒäºŒç»´ç ...'); getBatchAddQrCode(); }
}

function showAuthLoading(message = 'æ­£åœ¨è·å–æˆæƒäºŒç»´ç ...') {
    if (!customModal.element) return;
    updateModalContent(`<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">${message}</span></div><div class="mt-2">${message}</div></div>`);
    hideRetryButton();
}

function showAuthSuccess(message) {
    if (!customModal.element) return;
    updateModalContent(`<div class="text-center"><div class="alert alert-success"><i class="bi bi-check-circle text-success"></i> ${message}</div></div>`);
    hideRetryButton();
}

function closeDataSection() { $.hide('openapi-data-section'); }

document.addEventListener('DOMContentLoaded', initOpenAPI);
</script>
{% endblock %}
