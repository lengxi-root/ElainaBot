{% extends "pc/base.html" %}

{% block content %}
<div class="ai-plugins-page">
    <!-- 页面头部 -->
    <div class="ai-header">
        <div class="header-content">
            <div class="header-title">
                <div class="header-icon"><i class="bi bi-stars"></i></div>
                <div>
                    <h4>AI 插件助手</h4>
                    <p>使用 AI 创建、修改、添加功能或修复插件</p>
                </div>
            </div>
            <div class="header-actions">
                <select class="model-select" id="ai-model-select">
                    <option value="gpt-4o-mini">gpt-4o-mini</option>
                </select>
                <span class="ai-status" id="ai-status"><i class="bi bi-circle-fill"></i> 检测中...</span>
            </div>
        </div>
    </div>

    <div class="ai-main-container">
        <!-- 左侧：插件列表 -->
        <div class="plugins-panel">
            <div class="panel-header">
                <h5><i class="bi bi-folder2-open"></i> 插件列表</h5>
                <button class="refresh-btn" onclick="loadPluginList()"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
            <div class="search-box">
                <input type="text" id="plugin-search" placeholder="搜索插件..." oninput="filterPlugins()">
                <i class="bi bi-search"></i>
            </div>
            <div class="plugins-tree" id="plugins-tree">
                <div class="loading-state"><div class="spinner"></div><span>加载中...</span></div>
            </div>
        </div>

        <!-- 中间：操作区域 -->
        <div class="action-panel">
            <div class="action-tabs">
                <button class="tab-btn active" data-tab="create" onclick="switchTab('create')">
                    <i class="bi bi-plus-circle"></i> 创建插件
                </button>
                <button class="tab-btn" data-tab="modify" onclick="switchTab('modify')">
                    <i class="bi bi-pencil"></i> 修改插件
                </button>
                <button class="tab-btn" data-tab="feature" onclick="switchTab('feature')">
                    <i class="bi bi-puzzle"></i> 添加功能
                </button>
                <button class="tab-btn" data-tab="fix" onclick="switchTab('fix')">
                    <i class="bi bi-wrench"></i> 修复错误
                </button>
            </div>

            <!-- 创建插件 -->
            <div class="tab-content active" id="tab-create">
                <div class="form-group">
                    <label>目标目录</label>
                    <select class="form-select" id="create-directory"></select>
                </div>
                <div class="form-group">
                    <label>插件文件名</label>
                    <input type="text" class="form-input" id="create-filename" placeholder="例如: 我的插件">
                </div>
                <div class="form-group">
                    <label>功能描述</label>
                    <textarea class="form-textarea" id="create-description" rows="4" placeholder="详细描述你想要的插件功能..."></textarea>
                </div>
                <button class="action-btn primary" onclick="aiCreatePlugin()">
                    <i class="bi bi-magic"></i> AI 生成插件
                </button>
            </div>

            <!-- 修改插件 -->
            <div class="tab-content" id="tab-modify">
                <div class="form-group">
                    <label>选择插件</label>
                    <div class="selected-plugin" id="modify-selected">
                        <span class="placeholder">请从左侧选择一个插件</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>修改要求</label>
                    <textarea class="form-textarea" id="modify-description" rows="4" placeholder="描述你想要修改的内容..."></textarea>
                </div>
                <button class="action-btn primary" onclick="aiModifyPlugin()" id="btn-modify" disabled>
                    <i class="bi bi-magic"></i> AI 修改插件
                </button>
            </div>

            <!-- 添加功能 -->
            <div class="tab-content" id="tab-feature">
                <div class="form-group">
                    <label>选择插件</label>
                    <div class="selected-plugin" id="feature-selected">
                        <span class="placeholder">请从左侧选择一个插件</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>新功能描述</label>
                    <textarea class="form-textarea" id="feature-description" rows="4" placeholder="描述你想要添加的新功能..."></textarea>
                </div>
                <button class="action-btn primary" onclick="aiAddFeature()" id="btn-feature" disabled>
                    <i class="bi bi-magic"></i> AI 添加功能
                </button>
            </div>

            <!-- 修复错误 -->
            <div class="tab-content" id="tab-fix">
                <div class="form-group">
                    <label>选择插件</label>
                    <div class="selected-plugin" id="fix-selected">
                        <span class="placeholder">请从左侧选择一个插件</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>错误信息</label>
                    <textarea class="form-textarea" id="fix-error" rows="4" placeholder="粘贴错误信息或描述问题..."></textarea>
                </div>
                <button class="action-btn primary" onclick="aiFixPlugin()" id="btn-fix" disabled>
                    <i class="bi bi-magic"></i> AI 修复错误
                </button>
            </div>
        </div>

        <!-- 右侧：代码预览 -->
        <div class="code-panel">
            <div class="panel-header">
                <h5><i class="bi bi-code-slash"></i> 代码预览</h5>
                <div class="code-actions">
                    <span class="model-badge" id="used-model"></span>
                    <button class="code-btn" onclick="copyCode()" title="复制代码"><i class="bi bi-clipboard"></i></button>
                    <button class="code-btn primary" onclick="saveCode()" id="btn-save" disabled title="保存到文件">
                        <i class="bi bi-save"></i> 保存
                    </button>
                </div>
            </div>
            <div class="code-container">
                <div class="code-placeholder" id="code-placeholder">
                    <i class="bi bi-code-square"></i>
                    <p>AI 生成的代码将显示在这里</p>
                </div>
                <div id="code-editor" style="display: none;"></div>
            </div>
            <div class="code-info" id="code-info" style="display: none;">
                <span id="code-path"></span>
            </div>
        </div>
    </div>
</div>

<!-- 加载遮罩 -->
<div class="ai-loading-overlay" id="ai-loading" style="display: none;">
    <div class="ai-loading-content">
        <div class="ai-spinner"></div>
        <p id="ai-loading-text">AI 正在思考中...</p>
    </div>
</div>
{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('web.static', filename='css/vendor/codemirror.min.css') }}">
<link rel="stylesheet" href="{{ url_for('web.static', filename='css/vendor/codemirror-monokai.min.css') }}">
{% endblock %}

{% block scripts %}
<script src="{{ url_for('web.static', filename='js/vendor/codemirror.min.js') }}"></script>
<script src="{{ url_for('web.static', filename='js/vendor/codemirror-python.min.js') }}"></script>
<script src="{{ url_for('web.static', filename='js/vendor/codemirror-matchbrackets.min.js') }}"></script>
<script src="{{ url_for('web.static', filename='js/vendor/codemirror-closebrackets.min.js') }}"></script>
<script src="{{ url_for('web.static', filename='js/vendor/codemirror-active-line.min.js') }}"></script>

<script>
const getToken = () => new URLSearchParams(window.location.search).get('token');
let codeEditor = null;
let pluginsData = [];
let selectedPlugin = null;
let generatedCode = null;
let targetPath = null;
let availableModels = [];

// 获取当前选择的模型
function getSelectedModel() {
    return document.getElementById('ai-model-select').value;
}

// 检查 AI 服务状态并加载模型列表
async function checkAIStatus() {
    const statusEl = document.getElementById('ai-status');
    const modelSelect = document.getElementById('ai-model-select');
    try {
        const r = await fetch(`/web/api/ai_plugin/models?token=${getToken()}`);
        const result = await r.json();
        if (result.success) {
            statusEl.innerHTML = '<i class="bi bi-circle-fill online"></i> 在线';
            statusEl.classList.add('online');
            
            // 加载模型列表
            if (result.models && result.models.length > 0) {
                availableModels = result.models;
                modelSelect.innerHTML = '';
                result.models.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m;
                    if (m === result.default_model) opt.selected = true;
                    modelSelect.appendChild(opt);
                });
            }
        } else {
            statusEl.innerHTML = '<i class="bi bi-circle-fill offline"></i> 离线';
            statusEl.classList.add('offline');
        }
    } catch (e) {
        statusEl.innerHTML = '<i class="bi bi-circle-fill offline"></i> 离线';
        statusEl.classList.add('offline');
    }
}

// 加载插件列表
async function loadPluginList() {
    const tree = document.getElementById('plugins-tree');
    tree.innerHTML = '<div class="loading-state"><div class="spinner"></div><span>加载中...</span></div>';
    
    try {
        const r = await fetch(`/web/api/ai_plugin/list?token=${getToken()}`, {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({})
        });
        const result = await r.json();
        
        if (result.success) {
            pluginsData = result.data;
            renderPluginTree(result.data);
            populateDirectorySelect(result.data);
        } else {
            tree.innerHTML = `<div class="error-state"><i class="bi bi-exclamation-circle"></i><p>${result.message}</p></div>`;
        }
    } catch (e) {
        tree.innerHTML = `<div class="error-state"><i class="bi bi-exclamation-circle"></i><p>加载失败</p></div>`;
    }
}

function renderPluginTree(data) {
    const tree = document.getElementById('plugins-tree');
    if (!data || data.length === 0) {
        tree.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>暂无插件</p></div>';
        return;
    }
    
    let html = '';
    data.forEach(dir => {
        html += `<div class="tree-folder">
            <div class="folder-header" onclick="toggleFolder(this)">
                <i class="bi bi-chevron-right folder-chevron"></i>
                <i class="bi bi-folder-fill folder-icon"></i>
                <span>${dir.directory}</span>
                <span class="folder-count">${dir.count || dir.plugins.length}</span>
            </div>
            <div class="folder-content">`;
        
        dir.plugins.forEach(plugin => {
            html += `<div class="tree-file" onclick="selectPlugin('${dir.directory}', '${plugin}')">
                <i class="bi bi-file-earmark-code"></i>
                <span>${plugin}</span>
            </div>`;
        });
        
        html += '</div></div>';
    });
    
    tree.innerHTML = html;
}

function toggleFolder(el) {
    const content = el.nextElementSibling;
    const chevron = el.querySelector('.folder-chevron');
    content.classList.toggle('expanded');
    chevron.classList.toggle('bi-chevron-down');
    chevron.classList.toggle('bi-chevron-right');
}

function populateDirectorySelect(data) {
    const select = document.getElementById('create-directory');
    select.innerHTML = '';
    data.forEach(dir => {
        const opt = document.createElement('option');
        opt.value = dir.directory;
        opt.textContent = dir.directory;
        select.appendChild(opt);
    });
}

function filterPlugins() {
    const keyword = document.getElementById('plugin-search').value.toLowerCase();
    const files = document.querySelectorAll('.tree-file');
    files.forEach(file => {
        const name = file.querySelector('span').textContent.toLowerCase();
        file.style.display = name.includes(keyword) ? '' : 'none';
    });
}

function selectPlugin(directory, filename) {
    selectedPlugin = { directory, filename };
    
    // 更新选中状态
    document.querySelectorAll('.tree-file').forEach(el => el.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    
    // 更新各个 tab 的选中显示
    const displayText = `${directory}/${filename}`;
    ['modify', 'feature', 'fix'].forEach(tab => {
        const el = document.getElementById(`${tab}-selected`);
        el.innerHTML = `<i class="bi bi-file-earmark-code"></i> ${displayText}`;
        document.getElementById(`btn-${tab}`).disabled = false;
    });
}

function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
    document.getElementById(`tab-${tab}`).classList.add('active');
}

function showLoading(text = 'AI 正在思考中...') {
    document.getElementById('ai-loading-text').textContent = text;
    document.getElementById('ai-loading').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('ai-loading').style.display = 'none';
}

function showCode(code, model, path) {
    generatedCode = code;
    targetPath = path;
    
    document.getElementById('code-placeholder').style.display = 'none';
    document.getElementById('code-editor').style.display = 'block';
    document.getElementById('code-info').style.display = 'flex';
    document.getElementById('code-path').textContent = path;
    document.getElementById('used-model').textContent = model;
    document.getElementById('btn-save').disabled = false;
    
    if (codeEditor) {
        codeEditor.setValue(code);
    } else {
        codeEditor = CodeMirror(document.getElementById('code-editor'), {
            value: code, mode: 'python', theme: 'monokai', lineNumbers: true,
            matchBrackets: true, autoCloseBrackets: true, styleActiveLine: true,
            indentUnit: 4, indentWithTabs: false, lineWrapping: true
        });
        codeEditor.setSize('100%', '100%');
    }
    setTimeout(() => codeEditor?.refresh(), 50);
}

function showToast(msg, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast-msg ${type}`;
    toast.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'}-fill"></i> ${msg}`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// AI 创建插件
async function aiCreatePlugin() {
    const directory = document.getElementById('create-directory').value;
    const filename = document.getElementById('create-filename').value.trim();
    const description = document.getElementById('create-description').value.trim();
    const model = getSelectedModel();
    
    if (!filename) { showToast('请输入插件文件名', 'error'); return; }
    if (!description) { showToast('请输入功能描述', 'error'); return; }
    
    showLoading('AI 正在创建插件...');
    
    try {
        const r = await fetch(`/web/api/ai_plugin/create?token=${getToken()}`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ directory, filename, description, model })
        });
        const result = await r.json();
        
        if (result.success) {
            showCode(result.code, result.model, `${result.directory}/${result.filename}`);
            showToast('插件代码生成成功！', 'success');
        } else {
            showToast(result.message, 'error');
        }
    } catch (e) {
        showToast('请求失败: ' + e.message, 'error');
    } finally {
        hideLoading();
    }
}

// AI 修改插件
async function aiModifyPlugin() {
    if (!selectedPlugin) { showToast('请先选择一个插件', 'error'); return; }
    const modification = document.getElementById('modify-description').value.trim();
    const model = getSelectedModel();
    if (!modification) { showToast('请输入修改要求', 'error'); return; }
    
    showLoading('AI 正在修改插件...');
    
    try {
        const r = await fetch(`/web/api/ai_plugin/modify?token=${getToken()}`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ ...selectedPlugin, modification, model })
        });
        const result = await r.json();
        
        if (result.success) {
            showCode(result.code, result.model, `${result.directory}/${result.filename}`);
            showToast('插件修改成功！', 'success');
        } else {
            showToast(result.message, 'error');
        }
    } catch (e) {
        showToast('请求失败: ' + e.message, 'error');
    } finally {
        hideLoading();
    }
}

// AI 添加功能
async function aiAddFeature() {
    if (!selectedPlugin) { showToast('请先选择一个插件', 'error'); return; }
    const feature = document.getElementById('feature-description').value.trim();
    const model = getSelectedModel();
    if (!feature) { showToast('请输入新功能描述', 'error'); return; }
    
    showLoading('AI 正在添加功能...');
    
    try {
        const r = await fetch(`/web/api/ai_plugin/add_feature?token=${getToken()}`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ ...selectedPlugin, feature, model })
        });
        const result = await r.json();
        
        if (result.success) {
            showCode(result.code, result.model, `${result.directory}/${result.filename}`);
            showToast('功能添加成功！', 'success');
        } else {
            showToast(result.message, 'error');
        }
    } catch (e) {
        showToast('请求失败: ' + e.message, 'error');
    } finally {
        hideLoading();
    }
}

// AI 修复错误
async function aiFixPlugin() {
    if (!selectedPlugin) { showToast('请先选择一个插件', 'error'); return; }
    const error_message = document.getElementById('fix-error').value.trim();
    const model = getSelectedModel();
    if (!error_message) { showToast('请输入错误信息', 'error'); return; }
    
    showLoading('AI 正在修复错误...');
    
    try {
        const r = await fetch(`/web/api/ai_plugin/fix?token=${getToken()}`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ ...selectedPlugin, error_message, model })
        });
        const result = await r.json();
        
        if (result.success) {
            showCode(result.code, result.model, `${result.directory}/${result.filename}`);
            showToast('错误修复成功！', 'success');
        } else {
            showToast(result.message, 'error');
        }
    } catch (e) {
        showToast('请求失败: ' + e.message, 'error');
    } finally {
        hideLoading();
    }
}

// 复制代码
function copyCode() {
    if (!codeEditor) return;
    const code = codeEditor.getValue();
    navigator.clipboard.writeText(code).then(() => {
        showToast('代码已复制到剪贴板', 'success');
    });
}

// 保存代码
async function saveCode() {
    if (!targetPath || !codeEditor) return;
    
    const code = codeEditor.getValue();
    const [directory, filename] = targetPath.split('/');
    
    if (!confirm(`确定要保存到 ${targetPath} 吗？\n原文件将被备份为 .backup`)) return;
    
    showLoading('正在保存...');
    
    try {
        const r = await fetch(`/web/api/ai_plugin/save?token=${getToken()}`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ directory, filename, code })
        });
        const result = await r.json();
        
        if (result.success) {
            showToast('保存成功！请重启框架使更改生效', 'success');
            loadPluginList();
        } else {
            showToast(result.message, 'error');
        }
    } catch (e) {
        showToast('保存失败: ' + e.message, 'error');
    } finally {
        hideLoading();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadPluginList();
    checkAIStatus();
});
</script>


<style>
.ai-plugins-page { padding: 1rem; height: calc(100vh - 80px); display: flex; flex-direction: column; }

/* 头部 */
.ai-header {
    background: var(--theme-gradient);
    border-radius: 16px; padding: 1.25rem 1.5rem; margin-bottom: 1rem;
    box-shadow: 0 10px 30px rgba(88, 101, 242, 0.3);
}
.header-content { display: flex; justify-content: space-between; align-items: center; }
.header-title { display: flex; align-items: center; gap: 1rem; color: #fff; }
.header-icon { width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
.header-title h4 { margin: 0; font-size: 1.2rem; font-weight: 600; }
.header-title p { margin: 4px 0 0; font-size: 0.85rem; opacity: 0.9; }
.model-select { padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); color: #fff; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-size: 0.85rem; cursor: pointer; }
.model-select option { color: #333; }

/* 主容器 */
.ai-main-container { display: flex; gap: 1rem; flex: 1; min-height: 0; }

/* 左侧插件列表 */
.plugins-panel { width: 280px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); display: flex; flex-direction: column; }
.panel-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #f0f0f0; }
.panel-header h5 { margin: 0; font-size: 0.95rem; color: #333; display: flex; align-items: center; gap: 0.5rem; }
.refresh-btn { background: none; border: none; color: #999; cursor: pointer; padding: 4px 8px; border-radius: 4px; }
.refresh-btn:hover { background: #f5f5f5; color: #666; }
.search-box { padding: 0.75rem 1rem; position: relative; }
.search-box input { width: 100%; padding: 0.5rem 0.75rem 0.5rem 2rem; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 0.85rem; }
.search-box i { position: absolute; left: 1.5rem; top: 50%; transform: translateY(-50%); color: #999; }
.plugins-tree { flex: 1; overflow-y: auto; padding: 0.5rem; }

/* 树形结构 */
.tree-folder { margin-bottom: 4px; }
.folder-header { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; cursor: pointer; border-radius: 6px; font-size: 0.85rem; color: #555; }
.folder-header:hover { background: #f5f7fa; }
.folder-chevron { font-size: 0.75rem; color: #999; transition: transform 0.2s; }
.folder-icon { color: var(--theme-primary, #5865F2); }
.folder-count { margin-left: auto; background: var(--theme-primary, #5865F2); color: #fff; padding: 1px 6px; border-radius: 8px; font-size: 0.7rem; }
.folder-content { display: none; padding-left: 1.5rem; }
.folder-content.expanded { display: block; }
.tree-file { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.75rem; cursor: pointer; border-radius: 6px; font-size: 0.8rem; color: #666; }
.tree-file:hover { background: #f0f4ff; }
.tree-file.selected { background: #e8edff; color: var(--theme-primary, #5865F2); }
.tree-file i { color: #999; }

/* 中间操作区 */
.action-panel { width: 320px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); display: flex; flex-direction: column; }
.action-tabs { display: flex; border-bottom: 1px solid #f0f0f0; }
.tab-btn { flex: 1; padding: 0.75rem 0.5rem; background: none; border: none; border-bottom: 2px solid transparent; color: #999; font-size: 0.75rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all 0.2s; }
.tab-btn i { font-size: 1rem; }
.tab-btn:hover { color: var(--theme-primary, #5865F2); background: #f8f9ff; }
.tab-btn.active { color: var(--theme-primary, #5865F2); border-bottom-color: var(--theme-primary, #5865F2); }
.tab-content { display: none; padding: 1rem; flex: 1; overflow-y: auto; }
.tab-content.active { display: flex; flex-direction: column; gap: 1rem; }

/* 表单 */
.form-group { display: flex; flex-direction: column; gap: 0.5rem; }
.form-group label { font-size: 0.85rem; color: #555; font-weight: 500; }
.form-select, .form-input, .form-textarea { padding: 0.6rem 0.75rem; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 0.85rem; transition: border-color 0.2s; }
.form-select:focus, .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--theme-primary, #5865F2); }
.form-textarea { resize: none; min-height: 100px; }
.selected-plugin { padding: 0.6rem 0.75rem; background: #f8f9ff; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem; }
.selected-plugin .placeholder { color: #999; }
.selected-plugin i { color: var(--theme-primary, #5865F2); }

.action-btn { padding: 0.75rem 1rem; border: none; border-radius: 8px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; margin-top: auto; }
.action-btn.primary { background: var(--theme-gradient); color: #fff; }
.action-btn.primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(88, 101, 242, 0.4); }
.action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

/* 右侧代码区 */
.code-panel { flex: 1; background: #1e1e1e; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); display: flex; flex-direction: column; overflow: hidden; }
.code-panel .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background: #2d2d2d; border-bottom: 1px solid #3d3d3d; }
.code-panel .panel-header h5 { margin: 0; font-size: 0.9rem; color: #ccc; display: flex; align-items: center; gap: 0.5rem; }
.code-actions { display: flex; align-items: center; gap: 0.5rem; }
.model-badge { background: var(--theme-primary, #5865F2); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; }
.code-btn { padding: 0.4rem 0.6rem; background: #3d3d3d; border: none; color: #ccc; border-radius: 4px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 4px; }
.code-btn:hover { background: #4d4d4d; }
.code-btn.primary { background: var(--theme-primary, #5865F2); color: #fff; }
.code-btn.primary:hover { background: var(--theme-primary-hover, #4752c4); }
.code-btn:disabled { opacity: 0.5; cursor: not-allowed; }

.code-container { flex: 1; position: relative; overflow: hidden; }
.code-placeholder { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; }
.code-placeholder i { font-size: 3rem; margin-bottom: 1rem; }
#code-editor { height: 100%; }
#code-editor .CodeMirror { height: 100%; }
.code-info { padding: 0.5rem 1rem; background: #2d2d2d; border-top: 1px solid #3d3d3d; display: flex; align-items: center; }
#code-path { color: #999; font-size: 0.8rem; font-family: monospace; }

/* 加载遮罩 */
.ai-loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 9999; }
.ai-loading-content { background: #fff; padding: 2rem 3rem; border-radius: 16px; text-align: center; }
.ai-spinner { width: 48px; height: 48px; border: 4px solid #f0f0f0; border-top-color: var(--theme-primary, #5865F2); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 1rem; }
@keyframes spin { to { transform: rotate(360deg); } }
.ai-loading-content p { margin: 0; color: #666; }

/* 状态 */
.loading-state, .empty-state, .error-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; color: #999; gap: 0.5rem; }
.spinner { width: 24px; height: 24px; border: 2px solid #f0f0f0; border-top-color: var(--theme-primary, #5865F2); border-radius: 50%; animation: spin 0.8s linear infinite; }

/* Toast */
.toast-msg { position: fixed; top: 20px; right: 20px; padding: 0.75rem 1.25rem; background: #fff; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 0.5rem; z-index: 10000; animation: slideIn 0.3s ease; }
.toast-msg.success { border-left: 3px solid #10b981; }
.toast-msg.success i { color: #10b981; }
.toast-msg.error { border-left: 3px solid #ef4444; }
.toast-msg.error i { color: #ef4444; }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* AI 状态指示器 */
.ai-status { padding: 0.4rem 0.8rem; background: rgba(255,255,255,0.15); border-radius: 20px; font-size: 0.8rem; color: #fff; display: flex; align-items: center; gap: 0.4rem; }
.ai-status i { font-size: 0.5rem; }
.ai-status i.online { color: #10b981; }
.ai-status i.offline { color: #ef4444; }
.ai-status.online { background: rgba(16, 185, 129, 0.2); }
.ai-status.offline { background: rgba(239, 68, 68, 0.2); }

/* 模型选择下拉框 */
.model-select { padding: 0.4rem 0.8rem; background: rgba(255,255,255,0.15); color: #fff; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-size: 0.8rem; cursor: pointer; min-width: 150px; }
.model-select option { color: #333; background: #fff; }
.model-select:focus { outline: none; border-color: rgba(255,255,255,0.5); }
</style>

{% endblock %}
