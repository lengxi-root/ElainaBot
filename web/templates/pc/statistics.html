{% extends "pc/base.html" %}

{% block content %}
<!-- é¡µé¢æ ‡é¢˜åŒºåŸŸ -->
<div class="stats-header">
    <div class="stats-header-content">
        <div class="stats-title-wrapper">
            <div class="stats-icon"><i class="bi bi-bar-chart-line"></i></div>
            <div>
                <h4 class="stats-title">æ•°æ®ç»Ÿè®¡</h4>
                <p class="stats-subtitle">æŸ¥çœ‹æœºå™¨äººè¿è¡Œæ•°æ®ä¸è¶‹åŠ¿åˆ†æ</p>
            </div>
        </div>
        <div class="stats-actions">
            <button class="stats-btn warning" id="complete-dau">
                <i class="bi bi-plus-circle"></i> è¡¥å…¨DAU
            </button>
            <button class="stats-btn primary" id="refresh-statistics">
                <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°æ•°æ®
            </button>
        </div>
    </div>
</div>

<!-- å›¾è¡¨åˆ‡æ¢æ ‡ç­¾ -->
<div class="chart-tabs-wrapper">
    <div class="chart-tabs">
        <button class="chart-tab active" data-metric="messages_combined">
            <i class="bi bi-chat-dots"></i><span>æ¶ˆæ¯æ•°æ®</span>
        </button>
        <button class="chart-tab" data-metric="active_combined">
            <i class="bi bi-people"></i><span>æ´»è·ƒæ•°æ®</span>
        </button>
        <button class="chart-tab" data-metric="total_combined">
            <i class="bi bi-person-lines-fill"></i><span>ç”¨æˆ·æ•°æ®</span>
        </button>
        <button class="chart-tab" data-metric="group_events">
            <i class="bi bi-box-arrow-in-right"></i><span>ç¾¤ç»„å˜åŒ–</span>
        </button>
        <button class="chart-tab" data-metric="friend_events">
            <i class="bi bi-person-plus"></i><span>å¥½å‹å˜åŒ–</span>
        </button>
    </div>
</div>

<!-- å›¾è¡¨å¡ç‰‡ -->
<div class="chart-card">
    <div class="chart-card-header">
        <span class="chart-days-text">æ•°æ®è¶‹åŠ¿å›¾è¡¨ (æœ€è¿‘30å¤©)</span>
        <div id="chart-average-display" class="chart-average-badge"></div>
    </div>
    <div class="chart-wrapper">
        <canvas id="statisticsChart"></canvas>
    </div>
</div>

<!-- æ—¥æœŸé€‰æ‹©å™¨ -->
<div class="date-selector-card">
    <div class="date-selector-content">
        <div class="date-selector-left">
            <i class="bi bi-calendar3"></i>
            <label for="date-selector">æŸ¥çœ‹æ—¥æœŸ:</label>
            <select class="date-select" id="date-selector">
                <option value="today">ä»Šæ—¥æ•°æ®</option>
            </select>
        </div>
        <div id="data-source-info" class="data-source-badge">
            <span class="badge loading"><i class="bi bi-hourglass-split"></i> åŠ è½½ä¸­...</span>
        </div>
    </div>
</div>

<!-- æ•°æ®è¡¨æ ¼åŒºåŸŸ -->
<div class="stats-grid">
    <!-- ä»Šæ—¥æ•°æ®æ¦‚è§ˆ -->
    <div class="stats-card">
        <div class="stats-card-header primary">
            <i class="bi bi-clipboard-data"></i>
            <span id="stats-table-title">æ•°æ®æ¦‚è§ˆ</span>
        </div>
        <div class="stats-card-body compact">
            <table class="stats-table">
                <tbody id="today-stats-table">
                    <tr><td colspan="2" class="text-center text-muted">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- äº‹ä»¶ç»Ÿè®¡ -->
    <div class="stats-card">
        <div class="stats-card-header purple">
            <i class="bi bi-activity"></i>
            <span>äº‹ä»¶ç»Ÿè®¡</span>
        </div>
        <div class="stats-card-body compact">
            <table class="stats-table">
                <tbody id="event-stats-table">
                    <tr><td colspan="2" class="text-center text-muted">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- æŒ‡ä»¤æ’è¡Œ -->
    <div class="stats-card">
        <div class="stats-card-header warning">
            <i class="bi bi-terminal"></i>
            <span>æŒ‡ä»¤æ’è¡Œ</span>
        </div>
        <div class="stats-card-body compact">
            <table class="stats-table">
                <thead>
                    <tr><th>æŒ‡ä»¤</th><th>æ¬¡æ•°</th></tr>
                </thead>
                <tbody id="command-stats-table">
                    <tr><td colspan="2" class="text-center text-muted">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- æ´»è·ƒç”¨æˆ· -->
    <div class="stats-card">
        <div class="stats-card-header success">
            <i class="bi bi-person-fill"></i>
            <span>æ´»è·ƒç”¨æˆ·</span>
        </div>
        <div class="stats-card-body compact">
            <table class="stats-table">
                <thead>
                    <tr><th>ç”¨æˆ·ID</th><th>æ¶ˆæ¯</th></tr>
                </thead>
                <tbody id="top-users-table">
                    <tr><td colspan="2" class="text-center text-muted">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- æ´»è·ƒç¾¤ç»„ -->
    <div class="stats-card">
        <div class="stats-card-header info">
            <i class="bi bi-people-fill"></i>
            <span>æ´»è·ƒç¾¤ç»„</span>
        </div>
        <div class="stats-card-body compact">
            <table class="stats-table">
                <thead>
                    <tr><th>ç¾¤ç»„ID</th><th>æ¶ˆæ¯</th></tr>
                </thead>
                <tbody id="top-groups-table">
                    <tr><td colspan="2" class="text-center text-muted">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_styles %}
<style>
/* é¡µé¢æ ‡é¢˜åŒºåŸŸ */
.stats-header {
    background: var(--theme-gradient);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: 0 10px 15px -3px rgba(102,126,234,0.2);
}

.stats-header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.stats-title-wrapper {
    display: flex;
    align-items: center;
    gap: 16px;
    color: #fff;
}

.stats-icon {
    width: 56px;
    height: 56px;
    background: rgba(255,255,255,0.15);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.stats-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
}

.stats-subtitle {
    margin: 4px 0 0;
    font-size: 0.85rem;
    opacity: 0.85;
}

.stats-actions {
    display: flex;
    gap: 10px;
}

.stats-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 18px;
    border: none;
    border-radius: 10px;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.stats-btn.primary {
    background: rgba(255,255,255,0.2);
    color: #fff;
}

.stats-btn.primary:hover {
    background: rgba(255,255,255,0.3);
}

.stats-btn.warning {
    background: rgba(251,191,36,0.9);
    color: #1e293b;
}

.stats-btn.warning:hover {
    background: #fbbf24;
}

/* å›¾è¡¨åˆ‡æ¢æ ‡ç­¾ */
.chart-tabs-wrapper {
    margin-bottom: 16px;
}

.chart-tabs {
    display: flex;
    gap: 8px;
    padding: 4px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    border: 1px solid #e2e8f0;
}

.chart-tab {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 14px;
    border: none;
    background: transparent;
    border-radius: 8px;
    color: #64748b;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.chart-tab:hover {
    background: #f1f5f9;
    color: #475569;
}

.chart-tab.active {
    background: var(--theme-gradient);
    color: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.chart-tab i {
    font-size: 1rem;
}

/* å›¾è¡¨å¡ç‰‡ */
.chart-card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    border: 1px solid #e2e8f0;
    margin-bottom: 20px;
    overflow: hidden;
}

.chart-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-bottom: 1px solid #e2e8f0;
    font-weight: 600;
    color: #1e293b;
}

.chart-average-badge {
    padding: 4px 12px;
    background: rgba(102,126,234,0.1);
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--primary-color, #5865F2);
    display: none;
}

.chart-wrapper {
    padding: 20px;
    min-height: 300px;
}

.chart-wrapper canvas {
    max-height: 350px;
}

/* æ—¥æœŸé€‰æ‹©å™¨ */
.date-selector-card {
    background: #fff;
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    border: 1px solid #e2e8f0;
}

.date-selector-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.date-selector-left {
    display: flex;
    align-items: center;
    gap: 12px;
    color: #64748b;
    font-size: 0.9rem;
}

.date-selector-left i {
    font-size: 1.1rem;
    color: var(--primary-color, #5865F2);
}

.date-select {
    padding: 8px 32px 8px 14px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.85rem;
    color: #1e293b;
    background: #f8fafc url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23667eea' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e") no-repeat right 10px center/12px;
    appearance: none;
    cursor: pointer;
    transition: all 0.2s;
}

.date-select:hover {
    border-color: var(--primary-color, #5865F2);
}

.date-select:focus {
    outline: none;
    border-color: var(--primary-color, #5865F2);
    box-shadow: 0 0 0 3px rgba(88,101,242,0.1);
}

.data-source-badge .badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
}

.data-source-badge .badge.loading {
    background: rgba(251,191,36,0.15);
    color: #d97706;
}

.data-source-badge .badge.bg-success {
    background: rgba(16,185,129,0.15);
    color: #059669;
}

.data-source-badge .badge.bg-info {
    background: rgba(88,101,242,0.15);
    color: var(--primary-color, #5865F2);
}

.data-source-badge .badge.bg-warning {
    background: rgba(251,191,36,0.15);
    color: #d97706;
}

/* æ•°æ®è¡¨æ ¼åŒºåŸŸ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 16px;
}

.stats-card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    border: 1px solid #e2e8f0;
    overflow: hidden;
}

.stats-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 16px 20px;
    font-weight: 600;
    font-size: 0.95rem;
    color: #fff;
}

.stats-card-header.primary {
    background: var(--theme-gradient);
}

.stats-card-header.success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.stats-card-header.warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.stats-card-header.purple {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
}

.stats-card-header.info {
    background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
}

.stats-card-header i {
    font-size: 1rem;
}

.stats-card-body {
    padding: 12px 16px;
}

.stats-card-body.compact {
    padding: 10px 12px;
}

.stats-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
    margin: 16px 0;
}

.stats-section-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    color: #475569;
    margin-bottom: 12px;
}

.stats-section-title i {
    color: var(--primary-color, #5865F2);
}

.stats-table {
    width: 100%;
    border-collapse: collapse;
}

.stats-table th {
    padding: 8px 10px;
    text-align: left;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #64748b;
    background: #f8fafc;
    border-bottom: 2px solid #e2e8f0;
}

.stats-table td {
    padding: 6px 10px;
    font-size: 0.8rem;
    color: #334155;
    border-bottom: 1px solid #f1f5f9;
}

.stats-table tbody tr {
    transition: background 0.15s;
}

.stats-table tbody tr:hover {
    background: #f8fafc;
}

.stats-table td:last-child {
    font-weight: 600;
    color: var(--primary-color, #5865F2);
    text-align: right;
}

.nickname-loading {
    opacity: 0.5;
}

.nickname-display {
    color: #94a3b8;
    font-size: 0.8rem;
}

/* å“åº”å¼ */
@media (max-width: 1400px) {
    .stats-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 1200px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .stats-header-content {
        flex-direction: column;
        gap: 16px;
        text-align: center;
    }
    
    .stats-title-wrapper {
        flex-direction: column;
    }
    
    .stats-actions {
        width: 100%;
        justify-content: center;
    }
    
    .chart-tabs {
        flex-wrap: wrap;
        gap: 6px;
    }
    
    .chart-tab {
        flex: 1 1 calc(50% - 6px);
        padding: 8px 10px;
        font-size: 0.8rem;
    }
    
    .chart-tab span {
        display: none;
    }
    
    .chart-wrapper {
        height: 280px;
    }
    
    .date-selector-content {
        flex-direction: column;
        gap: 12px;
    }
    
    .chart-days-text::after {
        content: ' (æœ€è¿‘15å¤©)';
    }
}

@media (min-width: 769px) {
    .chart-days-text::after {
        content: '';
    }
}
</style>
{% endblock %}


{% block scripts %}
<script>
let statisticsChart = null;
let statisticsData = null;
const EMPTY_TABLE_ROW = '<tr><td colspan="2" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
const nicknameCache = new Map();

function debounce(func, delay) {
    let timeoutId;
    return function (...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
    };
}

function formatNumber(num) {
    if (num === null || num === undefined) return '0';
    if (typeof num === 'object') num = num.value ?? num.count ?? 0;
    const n = Number(num);
    if (isNaN(n)) return '0';
    if (n >= 10000) return (n / 10000).toFixed(2).replace(/\.?0+$/, '') + 'w';
    if (n >= 1000) return (n / 1000).toFixed(2).replace(/\.?0+$/, '') + 'k';
    return n.toString();
}

function getStat(item, statType, field) {
    return item?.[statType]?.[field] || 0;
}

function extractDataArrays(data, fields, statType = 'message_stats') {
    const arrays = fields.map(() => []);
    const isMobile = window.innerWidth <= 768;
    const maxDays = isMobile ? 15 : 30;
    
    if (data.historical && Array.isArray(data.historical)) {
        data.historical.slice(-maxDays).forEach(item => {
            fields.forEach((field, i) => {
                arrays[i].push(typeof field === 'function' ? field(item) : getStat(item, statType, field));
            });
        });
    }
    
    if (data.today) {
        fields.forEach((field, i) => {
            arrays[i].push(typeof field === 'function' ? field(data.today) : getStat(data.today, statType, field));
        });
    }
    return arrays;
}

function createDataset(label, data, color, bgColor) {
    return { label, data, borderColor: color, backgroundColor: bgColor, tension: 0.4, fill: false, pointRadius: 4, pointHoverRadius: 6 };
}

function getToken() {
    return new URLSearchParams(window.location.search).get('token');
}

function initStatistics() {
    const ctx = document.getElementById('statisticsChart');
    if (!ctx) return;
    
    statisticsChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'æ€»æ¶ˆæ¯é‡', data: [], borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.15)', tension: 0.3, fill: false, pointRadius: 4, pointHoverRadius: 6 }] },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2.5,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: { display: true, position: 'top', align: 'start' },
                datalabels: { display: true, align: 'top', anchor: 'end', color: 'rgba(0,0,0,0.6)', font: { size: 10 }, formatter: v => formatNumber(v), padding: { bottom: 4 }, clip: false }
            },
            scales: {
                x: { display: true, title: { display: false } },
                y: { display: true, title: { display: false }, beginAtZero: true }
            }
        },
        plugins: [ChartDataLabels]
    });
}

function loadStatistics(forceRefresh = false) {
    const token = getToken();
    if (!token) return;
    
    updateDataSourceInfo({ data_source_info: { source: 'loading', update_time: 'åŠ è½½ä¸­...' } });
    
    let apiUrl = `/web/api/statistics?token=${encodeURIComponent(token)}&async=true`;
    if (forceRefresh) apiUrl += '&force_refresh=true';
    
    fetch(apiUrl)
        .then(r => r.ok ? r.json() : Promise.reject(`HTTP ${r.status}`))
        .then(data => {
            if (data.success) {
                data.task_id && data.status === 'started' ? pollTaskStatus(data.task_id, token) : handleStatisticsData(data);
            } else {
                showStatisticsError('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(e => showStatisticsError('è·å–ç»Ÿè®¡æ•°æ®æ—¶å‡ºé”™: ' + e));
}

function pollTaskStatus(taskId, token, attempts = 0) {
    if (attempts > 60) { showStatisticsError('ç»Ÿè®¡ä»»åŠ¡è¶…æ—¶'); return; }
    
    setTimeout(() => {
        fetch(`/web/api/statistics/task/${taskId}?token=${encodeURIComponent(token)}`)
            .then(r => r.json())
            .then(data => {
                if (!data.success) { showStatisticsError('æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥'); return; }
                
                if (data.progress !== undefined) {
                    updateDataSourceInfo({ data_source_info: { source: 'processing', update_time: `${data.message || 'å¤„ç†ä¸­'} (${data.progress}%)` } });
                }
                
                if (data.status === 'completed') {
                    data.data ? handleStatisticsData(data.data) : showStatisticsError('ç»Ÿè®¡ä»»åŠ¡å®Œæˆä½†æ— æ•°æ®');
                } else if (data.status === 'failed') {
                    showStatisticsError('ç»Ÿè®¡ä»»åŠ¡å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                } else {
                    pollTaskStatus(taskId, token, attempts + 1);
                }
            })
            .catch(e => showStatisticsError('æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å‡ºé”™: ' + e));
    }, 1000);
}

function handleStatisticsData(data) {
    statisticsData = data;
    if (data.data_source_info) updateDataSourceInfo(data);
    if (data.historical && data.today) {
        updateChart('messages_combined');
        updateTables(data.today || {});
    } else if (data.selected_date_data) {
        updateTables(data.selected_date_data);
    }
}


function updateChart(metric) {
    if (!statisticsChart || !statisticsData) return;
    
    const labels = [];
    const isMobile = window.innerWidth <= 768;
    const maxDays = isMobile ? 15 : 30;
    
    if (statisticsData.historical && Array.isArray(statisticsData.historical)) {
        statisticsData.historical.slice(-maxDays).forEach(item => labels.push(item.display_date || item.date || 'æœªçŸ¥'));
    }
    if (statisticsData.today) labels.push('ä»Šæ—¥');
    
    let datasets = [];
    const metricConfigs = {
        messages_combined: () => {
            const [total, priv, group] = extractDataArrays(statisticsData, ['total_messages', 'private_messages', item => getStat(item, 'message_stats', 'total_messages') - getStat(item, 'message_stats', 'private_messages')]);
            return [createDataset('æ€»æ¶ˆæ¯é‡', total, '#667eea', 'rgba(102,126,234,0.15)'), createDataset('ç§èŠæ¶ˆæ¯æ•°', priv, '#764ba2', 'rgba(118,75,162,0.15)'), createDataset('ç¾¤èŠæ¶ˆæ¯æ•°', group, '#f72585', 'rgba(247,37,133,0.15)')];
        },
        active_combined: () => {
            const [users, groups] = extractDataArrays(statisticsData, ['active_users', 'active_groups']);
            return [createDataset('æ´»è·ƒç”¨æˆ·æ•°', users, '#f72585', 'rgba(247,37,133,0.15)'), createDataset('æ´»è·ƒç¾¤èŠæ•°', groups, '#4cc9f0', 'rgba(76,201,240,0.15)')];
        },
        total_combined: () => {
            const [users, groups, friends] = extractDataArrays(statisticsData, ['total_users', 'total_groups', 'total_friends'], 'user_stats');
            return [createDataset('æ€»ç”¨æˆ·æ•°', users, '#f77f00', 'rgba(247,127,0,0.15)'), createDataset('æ€»ç¾¤ç»„æ•°', groups, '#fcbf49', 'rgba(252,191,73,0.15)'), createDataset('æ€»å¥½å‹æ•°', friends, '#606c38', 'rgba(96,108,56,0.15)')];
        },
        group_events: () => {
            const [join, leave] = extractDataArrays(statisticsData, ['group_join_count', 'group_leave_count'], 'event_stats');
            return [createDataset('è¿›ç¾¤æ•°', join, '#10b981', 'rgba(16,185,129,0.15)'), createDataset('é€€ç¾¤æ•°', leave, '#ef4444', 'rgba(239,68,68,0.15)')];
        },
        friend_events: () => {
            const [add, remove] = extractDataArrays(statisticsData, ['friend_add_count', 'friend_remove_count'], 'event_stats');
            return [createDataset('åŠ å¥½å‹æ•°', add, '#17a2b8', 'rgba(23,162,184,0.15)'), createDataset('åˆ å¥½å‹æ•°', remove, '#ffc107', 'rgba(255,193,7,0.15)')];
        }
    };
    
    datasets = metricConfigs[metric] ? metricConfigs[metric]() : [];
    
    statisticsChart.data.labels = labels;
    statisticsChart.data.datasets = datasets;
    statisticsChart.update();
    
    document.querySelectorAll('.chart-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.metric === metric);
    });
    
    const avgEl = document.getElementById('chart-average-display');
    if (avgEl) avgEl.style.display = 'none';
}

function updateDataSourceInfo(data) {
    const el = document.getElementById('data-source-info');
    if (!el || !data.data_source_info) return;
    
    const sourceMap = {
        loading: { cls: 'loading', icon: 'hourglass-split', text: 'åŠ è½½ä¸­' },
        processing: { cls: 'bg-info', icon: 'gear-fill', text: 'è®¡ç®—ä¸­' },
        api: { cls: 'bg-success', icon: 'cloud-check', text: 'å®æ—¶æ•°æ®' },
        cache: { cls: 'bg-info', icon: 'clock-history', text: 'ç¼“å­˜æ•°æ®' }
    };
    
    const info = data.data_source_info;
    const { cls = 'loading', icon = 'hourglass-split', text = 'æœªçŸ¥' } = sourceMap[info.source] || {};
    el.innerHTML = `<span class="badge ${cls}"><i class="bi bi-${icon}"></i> ${text}</span>${info.update_time ? `<small class="text-muted ms-2">${info.update_time}</small>` : ''}`;
}

function updateTables(todayData) {
    const msgStats = todayData.message_stats || {};
    const userStats = todayData.user_stats || {};
    const eventStats = todayData.event_stats || {};
    
    const dataSourceEl = document.getElementById('data-source-info');
    if (dataSourceEl) {
        let html = '';
        if (todayData.is_historical) {
            html = `<span class="badge bg-info"><i class="bi bi-folder"></i> æœ¬åœ°æ–‡ä»¶</span>`;
        } else if (todayData.is_realtime) {
            html = `<span class="badge bg-warning"><i class="bi bi-database"></i> å®æ—¶æŸ¥è¯¢</span>`;
        } else {
            html = `<span class="badge bg-success"><i class="bi bi-folder"></i> æœ¬åœ°æ–‡ä»¶</span>`;
        }
        dataSourceEl.innerHTML = html;
    }
    
    // æ•°æ®æ¦‚è§ˆè¡¨æ ¼
    const statsTable = document.getElementById('today-stats-table');
    if (statsTable) {
        statsTable.innerHTML = `
            <tr><td>æ€»æ¶ˆæ¯é‡</td><td>${msgStats.total_messages || 0}</td></tr>
            <tr><td>æ´»è·ƒç”¨æˆ·</td><td>${msgStats.active_users || 0}</td></tr>
            <tr><td>æ´»è·ƒç¾¤èŠ</td><td>${msgStats.active_groups || 0}</td></tr>
            <tr><td>ç§èŠæ¶ˆæ¯</td><td>${msgStats.private_messages || 0}</td></tr>
            <tr><td>æœ€æ´»è·ƒæ—¶æ®µ</td><td>${msgStats.peak_hour || 0}ç‚¹</td></tr>
            <tr><td>æ€»ç”¨æˆ·æ•°</td><td>${userStats.total_users || 0}</td></tr>
            <tr><td>æ€»ç¾¤ç»„æ•°</td><td>${userStats.total_groups || 0}</td></tr>
            <tr><td>æ€»å¥½å‹æ•°</td><td>${userStats.total_friends || 0}</td></tr>
        `;
    }
    
    // äº‹ä»¶ç»Ÿè®¡è¡¨æ ¼
    const eventTable = document.getElementById('event-stats-table');
    if (eventTable) {
        const groupNet = (eventStats.group_join_count || 0) - (eventStats.group_leave_count || 0);
        const friendNet = (eventStats.friend_add_count || 0) - (eventStats.friend_remove_count || 0);
        eventTable.innerHTML = `
            <tr><td>è¿›ç¾¤æ•°</td><td>${eventStats.group_join_count || 0}</td></tr>
            <tr><td>é€€ç¾¤æ•°</td><td>${eventStats.group_leave_count || 0}</td></tr>
            <tr><td>ç¾¤ç»„å‡€å¢</td><td style="color:${groupNet >= 0 ? '#10b981' : '#ef4444'}">${groupNet >= 0 ? '+' : ''}${groupNet}</td></tr>
            <tr><td>åŠ å¥½å‹</td><td>${eventStats.friend_add_count || 0}</td></tr>
            <tr><td>åˆ å¥½å‹</td><td>${eventStats.friend_remove_count || 0}</td></tr>
            <tr><td>å¥½å‹å‡€å¢</td><td style="color:${friendNet >= 0 ? '#10b981' : '#ef4444'}">${friendNet >= 0 ? '+' : ''}${friendNet}</td></tr>
        `;
    }
    
    const topGroups = msgStats.top_groups || [];
    updateTable('top-groups-table', topGroups.slice(0, 5), g => `<tr><td>${maskId(g.group_id)}</td><td>${g.message_count}</td></tr>`);
    
    const topUsers = msgStats.top_users || [];
    if (topUsers.length > 0) {
        updateTable('top-users-table', topUsers.slice(0, 5), u => `<tr><td><span class="user-id-with-nickname" data-user-id="${u.user_id}">${maskId(u.user_id)} <span class="nickname-loading">ğŸ“</span></span></td><td>${u.message_count}</td></tr>`);
        loadNicknamesForUsers(topUsers.slice(0, 5));
    } else {
        document.getElementById('top-users-table').innerHTML = EMPTY_TABLE_ROW;
    }
    
    const cmdStats = todayData.command_stats || [];
    updateTable('command-stats-table', cmdStats.slice(0, 5), c => `<tr><td>${c.command}</td><td>${c.count}</td></tr>`);
}

function updateTable(tableId, items, rowMapper) {
    const table = document.getElementById(tableId);
    table.innerHTML = (!items || items.length === 0) ? EMPTY_TABLE_ROW : items.map(rowMapper).join('');
}

function maskId(id) {
    if (!id || typeof id !== 'string') return 'æœªçŸ¥';
    return id.length <= 6 ? id : id.substring(0, 3) + '***' + id.substring(id.length - 3);
}

function loadNicknamesForUsers(users) {
    users.forEach(u => {
        if (u.user_id && !nicknameCache.has(u.user_id)) fetchUserNickname(u.user_id);
        else if (nicknameCache.has(u.user_id)) updateUserNickname(u.user_id, nicknameCache.get(u.user_id));
    });
}

function fetchUserNickname(userId) {
    const token = getToken();
    if (!token) return;
    
    fetch(`/web/api/get_nickname/${encodeURIComponent(userId)}?token=${encodeURIComponent(token)}`)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.nickname) {
                nicknameCache.set(userId, data.nickname);
                updateUserNickname(userId, data.nickname);
            }
        })
        .catch(() => {});
}

function updateUserNickname(userId, nickname) {
    document.querySelectorAll(`[data-user-id="${userId}"]`).forEach(el => {
        const loading = el.querySelector('.nickname-loading');
        if (loading) {
            loading.textContent = `(${nickname})`;
            loading.className = 'nickname-display';
        }
    });
}


function loadAvailableDates() {
    const token = getToken();
    if (!token) return;
    
    fetch(`/web/api/available_dates?token=${encodeURIComponent(token)}`)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.dates) {
                const selector = document.getElementById('date-selector');
                selector.innerHTML = '';
                data.dates.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.value;
                    opt.textContent = d.display;
                    if (d.is_today) opt.selected = true;
                    selector.appendChild(opt);
                });
            }
        })
        .catch(() => {});
}

function loadDateSpecificData(date) {
    date === 'today' ? loadStatistics() : loadHistoricalDateData(date);
}

function loadHistoricalDateData(dateStr) {
    const token = getToken();
    if (!token) return;
    
    updateDataSourceInfo({ data_source_info: { source: 'loading', update_time: 'åŠ è½½å†å²æ•°æ®...' } });
    
    fetch(`/web/api/statistics?token=${encodeURIComponent(token)}&date=${dateStr}&async=false`)
        .then(r => r.ok ? r.json() : Promise.reject(`HTTP ${r.status}`))
        .then(data => {
            if (data.success && data.selected_date_data) {
                updateTables(data.selected_date_data);
            } else {
                showStatisticsError('è¯¥æ—¥æœŸæ²¡æœ‰å¯ç”¨æ•°æ®');
            }
        })
        .catch(e => showStatisticsError('è·å–å†å²æ•°æ®æ—¶å‡ºé”™: ' + e));
}

function completeDau() {
    const token = getToken();
    if (!token) return;
    
    const btn = document.getElementById('complete-dau');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> å¤„ç†ä¸­...';
    btn.disabled = true;
    
    fetch(`/web/api/complete_dau?token=${encodeURIComponent(token)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: '{}'
    })
        .then(r => r.json())
        .then(data => {
            alert(data.success ? 'DAUè¡¥å…¨æˆåŠŸï¼' : 'DAUè¡¥å…¨å¤±è´¥ï¼š' + data.message);
            if (data.success) loadStatistics();
        })
        .catch(() => alert('DAUè¡¥å…¨å¤±è´¥'))
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

function showStatisticsError(message) {
    console.error(message);
}

document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initStatistics, 50);
    setTimeout(loadStatistics, 100);
    setTimeout(loadAvailableDates, 150);
    
    document.querySelectorAll('.chart-tab').forEach(btn => {
        btn.addEventListener('click', debounce(function() { updateChart(this.dataset.metric); }, 200));
    });
    
    document.getElementById('refresh-statistics')?.addEventListener('click', debounce(() => {
        loadStatistics();
        loadDateSpecificData(document.getElementById('date-selector').value);
    }, 1000));
    
    document.getElementById('complete-dau')?.addEventListener('click', debounce(completeDau, 500));
    document.getElementById('date-selector')?.addEventListener('change', debounce(e => loadDateSpecificData(e.target.value), 300));
});
</script>
{% endblock %}