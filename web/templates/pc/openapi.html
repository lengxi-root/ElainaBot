{% extends "pc/base.html" %}

{% block content %}
<style>
/* å½»åº•ç¦ç”¨æ¨¡æ€æ¡†åŠ¨ç”»é¿å…é—ªçƒ */
.modal {
    transition: none !important;
    animation: none !important;
    transform: none !important;
}
.modal.fade {
    transition: none !important;
    opacity: 1 !important;
}
.modal-backdrop {
    transition: none !important;
    animation: none !important;
}
.modal-backdrop.fade {
    transition: none !important;
    opacity: 0.5 !important;
}
.modal.show .modal-dialog {
    transform: none !important;
    transition: none !important;
}

/* å¼ºåˆ¶å›ºå®šæ¨¡æ€æ¡†ä½ç½®ï¼Œé˜²æ­¢è·³åŠ¨ */
.modal.show {
    display: block !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    z-index: 1050 !important;
    overflow: auto !important;
}

.modal-dialog {
    position: relative !important;
    margin: 50px auto !important;
    max-width: 500px !important;
    transform: none !important;
}

/* ç¦ç”¨æ‰€æœ‰å¯èƒ½å¯¼è‡´è·³åŠ¨çš„CSSå±æ€§ */
#deleteIpQrModal, #deleteIpQrModal * {
    -webkit-transform: none !important;
    -moz-transform: none !important;
    -ms-transform: none !important;
    -o-transform: none !important;
    transition: none !important;
    animation: none !important;
}

/* å›ºå®šèƒŒæ™¯é®ç½© */
.modal-backdrop {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background-color: rgba(0, 0, 0, 0.5) !important;
    z-index: 1040 !important;
}
</style>
<div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="mb-0">å¼€æ”¾å¹³å°ç®¡ç†</h5>
    <small class="text-muted">ç®¡ç†QQå¼€å‘è€…å¹³å°çš„æœºå™¨äººæ•°æ®</small>
</div>

<!-- ç™»å½•çŠ¶æ€å¡ç‰‡ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card" id="openapi-login-card">
            <div class="card-body">
                <div id="openapi-not-logged-in" class="text-center">
                    <h6 class="card-title"><i class="bi bi-shield-lock"></i> å¼€æ”¾å¹³å°ç™»å½•</h6>
                    <p class="text-muted mb-3">è¯·å…ˆç™»å½•QQå¼€å‘è€…å¹³å°ä»¥æŸ¥çœ‹å’Œç®¡ç†æœºå™¨äººæ•°æ®</p>
                    <button class="btn btn-primary" id="openapi-start-login">
                        <i class="bi bi-qr-code"></i> å¼€å§‹ç™»å½•
                    </button>
                    <div id="openapi-login-progress" class="mt-3" style="display: none;">
                        <div class="d-flex flex-column align-items-center">
                            <div id="openapi-login-loading" class="mb-3">
                                <div class="spinner-border text-primary mb-2" role="status">
                                    <span class="visually-hidden">ç”ŸæˆäºŒç»´ç ä¸­...</span>
            </div>
                                <p class="text-muted mb-2">æ­£åœ¨ç”Ÿæˆç™»å½•äºŒç»´ç ...</p>
        </div>
                            <div id="openapi-qr-container" style="display: none;">
                                <div class="card" style="max-width: 300px;">
                                    <div class="card-header text-center">
                                        <h6 class="mb-0"><i class="bi bi-qr-code"></i> æ‰«æäºŒç»´ç ç™»å½•</h6>
    </div>
            <div class="card-body text-center">
                                        <img id="openapi-qr-image" src="" alt="ç™»å½•äºŒç»´ç " class="img-fluid mb-3" style="max-width: 200px; border: 1px solid #ddd; border-radius: 8px;">
                                        <p class="text-muted small mb-2">è¯·ä½¿ç”¨æ‰‹æœºQQæ‰«æä¸Šæ–¹äºŒç»´ç </p>
                                        <button class="btn btn-outline-secondary btn-sm" id="openapi-login-url" target="_blank">
                                            <i class="bi bi-box-arrow-up-right"></i> æˆ–ç‚¹å‡»æ‰“å¼€ç™»å½•é¡µé¢
                </button>
            </div>
                    </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="openapi-logged-in" style="display: none;">
                    <div class="row align-items-center">
                        <div class="col">
                            <h6 class="card-title mb-1">
                                <i class="bi bi-person-check text-success"></i> å·²ç™»å½•å¼€æ”¾å¹³å°
                            </h6>
                            <div class="d-flex flex-wrap gap-3">
                                <span class="badge bg-primary">
                                    <i class="bi bi-hash"></i> UIN: <span id="openapi-uin">-</span>
                                </span>

                            </div>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-outline-danger btn-sm" id="openapi-logout">
                                <i class="bi bi-box-arrow-right"></i> é‡æ–°ç™»å½•
                            </button>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
<!-- æœºå™¨äººåˆ—è¡¨ -->
<div class="row" id="openapi-main-content" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-robot"></i> æœºå™¨äººåˆ—è¡¨</h6>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-info btn-sm" id="openapi-get-notifications">
                        <i class="bi bi-bell"></i> æŸ¥çœ‹é€šçŸ¥æ¶ˆæ¯
                    </button>
                    <button class="btn btn-outline-primary btn-sm" id="openapi-refresh-botlist">
                    <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                </button>
                </div>
            </div>
            <div class="card-body">
                <div id="openapi-botlist-loading" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="text-muted mt-2">æ­£åœ¨è·å–æœºå™¨äººåˆ—è¡¨...</p>
                </div>
                <div id="openapi-botlist-container" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 35%;">æœºå™¨äººåç§°</th>
                                    <th style="width: 30%;">AppID</th>
                                    <th style="width: 35%;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="openapi-botlist-table">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
<div class="row mt-4" id="openapi-data-section" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0" id="openapi-data-title"><i class="bi bi-table"></i> æ•°æ®è¯¦æƒ…</h6>
                <div class="d-flex gap-2">
                    <span class="badge bg-primary">30å¤©æ•°æ®</span>
                    <button class="btn btn-outline-secondary btn-sm" id="openapi-close-data">
                        <i class="bi bi-x-lg"></i> å…³é—­
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="openapi-data-loading" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="text-muted mt-2">æ­£åœ¨è·å–æ•°æ®...</p>
                </div>
                
                <!-- éšè—çš„æ•°æ®å­˜å‚¨ -->
                <div id="openapi-data-summary" style="display: none;">
                    <span id="openapi-data-appid" style="display: none;">-</span>
                    <span id="openapi-data-avg-dau" style="display: none;">-</span>
                </div>
                
                <!-- æ•°æ®è¡¨æ ¼ -->
                <div id="openapi-data-table-container" style="display: none;">
                        <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>ä¸Šè¡Œæ¶ˆæ¯</th>
                                    <th>æ´»è·ƒç”¨æˆ·</th>
                                    <th>ä¸‹è¡Œæ¶ˆæ¯</th>
                                    <th>æ€»æ¶ˆæ¯</th>
                                    <th>ç¾¤ç»„(æ–°å¢/ç°æœ‰)</th>
                                    <th>å¥½å‹(æ–°å¢/ç°æœ‰)</th>
                                </tr>
                                <tr class="table-info">
                                    <td colspan="7" class="text-center">
                                        <strong>å¹³å‡DAU: <span id="openapi-avg-dau-display">-</span></strong>
                                    </td>
                                    </tr>
                                </thead>
                            <tbody id="openapi-data-table">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- é€šçŸ¥æ¶ˆæ¯è¡¨æ ¼ -->
                <div id="openapi-notifications-container" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>æ ‡é¢˜</th>
                                    <th>å†…å®¹</th>
                                    </tr>
                            </thead>
                            <tbody id="openapi-notifications-table">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- ç™½åå•è¡¨æ ¼ -->
                <div id="openapi-whitelist-container" style="display: none;">
                    <div class="mb-3 d-flex gap-2">
                        <button class="btn btn-outline-success btn-sm" onclick="addNewIpInput()">
                            <i class="bi bi-plus-lg"></i> æ·»åŠ IPè¾“å…¥æ¡†
                        </button>
                        <button class="btn btn-success btn-sm" id="batch-add-ips-btn" onclick="batchAddIps()" style="display: none;">
                            <i class="bi bi-shield-check"></i> æ‰¹é‡æ·»åŠ IP (éœ€è¦æˆæƒ)
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearAllInputs()">
                            <i class="bi bi-x-lg"></i> æ¸…ç©ºè¾“å…¥
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 70%;">IPåœ°å€</th>
                                    <th style="width: 30%;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="openapi-whitelist-table">
                            </tbody>
                        </table>
                    </div>
                </div>
                


                <!-- è‡ªå®šä¹‰æ¨¡æ€æ¡†å®¹å™¨ - åŠ¨æ€åˆ›å»º -->
                
                <!-- æ¨¡æ¿åˆ—è¡¨ -->
                <div id="openapi-templates-container" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3" id="template-list-title"><i class="bi bi-layout-text-sidebar-reverse"></i> æ¨¡æ¿åˆ—è¡¨</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="width: 40%;">æ¨¡æ¿åç§°</th>
                                            <th style="width: 25%;">ç±»å‹</th>
                                            <th style="width: 20%;">çŠ¶æ€</th>
                                            <th style="width: 15%;">æ“ä½œ</th>
                                    </tr>
                                    </thead>
                                    <tbody id="openapi-templates-table">
                                </tbody>
                            </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="openapi-template-detail" style="display: none;">
                                <h6 class="mb-3">
                                    <i class="bi bi-info-circle"></i> æ¨¡æ¿è¯¦æƒ…
                                    <span class="badge bg-primary ms-2" id="template-detail-index">1/1</span>
                                </h6>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <div class="row">
                                                <div class="col-sm-3"><strong>æ¨¡æ¿ID:</strong></div>
                                                <div class="col-sm-9" id="template-detail-id">-</div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="row">
                                                <div class="col-sm-3"><strong>åç§°:</strong></div>
                                                <div class="col-sm-9" id="template-detail-name">-</div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="row">
                                                <div class="col-sm-3"><strong>ç±»å‹:</strong></div>
                                                <div class="col-sm-9" id="template-detail-type">-</div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="row">
                                                <div class="col-sm-3"><strong>çŠ¶æ€:</strong></div>
                                                <div class="col-sm-9" id="template-detail-status">-</div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="row">
                                                <div class="col-sm-3"><strong>åˆ›å»ºæ—¶é—´:</strong></div>
                                                <div class="col-sm-9" id="template-detail-create-time">-</div>
                                            </div>
                        </div>
                        
                                        <!-- æ¨¡æ¿å†…å®¹å±•ç¤º -->
                                        <div class="mb-3">
                                            <strong>æ¨¡æ¿å†…å®¹:</strong>
                                            <div id="template-content-text" class="mt-2">
                                                <pre class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto; font-size: 12px;" id="template-detail-content">-</pre>
                                            </div>
                    </div>
                    
                                        <!-- æŒ‰é’®æ¨¡æ¿é¢„è§ˆ -->
                                        <div id="template-button-preview" style="display: none;">
                                            <strong>æŒ‰é’®é¢„è§ˆ:</strong>
                                            <div class="mt-2 p-3 bg-light rounded">
                                                <div id="template-button-rows"></div>
                                                <small class="text-muted mt-2 d-block">
                                                    <i class="bi bi-info-circle"></i> æŒ‰é’®ä»…ä¾›å‚è€ƒï¼Œå®é™…æ•ˆæœä»¥å®é™…ä¸ºå‡†<br>
                                                    ç±»å‹: 0=è·³è½¬é“¾æ¥, 1=å›è°ƒ, 2=å›è½¦å‘½ä»¤
                                                </small>
                                            </div>
                    </div>
                    
                                        <!-- å¯¼èˆªæŒ‰é’® -->
                                        <div class="mt-3 d-flex justify-content-between">
                                            <button class="btn btn-outline-secondary btn-sm" id="template-prev-btn" style="display: none;">
                                                <i class="bi bi-chevron-left"></i> ä¸Šä¸€ä¸ª
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm" id="template-next-btn" style="display: none;">
                                                ä¸‹ä¸€ä¸ª <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// =====================
// å¼€æ”¾å¹³å°é¡µé¢ç›¸å…³åŠŸèƒ½
// =====================
let openApiLoginCheckInterval = null;
let currentTemplates = [];
let currentTemplateIndex = 0;

// æ”¹è¿›çš„DOMæ“ä½œå·¥å…·
const $ = {
    get: (id) => document.getElementById(id),
    show: (id) => { const el = document.getElementById(id); if (el) el.style.display = 'block'; },
    hide: (id) => { const el = document.getElementById(id); if (el) el.style.display = 'none'; },
    setText: (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; },
    setHtml: (id, html) => { const el = document.getElementById(id); if (el) el.innerHTML = html; },
    toggleVisibility: (showIds, hideIds) => {
        showIds.forEach(id => $.show(id));
        hideIds.forEach(id => $.hide(id));
    }
};

// é€šç”¨APIè¯·æ±‚å·¥å…·
const API = {
    async request(endpoint, data = {}) {
        return fetch(`/web/openapi${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: 'web_user', ...data })
        }).then(response => response.json());
    },
    
    handleError(data, defaultMsg = 'æ“ä½œå¤±è´¥') {
        if (data.message && data.message.includes('ç™»å½•çŠ¶æ€å¤±æ•ˆ')) {
            showNotLoggedInState();
        }
        return data.message || defaultMsg;
    }
};

// æ•°æ®åŒºåŸŸç®¡ç†å·¥å…·
const DataArea = {
    show(title, containerType = 'data') {
        $.toggleVisibility(['openapi-data-section', 'openapi-data-loading'], []);
        $.setHtml('openapi-data-title', title);
        this.hideAllContainers();
    },
    
    hideAllContainers() {
        $.toggleVisibility([], [
            'openapi-data-table-container', 
            'openapi-notifications-container', 
            'openapi-whitelist-container', 
            'openapi-templates-container'
        ]);
        const templateDetail = $.get('openapi-template-detail');
        if (templateDetail) templateDetail.style.display = 'none';
    },
    
    showContainer(containerType) {
        $.hide('openapi-data-loading');
        $.show(`openapi-${containerType}-container`);
    }
};

// åˆå§‹åŒ–å¼€æ”¾å¹³å°
function initOpenAPI() {
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    checkOpenAPILoginStatus();
    
    // ç»‘å®šäº‹ä»¶
    document.getElementById('openapi-start-login').addEventListener('click', startOpenAPILogin);
    document.getElementById('openapi-logout').addEventListener('click', logoutOpenAPI);
    document.getElementById('openapi-refresh-botlist').addEventListener('click', refreshBotList);
    document.getElementById('openapi-get-notifications').addEventListener('click', getNotifications);
    document.getElementById('openapi-close-data').addEventListener('click', closeDataSection);
}

// æ£€æŸ¥ç™»å½•çŠ¶æ€
async function checkOpenAPILoginStatus() {
    try {
        const data = await API.request('/get_login_status');
        if (data.success && data.logged_in) {
            showLoggedInState(data);
            loadBotList();
        } else {
            showNotLoggedInState();
        }
    } catch (error) {
        console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
        showNotLoggedInState();
    }
}

// æ˜¾ç¤ºå·²ç™»å½•çŠ¶æ€
function showLoggedInState(data) {
    $.toggleVisibility(
        ['openapi-logged-in', 'openapi-main-content'],
        ['openapi-not-logged-in']
    );
    if (data.uin) {
        $.setText('openapi-uin', data.uin);
    }
}

// æ˜¾ç¤ºæœªç™»å½•çŠ¶æ€
function showNotLoggedInState() {
    $.toggleVisibility(
        ['openapi-not-logged-in'],
        ['openapi-logged-in', 'openapi-main-content', 'openapi-data-section']
    );
}

// å¼€å§‹ç™»å½•
async function startOpenAPILogin() {
    $.toggleVisibility(
        ['openapi-login-progress', 'openapi-login-loading'],
        ['openapi-qr-container']
    );
    
    try {
        const data = await API.request('/start_login');
        if (data.success) {
            // ç”ŸæˆäºŒç»´ç ï¼ˆä½¿ç”¨è€ç‰ˆæœ¬çš„æ–¹å¼ï¼‰
            generateQRCode(data.login_url);
            $.get('openapi-login-url').onclick = () => window.open(data.login_url, '_blank');
            
            // å¼€å§‹æ£€æŸ¥ç™»å½•çŠ¶æ€
            startLoginStatusCheck();
        } else {
            alert('è·å–ç™»å½•äºŒç»´ç å¤±è´¥ï¼š' + data.message);
            $.hide('openapi-login-progress');
        }
    } catch (error) {
        console.error('å¼€å§‹ç™»å½•å¤±è´¥:', error);
        alert('å¼€å§‹ç™»å½•å¤±è´¥');
        $.hide('openapi-login-progress');
    }
}

// ç”Ÿæˆç™»å½•äºŒç»´ç 
function generateQRCode(loginUrl) {
    const qrImage = $.get('openapi-qr-image');
    const qrApiUrl = `https://api.2dcode.biz/v1/create-qr-code?data=${encodeURIComponent(loginUrl)}`;
    
    qrImage.onload = function() {
        $.toggleVisibility(['openapi-qr-container'], ['openapi-login-loading']);
    };
    
    qrImage.onerror = function() {
        console.error('äºŒç»´ç ç”Ÿæˆå¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º');
        $.setHtml('openapi-login-loading', `
            <div class="alert alert-warning text-center">
                <i class="bi bi-exclamation-triangle"></i> äºŒç»´ç ç”Ÿæˆå¤±è´¥<br>
                <small class="text-muted">è¯·ä½¿ç”¨ä¸‹æ–¹æŒ‰é’®æ‰“å¼€ç™»å½•é¡µé¢</small>
            </div>
        `);
        $.show('openapi-qr-container');
    };
    
    qrImage.src = qrApiUrl;
}

// å¼€å§‹æ£€æŸ¥ç™»å½•çŠ¶æ€
function startLoginStatusCheck() {
    if (openApiLoginCheckInterval) {
        clearInterval(openApiLoginCheckInterval);
    }
    
    openApiLoginCheckInterval = setInterval(() => {
        fetch('/web/openapi/check_login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: 'web_user'
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('ç™»å½•çŠ¶æ€æ£€æŸ¥ç»“æœ:', data);
            if (data.success && data.status === 'logged_in') {
                clearInterval(openApiLoginCheckInterval);
                $.hide('openapi-login-progress');
                showLoggedInState(data);
                loadBotList();
            } else if (data.status === 'not_started') {
                console.log('ç™»å½•ä»»åŠ¡æœªå¼€å§‹ï¼Œåœæ­¢æ£€æŸ¥');
                clearInterval(openApiLoginCheckInterval);
                $.hide('openapi-login-progress');
            }
        })
        .catch(error => {
            console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
        });
    }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
}

// é€€å‡ºç™»å½•
function logoutOpenAPI() {
    if (confirm('ç¡®å®šè¦é‡æ–°ç™»å½•å—ï¼Ÿ')) {
        fetch('/web/openapi/logout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: 'web_user'
            })
        })
        .then(response => response.json())
        .then(data => {
            showNotLoggedInState();
            if (openApiLoginCheckInterval) {
                clearInterval(openApiLoginCheckInterval);
            }
        })
        .catch(error => {
            console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
        });
    }
}

// åŠ è½½æœºå™¨äººåˆ—è¡¨ï¼ˆç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
async function loadBotList() {
    $.toggleVisibility(['openapi-botlist-loading'], ['openapi-botlist-container']);
    
    try {
        const data = await API.request('/get_botlist');
        $.hide('openapi-botlist-loading');
        
        if (data.success) {
            displayBotList(data.data);
            $.show('openapi-botlist-container');
        } else {
            alert('è·å–æœºå™¨äººåˆ—è¡¨å¤±è´¥: ' + API.handleError(data));
        }
    } catch (error) {
        console.error('è·å–æœºå™¨äººåˆ—è¡¨å¤±è´¥:', error);
        $.hide('openapi-botlist-loading');
        alert('è·å–æœºå™¨äººåˆ—è¡¨å¤±è´¥');
    }
}

// æ˜¾ç¤ºæœºå™¨äººåˆ—è¡¨ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function displayBotList(data) {
    const tbody = $.get('openapi-botlist-table');
    tbody.innerHTML = '';
    
    if (!data || !data.apps || data.apps.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">æš‚æ— æœºå™¨äºº</td></tr>';
        return;
    }
    
    data.apps.forEach(app => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>
                <strong>${app.app_name || 'æœªå‘½å'}</strong>
                <br><small class="text-muted">${app.app_desc || 'æ— æè¿°'}</small>
            </td>
            <td><code>${app.app_id}</code></td>
            <td>
                <div class="d-flex gap-1 flex-wrap">
                    <button class="btn btn-outline-primary btn-sm" onclick="getBotData('${app.app_id}')">
                        <i class="bi bi-graph-up"></i> æ•°æ®
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="getBotTemplates('${app.app_id}', '${app.app_name}')">
                        <i class="bi bi-layout-text-sidebar-reverse"></i> æ¨¡æ¿
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="getBotWhitelist('${app.app_id}', '${app.app_name}')">
                        <i class="bi bi-shield-check"></i> ç™½åå•
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="importBotTemplates('${app.app_id}', '${app.app_name}')">
                        <i class="bi bi-download"></i> å¯¼å…¥
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    $.show('openapi-botlist-container');
}

// åˆ·æ–°æœºå™¨äººåˆ—è¡¨
function refreshBotList() {
    loadBotList();
}

// è·å–æœºå™¨äººæ•°æ®ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
async function getBotData(appid) {
    // å›ºå®šæŸ¥è¯¢30å¤©
    const days = 30;
    
    DataArea.show(`<i class="bi bi-table"></i> æœºå™¨äººæ•°æ® - ${appid}`);
    
    try {
        const data = await API.request('/get_botdata', { appid, days });
        if (data.success) {
            displayBotData(data);
        } else {
            alert('è·å–æœºå™¨äººæ•°æ®å¤±è´¥: ' + API.handleError(data));
        }
    } catch (error) {
        console.error('è·å–æœºå™¨äººæ•°æ®å¤±è´¥:', error);
        alert('è·å–æœºå™¨äººæ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
        $.hide('openapi-data-loading');
    }
}

// æ˜¾ç¤ºæœºå™¨äººæ•°æ®ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function displayBotData(data) {
    // å­˜å‚¨æ•°æ®åˆ°éšè—å…ƒç´ 
    $.setText('openapi-data-appid', data.appid);
    $.setText('openapi-data-avg-dau', data.avg_dau);
    
    // æ›´æ–°è¡¨æ ¼ä¸­çš„å¹³å‡DAUæ˜¾ç¤º
    $.setText('openapi-avg-dau-display', Number(data.avg_dau).toLocaleString('zh-CN'));
   
   // æ›´æ–°æ•°æ®è¡¨æ ¼
   const tbody = $.get('openapi-data-table');
   tbody.innerHTML = '';
   
   data.days_data.forEach(dayData => {
       const row = document.createElement('tr');
       row.innerHTML = `
           <td><strong>${dayData.date}</strong></td>
           <td>${Number(dayData.up_messages).toLocaleString('zh-CN')}</td>
           <td><span class="badge bg-primary">${Number(dayData.up_users).toLocaleString('zh-CN')}</span></td>
           <td>${Number(dayData.down_messages).toLocaleString('zh-CN')}</td>
           <td><strong>${Number(dayData.total_messages).toLocaleString('zh-CN')}</strong></td>
           <td>
               <span class="text-success">+${Number(dayData.new_groups).toLocaleString('zh-CN')}</span> / 
               <span class="text-info">${Number(dayData.current_groups).toLocaleString('zh-CN')}</span>
           </td>
           <td>
               <span class="text-success">+${Number(dayData.new_friends).toLocaleString('zh-CN')}</span> / 
               <span class="text-info">${Number(dayData.current_friends).toLocaleString('zh-CN')}</span>
           </td>
       `;
       tbody.appendChild(row);
   });
   
   DataArea.showContainer('data-table');
}

// è·å–æŒ‡å®šæœºå™¨äººçš„æ¨¡æ¿åˆ—è¡¨ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function getBotTemplates(appid, appName) {
    getTemplates(appid, appName);
}

// è·å–æ¨¡æ¿åˆ—è¡¨ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
async function getTemplates(appid = null, appName = null) {
    DataArea.show('<i class="bi bi-layout-text-sidebar-reverse"></i> æ¨¡æ¿ç®¡ç†');
    
    try {
        const requestData = appid ? { appid } : {};
        const data = await API.request('/get_templates', requestData);
        $.hide('openapi-data-loading');
        
        if (data.success) {
            currentTemplates = data.data.templates;
            displayTemplates(data.data.templates, appName);
        } else {
            alert('è·å–æ¨¡æ¿åˆ—è¡¨å¤±è´¥: ' + API.handleError(data, 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–é‡æ–°ç™»å½•'));
        }
    } catch (error) {
        $.hide('openapi-data-loading');
        alert('è·å–æ¨¡æ¿åˆ—è¡¨å¤±è´¥: ' + (error.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•'));
    }
}

// æ˜¾ç¤ºæ¨¡æ¿åˆ—è¡¨ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function displayTemplates(templates, appName = null) {
    // æ›´æ–°æ¨¡æ¿åˆ—è¡¨æ ‡é¢˜
    const titleText = appName ? `${appName} - æ¨¡æ¿åˆ—è¡¨` : 'æ¨¡æ¿åˆ—è¡¨';
    $.setHtml('template-list-title', `<i class="bi bi-layout-text-sidebar-reverse"></i> ${titleText}`);
    
    const tbody = $.get('openapi-templates-table');
    tbody.innerHTML = '';
    
    if (templates.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="4" class="text-center text-muted">æš‚æ— æ¨¡æ¿</td>
        `;
        tbody.appendChild(row);
    } else {
        templates.forEach((template, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="max-width: 200px; word-break: break-word;">
                    <strong>${template.name}</strong>
                    <br><small class="text-muted">ID: ${template.id}</small>
                </td>
                <td><span class="badge ${template.type === 'æŒ‰é’®æ¨¡æ¿' ? 'bg-info' : 'bg-secondary'}">${template.type}</span></td>
                <td><span class="badge ${getStatusBadgeClass(template.status)}">${template.status}</span></td>
                <td>
                    <button class="btn btn-outline-primary btn-sm" onclick="viewTemplateDetail(${index})">
                        <i class="bi bi-eye"></i> æŸ¥çœ‹
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    DataArea.showContainer('templates');
}

// è·å–çŠ¶æ€å¾½ç« æ ·å¼ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function getStatusBadgeClass(status) {
    switch (status) {
        case 'å®¡æ ¸é€šè¿‡': return 'bg-success';
        case 'æœªé€šè¿‡': return 'bg-danger';
        case 'å®¡æ ¸ä¸­': return 'bg-primary';
        case 'æœªæå®¡': return 'bg-warning';
        default: return 'bg-secondary';
    }
}

// æŸ¥çœ‹æ¨¡æ¿è¯¦æƒ…ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function viewTemplateDetail(index) {
    if (index < 0 || index >= currentTemplates.length) return;
    
    currentTemplateIndex = index;
    const template = currentTemplates[index];
    
    // æ›´æ–°æ¨¡æ¿è¯¦æƒ…
    document.getElementById('template-detail-index').textContent = `${index + 1}/${currentTemplates.length}`;
    document.getElementById('template-detail-id').textContent = template.id;
    document.getElementById('template-detail-name').textContent = template.name;
    document.getElementById('template-detail-type').innerHTML = `<span class="badge ${template.type === 'æŒ‰é’®æ¨¡æ¿' ? 'bg-info' : 'bg-secondary'}">${template.type}</span>`;
    document.getElementById('template-detail-status').innerHTML = `<span class="badge ${getStatusBadgeClass(template.status)}">${template.status}</span>`;
    document.getElementById('template-detail-create-time').textContent = template.create_time || '-';
    document.getElementById('template-detail-content').textContent = template.content;
    
    // æ›´æ–°å¯¼èˆªæŒ‰é’®
    const prevBtn = document.getElementById('template-prev-btn');
    const nextBtn = document.getElementById('template-next-btn');
    
    if (prevBtn) {
        if (index > 0) {
            prevBtn.style.display = 'inline-block';
        } else {
            prevBtn.style.display = 'none';
        }
    }
    
    if (nextBtn) {
        if (index < currentTemplates.length - 1) {
            nextBtn.style.display = 'inline-block';
        } else {
            nextBtn.style.display = 'none';
        }
    }
    
    // å¦‚æœæ˜¯æŒ‰é’®æ¨¡æ¿ï¼Œå°è¯•æ¸²æŸ“æŒ‰é’®é¢„è§ˆ
    if (template.type === 'æŒ‰é’®æ¨¡æ¿') {
        renderButtonPreview(template);
    } else {
        const buttonPreview = document.getElementById('template-button-preview');
        if (buttonPreview) buttonPreview.style.display = 'none';
    }
    
    // éšè—æ¨¡æ¿åˆ—è¡¨ï¼Œæ˜¾ç¤ºæ¨¡æ¿è¯¦æƒ…
    document.getElementById('openapi-templates-container').style.display = 'none';
    const templateDetail = document.getElementById('openapi-template-detail');
    if (templateDetail) templateDetail.style.display = 'block';
}

// å¯¼å…¥æŒ‡å®šæœºå™¨äººçš„æ¨¡æ¿åˆ°æ–‡ä»¶ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function importBotTemplates(appid, appName) {
    if (!confirm(`ç¡®å®šè¦å°†æœºå™¨äºº "${appName}" çš„æ¨¡æ¿å¯¼å…¥åˆ°markdown_templates.pyæ–‡ä»¶ä¸­å—ï¼Ÿ\n\nAppID: ${appid}\n\næ³¨æ„ï¼š\n- æ¨¡æ¿å°†ä»1å¼€å§‹å‘½å\n- æŒ‰é’®IDå°†ä»¥æ³¨é‡Šå½¢å¼æ·»åŠ `)) {
        return;
    }
    
    // é€šè¿‡äº‹ä»¶æ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> å¯¼å…¥ä¸­...';
    button.disabled = true;
    
    fetch('/web/openapi/import_templates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            user_id: 'web_user',
            appid: appid
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const result = data.data;
            let message = `âœ… æ¨¡æ¿å¯¼å…¥å®Œæˆï¼\n\n`;
            message += `ğŸ¤– æœºå™¨äºº: ${appName}\n`;
            message += `ğŸ“± AppID: ${appid}\n\n`;
            message += `ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š\n`;
            message += `â€¢ æ–°å¯¼å…¥æ¨¡æ¿ï¼š${result.imported_count} ä¸ª\n`;
            message += `â€¢ è·³è¿‡é‡å¤æ¨¡æ¿ï¼š${result.skipped_count} ä¸ª\n`;
            if (result.button_count > 0) {
                message += `â€¢ æŒ‰é’®æ¨¡æ¿æ³¨é‡Šï¼š${result.button_count} ä¸ª\n`;
            }
            message += `\nğŸ’¡ ${result.message}`;
            message += `\n\nâš ï¸ é‡è¦æç¤ºï¼šä½ éœ€è¦é‡å¯æ¡†æ¶æ¥é‡è½½æ¨¡æ¿æ–‡ä»¶ï¼`;
            
            alert(message);
            
            // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
            button.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i> å¯¼å…¥æˆåŠŸ';
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 3000);
        } else {
            alert('âŒ å¯¼å…¥æ¨¡æ¿å¤±è´¥: ' + data.message);
            if (data.message && data.message.includes('ç™»å½•çŠ¶æ€å¤±æ•ˆ')) {
                showNotLoggedInState();
            }
        }
    })
    .catch(error => {
        console.error('å¯¼å…¥æ¨¡æ¿å¤±è´¥:', error);
        alert('âŒ å¯¼å…¥æ¨¡æ¿å¤±è´¥ï¼Œè¯·é‡è¯•\n\né”™è¯¯ä¿¡æ¯: ' + error.message);
    })
    .finally(() => {
        if (button.innerHTML.includes('å¯¼å…¥ä¸­')) {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    });
}

// æ¸²æŸ“æŒ‰é’®é¢„è§ˆï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function renderButtonPreview(template) {
    try {
        let buttonData;
        
        // å°è¯•è§£ææŒ‰é’®æ•°æ®
        try {
            buttonData = JSON.parse(template.content);
        } catch (e) {
            // å¦‚æœæ˜¯@å¼€å¤´çš„æ ¼å¼
            if (template.content.startsWith('@')) {
                buttonData = JSON.parse(template.content.substring(1));
            } else {
                throw e;
            }
        }
        
        const rows = buttonData.rows || [];
        const buttonRowsContainer = document.getElementById('template-button-rows');
        if (!buttonRowsContainer) return;
        
        buttonRowsContainer.innerHTML = '';
        
        rows.slice(0, 5).forEach((row, rowIndex) => {
            const buttons = row.buttons || [];
            if (buttons.length === 0) return;
            
            const rowDiv = document.createElement('div');
            rowDiv.className = 'mb-2 d-flex gap-2 flex-wrap';
            
            buttons.slice(0, 5).forEach(button => {
                const renderData = button.render_data || {};
                const action = button.action || {};
                
                const btnElement = document.createElement('button');
                btnElement.className = `btn btn-sm ${getButtonStyleClass(renderData.style || 0)}`;
                btnElement.textContent = renderData.label || 'Button';
                btnElement.disabled = true;
                btnElement.style.minWidth = '80px';
                
                // æ·»åŠ ç±»å‹å›¾æ ‡
                const actionType = action.type || 2;
                let icon = '';
                if (actionType === 0) {
                    icon = '<i class="bi bi-box-arrow-up-right"></i> ';
                } else if (actionType === 1) {
                    icon = '<i class="bi bi-arrow-clockwise"></i> ';
                }
                
                btnElement.innerHTML = icon + btnElement.textContent;
                rowDiv.appendChild(btnElement);
            });
            
            buttonRowsContainer.appendChild(rowDiv);
        });
        
        const buttonPreview = document.getElementById('template-button-preview');
        if (buttonPreview) buttonPreview.style.display = 'block';
        
    } catch (error) {
        console.error('æŒ‰é’®é¢„è§ˆæ¸²æŸ“å¤±è´¥:', error);
        const buttonPreview = document.getElementById('template-button-preview');
        if (buttonPreview) buttonPreview.style.display = 'none';
    }
}

// è·å–æŒ‰é’®æ ·å¼ç±»ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function getButtonStyleClass(style) {
    switch (style) {
        case 0: return 'btn-outline-dark';
        case 1: return 'btn-outline-primary';
        case 2: return 'btn-outline-secondary';
        case 3: return 'btn-outline-danger';
        case 4: return 'btn-primary';
        default: return 'btn-outline-dark';
    }
}

// æ˜¾ç¤ºä¸Šä¸€ä¸ªæ¨¡æ¿ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function showPreviousTemplate() {
    if (currentTemplateIndex > 0) {
        viewTemplateDetail(currentTemplateIndex - 1);
    }
}

// æ˜¾ç¤ºä¸‹ä¸€ä¸ªæ¨¡æ¿ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function showNextTemplate() {
    if (currentTemplateIndex < currentTemplates.length - 1) {
        viewTemplateDetail(currentTemplateIndex + 1);
    }
}

// æŸ¥çœ‹é€šçŸ¥æ¶ˆæ¯
async function getNotifications() {
    DataArea.show(`<i class="bi bi-bell"></i> é€šçŸ¥æ¶ˆæ¯`);
    
    try {
        const data = await API.request('/get_notifications');
        if (data.success) {
            // é€‚é…åç«¯è¿”å›çš„æ•°æ®ç»“æ„ï¼šdata.messages è€Œä¸æ˜¯ data.notifications
            const notifications = data.messages || data.notifications || [];
            displayNotifications(notifications);
            DataArea.showContainer('notifications');
        } else {
            alert('è·å–é€šçŸ¥æ¶ˆæ¯å¤±è´¥ï¼š' + API.handleError(data, 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        console.error('è·å–é€šçŸ¥æ¶ˆæ¯å¤±è´¥:', error);
        $.hide('openapi-data-loading');
        alert('è·å–é€šçŸ¥æ¶ˆæ¯å¤±è´¥');
    }
}

// æŸ¥çœ‹æŒ‡å®šæœºå™¨äººçš„ç™½åå•
async function getBotWhitelist(appid, appName) {
    // è®¾ç½®å½“å‰æ“ä½œçš„AppIDå’Œåç§°
    currentWhitelistAppId = appid;
    currentWhitelistAppName = appName;
    
    DataArea.show(`<i class="bi bi-shield-check"></i> ${appName} - IPç™½åå•`);
    
    try {
        const data = await API.request('/get_whitelist', { appid });
        if (data.success) {
            displayWhitelist(data.data.ip_list || []);
            DataArea.showContainer('whitelist');
        } else {
            alert('è·å–ç™½åå•å¤±è´¥ï¼š' + API.handleError(data, 'è·å–ç™½åå•å¤±è´¥'));
        }
    } catch (error) {
        console.error('è·å–ç™½åå•å¤±è´¥:', error);
        $.hide('openapi-data-loading');
        alert('è·å–ç™½åå•å¤±è´¥ï¼š' + (error.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•'));
    }
}

// æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
function displayNotifications(notifications) {
    const table = $.get('openapi-notifications-table');
    
    if (!notifications || notifications.length === 0) {
        table.innerHTML = '<tr><td colspan="3" class="text-center text-muted">æš‚æ— é€šçŸ¥æ¶ˆæ¯</td></tr>';
        return;
    }
    
    table.innerHTML = notifications.map(notification => `
        <tr>
            <td>${notification.send_time || notification.time || '-'}</td>
            <td>${notification.title || '-'}</td>
            <td style="max-width: 300px; word-break: break-word;">${notification.content || '-'}</td>
        </tr>
    `).join('');
}

// æ˜¾ç¤ºç™½åå•
function displayWhitelist(ipList) {
    const table = $.get('openapi-whitelist-table');
    
    // ä¿å­˜ç°æœ‰IPåˆ—è¡¨åˆ°å…¨å±€å˜é‡
    existingIpList = ipList ? ipList.map(ip => typeof ip === 'string' ? ip : (ip.ip || ip)) : [];
    
    // æ¸…ç©ºä¹‹å‰çš„æ‰€æœ‰è¾“å…¥æ¡†
    clearAllInputs();
    
    if (!ipList || ipList.length === 0) {
        table.innerHTML = `
            <tr>
                <td colspan="2" class="text-center text-muted">
                    <i class="bi bi-inbox"></i> æš‚æ— IPç™½åå•ï¼Œç‚¹å‡»ä¸Šæ–¹"æ·»åŠ IPè¾“å…¥æ¡†"å¼€å§‹æ·»åŠ 
                </td>
            </tr>
        `;
        return;
    }
    
    // æ¸²æŸ“ç°æœ‰IPåˆ—è¡¨
    table.innerHTML = ipList.map((ip, index) => {
        const ipAddress = typeof ip === 'string' ? ip : (ip.ip || ip);
        return `
            <tr class="existing-ip-row">
                <td>
                    <span class="badge bg-primary me-2">å·²æœ‰</span>
                    <code>${ipAddress}</code>
                </td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteWhitelistIp('${ipAddress}', ${index}, this)">
                        <i class="bi bi-trash"></i> åˆ é™¤
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// å…¨å±€å˜é‡å­˜å‚¨å½“å‰æ“ä½œçš„AppIDå’Œåç§°
let currentWhitelistAppId = '';
let currentWhitelistAppName = '';

// åˆ é™¤IPç›¸å…³å˜é‡
let deleteIpData = {
    ip: '',
    qrcode: '',
    authCheckInterval: null
};

// ç™½åå•ç®¡ç†ç›¸å…³å˜é‡
let existingIpList = [];  // å­˜å‚¨å½“å‰å·²æœ‰çš„IPåˆ—è¡¨
let newIpInputCount = 0;  // æ–°å¢è¾“å…¥æ¡†è®¡æ•°å™¨

// å®Œå…¨è‡ªå®šä¹‰çš„æ¨¡æ€æ¡†ç®¡ç†ç³»ç»Ÿ
let customModal = {
    element: null,
    isVisible: false
};

// åˆ›å»ºè‡ªå®šä¹‰æ¨¡æ€æ¡†
function createCustomModal() {
    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§æ¨¡æ€æ¡†
    destroyCustomModal();
    
    // åˆ›å»ºæ¨¡æ€æ¡†HTMLç»“æ„
    const modalHTML = `
        <div id="customAuthModal" style="
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(0, 0, 0, 0.6) !important;
            z-index: 9999 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: none !important;
            animation: none !important;
            transform: none !important;
        ">
            <div id="customModalDialog" style="
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
                margin: 20px;
            ">
                <div id="customModalHeader" style="
                    padding: 15px 20px;
                    border-bottom: 1px solid #dee2e6;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <h5 id="customModalTitle" style="margin: 0; font-size: 1.1rem;">
                        <i class="bi bi-shield-check"></i> IPæˆæƒ
                    </h5>
                    <button id="customModalClose" style="
                        background: none;
                        border: none;
                        font-size: 1.5rem;
                        cursor: pointer;
                        color: #6c757d;
                        padding: 0;
                        width: 30px;
                        height: 30px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " title="å…³é—­">
                        Ã—
                    </button>
                </div>
                <div id="customModalBody" style="
                    padding: 20px;
                    text-align: center;
                ">
                    <div id="modalContent">
                        <!-- åŠ¨æ€å†…å®¹å°†åœ¨è¿™é‡Œ -->
                    </div>
                </div>
                <div id="customModalFooter" style="
                    padding: 15px 20px;
                    border-top: 1px solid #dee2e6;
                    text-align: right;
                ">
                    <button id="customModalCancel" class="btn btn-secondary" style="margin-right: 10px;">
                        å–æ¶ˆ
                    </button>
                    <button id="customModalRetry" class="btn btn-primary" style="display: none;">
                        <i class="bi bi-arrow-clockwise"></i> é‡è¯•
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // åˆ›å»ºæ¨¡æ€æ¡†å…ƒç´ 
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    const modalElement = modalContainer.firstElementChild;
    
    // ç»‘å®šäº‹ä»¶
    modalElement.querySelector('#customModalClose').addEventListener('click', destroyCustomModal);
    modalElement.querySelector('#customModalCancel').addEventListener('click', destroyCustomModal);
    modalElement.querySelector('#customModalRetry').addEventListener('click', retryCurrentOperation);
    
    // ç‚¹å‡»èƒŒæ™¯å…³é—­
    modalElement.addEventListener('click', function(e) {
        if (e.target === modalElement) {
            destroyCustomModal();
        }
    });
    
    // é˜»æ­¢å¯¹è¯æ¡†å†…éƒ¨ç‚¹å‡»äº‹ä»¶å†’æ³¡
    modalElement.querySelector('#customModalDialog').addEventListener('click', function(e) {
        e.stopPropagation();
    });
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(modalElement);
    document.body.style.overflow = 'hidden';
    
    customModal.element = modalElement;
    customModal.isVisible = true;
    
    return modalElement;
}

// é”€æ¯è‡ªå®šä¹‰æ¨¡æ€æ¡†
function destroyCustomModal() {
    if (customModal.element) {
        // æ¸…ç†å®šæ—¶å™¨
        if (deleteIpData.authCheckInterval) {
            clearInterval(deleteIpData.authCheckInterval);
            deleteIpData.authCheckInterval = null;
        }
        
        // ç§»é™¤æ¨¡æ€æ¡†
        customModal.element.remove();
        customModal.element = null;
        customModal.isVisible = false;
        
        // æ¢å¤é¡µé¢æ»šåŠ¨
        document.body.style.overflow = '';
    }
}

// æ˜¾ç¤ºè‡ªå®šä¹‰æ¨¡æ€æ¡†
function showCustomModal(title, content) {
    const modal = createCustomModal();
    
    // è®¾ç½®æ ‡é¢˜å’Œå†…å®¹
    modal.querySelector('#customModalTitle').innerHTML = title;
    modal.querySelector('#modalContent').innerHTML = content;
    
    return modal;
}

// æ›´æ–°æ¨¡æ€æ¡†å†…å®¹
function updateModalContent(content) {
    if (customModal.element) {
        customModal.element.querySelector('#modalContent').innerHTML = content;
    }
}

// æ˜¾ç¤ºé‡è¯•æŒ‰é’®
function showRetryButton() {
    if (customModal.element) {
        customModal.element.querySelector('#customModalRetry').style.display = 'inline-block';
    }
}

// éšè—é‡è¯•æŒ‰é’®
function hideRetryButton() {
    if (customModal.element) {
        customModal.element.querySelector('#customModalRetry').style.display = 'none';
    }
}

// é‡è¯•å½“å‰æ“ä½œ
function retryCurrentOperation() {
    if (deleteIpData.ip) {
        // åˆ é™¤IPé‡è¯•
        showAuthLoading('æ­£åœ¨é‡æ–°è·å–åˆ é™¤æˆæƒäºŒç»´ç ...');
        getDeleteQrCode();
    } else if (deleteIpData.batchIpList && deleteIpData.batchIpList.length > 0) {
        // æ‰¹é‡æ·»åŠ é‡è¯•
        showAuthLoading('æ­£åœ¨é‡æ–°è·å–æ‰¹é‡æ·»åŠ æˆæƒäºŒç»´ç ...');
        getBatchAddQrCode();
    }
}

// æ˜¾ç¤ºæˆæƒåŠ è½½çŠ¶æ€
function showAuthLoading(message = 'æ­£åœ¨è·å–æˆæƒäºŒç»´ç ...') {
    if (!customModal.element) return;
    
    const loadingContent = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">${message}</span>
            </div>
            <div class="mt-2">${message}</div>
        </div>
    `;
    
    updateModalContent(loadingContent);
    hideRetryButton();
}

// æ˜¾ç¤ºæˆæƒæˆåŠŸçŠ¶æ€
function showAuthSuccess(message) {
    if (!customModal.element) return;
    
    const successContent = `
        <div class="text-center">
            <div class="alert alert-success">
                <i class="bi bi-check-circle text-success"></i>
                ${message}
            </div>
        </div>
    `;
    
    updateModalContent(successContent);
    hideRetryButton();
}

// æ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€
function showProcessing(message) {
    if (!customModal.element) return;
    
    const processingContent = `
        <div class="text-center">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">${message}</span>
            </div>
            <div class="mt-2 text-success">
                <i class="bi bi-check-circle"></i> ${message}
            </div>
        </div>
    `;
    
    updateModalContent(processingContent);
    hideRetryButton();
}

// å…¼å®¹æ—§çš„å‡½æ•°è°ƒç”¨
function closeModal(modalElement) {
    destroyCustomModal();
}

function forceCloseModal(modalElement) {
    destroyCustomModal();
}

function forceShowModal(modalElement, title, content) {
    showCustomModal(title, content);
}

// æ·»åŠ æ–°çš„IPè¾“å…¥æ¡†
function addNewIpInput() {
    newIpInputCount++;
    const table = $.get('openapi-whitelist-table');
    
    // åˆ›å»ºæ–°çš„è¾“å…¥è¡Œ
    const row = document.createElement('tr');
    row.className = 'new-ip-input-row';
    row.id = `new-ip-row-${newIpInputCount}`;
    row.innerHTML = `
        <td>
            <div class="input-group">
                <input type="text" class="form-control new-ip-input" 
                       placeholder="è¯·è¾“å…¥IPåœ°å€ï¼Œå¦‚ï¼š192.168.1.100" 
                       id="new-ip-${newIpInputCount}"
                       onkeypress="handleIpInputKeypress(event, ${newIpInputCount})">
                <span class="input-group-text bg-success text-white">
                    <i class="bi bi-plus-lg"></i>
                </span>
            </div>
        </td>
        <td>
            <button class="btn btn-outline-danger btn-sm" onclick="removeIpInput(${newIpInputCount})">
                <i class="bi bi-x-lg"></i> ç§»é™¤
            </button>
        </td>
    `;
    
    // æ’å…¥åˆ°è¡¨æ ¼é¡¶éƒ¨ï¼ˆç°æœ‰IPä¹‹å‰ï¼‰
    table.insertBefore(row, table.firstChild);
    
    // èšç„¦åˆ°æ–°è¾“å…¥æ¡†
    setTimeout(() => $.get(`new-ip-${newIpInputCount}`).focus(), 100);
    
    // æ˜¾ç¤ºæ‰¹é‡æ·»åŠ æŒ‰é’®
    updateBatchAddButtonVisibility();
}

// ç§»é™¤IPè¾“å…¥æ¡†
function removeIpInput(inputId) {
    const row = $.get(`new-ip-row-${inputId}`);
    if (row) row.remove();
    updateBatchAddButtonVisibility();
}

// å¤„ç†IPè¾“å…¥æ¡†çš„é”®ç›˜äº‹ä»¶
function handleIpInputKeypress(event, inputId) {
    if (event.key === 'Enter') {
        // å›è½¦é”®è‡ªåŠ¨æ·»åŠ æ–°çš„è¾“å…¥æ¡†
        addNewIpInput();
    }
}

// æ›´æ–°æ‰¹é‡æ·»åŠ æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
function updateBatchAddButtonVisibility() {
    const inputRows = document.querySelectorAll('.new-ip-input-row');
    const batchButton = $.get('batch-add-ips-btn');
    
    batchButton.style.display = inputRows.length > 0 ? 'inline-block' : 'none';
}

// æ¸…ç©ºæ‰€æœ‰è¾“å…¥
function clearAllInputs() {
    const inputRows = document.querySelectorAll('.new-ip-input-row');
    inputRows.forEach(row => row.remove());
    newIpInputCount = 0;
    updateBatchAddButtonVisibility();
}

// IPéªŒè¯å·¥å…·
const IPValidator = {
    isValid(ip) {
        const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
        if (!ipRegex.test(ip)) return false;
        
        return ip.split('.').every(part => parseInt(part) <= 255);
    },
    
    getValidIps() {
        const inputs = document.querySelectorAll('.new-ip-input');
        const validIps = [];
        const invalidIps = [];
        
        inputs.forEach(input => {
            const ip = input.value.trim();
            if (!ip) return;
            
            if (this.isValid(ip)) {
                if (!existingIpList.includes(ip) && !validIps.includes(ip)) {
                    validIps.push(ip);
                }
            } else {
                invalidIps.push(ip);
            }
        });
        
        return { validIps, invalidIps };
    }
};

// è·å–æ‰€æœ‰æ–°è¾“å…¥çš„IPåœ°å€
function getNewIpAddresses() {
    return IPValidator.getValidIps().validIps;
}

// æ‰¹é‡æ·»åŠ IP
function batchAddIps() {
    const { validIps: newIps, invalidIps } = IPValidator.getValidIps();
    
    if (newIps.length === 0) {
        alert('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„IPåœ°å€');
        return;
    }
    
    if (invalidIps.length > 0) {
        alert(`ä»¥ä¸‹IPåœ°å€æ ¼å¼æ— æ•ˆï¼š\n${invalidIps.join('\n')}\n\nè¯·ä¿®æ­£åé‡è¯•ã€‚`);
        return;
    }
    
    // æ£€æŸ¥é‡å¤IP
    const duplicateIps = newIps.filter(ip => existingIpList.includes(ip));
    if (duplicateIps.length > 0) {
        alert(`ä»¥ä¸‹IPåœ°å€å·²å­˜åœ¨ï¼š\n${duplicateIps.join('\n')}\n\nå°†è·³è¿‡è¿™äº›IPåœ°å€ã€‚`);
    }
    
    const finalIpList = newIps.filter(ip => !existingIpList.includes(ip));
    if (finalIpList.length === 0) {
        alert('æ²¡æœ‰æ–°çš„IPåœ°å€éœ€è¦æ·»åŠ ');
        return;
    }
    
    // ç¡®è®¤æ·»åŠ 
    if (!confirm(`ç¡®è®¤æ‰¹é‡æ·»åŠ ä»¥ä¸‹ ${finalIpList.length} ä¸ªIPåœ°å€å—ï¼Ÿ\n\n${finalIpList.join('\n')}\n\næ³¨æ„ï¼šæ­¤æ“ä½œéœ€è¦äºŒç»´ç æˆæƒã€‚`)) {
        return;
    }
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    const batchButton = $.get('batch-add-ips-btn');
    batchButton.disabled = true;
    batchButton.innerHTML = '<i class="bi bi-hourglass"></i> è·å–æˆæƒä¸­...';
    
    // å¯åŠ¨æ‰¹é‡æ·»åŠ æµç¨‹
    startBatchAddProcess(finalIpList);
}

// å¯åŠ¨æ‰¹é‡æ·»åŠ æµç¨‹
function startBatchAddProcess(newIpList) {
    // å­˜å‚¨è¦æ·»åŠ çš„IPåˆ—è¡¨
    deleteIpData.batchIpList = newIpList;
    
    // æ–°çš„è‡ªå®šä¹‰æ¨¡æ€æ¡†ä¼šè‡ªåŠ¨é‡ç½®çŠ¶æ€
    
    // ä½¿ç”¨æ–°çš„è‡ªå®šä¹‰æ¨¡æ€æ¡†ç³»ç»Ÿ
    const title = '<i class="bi bi-shield-check"></i> æ‰¹é‡æ·»åŠ IPæˆæƒ';
    const content = `
        <div class="mb-3">
            <strong>æ‰¹é‡æ·»åŠ  ${newIpList.length} ä¸ªIPåœ°å€ï¼š</strong><br>
            <small class="text-muted">${newIpList.join(', ')}</small>
        </div>
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">æ­£åœ¨è·å–æˆæƒäºŒç»´ç ...</span>
            </div>
            <div class="mt-2">æ­£åœ¨è·å–æˆæƒäºŒç»´ç ...</div>
        </div>
    `;
    showCustomModal(title, content);
    
    // è·å–æ‰¹é‡æ·»åŠ æˆæƒäºŒç»´ç 
    getBatchAddQrCode();
}

// è·å–æ‰¹é‡æ·»åŠ æˆæƒäºŒç»´ç 
async function getBatchAddQrCode() {
    try {
        const data = await API.request('/get_delete_qr', { appid: currentWhitelistAppId });
        if (data.success) {
            deleteIpData.qrcode = data.qrcode;
            showDeleteQrCode(data.url);
            startBatchAddAuthCheck();
        } else {
            showDeleteQrError(API.handleError(data, 'è·å–æˆæƒäºŒç»´ç å¤±è´¥'));
        }
    } catch (error) {
        console.error('è·å–æ‰¹é‡æ·»åŠ æˆæƒäºŒç»´ç å¤±è´¥:', error);
        showDeleteQrError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
    }
}

// å¼€å§‹æ£€æŸ¥æ‰¹é‡æ·»åŠ æˆæƒçŠ¶æ€
function startBatchAddAuthCheck() {
    if (deleteIpData.authCheckInterval) {
        clearInterval(deleteIpData.authCheckInterval);
    }
    
    deleteIpData.authCheckInterval = setInterval(checkBatchAddAuthStatus, 3000);
}

// æ£€æŸ¥æ‰¹é‡æ·»åŠ æˆæƒçŠ¶æ€
async function checkBatchAddAuthStatus() {
    if (!deleteIpData.qrcode) return;
    
    try {
        const data = await API.request('/check_delete_auth', {
            appid: currentWhitelistAppId,
            qrcode: deleteIpData.qrcode
        });
        
        if (data.success && data.authorized) {
            clearInterval(deleteIpData.authCheckInterval);
            deleteIpData.authCheckInterval = null;
            showAuthSuccess('æˆæƒæˆåŠŸï¼Œæ­£åœ¨æ‰¹é‡æ·»åŠ IP...');
            executeBatchAddIp();
        } else if (data.error) {
            clearInterval(deleteIpData.authCheckInterval);
            deleteIpData.authCheckInterval = null;
            showDeleteQrError(API.handleError(data, 'æˆæƒå¤±è´¥ï¼Œè¯·é‡è¯•'));
        }
    } catch (error) {
        console.error('æ£€æŸ¥æ‰¹é‡æ·»åŠ æˆæƒçŠ¶æ€å¤±è´¥:', error);
    }
}

// æ‰§è¡Œæ‰¹é‡æ·»åŠ IPæ“ä½œ
async function executeBatchAddIp() {
    const allIpList = [...existingIpList, ...deleteIpData.batchIpList];
    
    try {
        const data = await API.request('/batch_add_whitelist', {
            appid: currentWhitelistAppId,
            ip_list: allIpList,
            qrcode: deleteIpData.qrcode
        });
        
        if (data.success) {
            showAuthSuccess(`æˆåŠŸæ·»åŠ  ${deleteIpData.batchIpList.length} ä¸ªIPåœ°å€ï¼`);
            
            setTimeout(() => {
                destroyCustomModal();
                clearAllInputs();
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const batchButton = $.get('batch-add-ips-btn');
                batchButton.disabled = false;
                batchButton.innerHTML = '<i class="bi bi-shield-check"></i> æ‰¹é‡æ·»åŠ IP (éœ€è¦æˆæƒ)';
                // åˆ·æ–°ç™½åå•åˆ—è¡¨
                getBotWhitelist(currentWhitelistAppId, currentWhitelistAppName);
            }, 1500);
        } else {
            showDeleteQrError(API.handleError(data, 'æ‰¹é‡æ·»åŠ IPå¤±è´¥'));
        }
    } catch (error) {
        console.error('æ‰¹é‡æ·»åŠ IPå¤±è´¥:', error);
        showDeleteQrError('æ‰¹é‡æ·»åŠ IPæ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯');
    }
}

// åˆ é™¤ç™½åå•IP - å¯åŠ¨äºŒç»´ç æˆæƒæµç¨‹
function deleteWhitelistIp(ipAddress, index, buttonElement) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤IP "${ipAddress}" å—ï¼Ÿ\n\néœ€è¦æ‰«æäºŒç»´ç è¿›è¡Œæˆæƒç¡®è®¤ã€‚`)) {
        return;
    }
    
    // å­˜å‚¨åˆ é™¤çš„IPä¿¡æ¯
    deleteIpData.ip = ipAddress;
    deleteIpData.qrcode = '';
    
    // ä½¿ç”¨æ–°çš„è‡ªå®šä¹‰æ¨¡æ€æ¡†ç³»ç»Ÿ
    const title = '<i class="bi bi-trash"></i> åˆ é™¤IPæˆæƒ';
    const content = `
        <div class="mb-3">
            <strong>ç¡®è®¤åˆ é™¤IPåœ°å€ï¼š<span class="text-danger">${ipAddress}</span></strong>
        </div>
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">æ­£åœ¨è·å–æˆæƒäºŒç»´ç ...</span>
            </div>
            <div class="mt-2">æ­£åœ¨è·å–æˆæƒäºŒç»´ç ...</div>
        </div>
    `;
    showCustomModal(title, content);
    
    // è·å–åˆ é™¤æˆæƒäºŒç»´ç 
    getDeleteQrCode();
}

// resetDeleteQrModalå‡½æ•°å·²ä¸å†éœ€è¦ - ä½¿ç”¨æ–°çš„è‡ªå®šä¹‰æ¨¡æ€æ¡†ç³»ç»Ÿ

// è·å–åˆ é™¤æˆæƒäºŒç»´ç 
async function getDeleteQrCode() {
    try {
        const data = await API.request('/get_delete_qr', { appid: currentWhitelistAppId });
        if (data.success) {
            deleteIpData.qrcode = data.qrcode;
            showDeleteQrCode(data.url);
            startDeleteAuthCheck();
        } else {
            showDeleteQrError(API.handleError(data, 'è·å–æˆæƒäºŒç»´ç å¤±è´¥'));
        }
    } catch (error) {
        console.error('è·å–åˆ é™¤æˆæƒäºŒç»´ç å¤±è´¥:', error);
        showDeleteQrError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
    }
}

// é€šç”¨äºŒç»´ç ç”Ÿæˆå‡½æ•° - ä½¿ç”¨å¿«é€Ÿ2dcode.biz APIæ¥å£
function generateQRCodeToElement(url, targetElement, options = {}) {
    const {
        size = 200,
        margin = 10,
        showFailureText = true,
        failureText = 'äºŒç»´ç ç”Ÿæˆå¤±è´¥',
        showLinkButton = true,
        linkButtonText = 'æ‰“å¼€æˆæƒé“¾æ¥'
    } = options;
    
    // æ¸…ç©ºç›®æ ‡å…ƒç´ 
    targetElement.innerHTML = '';
    
    // ä½¿ç”¨å¿«é€ŸäºŒç»´ç API
    const qrApiUrl = `https://api.2dcode.biz/v1/create-qr-code?data=${encodeURIComponent(url)}`;
    
    // åˆ›å»ºäºŒç»´ç å›¾ç‰‡
    const qrImg = document.createElement('img');
    qrImg.src = qrApiUrl;
    qrImg.alt = 'äºŒç»´ç ';
    qrImg.style.width = size + 'px';
    qrImg.style.height = size + 'px';
    qrImg.style.border = '1px solid #ddd';
    qrImg.style.borderRadius = '8px';
    qrImg.style.display = 'block';
    qrImg.style.margin = '0 auto';
    
    // ç›‘å¬å›¾ç‰‡åŠ è½½æˆåŠŸ
    qrImg.onload = function() {
        targetElement.appendChild(qrImg);
    };
    
    // ç›‘å¬å›¾ç‰‡åŠ è½½å¤±è´¥
    qrImg.onerror = function() {
        console.error('äºŒç»´ç APIå¤±è´¥ï¼Œæ˜¾ç¤ºå¤‡ç”¨æ–¹æ¡ˆ');
        
        // æ„å»ºå¤‡ç”¨æ–¹æ¡ˆHTML
        let fallbackHtml = `
            <div class="border p-3" style="width: ${size}px; height: ${size}px; background: #f8f9fa; margin: 0 auto;">
                <div class="text-center h-100 d-flex align-items-center justify-content-center">
                    <div>
                        <i class="bi bi-qr-code text-muted" style="font-size: 3rem;"></i>
        `;
        
        if (showFailureText) {
            fallbackHtml += `<div class="mt-2 text-muted">${failureText}</div>`;
        }
        
        if (showLinkButton) {
            fallbackHtml += `
                <div class="mt-2">
                    <a href="${url}" target="_blank" class="btn btn-primary btn-sm">
                        <i class="bi bi-box-arrow-up-right"></i> ${linkButtonText}
                    </a>
                </div>
            `;
        }
        
        fallbackHtml += `
                    </div>
                </div>
            </div>
        `;
        
        targetElement.innerHTML = fallbackHtml;
    };
}

// æ˜¾ç¤ºåˆ é™¤æˆæƒäºŒç»´ç 
function showDeleteQrCode(qrUrl) {
    if (!customModal.element) return;
    
    // åˆ›å»ºäºŒç»´ç å†…å®¹
    const qrContent = `
        <div class="mb-3">
            <div class="d-flex justify-content-center mb-3">
                <div id="qrCodeContainer"></div>
            </div>
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                è¯·ä½¿ç”¨QQæ‰«æäºŒç»´ç è¿›è¡Œæˆæƒ
            </div>
            <div class="text-muted">
                <i class="bi bi-hourglass"></i> ç­‰å¾…æˆæƒä¸­...
            </div>
        </div>
    `;
    
    updateModalContent(qrContent);
    hideRetryButton();
    
    // ç”ŸæˆäºŒç»´ç 
    const qrCodeDiv = customModal.element.querySelector('#qrCodeContainer');
    generateQRCodeToElement(qrUrl, qrCodeDiv, {
        size: 200,
        margin: 10,
        failureText: 'æˆæƒäºŒç»´ç ç”Ÿæˆå¤±è´¥',
        linkButtonText: 'æ‰“å¼€æˆæƒé“¾æ¥'
    });
}

// æ˜¾ç¤ºåˆ é™¤æˆæƒäºŒç»´ç é”™è¯¯
function showDeleteQrError(message) {
    if (!customModal.element) return;
    
    const errorContent = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i>
            ${message}
        </div>
    `;
    
    updateModalContent(errorContent);
    showRetryButton();
}

// é‡è¯•è·å–åˆ é™¤æˆæƒäºŒç»´ç 
function retryGetDeleteQr() {
    showAuthLoading('æ­£åœ¨é‡æ–°è·å–åˆ é™¤æˆæƒäºŒç»´ç ...');
    getDeleteQrCode();
}

// å¼€å§‹æ£€æŸ¥åˆ é™¤æˆæƒçŠ¶æ€
function startDeleteAuthCheck() {
    if (deleteIpData.authCheckInterval) {
        clearInterval(deleteIpData.authCheckInterval);
    }
    
    deleteIpData.authCheckInterval = setInterval(checkDeleteAuthStatus, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡
}

// æ£€æŸ¥åˆ é™¤æˆæƒçŠ¶æ€
async function checkDeleteAuthStatus() {
    if (!deleteIpData.qrcode) return;
    
    try {
        const data = await API.request('/check_delete_auth', {
            appid: currentWhitelistAppId,
            qrcode: deleteIpData.qrcode
        });
        
        if (data.success && data.authorized) {
            clearInterval(deleteIpData.authCheckInterval);
            deleteIpData.authCheckInterval = null;
            showAuthSuccess('æˆæƒæˆåŠŸï¼Œæ­£åœ¨åˆ é™¤IP...');
            executeDeleteIp();
        } else if (data.error) {
            clearInterval(deleteIpData.authCheckInterval);
            deleteIpData.authCheckInterval = null;
            showDeleteQrError(API.handleError(data, 'æˆæƒå¤±è´¥ï¼Œè¯·é‡è¯•'));
        }
    } catch (error) {
        console.error('æ£€æŸ¥åˆ é™¤æˆæƒçŠ¶æ€å¤±è´¥:', error);
    }
}

// æ‰§è¡Œåˆ é™¤IPæ“ä½œ
async function executeDeleteIp() {
    try {
        const data = await API.request('/execute_delete_ip', {
            appid: currentWhitelistAppId,
            ip: deleteIpData.ip,
            qrcode: deleteIpData.qrcode
        });
        
        if (data.success) {
            showAuthSuccess('IPåˆ é™¤æˆåŠŸï¼');
            setTimeout(() => {
                destroyCustomModal();
                getBotWhitelist(currentWhitelistAppId, currentWhitelistAppName);
            }, 1000);
        } else {
            showDeleteQrError(API.handleError(data, 'åˆ é™¤IPå¤±è´¥'));
        }
    } catch (error) {
        console.error('åˆ é™¤IPå¤±è´¥:', error);
        showDeleteQrError('åˆ é™¤IPæ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯');
    }
}

// æŸ¥çœ‹æœºå™¨äººæ¨¡æ¿
async function viewBotTemplates(appId, botName) {
    DataArea.show(`<i class="bi bi-layout-text-sidebar-reverse"></i> ${botName} - æ¨¡æ¿ç®¡ç†`);
    
    try {
        const data = await API.request('/get_templates', { appid: appId });
        if (data.success) {
            currentTemplates = data.templates || [];
            displayTemplates(currentTemplates);
            DataArea.showContainer('templates');
        } else {
            alert('è·å–æ¨¡æ¿åˆ—è¡¨å¤±è´¥ï¼š' + API.handleError(data, 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–é‡æ–°ç™»å½•'));
        }
    } catch (error) {
        console.error('è·å–æ¨¡æ¿åˆ—è¡¨å¤±è´¥:', error);
        $.hide('openapi-data-loading');
        alert('è·å–æ¨¡æ¿åˆ—è¡¨å¤±è´¥');
    }
}



// æŸ¥çœ‹æ¨¡æ¿è¯¦æƒ…
function viewTemplateDetail(index) {
    if (!currentTemplates || index >= currentTemplates.length) return;
    
    currentTemplateIndex = index;
    const template = currentTemplates[index];
    
    // æ›´æ–°æ¨¡æ¿è¯¦æƒ…
    $.setText('template-detail-index', `${index + 1}/${currentTemplates.length}`);
    $.setText('template-detail-id', template.id || '-');
    $.setText('template-detail-name', template.name || '-');
    $.setHtml('template-detail-type', `<span class="badge ${template.type === 'æŒ‰é’®æ¨¡æ¿' ? 'bg-info' : 'bg-secondary'}">${template.type}</span>`);
    $.setText('template-detail-status', template.status || '-');
    $.setText('template-detail-create-time', template.create_time || '-');
    $.setText('template-detail-content', JSON.stringify(template.content, null, 2) || '-');
    
    // æ˜¾ç¤ºæŒ‰é’®é¢„è§ˆ
    const buttonPreview = $.get('template-button-preview');
    if (template.type === 'button' && template.content && template.content.buttons) {
        displayButtonPreview(template.content.buttons);
        $.show('template-button-preview');
    } else {
        $.hide('template-button-preview');
    }
    
    // æ›´æ–°å¯¼èˆªæŒ‰é’®
    const prevBtn = $.get('template-prev-btn');
    const nextBtn = $.get('template-next-btn');
    
    if (currentTemplates.length > 1) {
        prevBtn.style.display = index > 0 ? 'inline-block' : 'none';
        nextBtn.style.display = index < currentTemplates.length - 1 ? 'inline-block' : 'none';
        
        prevBtn.onclick = () => viewTemplateDetail(index - 1);
        nextBtn.onclick = () => viewTemplateDetail(index + 1);
    } else {
        $.hide('template-prev-btn');
        $.hide('template-next-btn');
    }
    
    // æ˜¾ç¤ºè¯¦æƒ…åŒºåŸŸ
    $.show('openapi-template-detail');
}

// æ˜¾ç¤ºæŒ‰é’®é¢„è§ˆ
function displayButtonPreview(buttons) {
    const container = $.get('template-button-rows');
    
    if (!buttons || !Array.isArray(buttons)) {
        container.innerHTML = '<p class="text-muted">æ— æŒ‰é’®æ•°æ®</p>';
        return;
    }
    
    const html = buttons.map(row => {
        if (!Array.isArray(row)) return '';
        
        const buttonHtml = row.map(button => {
            const typeText = button.type === 0 ? 'é“¾æ¥' : (button.type === 1 ? 'å›è°ƒ' : 'å‘½ä»¤');
            return `
                <button class="btn btn-outline-secondary btn-sm me-1" disabled>
                    ${button.label || 'æŒ‰é’®'} <small>(${typeText})</small>
                </button>
            `;
        }).join('');
        
        return `<div class="mb-2">${buttonHtml}</div>`;
    }).join('');
    
    container.innerHTML = html || '<p class="text-muted">æ— æœ‰æ•ˆæŒ‰é’®</p>';
}

// å…³é—­æ•°æ®åŒºåŸŸ
function closeDataSection() {
    $.hide('openapi-data-section');
}

// æ•°å­—æ ¼å¼åŒ–
function formatNumber(num) {
    if (num >= 10000) {
        return (num / 10000).toFixed(2).replace(/\.?0+$/, '') + 'w';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(2).replace(/\.?0+$/, '') + 'k';
    } else {
        return num.toString();
    }
}

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initOpenAPI();
    
    // å¼€æ”¾å¹³å°é¡µé¢ä¸éœ€è¦å®æ—¶WebSocketè¿æ¥
    // initSocket('openapi');
});
</script>
{% endblock %}