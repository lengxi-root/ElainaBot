<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>插件市场 - ElainaBot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { --primary: #7c3aed; --primary-light: #a78bfa; }
        body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: #e2e8f0; }
        .navbar { background: rgba(30, 30, 50, 0.95) !important; backdrop-filter: blur(10px); }
        .card { background: rgba(30, 30, 50, 0.8); border: 1px solid rgba(124, 58, 237, 0.3); border-radius: 12px; transition: all 0.3s; }
        .card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 40px rgba(124, 58, 237, 0.2); }
        .btn-primary { background: var(--primary); border: none; }
        .btn-primary:hover { background: var(--primary-light); }
        .badge-official { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .badge-warning { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .badge-approved { background: linear-gradient(135deg, #10b981, #059669); }
        .search-box { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; }
        .search-box:focus { background: rgba(255,255,255,0.15); border-color: var(--primary); color: #fff; box-shadow: none; }
        .category-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #e2e8f0; }
        .category-btn:hover, .category-btn.active { background: var(--primary); border-color: var(--primary); color: #fff; }
        .plugin-icon { width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .modal-content { background: #1a1a2e; border: 1px solid rgba(124, 58, 237, 0.3); }
        .form-control, .form-select { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; }
        .form-control:focus, .form-select:focus { background: rgba(255,255,255,0.15); border-color: var(--primary); color: #fff; }
        .repo-icon { font-size: 1.2em; }
        .download-count { font-size: 0.85em; color: #94a3b8; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="bi bi-box-seam me-2"></i>ElainaBot 插件市场</a>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-light btn-sm" onclick="showSubmitModal()">
                    <i class="bi bi-plus-lg me-1"></i>提交插件
                </button>
                <button class="btn btn-outline-warning btn-sm" onclick="showAdminModal()" id="adminBtn" style="display:none;">
                    <i class="bi bi-shield-check me-1"></i>审核管理
                </button>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <!-- 搜索和筛选 -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3 mb-md-0">
                <div class="input-group">
                    <span class="input-group-text bg-transparent border-end-0" style="border-color: rgba(255,255,255,0.2);"><i class="bi bi-search text-white"></i></span>
                    <input type="text" class="form-control search-box border-start-0" placeholder="搜索插件..." id="searchInput" onkeyup="debounceSearch()">
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex gap-2 flex-wrap" id="categoryBtns">
                    <button class="btn btn-sm category-btn active" data-category="">全部</button>
                </div>
            </div>
        </div>

        <!-- 插件列表 -->
        <div class="row g-4" id="pluginList">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3 text-muted">加载中...</p>
            </div>
        </div>
    </div>

    <!-- 提交插件模态框 -->
    <div class="modal fade" id="submitModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>提交插件</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="submitForm">
                        <div class="mb-3">
                            <label class="form-label">插件名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="name" required placeholder="如：天气查询">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">插件描述 <span class="text-danger">*</span></label>
                            <textarea class="form-control" name="description" rows="3" required placeholder="简要描述插件功能"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">作者 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="author" required placeholder="你的名字或昵称">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">版本号</label>
                            <input type="text" class="form-control" name="version" value="1.0.0" placeholder="1.0.0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">下载链接 <span class="text-danger">*</span></label>
                            <input type="url" class="form-control" name="download_url" required placeholder="GitHub/Gitee/GitCode 链接或直链">
                            <div class="form-text text-muted">支持 GitHub、Gitee、GitCode 仓库链接或 .py/.zip 直链</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">分类</label>
                            <select class="form-select" name="category" id="submitCategory"></select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitPlugin()">
                        <i class="bi bi-send me-1"></i>提交
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 管理员模态框 -->
    <div class="modal fade" id="adminModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title"><i class="bi bi-shield-check me-2"></i>审核管理</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="adminTabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#pendingTab">待审核</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#allTab">所有插件</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="pendingTab">
                            <div id="pendingList"></div>
                        </div>
                        <div class="tab-pane fade" id="allTab">
                            <div id="allPluginsList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/web/api/market';
        let adminToken = localStorage.getItem('market_admin_token') || '';
        let categories = [];
        let currentCategory = '';
        let searchTimeout = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            loadPlugins();
            checkAdmin();
        });

        // 检查管理员
        function checkAdmin() {
            if (adminToken) {
                document.getElementById('adminBtn').style.display = 'block';
            }
            // 双击标题进入管理模式
            document.querySelector('.navbar-brand').addEventListener('dblclick', () => {
                const token = prompt('请输入管理员密钥:');
                if (token) {
                    adminToken = token;
                    localStorage.setItem('market_admin_token', token);
                    document.getElementById('adminBtn').style.display = 'block';
                }
            });
        }

        // 加载分类
        async function loadCategories() {
            try {
                const res = await fetch(`${API_BASE}/categories`);
                const data = await res.json();
                if (data.success) {
                    categories = data.categories;
                    renderCategories();
                }
            } catch (e) {
                console.error('加载分类失败:', e);
            }
        }

        // 渲染分类按钮
        function renderCategories() {
            const container = document.getElementById('categoryBtns');
            let html = '<button class="btn btn-sm category-btn active" data-category="" onclick="filterCategory(this, \'\')">全部</button>';
            categories.forEach(cat => {
                html += `<button class="btn btn-sm category-btn" data-category="${cat}" onclick="filterCategory(this, '${cat}')">${cat}</button>`;
            });
            container.innerHTML = html;
            
            // 填充提交表单的分类
            const select = document.getElementById('submitCategory');
            select.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        // 筛选分类
        function filterCategory(btn, category) {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentCategory = category;
            loadPlugins();
        }

        // 搜索防抖
        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(loadPlugins, 300);
        }

        // 加载插件列表
        async function loadPlugins() {
            const search = document.getElementById('searchInput').value;
            let url = `${API_BASE}/list?`;
            if (currentCategory) url += `category=${encodeURIComponent(currentCategory)}&`;
            if (search) url += `search=${encodeURIComponent(search)}&`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.success) {
                    renderPlugins(data.plugins);
                }
            } catch (e) {
                console.error('加载插件失败:', e);
                document.getElementById('pluginList').innerHTML = '<div class="col-12 text-center py-5 text-danger">加载失败，请刷新重试</div>';
            }
        }

        // 渲染插件列表
        function renderPlugins(plugins) {
            const container = document.getElementById('pluginList');
            if (!plugins.length) {
                container.innerHTML = '<div class="col-12 text-center py-5 text-muted"><i class="bi bi-inbox fs-1 d-block mb-3"></i>暂无插件</div>';
                return;
            }

            container.innerHTML = plugins.map(p => `
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 p-3">
                        <div class="d-flex align-items-start mb-3">
                            <div class="plugin-icon me-3">
                                ${getRepoIcon(p.repo_type)}
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${escapeHtml(p.name)} 
                                    ${getStatusBadge(p.status)}
                                </h6>
                                <small class="text-muted">by ${escapeHtml(p.author)} · v${p.version}</small>
                            </div>
                        </div>
                        <p class="text-muted small mb-3 flex-grow-1">${escapeHtml(p.description)}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-secondary">${p.category}</span>
                            <div>
                                <span class="download-count me-2"><i class="bi bi-download"></i> ${p.downloads || 0}</span>
                                <button class="btn btn-sm btn-primary" onclick="downloadPlugin('${p.id}', '${escapeHtml(p.download_url)}')">
                                    <i class="bi bi-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 获取仓库图标
        function getRepoIcon(type) {
            const icons = {
                github: '<i class="bi bi-github"></i>',
                gitee: '<i class="bi bi-git"></i>',
                gitcode: '<i class="bi bi-code-square"></i>',
                direct: '<i class="bi bi-link-45deg"></i>'
            };
            return icons[type] || icons.direct;
        }

        // 获取状态徽章
        function getStatusBadge(status) {
            const badges = {
                official: '<span class="badge badge-official ms-1"><i class="bi bi-patch-check-fill"></i> 官方</span>',
                warning: '<span class="badge badge-warning ms-1"><i class="bi bi-exclamation-triangle-fill"></i> 风险</span>',
                approved: ''
            };
            return badges[status] || '';
        }

        // 下载插件
        async function downloadPlugin(id, url) {
            try {
                await fetch(`${API_BASE}/download`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
            } catch (e) {}
            window.open(url, '_blank');
        }

        // 显示提交模态框
        function showSubmitModal() {
            new bootstrap.Modal(document.getElementById('submitModal')).show();
        }

        // 提交插件
        async function submitPlugin() {
            const form = document.getElementById('submitForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const res = await fetch(`${API_BASE}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    alert('提交成功！等待审核');
                    bootstrap.Modal.getInstance(document.getElementById('submitModal')).hide();
                    form.reset();
                } else {
                    alert('提交失败: ' + result.message);
                }
            } catch (e) {
                alert('提交失败: ' + e.message);
            }
        }

        // 显示管理模态框
        async function showAdminModal() {
            const modal = new bootstrap.Modal(document.getElementById('adminModal'));
            modal.show();
            await loadPendingPlugins();
            await loadAllPluginsAdmin();
        }

        // 加载待审核插件
        async function loadPendingPlugins() {
            try {
                const res = await fetch(`${API_BASE}/pending`, {
                    headers: { 'X-Admin-Token': adminToken }
                });
                const data = await res.json();
                if (data.success) {
                    renderPendingPlugins(data.plugins);
                } else {
                    document.getElementById('pendingList').innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                }
            } catch (e) {
                document.getElementById('pendingList').innerHTML = '<div class="alert alert-danger">加载失败</div>';
            }
        }

        // 渲染待审核列表
        function renderPendingPlugins(plugins) {
            const container = document.getElementById('pendingList');
            if (!plugins.length) {
                container.innerHTML = '<div class="text-center text-muted py-4">暂无待审核插件</div>';
                return;
            }
            container.innerHTML = plugins.map(p => `
                <div class="card mb-2 p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${escapeHtml(p.name)}</h6>
                            <small class="text-muted">by ${escapeHtml(p.author)} · ${p.submit_time}</small>
                            <p class="small mb-2 mt-2">${escapeHtml(p.description)}</p>
                            <a href="${escapeHtml(p.download_url)}" target="_blank" class="small">${escapeHtml(p.download_url)}</a>
                        </div>
                        <div class="btn-group-vertical">
                            <button class="btn btn-sm btn-success" onclick="reviewPlugin('${p.id}', 'approve', 'approved')">通过</button>
                            <button class="btn btn-sm btn-warning" onclick="reviewPlugin('${p.id}', 'approve', 'official')">官方</button>
                            <button class="btn btn-sm btn-danger" onclick="reviewPlugin('${p.id}', 'reject')">拒绝</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 审核插件
        async function reviewPlugin(id, action, status = 'approved') {
            try {
                const res = await fetch(`${API_BASE}/review`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Admin-Token': adminToken },
                    body: JSON.stringify({ id, action, status })
                });
                const data = await res.json();
                if (data.success) {
                    await loadPendingPlugins();
                    await loadAllPluginsAdmin();
                    loadPlugins();
                } else {
                    alert(data.message);
                }
            } catch (e) {
                alert('操作失败: ' + e.message);
            }
        }

        // 加载所有插件（管理）
        async function loadAllPluginsAdmin() {
            try {
                const res = await fetch(`${API_BASE}/list`);
                const data = await res.json();
                if (data.success) {
                    renderAllPluginsAdmin(data.plugins);
                }
            } catch (e) {
                document.getElementById('allPluginsList').innerHTML = '<div class="alert alert-danger">加载失败</div>';
            }
        }

        // 渲染所有插件（管理）
        function renderAllPluginsAdmin(plugins) {
            const container = document.getElementById('allPluginsList');
            if (!plugins.length) {
                container.innerHTML = '<div class="text-center text-muted py-4">暂无插件</div>';
                return;
            }
            container.innerHTML = plugins.map(p => `
                <div class="card mb-2 p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">${escapeHtml(p.name)}</span>
                            ${getStatusBadge(p.status)}
                            <small class="text-muted ms-2">by ${escapeHtml(p.author)}</small>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-success" onclick="updateStatus('${p.id}', 'approved')" ${p.status === 'approved' ? 'disabled' : ''}>正常</button>
                            <button class="btn btn-sm btn-outline-warning" onclick="updateStatus('${p.id}', 'official')" ${p.status === 'official' ? 'disabled' : ''}>官方</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="updateStatus('${p.id}', 'warning')" ${p.status === 'warning' ? 'disabled' : ''}>风险</button>
                            <button class="btn btn-sm btn-danger" onclick="deletePlugin('${p.id}')"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 更新状态
        async function updateStatus(id, status) {
            try {
                const res = await fetch(`${API_BASE}/update_status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Admin-Token': adminToken },
                    body: JSON.stringify({ id, status })
                });
                const data = await res.json();
                if (data.success) {
                    await loadAllPluginsAdmin();
                    loadPlugins();
                } else {
                    alert(data.message);
                }
            } catch (e) {
                alert('操作失败: ' + e.message);
            }
        }

        // 删除插件
        async function deletePlugin(id) {
            if (!confirm('确定删除此插件？')) return;
            try {
                const res = await fetch(`${API_BASE}/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Admin-Token': adminToken },
                    body: JSON.stringify({ id })
                });
                const data = await res.json();
                if (data.success) {
                    await loadAllPluginsAdmin();
                    loadPlugins();
                } else {
                    alert(data.message);
                }
            } catch (e) {
                alert('操作失败: ' + e.message);
            }
        }

        // HTML转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
    </script>
</body>
</html>
