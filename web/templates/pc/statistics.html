{% extends "pc/base.html" %}

{% block content %}
<!-- ç»Ÿè®¡é¡µé¢ -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="mb-0">æ•°æ®ç»Ÿè®¡</h5>
    <div class="d-flex gap-2">
        <button class="btn-control btn-warning" id="complete-dau">
            <i class="bi bi-plus-circle"></i> è¡¥å…¨DAU
        </button>
        <button class="btn-control" id="refresh-statistics">
            <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°æ•°æ®
        </button>
    </div>
</div>

<!-- ç»Ÿè®¡å›¾è¡¨ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">æ•°æ®è¶‹åŠ¿å›¾ (æœ€è¿‘30å¤©)</h6>
                <div class="d-flex flex-wrap gap-2 mb-3">
                    <button class="btn btn-sm btn-outline-primary chart-toggle active" data-metric="total_messages">æ€»æ¶ˆæ¯é‡</button>
                    <button class="btn btn-sm btn-outline-primary chart-toggle" data-metric="active_users">æ´»è·ƒç”¨æˆ·æ•°</button>
                    <button class="btn btn-sm btn-outline-primary chart-toggle" data-metric="active_groups">æ´»è·ƒç¾¤èŠæ•°</button>
                    <button class="btn btn-sm btn-outline-primary chart-toggle" data-metric="private_messages">ç§èŠæ¶ˆæ¯æ•°</button>
                    <button class="btn btn-sm btn-outline-primary chart-toggle" data-metric="total_users">æ€»ç”¨æˆ·æ•°</button>
                    <button class="btn btn-sm btn-outline-primary chart-toggle" data-metric="total_groups">æ€»ç¾¤ç»„æ•°</button>
                    <button class="btn btn-sm btn-outline-primary chart-toggle" data-metric="total_friends">æ€»å¥½å‹æ•°</button>
                    <button class="btn btn-sm btn-outline-success chart-toggle" data-metric="group_events">ç¾¤ç»„å˜åŒ–</button>
                    <button class="btn btn-sm btn-outline-info chart-toggle" data-metric="friend_events">å¥½å‹å˜åŒ–</button>
                </div>
                <div class="chart-container position-relative">
                    <div id="chart-average-display" class="chart-average-display"></div>
                    <canvas id="statisticsChart" width="400" height="150"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ—¥æœŸé€‰æ‹©å™¨ -->
<div class="row mb-3 date-selector-container">
    <div class="col-12">
        <div class="card">
            <div class="card-body" style="padding-bottom: 20px; position: relative; z-index: 100;">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                        <label for="date-selector" class="form-label mb-0">æŸ¥çœ‹æ—¥æœŸ:</label>
                        <select class="form-select date-selector-dropdown" id="date-selector" style="width: 200px;">
                            <option value="today">ä»Šæ—¥æ•°æ®</option>
                        </select>
                        <small class="text-muted">é€‰æ‹©è¦æŸ¥çœ‹çš„æ—¥æœŸæ•°æ®</small>
            </div>
                    <div id="data-source-info" class="data-source-info">
                        <span class="badge bg-secondary">
                            <i class="bi bi-hourglass-split"></i> åŠ è½½ä¸­...
                        </span>
        </div>
    </div>
            </div>
        </div>
    </div>
</div>

<!-- è¯¦ç»†æ•°æ®è¡¨æ ¼ -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title" id="stats-table-title">ä»Šæ—¥æ•°æ®æ¦‚è§ˆ</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <tbody id="today-stats-table">
                            <tr><td colspan="2" class="text-center text-muted">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- æŒ‡ä»¤ä½¿ç”¨æ’è¡Œæ”¾åœ¨ä»Šæ—¥æ•°æ®ä¸‹é¢ -->
                <hr class="my-3">
                <h6 class="card-title">æŒ‡ä»¤ä½¿ç”¨æ’è¡Œ</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>æŒ‡ä»¤</th>
                                <th>ä½¿ç”¨æ¬¡æ•°</th>
                            </tr>
                        </thead>
                        <tbody id="command-stats-table">
                            <tr><td colspan="2" class="text-center text-muted">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <!-- æœ€æ´»è·ƒç”¨æˆ·åœ¨ä¸Šæ–¹ -->
                <h6 class="card-title">æœ€æ´»è·ƒç”¨æˆ·</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ç”¨æˆ·ID</th>
                                <th>æ¶ˆæ¯æ•°</th>
                            </tr>
                        </thead>
                        <tbody id="top-users-table">
                            <tr><td colspan="2" class="text-center text-muted">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- æœ€æ´»è·ƒç¾¤ç»„åœ¨ä¸‹æ–¹ -->
                <hr class="my-3">
                <h6 class="card-title">æœ€æ´»è·ƒç¾¤ç»„</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ç¾¤ç»„ID</th>
                                <th>æ¶ˆæ¯æ•°</th>
                            </tr>
                        </thead>
                        <tbody id="top-groups-table">
                            <tr><td colspan="2" class="text-center text-muted">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// =====================
// ç»Ÿè®¡é¡µé¢ç›¸å…³åŠŸèƒ½
// =====================
let statisticsChart = null;
let statisticsData = null;

// è‡ªå®šä¹‰å¹³å‡å€¼æ˜¾ç¤ºæ’ä»¶ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬ï¼‰
const averageDisplayPlugin = {
    id: 'averageDisplay',
    afterDraw: function(chart) {
        const options = chart.options.plugins.averageDisplay;
        if (!options || !options.display) return;
        
        const ctx = chart.ctx;
        const legend = chart.legend;
        
        if (!legend || !legend.legendItems || legend.legendItems.length === 0) return;
        
        ctx.save();
        ctx.font = 'normal 12px Arial';
        ctx.fillStyle = options.color || '#666';
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        
        const text = ` (${options.text})`;
        
        // è·å–å›¾ä¾‹é¡¹çš„ä½ç½®
        const legendItem = legend.legendItems[0];
        if (legendItem) {
            // è®¡ç®—æ–‡æœ¬ä½ç½®ï¼šåœ¨å›¾ä¾‹æ ‡ç­¾åé¢
            const labelWidth = ctx.measureText(legendItem.text).width;
            const x = legend.left + 35 + labelWidth; // 35æ˜¯å›¾ä¾‹è‰²å—å’Œé—´è·çš„å®½åº¦
            const y = legend.top + legend.height / 2;
            
            ctx.fillText(text, x, y);
        }
        
        ctx.restore();
    }
};

// æ•°å­—æ ¼å¼åŒ–å‡½æ•°
function formatNumber(num) {
    // å¤„ç†å„ç§è¾“å…¥ç±»å‹
    if (num === null || num === undefined) {
        return '0';
    }
    
    // å¦‚æœæ˜¯å¯¹è±¡ï¼Œå°è¯•æå–æ•°å€¼
    if (typeof num === 'object') {
        if (num.value !== undefined) {
            num = num.value;
        } else if (num.count !== undefined) {
            num = num.count;
        } else {
            return '0';
        }
    }
    
    // è½¬æ¢ä¸ºæ•°å­—
    const numValue = Number(num);
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
    if (isNaN(numValue)) {
        return '0';
    }
    
    if (numValue >= 10000) {
        return (numValue / 10000).toFixed(2).replace(/\.?0+$/, '') + 'w';
    } else if (numValue >= 1000) {
        return (numValue / 1000).toFixed(2).replace(/\.?0+$/, '') + 'k';
    } else {
        return numValue.toString();
    }
}



// åˆå§‹åŒ–ç»Ÿè®¡é¡µé¢
function initStatistics() {
    const ctx = document.getElementById('statisticsChart');
    if (!ctx) return;
    
    statisticsChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'æ€»æ¶ˆæ¯é‡',
                data: [],
                borderColor: '#4361ee',
                backgroundColor: 'rgba(67, 97, 238, 0.15)',
                tension: 0.3,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
                    plugins: {
            legend: {
                display: true,
                position: 'top',
                align: 'start'
            },
            datalabels: {
                display: true,
                align: 'top',
                anchor: 'end',
                color: 'rgba(0, 0, 0, 0.6)',
                font: {
                    size: 10,
                    weight: 'normal'
                },
                formatter: function(value, context) {
                    return formatNumber(value);
                },
                padding: {
                    bottom: 4
                },
                clip: false
            },
            averageDisplay: {
                display: false
            }
        },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'æ—¥æœŸ'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'æ•°é‡'
                    },
                    beginAtZero: true
                }
            }
        },
        plugins: [ChartDataLabels, averageDisplayPlugin]
    });
}

// åŠ è½½ç»Ÿè®¡æ•°æ®ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function loadStatistics(forceRefresh = false) {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    if (!token) {
        console.error('æœªæ‰¾åˆ°è®¿é—®token');
        return;
    }
    
    // æ„å»ºAPI URLï¼Œå¦‚æœéœ€è¦å¼ºåˆ¶åˆ·æ–°åˆ™æ·»åŠ å‚æ•°ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬ï¼‰
    let apiUrl = `/web/api/statistics?token=${encodeURIComponent(token)}`;
    if (forceRefresh) {
        apiUrl += '&force_refresh=true';
    }
    
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                statisticsData = data;
                // åªæœ‰åœ¨åŠ è½½å®Œæ•´ç»Ÿè®¡æ•°æ®æ—¶æ‰æ›´æ–°å›¾è¡¨ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬é€»è¾‘ï¼‰
                if (data.historical && data.today) {
                    updateChart('total_messages');
                    updateTables(data.today || {});
                } else if (data.selected_date_data) {
                    // è¿™æ˜¯å†å²æ—¥æœŸæ•°æ®ï¼Œåªæ›´æ–°è¡¨æ ¼
                    updateTables(data.selected_date_data);
                }
            } else {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', data.error);
                showStatisticsError('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            console.error('è·å–ç»Ÿè®¡æ•°æ®æ—¶å‡ºé”™:', error);
            showStatisticsError('è·å–ç»Ÿè®¡æ•°æ®æ—¶å‡ºé”™: ' + error.message);
        });
}

// æ›´æ–°å›¾è¡¨
function updateChart(metric) {
    if (!statisticsChart || !statisticsData) return;
    
    const labels = [];
    const data = [];
    let total = 0;
    let count = 0;
    
    statisticsData.forEach(item => {
        labels.push(item.date);
        const value = item[metric] || 0;
        data.push(value);
        total += value;
        count++;
    });
    
    const average = count > 0 ? (total / count) : 0;
    
    // æ›´æ–°å›¾è¡¨æ•°æ®
    statisticsChart.data.labels = labels;
    statisticsChart.data.datasets[0].data = data;
    
    // è·å–åº¦é‡æ ‡ç­¾
    const metricLabels = {
        'total_messages': 'æ€»æ¶ˆæ¯é‡',
        'active_users': 'æ´»è·ƒç”¨æˆ·æ•°',
        'active_groups': 'æ´»è·ƒç¾¤èŠæ•°',
        'private_messages': 'ç§èŠæ¶ˆæ¯æ•°',
        'total_users': 'æ€»ç”¨æˆ·æ•°',
        'total_groups': 'æ€»ç¾¤ç»„æ•°',
        'total_friends': 'æ€»å¥½å‹æ•°'
    };
    
    statisticsChart.data.datasets[0].label = metricLabels[metric] || metric;
    
    // æ›´æ–°å¹³å‡å€¼æ˜¾ç¤º
    statisticsChart.options.plugins.averageDisplay.display = true;
    statisticsChart.options.plugins.averageDisplay.text = `å¹³å‡: ${formatNumber(Math.round(average))}`;
    
    statisticsChart.update();
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.chart-toggle').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-metric="${metric}"]`).classList.add('active');
}

// æ›´æ–°æ•°æ®æºä¿¡æ¯
function updateDataSourceInfo(data) {
    const infoElement = document.getElementById('data-source-info');
    if (!infoElement || !data.data_source_info) return;
    
    const sourceInfo = data.data_source_info;
    let badgeClass = 'bg-secondary';
    let icon = 'hourglass-split';
    let text = 'æœªçŸ¥';
    
    if (sourceInfo.source === 'api') {
        badgeClass = 'bg-success';
        icon = 'cloud-check';
        text = 'å®æ—¶æ•°æ®';
    } else if (sourceInfo.source === 'cache') {
        badgeClass = 'bg-info';
        icon = 'clock-history';
        text = 'ç¼“å­˜æ•°æ®';
    }
    
    infoElement.innerHTML = `
        <span class="badge ${badgeClass}">
            <i class="bi bi-${icon}"></i> ${text}
        </span>
        <small>${sourceInfo.update_time || ''}</small>
    `;
}

// å¡«å……æ—¥æœŸé€‰æ‹©å™¨ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function populateDateSelector(dates) {
    const selector = document.getElementById('date-selector');
    selector.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹
    
    dates.forEach(dateItem => {
        const option = document.createElement('option');
        option.value = dateItem.value;
        option.textContent = dateItem.display;
        if (dateItem.is_today) {
            option.selected = true; // é»˜è®¤é€‰ä¸­ä»Šæ—¥
        }
        selector.appendChild(option);
    });
}

// åŠ è½½å¯ç”¨æ—¥æœŸï¼ˆç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function loadAvailableDates() {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    if (!token) return;
    
    fetch(`/web/api/available_dates?token=${encodeURIComponent(token)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.dates) {
                populateDateSelector(data.dates);
            }
        })
        .catch(error => {
            console.error('Error loading available dates:', error);
        });
}

// åŠ è½½æŒ‡å®šæ—¥æœŸçš„æ•°æ®ï¼ˆä½¿ç”¨loadDateSpecificDataï¼‰
function loadDateData(date) {
    loadDateSpecificData(date);
}

// æ›´æ–°ä»Šæ—¥ç»Ÿè®¡æ•°æ®
function updateTodayStats(data) {
    const table = document.getElementById('today-stats-table');
    if (!data) {
        table.innerHTML = '<tr><td colspan="2" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    const statsItems = [
        { label: 'æ€»æ¶ˆæ¯é‡', value: data.total_messages || 0 },
        { label: 'æ´»è·ƒç”¨æˆ·æ•°', value: data.active_users || 0 },
        { label: 'æ´»è·ƒç¾¤èŠæ•°', value: data.active_groups || 0 },
        { label: 'ç§èŠæ¶ˆæ¯æ•°', value: data.private_messages || 0 },
        { label: 'ç¾¤èŠæ¶ˆæ¯æ•°', value: data.group_messages || 0 },
        { label: 'æ€»ç”¨æˆ·æ•°', value: data.total_users || 0 },
        { label: 'æ€»ç¾¤ç»„æ•°', value: data.total_groups || 0 },
        { label: 'æ€»å¥½å‹æ•°', value: data.total_friends || 0 }
    ];
    
    table.innerHTML = statsItems.map(item => 
        `<tr><td>${item.label}</td><td class="fw-bold">${formatNumber(item.value)}</td></tr>`
    ).join('');
}

// æ›´æ–°æœ€æ´»è·ƒç”¨æˆ·
function updateTopUsers(users) {
    const table = document.getElementById('top-users-table');
    if (!users || users.length === 0) {
        table.innerHTML = '<tr><td colspan="2" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    table.innerHTML = users.map(user => 
        `<tr><td>${user.user_id}</td><td class="fw-bold">${formatNumber(user.message_count)}</td></tr>`
    ).join('');
}

// æ›´æ–°æœ€æ´»è·ƒç¾¤ç»„
function updateTopGroups(groups) {
    const table = document.getElementById('top-groups-table');
    if (!groups || groups.length === 0) {
        table.innerHTML = '<tr><td colspan="2" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    table.innerHTML = groups.map(group => 
        `<tr><td>${group.group_id}</td><td class="fw-bold">${formatNumber(group.message_count)}</td></tr>`
    ).join('');
}

// æ›´æ–°æŒ‡ä»¤ç»Ÿè®¡
function updateCommandStats(commands) {
    const table = document.getElementById('command-stats-table');
    if (!commands || commands.length === 0) {
        table.innerHTML = '<tr><td colspan="2" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    table.innerHTML = commands.map(cmd => 
        `<tr><td>${cmd.command}</td><td class="fw-bold">${formatNumber(cmd.count)}</td></tr>`
    ).join('');
}

// è¡¥å…¨DAUï¼ˆç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function completeDau() {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    if (!token) return;
    
    const button = document.getElementById('complete-dau');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> å¤„ç†ä¸­...';
    button.disabled = true;
    
    fetch(`/web/api/complete_dau?token=${encodeURIComponent(token)}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('DAUè¡¥å…¨æˆåŠŸï¼');
                loadStatistics(); // é‡æ–°åŠ è½½æ•°æ®
            } else {
                alert('DAUè¡¥å…¨å¤±è´¥ï¼š' + data.message);
            }
        })
        .catch(error => {
            console.error('Error completing DAU:', error);
            alert('DAUè¡¥å…¨å¤±è´¥');
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
}

// æ˜¾ç¤ºç»Ÿè®¡é”™è¯¯ä¿¡æ¯ï¼ˆç…§æŠ„è€ç‰ˆæœ¬ï¼‰
function showStatisticsError(message) {
    const container = document.getElementById('statistics-container');
    if (container) {
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> ${message}
            </div>
        `;
    }
}

// æ›´æ–°å›¾è¡¨ï¼ˆæ”¯æŒå¤šæ¡æŠ˜çº¿ï¼‰
function updateChart(metric) {
    if (!statisticsChart || !statisticsData) return;
    
    const labels = [];
    
    // æ„å»ºæ ‡ç­¾
    if (statisticsData.historical && Array.isArray(statisticsData.historical)) {
        statisticsData.historical.forEach(item => {
            const displayLabel = item.display_date || item.date || 'æœªçŸ¥';
            labels.push(displayLabel);
        });
    }
    if (statisticsData.today) {
        labels.push('ä»Šæ—¥');
    }
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºå¤šçº¿å›¾è¡¨
    const isMultiLine = metric === 'group_events' || metric === 'friend_events';
    
    if (isMultiLine) {
        // å¤šçº¿å›¾è¡¨å¤„ç†
        updateMultiLineChart(metric, labels);
    } else {
        // å•çº¿å›¾è¡¨å¤„ç†
        updateSingleLineChart(metric, labels);
    }
}

// æ›´æ–°å•çº¿å›¾è¡¨
function updateSingleLineChart(metric, labels) {
    const data = [];
    
    // å¤„ç†å†å²æ•°æ®
    if (statisticsData.historical && Array.isArray(statisticsData.historical)) {
        statisticsData.historical.forEach(item => {
            let value = 0;
            
            switch(metric) {
                case 'total_messages':
                case 'active_users':
                case 'active_groups':
                case 'private_messages':
                    value = item.message_stats ? item.message_stats[metric] || 0 : 0;
                break;
                case 'total_users':
                case 'total_groups':
                case 'total_friends':
                    value = item.user_stats ? item.user_stats[metric] || 0 : 0;
                break;
                default:
                    value = 0;
            }
            
            data.push(value);
        });
    }
    
    // æ·»åŠ ä»Šæ—¥æ•°æ®
    if (statisticsData.today) {
        let todayValue = 0;
        
        switch(metric) {
            case 'total_messages':
            case 'active_users':
            case 'active_groups':
            case 'private_messages':
                todayValue = statisticsData.today.message_stats ? statisticsData.today.message_stats[metric] || 0 : 0;
            break;
            case 'total_users':
            case 'total_groups':
            case 'total_friends':
                todayValue = statisticsData.today.user_stats ? statisticsData.today.user_stats[metric] || 0 : 0;
            break;
            default:
                todayValue = 0;
        }
        
        data.push(todayValue);
    }
    
    // è®¡ç®—30å¤©å†…å¹³å‡å€¼ï¼ˆåªå¯¹å‰4ä¸ªæŒ‡æ ‡ï¼‰
    let averageText = '';
    const shouldShowAverage = ['total_messages', 'active_users', 'active_groups', 'private_messages'].includes(metric);
    if (shouldShowAverage && data.length > 0) {
        const average = data.reduce((sum, val) => sum + val, 0) / data.length;
        averageText = `30å¤©å¹³å‡: ${formatNumber(Math.round(average))}`;
    }
    
    const metricNames = {
        'total_messages': 'æ€»æ¶ˆæ¯é‡',
        'active_users': 'æ´»è·ƒç”¨æˆ·æ•°',
        'active_groups': 'æ´»è·ƒç¾¤èŠæ•°',
        'private_messages': 'ç§èŠæ¶ˆæ¯æ•°',
        'total_users': 'æ€»ç”¨æˆ·æ•°',
        'total_groups': 'æ€»ç¾¤ç»„æ•°',
        'total_friends': 'æ€»å¥½å‹æ•°'
    };
    
    // ä¸ºä¸åŒæŒ‡æ ‡è®¾ç½®ä¸åŒé¢œè‰²
    const colorSchemes = {
        'total_messages': { border: '#4361ee', bg: 'rgba(67, 97, 238, 0.15)' },
        'active_users': { border: '#f72585', bg: 'rgba(247, 37, 133, 0.15)' },
        'active_groups': { border: '#4cc9f0', bg: 'rgba(76, 201, 240, 0.15)' },
        'private_messages': { border: '#7209b7', bg: 'rgba(114, 9, 183, 0.15)' },
        'total_users': { border: '#f77f00', bg: 'rgba(247, 127, 0, 0.15)' },
        'total_groups': { border: '#fcbf49', bg: 'rgba(252, 191, 73, 0.15)' },
        'total_friends': { border: '#606c38', bg: 'rgba(96, 108, 56, 0.15)' }
    };
    
    const colors = colorSchemes[metric] || colorSchemes['total_messages'];
    
    // ç¡®ä¿åªæœ‰ä¸€ä¸ªæ•°æ®é›†ç”¨äºå•çº¿å›¾è¡¨
    statisticsChart.data.labels = labels;
    statisticsChart.data.datasets = [{
        label: metricNames[metric] || metric,
        data: data,
        borderColor: colors.border,
        backgroundColor: colors.bg,
        tension: 0.4,
        fill: false
    }];
    
    // æ›´æ–°å›¾è¡¨å¤–éƒ¨çš„å¹³å‡å€¼æ˜¾ç¤º
    const averageDisplayElement = document.getElementById('chart-average-display');
    if (shouldShowAverage && averageDisplayElement) {
        averageDisplayElement.textContent = averageText;
        averageDisplayElement.style.color = colors.border;
        averageDisplayElement.style.display = 'block';
    } else if (averageDisplayElement) {
        averageDisplayElement.style.display = 'none';
    }
    
    // ç¦ç”¨åŸæ¥çš„æ’ä»¶æ˜¾ç¤º
    statisticsChart.options.plugins.averageDisplay = {
        display: false
    };
    
    statisticsChart.update();
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€  
    updateButtonState(metric);
}

// æ›´æ–°å¤šçº¿å›¾è¡¨
function updateMultiLineChart(metric, labels) {
    const datasets = [];
    
    if (metric === 'group_events') {
        // ç¾¤ç»„å˜åŒ–ï¼šè¿›ç¾¤å’Œé€€ç¾¤ä¸¤æ¡çº¿
        const joinData = [];
        const leaveData = [];
        
        // å¤„ç†å†å²æ•°æ®
        if (statisticsData.historical && Array.isArray(statisticsData.historical)) {
            statisticsData.historical.forEach(item => {
                const joinCount = item.event_stats ? item.event_stats.group_join_count || 0 : 0;
                const leaveCount = item.event_stats ? item.event_stats.group_leave_count || 0 : 0;
                joinData.push(joinCount);
                leaveData.push(leaveCount);
            });
        }
        
        // æ·»åŠ ä»Šæ—¥æ•°æ®
        if (statisticsData.today) {
            const todayJoin = statisticsData.today.event_stats ? statisticsData.today.event_stats.group_join_count || 0 : 0;
            const todayLeave = statisticsData.today.event_stats ? statisticsData.today.event_stats.group_leave_count || 0 : 0;
            joinData.push(todayJoin);
            leaveData.push(todayLeave);
        }
        
        datasets.push({
            label: 'è¿›ç¾¤æ•°',
            data: joinData,
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.15)',
            tension: 0.4,
            fill: false
        });
        
        datasets.push({
            label: 'é€€ç¾¤æ•°',
            data: leaveData,
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220, 53, 69, 0.15)',
            tension: 0.4,
            fill: false
        });
        
    } else if (metric === 'friend_events') {
        // å¥½å‹å˜åŒ–ï¼šåŠ å‹å’Œåˆ å‹ä¸¤æ¡çº¿
        const addData = [];
        const removeData = [];
        
        // å¤„ç†å†å²æ•°æ®
        if (statisticsData.historical && Array.isArray(statisticsData.historical)) {
            statisticsData.historical.forEach(item => {
                const addCount = item.event_stats ? item.event_stats.friend_add_count || 0 : 0;
                const removeCount = item.event_stats ? item.event_stats.friend_remove_count || 0 : 0;
                addData.push(addCount);
                removeData.push(removeCount);
            });
        }
        
        // æ·»åŠ ä»Šæ—¥æ•°æ®
        if (statisticsData.today) {
            const todayAdd = statisticsData.today.event_stats ? statisticsData.today.event_stats.friend_add_count || 0 : 0;
            const todayRemove = statisticsData.today.event_stats ? statisticsData.today.event_stats.friend_remove_count || 0 : 0;
            addData.push(todayAdd);
            removeData.push(todayRemove);
        }
        
        datasets.push({
            label: 'åŠ å¥½å‹æ•°',
            data: addData,
            borderColor: '#17a2b8',
            backgroundColor: 'rgba(23, 162, 184, 0.15)',
            tension: 0.4,
            fill: false
        });
        
        datasets.push({
            label: 'åˆ å¥½å‹æ•°',
            data: removeData,
            borderColor: '#ffc107',
            backgroundColor: 'rgba(255, 193, 7, 0.15)',
            tension: 0.4,
            fill: false
        });
    }
    
    statisticsChart.data.labels = labels;
    statisticsChart.data.datasets = datasets;
    
    // éšè—å¹³å‡å€¼æ˜¾ç¤º
    const averageDisplayElement = document.getElementById('chart-average-display');
    if (averageDisplayElement) {
        averageDisplayElement.style.display = 'none';
    }
    
    statisticsChart.update();
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    updateButtonState(metric);
}

// æ›´æ–°æŒ‰é’®çŠ¶æ€
function updateButtonState(metric) {
    document.querySelectorAll('.chart-toggle').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.metric === metric) {
            btn.classList.add('active');
        }
    });
}

// æ›´æ–°è¡¨æ ¼ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function updateTables(todayData) {
    // æ›´æ–°ä»Šæ—¥æ•°æ®æ¦‚è§ˆè¡¨æ ¼
    const todayStatsTable = document.getElementById('today-stats-table');
    const messageStats = todayData.message_stats || {};
    const userStats = todayData.user_stats || {};
    
    // æ›´æ–°æ•°æ®æºä¿¡æ¯æ˜¾ç¤º
    const dataSourceInfoElement = document.getElementById('data-source-info');
    if (dataSourceInfoElement) {
        let sourceHtml = '';
        if (todayData.is_historical) {
            sourceHtml = `<span class="badge bg-info">
                <i class="bi bi-folder"></i> æœ¬åœ°æ–‡ä»¶
            </span>`;
            if (todayData.generated_at) {
                try {
                    const genTime = new Date(todayData.generated_at);
                    const timeStr = genTime.toLocaleString('zh-CN', { 
                        month: '2-digit', 
                        day: '2-digit', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    sourceHtml += `<br><small class="text-muted">
                        <i class="bi bi-clock"></i> ${timeStr}
                    </small>`;
                } catch (e) {
                    // æ—¶é—´è§£æå¤±è´¥ï¼Œå¿½ç•¥
                }
            }
        } else if (todayData.is_realtime) {
            sourceHtml = `<span class="badge bg-warning text-dark">
                <i class="bi bi-database"></i> å®æ—¶æŸ¥è¯¢
            </span>`;
        } else {
            sourceHtml = `<span class="badge bg-success">
                <i class="bi bi-folder"></i> æœ¬åœ°æ–‡ä»¶
            </span>`;
        }
        dataSourceInfoElement.innerHTML = sourceHtml;
    }

    if (todayStatsTable) {
        const eventStats = todayData.event_stats || {};
        todayStatsTable.innerHTML = `
            <tr><td>æ€»æ¶ˆæ¯é‡</td><td>${messageStats.total_messages || 0}</td></tr>
            <tr><td>æ´»è·ƒç”¨æˆ·æ•°</td><td>${messageStats.active_users || 0}</td></tr>
            <tr><td>æ´»è·ƒç¾¤èŠæ•°</td><td>${messageStats.active_groups || 0}</td></tr>
            <tr><td>ç§èŠæ¶ˆæ¯æ•°</td><td>${messageStats.private_messages || 0}</td></tr>
            <tr><td>æœ€æ´»è·ƒæ—¶æ®µ</td><td>${messageStats.peak_hour || 0}ç‚¹ (${messageStats.peak_hour_count || 0}æ¡)</td></tr>
            <tr><td>æ€»ç”¨æˆ·æ•°</td><td>${userStats.total_users || 0}</td></tr>
            <tr><td>æ€»ç¾¤ç»„æ•°</td><td>${userStats.total_groups || 0}</td></tr>
            <tr><td>æ€»å¥½å‹æ•°</td><td>${userStats.total_friends || 0}</td></tr>
            <tr><td colspan="2" style="font-weight: bold; background-color: #f8f9fa;">äº‹ä»¶ç»Ÿè®¡</td></tr>
            <tr><td>è¿›ç¾¤æ•°</td><td>${eventStats.group_join_count || 0}</td></tr>
            <tr><td>é€€ç¾¤æ•°</td><td>${eventStats.group_leave_count || 0}</td></tr>
            <tr><td>ç¾¤ç»„å‡€å¢é‡</td><td>${(eventStats.group_join_count || 0) - (eventStats.group_leave_count || 0)}</td></tr>
            <tr><td>åŠ å¥½å‹æ•°</td><td>${eventStats.friend_add_count || 0}</td></tr>
            <tr><td>åˆ å¥½å‹æ•°</td><td>${eventStats.friend_remove_count || 0}</td></tr>
            <tr><td>å¥½å‹å‡€å¢é‡</td><td>${(eventStats.friend_add_count || 0) - (eventStats.friend_remove_count || 0)}</td></tr>
        `;
    }
    
    // æ›´æ–°æœ€æ´»è·ƒç¾¤ç»„è¡¨æ ¼
    const topGroupsTable = document.getElementById('top-groups-table');
    const topGroups = messageStats.top_groups || [];
    if (topGroupsTable) {
        if (topGroups.length > 0) {
            topGroupsTable.innerHTML = topGroups.slice(0, 5).map(group => 
                `<tr><td>${maskId(group.group_id)}</td><td>${group.message_count}</td></tr>`
            ).join('');
        } else {
            topGroupsTable.innerHTML = '<tr><td colspan="2" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
        }
    }
    
    // æ›´æ–°æœ€æ´»è·ƒç”¨æˆ·è¡¨æ ¼
    const topUsersTable = document.getElementById('top-users-table');
    const topUsers = messageStats.top_users || [];
    if (topUsersTable) {
        if (topUsers.length > 0) {
            topUsersTable.innerHTML = topUsers.slice(0, 5).map(user => 
                `<tr><td><span class="user-id-with-nickname" data-user-id="${user.user_id}">${maskId(user.user_id)} <span class="nickname-loading">ğŸ“</span></span></td><td>${user.message_count}</td></tr>`
            ).join('');
            
            // å¼‚æ­¥åŠ è½½æ˜µç§°
            loadNicknamesForUsers(topUsers.slice(0, 5));
        } else {
            topUsersTable.innerHTML = '<tr><td colspan="2" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
        }
    }
    
    // æ›´æ–°æŒ‡ä»¤ä½¿ç”¨æ’è¡Œè¡¨æ ¼
    const commandStatsTable = document.getElementById('command-stats-table');
    const commandStats = todayData.command_stats || [];
    if (commandStatsTable) {
        if (commandStats.length > 0) {
            commandStatsTable.innerHTML = commandStats.slice(0, 5).map(cmd => 
                `<tr><td>${cmd.command}</td><td>${cmd.count}</td></tr>`
            ).join('');
        } else {
            commandStatsTable.innerHTML = '<tr><td colspan="2" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
        }
    }
}

// è„±æ•å¤„ç†IDï¼ˆç…§æŠ„è€ç‰ˆæœ¬ï¼‰
function maskId(id) {
    if (!id || typeof id !== 'string') return 'æœªçŸ¥';
    if (id.length <= 6) return id;
    return id.substring(0, 3) + '***' + id.substring(id.length - 3);
}

// æ˜µç§°ç¼“å­˜ï¼ˆç…§æŠ„è€ç‰ˆæœ¬ï¼‰
const nicknameCache = new Map();

// ä¸ºç”¨æˆ·åˆ—è¡¨åŠ è½½æ˜µç§°ï¼ˆç…§æŠ„è€ç‰ˆæœ¬ï¼‰
function loadNicknamesForUsers(users) {
    users.forEach(user => {
        if (user.user_id && !nicknameCache.has(user.user_id)) {
            fetchUserNickname(user.user_id);
        } else if (nicknameCache.has(user.user_id)) {
            updateUserNickname(user.user_id, nicknameCache.get(user.user_id));
        }
    });
}

// è·å–å•ä¸ªç”¨æˆ·æ˜µç§°ï¼ˆç…§æŠ„è€ç‰ˆæœ¬ï¼‰
function fetchUserNickname(userId) {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    if (!token) return;
    
    fetch(`/web/api/get_nickname/${encodeURIComponent(userId)}?token=${encodeURIComponent(token)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.nickname) {
                nicknameCache.set(userId, data.nickname);
                updateUserNickname(userId, data.nickname);
            }
        })
        .catch(error => {
            console.error('è·å–æ˜µç§°å¤±è´¥:', error);
        });
}

// æ›´æ–°ç”¨æˆ·æ˜µç§°æ˜¾ç¤ºï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬ï¼‰
function updateUserNickname(userId, nickname) {
    const elements = document.querySelectorAll(`[data-user-id="${userId}"]`);
    elements.forEach(element => {
        const loadingEl = element.querySelector('.nickname-loading');
        if (loadingEl) {
            loadingEl.textContent = `(${nickname})`;
            loadingEl.classList.remove('nickname-loading');
            loadingEl.classList.add('nickname-display');
        }
    });
}

// åŠ è½½ç‰¹å®šæ—¥æœŸçš„æ•°æ®ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function loadDateSpecificData(selectedDate) {
    if (selectedDate === 'today') {
        // åŠ è½½ä»Šæ—¥æ•°æ®ï¼ˆåŒ…å«å›¾è¡¨ï¼‰
        loadStatisticsData();
    } else {
        // åŠ è½½å†å²æ•°æ®ï¼ˆä»…è¡¨æ ¼ï¼‰
        loadHistoricalDateData(selectedDate);
    }
}

// åˆ«åå‡½æ•°ï¼Œä¸è€ç‰ˆæœ¬ä¿æŒä¸€è‡´
function loadStatisticsData(forceRefresh = false) {
    loadStatistics(forceRefresh);
}

// åŠ è½½å†å²æ—¥æœŸæ•°æ®ï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬å®ç°ï¼‰
function loadHistoricalDateData(dateStr) {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (!token) {
        console.error('æœªæ‰¾åˆ°è®¿é—®token');
        return;
    }
    
    // æ„å»ºAPI URLæŸ¥è¯¢ç‰¹å®šæ—¥æœŸï¼ˆå®Œå…¨ç…§æŠ„è€ç‰ˆæœ¬ï¼‰
    const apiUrl = `/web/api/statistics?token=${encodeURIComponent(token)}&date=${dateStr}`;
    
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // æ›´æ–°è¡¨æ ¼æ•°æ®ï¼ˆä¸æ›´æ–°å›¾è¡¨ï¼‰
                if (data.selected_date_data) {
                    updateTables(data.selected_date_data);
                } else {
                    showStatisticsError('è¯¥æ—¥æœŸæ²¡æœ‰å¯ç”¨æ•°æ®');
                }
            } else {
                console.error('åŠ è½½å†å²æ•°æ®å¤±è´¥:', data.error);
                showStatisticsError('åŠ è½½å†å²æ•°æ®å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            console.error('è·å–å†å²æ•°æ®æ—¶å‡ºé”™:', error);
            showStatisticsError('è·å–å†å²æ•°æ®æ—¶å‡ºé”™: ' + error.message);
        });
}

// é¡µé¢åˆå§‹åŒ–ï¼ˆæ€§èƒ½ä¼˜åŒ–ç‰ˆæœ¬ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼‰
document.addEventListener('DOMContentLoaded', function() {
    // å¼‚æ­¥åˆå§‹åŒ–ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
    function initializeStatisticsAsync() {
        // åˆ†é˜¶æ®µåˆå§‹åŒ–ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½è¿‡å¤š
        
        // ç¬¬ä¸€é˜¶æ®µï¼šåˆå§‹åŒ–å›¾è¡¨ï¼ˆå»¶è¿Ÿ50msï¼‰
        setTimeout(() => {
            initStatistics();
        }, 50);
        
        // ç¬¬äºŒé˜¶æ®µï¼šåŠ è½½ç»Ÿè®¡æ•°æ®ï¼ˆå»¶è¿Ÿ100msï¼‰
        setTimeout(() => {
            loadStatistics();
        }, 100);
        
        // ç¬¬ä¸‰é˜¶æ®µï¼šåŠ è½½å¯ç”¨æ—¥æœŸï¼ˆå»¶è¿Ÿ150msï¼‰
        setTimeout(() => {
            loadAvailableDates();
        }, 150);
    }
    
    // ç«‹å³ç»‘å®šäº‹ä»¶ï¼Œä½†ä½¿ç”¨é˜²æŠ–ä¼˜åŒ–
    function bindEventsWithOptimization() {
        // å›¾è¡¨åˆ‡æ¢æŒ‰é’®ï¼ˆä½¿ç”¨é˜²æŠ–ï¼Œé¿å…é¢‘ç¹åˆ‡æ¢ï¼‰
        const debouncedUpdateChart = debounce((metric) => {
            updateChart(metric);
        }, 200);
        
        document.querySelectorAll('.chart-toggle').forEach(button => {
            button.addEventListener('click', function() {
                debouncedUpdateChart(this.dataset.metric);
            });
        });
        
        // åˆ·æ–°æŒ‰é’®ï¼ˆé˜²æ­¢é‡å¤ç‚¹å‡»ï¼‰
        const debouncedRefresh = debounce(() => {
            loadStatistics();
            const selectedDate = document.getElementById('date-selector').value;
            loadDateSpecificData(selectedDate);
        }, 1000);
        
        document.getElementById('refresh-statistics').addEventListener('click', debouncedRefresh);
        
        // è¡¥å…¨DAUæŒ‰é’®ï¼ˆé˜²æ­¢é‡å¤ç‚¹å‡»ï¼‰
        const debouncedComplete = debounce(() => {
            completeDau();
        }, 500);
        
        document.getElementById('complete-dau').addEventListener('click', debouncedComplete);
        
        // æ—¥æœŸé€‰æ‹©å™¨ï¼ˆä½¿ç”¨é˜²æŠ–ï¼Œé¿å…é¢‘ç¹åˆ‡æ¢ï¼‰
        const debouncedDateChange = debounce((value) => {
            loadDateSpecificData(value);
        }, 300);
        
        document.getElementById('date-selector').addEventListener('change', function() {
            debouncedDateChange(this.value);
        });
    }
    
    // ç«‹å³ç»‘å®šäº‹ä»¶
    bindEventsWithOptimization();
    
    // ä½¿ç”¨requestIdleCallbackè¿›è¡Œå¼‚æ­¥åˆå§‹åŒ–
    if ('requestIdleCallback' in window) {
        requestIdleCallback(initializeStatisticsAsync, { timeout: 300 });
    } else {
        // é™çº§åˆ°setTimeout
        setTimeout(initializeStatisticsAsync, 100);
    }
    
    // ç»Ÿè®¡é¡µé¢ä¸éœ€è¦å®æ—¶WebSocketè¿æ¥ï¼Œé¿å…é¢å¤–æ€§èƒ½å¼€é”€
    // initSocket('statistics');
});
</script>
{% endblock %}