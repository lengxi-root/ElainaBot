{% extends "pc/base.html" %}

{% block content %}
<!-- 页面标题区域 -->
<div class="openapi-header" id="openapi-header">
    <div class="openapi-header-content">
        <div class="openapi-title-wrapper">
            <div class="openapi-icon"><i class="bi bi-cloud-check"></i></div>
            <div>
                <h4 class="openapi-title">开放平台管理</h4>
                <p class="openapi-subtitle">管理QQ开发者平台的机器人数据</p>
            </div>
        </div>
        <div class="openapi-status-wrapper">
            <div class="openapi-login-status" id="openapi-login-status">
                <i class="bi bi-x-circle"></i>
                <span>未登录</span>
            </div>
            <div class="openapi-actions" id="openapi-header-actions" style="display: none;">
                <button class="openapi-btn header-btn" id="openapi-get-notifications">
                    <i class="bi bi-bell"></i> 通知
                </button>
                <button class="openapi-btn header-btn" id="openapi-refresh-botlist">
                    <i class="bi bi-arrow-clockwise"></i> 刷新
                </button>
                <button class="openapi-btn header-btn" id="openapi-logout">
                    <i class="bi bi-box-arrow-right"></i> 退出
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 登录状态卡片 -->
<div class="login-card" id="openapi-login-card">
    <div id="openapi-not-logged-in" class="login-content">
        <div class="login-icon"><i class="bi bi-shield-lock"></i></div>
        <h5>开放平台登录</h5>
        <p class="text-muted">请先登录QQ开发者平台以查看和管理机器人数据</p>
        <button class="openapi-btn primary large" id="openapi-start-login">
            <i class="bi bi-qr-code"></i> 开始登录
        </button>
        <div id="openapi-login-progress" class="login-progress" style="display: none;">
            <div id="openapi-login-loading" class="login-loading">
                <div class="spinner"></div>
                <p>正在生成登录二维码...</p>
            </div>
            <div id="openapi-qr-container" class="qr-container" style="display: none;">
                <img id="openapi-qr-image" src="" alt="登录二维码" class="qr-image">
                <p class="text-muted">请使用手机QQ扫描上方二维码</p>
                <button class="openapi-btn outline" id="openapi-login-url">
                    <i class="bi bi-box-arrow-up-right"></i> 或点击打开登录页面
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 机器人列表 -->
<div class="bot-list-card" id="openapi-main-content" style="display: none;">
    <div class="bot-list-header">
        <i class="bi bi-robot"></i>
        <span>机器人列表</span>
    </div>
    <div class="bot-list-body">
        <div id="openapi-botlist-loading" class="loading-state">
            <div class="spinner"></div>
            <p>正在获取机器人列表...</p>
        </div>
        <div id="openapi-botlist-container" style="display: none;">
            <div class="bot-grid" id="openapi-botlist-table"></div>
        </div>
    </div>
</div>

<!-- 数据展示区域 -->
<div class="data-section" id="openapi-data-section" style="display: none;">
    <div class="data-section-header">
        <h6 id="openapi-data-title"><i class="bi bi-table"></i> 数据详情</h6>
        <button class="openapi-btn outline small" id="openapi-close-data">
            <i class="bi bi-x-lg"></i> 关闭
        </button>
    </div>
    <div class="data-section-body">
        <div id="openapi-data-loading" class="loading-state">
            <div class="spinner"></div>
            <p>正在获取数据...</p>
        </div>
        
        <span id="openapi-data-appid" style="display: none;">-</span>
        <span id="openapi-data-avg-dau" style="display: none;">-</span>
        
        <!-- 数据表格 -->
        <div id="openapi-data-table-container" style="display: none;">
            <div class="avg-dau-badge">
                <i class="bi bi-graph-up"></i> 平均DAU: <strong id="openapi-avg-dau-display">-</strong>
            </div>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>上行消息</th>
                            <th>活跃用户</th>
                            <th>下行消息</th>
                            <th>总消息</th>
                            <th>群组</th>
                            <th>好友</th>
                        </tr>
                    </thead>
                    <tbody id="openapi-data-table"></tbody>
                </table>
            </div>
        </div>
        
        <!-- 通知消息 -->
        <div id="openapi-notifications-container" style="display: none;">
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 15%;">时间</th>
                            <th style="width: 20%;">标题</th>
                            <th>内容</th>
                        </tr>
                    </thead>
                    <tbody id="openapi-notifications-table"></tbody>
                </table>
            </div>
        </div>
        
        <!-- 白名单 -->
        <div id="openapi-whitelist-container" style="display: none;">
            <div class="whitelist-actions">
                <button class="openapi-btn success small" onclick="addNewIpInput()">
                    <i class="bi bi-plus-lg"></i> 添加IP
                </button>
                <button class="openapi-btn primary small" id="batch-add-ips-btn" onclick="batchAddIps()" style="display: none;">
                    <i class="bi bi-shield-check"></i> 批量添加
                </button>
                <button class="openapi-btn outline small" onclick="clearAllInputs()">
                    <i class="bi bi-x-lg"></i> 清空
                </button>
            </div>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>IP地址</th>
                            <th style="width: 100px;">操作</th>
                        </tr>
                    </thead>
                    <tbody id="openapi-whitelist-table"></tbody>
                </table>
            </div>
        </div>
        
        <!-- 模板列表 -->
        <div id="openapi-templates-container" style="display: none;">
            <div class="templates-grid">
                <div class="templates-list-section">
                    <div class="templates-list-header">
                        <span id="template-list-title"><i class="bi bi-layout-text-sidebar-reverse"></i> 模板列表</span>
                        <div class="templates-list-actions">
                            <button class="openapi-btn danger small" onclick="deleteSelectedTemplates()" id="delete-templates-btn" style="display: none;">
                                <i class="bi bi-trash"></i> 删除
                            </button>
                            <button class="openapi-btn primary small" onclick="submitSelectedTemplates()" id="submit-templates-btn" style="display: none;">
                                <i class="bi bi-send-check"></i> 提审
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table compact">
                            <thead>
                                <tr>
                                    <th style="width: 30px;"><input type="checkbox" id="select-all-templates" onchange="toggleAllTemplates(this)"></th>
                                    <th>模板名称</th>
                                    <th>类型</th>
                                    <th>状态</th>
                                    <th style="width: 60px;">操作</th>
                                </tr>
                            </thead>
                            <tbody id="openapi-templates-table"></tbody>
                        </table>
                    </div>
                </div>
                <div class="template-detail-section" id="openapi-template-detail" style="display: none;">
                    <div class="template-detail-header">
                        <span><i class="bi bi-info-circle"></i> 模板详情</span>
                        <span class="template-index-badge" id="template-detail-index">1/1</span>
                    </div>
                    <div class="template-detail-body">
                        <div class="detail-row"><span class="label">模板ID:</span><span id="template-detail-id">-</span></div>
                        <div class="detail-row"><span class="label">名称:</span><span id="template-detail-name">-</span></div>
                        <div class="detail-row"><span class="label">类型:</span><span id="template-detail-type">-</span></div>
                        <div class="detail-row"><span class="label">状态:</span><span id="template-detail-status">-</span></div>
                        <div class="detail-row"><span class="label">创建时间:</span><span id="template-detail-create-time">-</span></div>
                        <div class="detail-content">
                            <span class="label">模板内容:</span>
                            <pre id="template-detail-content">-</pre>
                        </div>
                        <div id="template-button-preview" style="display: none;">
                            <span class="label">按钮预览:</span>
                            <div id="template-button-rows" class="button-preview"></div>
                        </div>
                        <div class="template-nav">
                            <button class="openapi-btn outline small" id="template-prev-btn" style="display: none;"><i class="bi bi-chevron-left"></i> 上一个</button>
                            <button class="openapi-btn outline small" id="template-next-btn" style="display: none;">下一个 <i class="bi bi-chevron-right"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 模板提交 -->
        <div id="openapi-submit-template-container" style="display: none;">
            <button class="openapi-btn outline small mb-3" onclick="backToTemplateList()">
                <i class="bi bi-arrow-left"></i> 返回模板列表
            </button>
            <div class="submit-template-form">
                <div class="form-group">
                    <label>模板类型</label>
                    <select class="form-select" id="template-type-select" onchange="onTemplateTypeChange()">
                        <option value="2">Markdown模板</option>
                        <option value="1">按钮模板</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>模板名称</label>
                    <input type="text" class="form-control" id="template-name-input" placeholder="请输入模板名称">
                </div>
                <div class="form-group">
                    <label>使用场景</label>
                    <input type="text" class="form-control" id="template-scene-input" placeholder="请输入使用场景">
                </div>
                <div id="markdown-template-inputs">
                    <div class="form-group">
                        <label>模板内容</label>
                        <textarea class="form-control" id="template-content-input" rows="4" placeholder="例如: {{ '{{' }}.text{{ '}}' }}" oninput="extractTemplateParams()"></textarea>
                    </div>
                    <div id="template-params-container" style="display: none;">
                        <label>测试参数值</label>
                        <div id="template-params-inputs"></div>
                    </div>
                </div>
                <div id="button-template-inputs" style="display: none;">
                    <div class="form-group">
                        <label>按钮配置 (JSON)</label>
                        <textarea class="form-control" id="button-config-input" rows="6" placeholder='{"rows":[{"buttons":[...]}]}'></textarea>
                    </div>
                </div>
                <button class="openapi-btn success" onclick="startTemplateSubmit()">
                    <i class="bi bi-upload"></i> 提交模板
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 模态框 -->
<div class="modal fade" id="templateSubmitQrModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title"><i class="bi bi-qr-code"></i> 扫码授权提交</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body text-center">
                <div id="template-qr-loading"><div class="spinner-border text-primary mb-2"></div><p class="text-muted">正在生成授权二维码...</p></div>
                <div id="template-qr-display" style="display: none;"><img id="template-qr-image" src="" alt="授权二维码" class="qr-image"><p class="text-muted">请使用手机QQ扫描二维码授权</p><div id="template-submit-status" class="alert alert-info"><i class="bi bi-hourglass-split"></i> 等待授权中...</div></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="auditTemplateQrModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title"><i class="bi bi-qr-code"></i> 扫码授权提审</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body text-center">
                <div id="audit-qr-loading"><div class="spinner-border text-primary mb-2"></div><p class="text-muted">正在生成授权二维码...</p></div>
                <div id="audit-qr-display" style="display: none;"><img id="audit-qr-image" src="" alt="授权二维码" class="qr-image"><p class="text-muted">请使用手机QQ扫描二维码授权</p><div id="audit-status" class="alert alert-info"><i class="bi bi-hourglass-split"></i> 等待授权中...</div></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteTemplateQrModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title"><i class="bi bi-qr-code"></i> 扫码授权删除</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body text-center">
                <div id="delete-qr-loading"><div class="spinner-border text-danger mb-2"></div><p class="text-muted">正在生成授权二维码...</p></div>
                <div id="delete-qr-display" style="display: none;"><img id="delete-qr-image" src="" alt="授权二维码" class="qr-image"><p class="text-muted">请使用手机QQ扫描二维码授权</p><div id="delete-status" class="alert alert-warning"><i class="bi bi-hourglass-split"></i> 等待授权中...</div></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_styles %}
<style>
/* 页面标题区域 */
.openapi-header {
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    transition: background 0.3s;
}

.openapi-header.logged-out {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.openapi-header.logged-in {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.openapi-header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.openapi-title-wrapper {
    display: flex;
    align-items: center;
    gap: 16px;
    color: #fff;
}

.openapi-icon {
    width: 56px;
    height: 56px;
    background: rgba(255,255,255,0.15);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.openapi-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
}

.openapi-subtitle {
    margin: 4px 0 0;
    font-size: 0.85rem;
    opacity: 0.85;
}

.openapi-status-wrapper {
    display: flex;
    align-items: center;
    gap: 16px;
}

.openapi-login-status {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(255,255,255,0.2);
    padding: 8px 16px;
    border-radius: 20px;
    color: #fff;
    font-size: 0.85rem;
    font-weight: 500;
}

.openapi-login-status i {
    font-size: 1rem;
}

.openapi-actions {
    display: flex;
    gap: 8px;
}

/* 顶部按钮样式 */
.openapi-btn.header-btn {
    background: rgba(255,255,255,0.2);
    color: #fff;
    padding: 8px 14px;
    font-size: 0.8rem;
}

.openapi-btn.header-btn:hover {
    background: rgba(255,255,255,0.3);
}

/* 按钮样式 */
.openapi-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.openapi-btn.small {
    padding: 6px 12px;
    font-size: 0.8rem;
}

.openapi-btn.large {
    padding: 12px 24px;
    font-size: 0.9rem;
}

.openapi-btn.primary {
    background: var(--theme-gradient);
    color: #fff;
}

.openapi-btn.primary:hover {
    background: linear-gradient(135deg, #5a6fd6 0%, #6a4190 100%);
    box-shadow: 0 4px 12px rgba(102,126,234,0.3);
}

.openapi-btn.success {
    background: #10b981;
    color: #fff;
}

.openapi-btn.success:hover {
    background: #059669;
}

.openapi-btn.danger {
    background: rgba(239,68,68,0.9);
    color: #fff;
}

.openapi-btn.danger:hover {
    background: #ef4444;
}

.openapi-btn.info {
    background: rgba(6,182,212,0.9);
    color: #fff;
}

.openapi-btn.info:hover {
    background: #06b6d4;
}

.openapi-btn.outline {
    background: transparent;
    border: 1px solid #e2e8f0;
    color: #64748b;
}

.openapi-btn.outline:hover {
    background: #f1f5f9;
    border-color: #cbd5e1;
}

/* 登录卡片 */
.login-card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    border: 1px solid #e2e8f0;
    margin-bottom: 20px;
    overflow: hidden;
}

.login-content {
    padding: 40px;
    text-align: center;
}

.login-icon {
    width: 80px;
    height: 80px;
    background: var(--theme-gradient);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: #fff;
    margin: 0 auto 20px;
}

.login-content h5 {
    margin: 0 0 8px;
    font-weight: 600;
    color: #1e293b;
}

.login-content p {
    margin: 0 0 20px;
}

.login-progress {
    margin-top: 24px;
}

.login-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #e2e8f0;
    border-top-color: var(--primary-color, #5865F2);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.qr-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
}

.qr-image {
    width: 200px;
    height: 200px;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
}

.logged-in-content {
    padding: 16px 24px;
    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
}

.logged-in-info {
    display: flex;
    align-items: center;
    gap: 12px;
    color: #059669;
    font-weight: 500;
}

.logged-in-info i {
    font-size: 1.25rem;
}

.uin-badge {
    background: #10b981;
    color: #fff;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    margin-left: auto;
}

/* 机器人列表 */
.bot-list-card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    border: 1px solid #e2e8f0;
    margin-bottom: 20px;
    overflow: hidden;
}

.bot-list-header {
    padding: 16px 20px;
    background: var(--theme-gradient);
    color: #fff;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.bot-list-body {
    padding: 20px;
}

.loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 40px;
    color: #64748b;
}

/* 机器人网格 */
.bot-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 16px;
}

.bot-card {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 16px;
    transition: all 0.2s;
}

.bot-card:hover {
    border-color: var(--primary-color, #5865F2);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.bot-card-header {
    margin-bottom: 12px;
}

.bot-name-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}

.bot-card-header h6 {
    margin: 0;
    font-weight: 600;
    color: #1e293b;
}

.bot-card-header small {
    color: #94a3b8;
}

.openapi-btn.tiny {
    padding: 4px 8px;
    font-size: 0.75rem;
}

.bot-card-appid {
    display: inline-block;
    background: #e2e8f0;
    padding: 4px 10px;
    border-radius: 6px;
    font-family: monospace;
    font-size: 0.8rem;
    color: #475569;
    margin-bottom: 12px;
}

.bot-card-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.bot-card-actions .openapi-btn {
    flex: 1;
    min-width: 70px;
    justify-content: center;
    padding: 6px 8px;
    font-size: 0.75rem;
}

/* 数据区域 */
.data-section {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    border: 1px solid #e2e8f0;
    margin-top: 20px;
    overflow: hidden;
}

.data-section-header {
    padding: 16px 20px;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.data-section-header h6 {
    margin: 0;
    font-weight: 600;
    color: #1e293b;
}

.data-section-body {
    padding: 20px;
}

.avg-dau-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--theme-gradient);
    color: #fff;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.85rem;
    margin-bottom: 16px;
}

/* 数据表格 */
.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th {
    padding: 10px 12px;
    text-align: left;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #64748b;
    background: #f8fafc;
    border-bottom: 2px solid #e2e8f0;
}

.data-table td {
    padding: 10px 12px;
    font-size: 0.85rem;
    color: #334155;
    border-bottom: 1px solid #f1f5f9;
}

.data-table tbody tr:hover {
    background: #f8fafc;
}

.data-table.compact th,
.data-table.compact td {
    padding: 8px 10px;
    font-size: 0.8rem;
}

/* 白名单 */
.whitelist-actions {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}

/* 模板区域 */
.templates-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.templates-list-section,
.template-detail-section {
    background: #f8fafc;
    border-radius: 12px;
    padding: 16px;
}

.templates-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    font-weight: 600;
    color: #1e293b;
}

.templates-list-actions {
    display: flex;
    gap: 6px;
}

.template-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    font-weight: 600;
    color: #1e293b;
}

.template-index-badge {
    background: var(--primary-color, #5865F2);
    color: #fff;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
}

.template-detail-body {
    font-size: 0.85rem;
}

.detail-row {
    display: flex;
    margin-bottom: 8px;
}

.detail-row .label {
    width: 80px;
    color: #64748b;
    flex-shrink: 0;
}

.detail-content {
    margin-top: 12px;
}

.detail-content .label {
    display: block;
    color: #64748b;
    margin-bottom: 8px;
}

.detail-content pre {
    background: #1e293b;
    color: #e2e8f0;
    padding: 12px;
    border-radius: 8px;
    font-size: 0.75rem;
    max-height: 150px;
    overflow-y: auto;
    margin: 0;
}

.button-preview {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    margin-top: 8px;
}

.template-nav {
    display: flex;
    justify-content: space-between;
    margin-top: 16px;
}

/* 提交表单 */
.submit-template-form {
    max-width: 600px;
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    font-weight: 500;
    color: #475569;
    margin-bottom: 6px;
    font-size: 0.85rem;
}

/* 响应式 */
@media (max-width: 992px) {
    .templates-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .openapi-header-content {
        flex-direction: column;
        gap: 16px;
        text-align: center;
    }
    
    .openapi-title-wrapper {
        flex-direction: column;
    }
    
    .openapi-actions {
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .bot-grid {
        grid-template-columns: 1fr;
    }
    
    .login-content {
        padding: 24px;
    }
}
</style>
{% endblock %}


{% block scripts %}
<script>
const $ = {
    get: id => document.getElementById(id),
    show: id => { const el = document.getElementById(id); if (el) el.style.display = 'block'; },
    hide: id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; },
    setText: (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; },
    setHtml: (id, html) => { const el = document.getElementById(id); if (el) el.innerHTML = html; },
    toggleVisibility: (showIds, hideIds) => { showIds.forEach(id => $.show(id)); hideIds.forEach(id => $.hide(id)); }
};

const API = {
    async request(endpoint, data = {}) {
        const response = await fetch(`/web/openapi${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: 'web_user', ...data })
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
    },
    handleError(data, defaultMsg = '操作失败') {
        if (data.message && data.message.includes('登录状态失效')) showNotLoggedInState();
        return data.message || defaultMsg;
    }
};

const DataArea = {
    show(title) { $.toggleVisibility(['openapi-data-section', 'openapi-data-loading'], []); $.setHtml('openapi-data-title', title); this.hideAllContainers(); },
    hideAllContainers() {
        $.toggleVisibility([], ['openapi-data-table-container', 'openapi-notifications-container', 'openapi-whitelist-container', 'openapi-templates-container', 'openapi-submit-template-container']);
        const td = $.get('openapi-template-detail'); if (td) td.style.display = 'none';
    },
    showContainer(type) { $.hide('openapi-data-loading'); $.show(`openapi-${type}-container`); }
};

const IPValidator = {
    isValid(ip) {
        const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
        return ipRegex.test(ip) && ip.split('.').every(p => parseInt(p) <= 255);
    },
    getValidIps() {
        const inputs = document.querySelectorAll('.new-ip-input');
        const validIps = [], invalidIps = [];
        inputs.forEach(input => {
            const ip = input.value.trim();
            if (!ip) return;
            if (this.isValid(ip) && !existingIpList.includes(ip) && !validIps.includes(ip)) validIps.push(ip);
            else if (!this.isValid(ip)) invalidIps.push(ip);
        });
        return { validIps, invalidIps };
    }
};

let openApiLoginCheckInterval = null, currentTemplates = [], currentTemplateIndex = 0;
let currentWhitelistAppId = '', currentWhitelistAppName = '', existingIpList = [], newIpInputCount = 0;
let currentTemplateAppId = '', currentTemplateAppName = '';
let deleteIpData = { ip: '', qrcode: '', authCheckInterval: null, batchIpList: [] };
let customModal = { element: null, isVisible: false };

function initOpenAPI() {
    // 初始化顶栏为未登录状态
    const header = $.get('openapi-header');
    if (header) header.classList.add('logged-out');
    
    checkOpenAPILoginStatus();
    $.get('openapi-start-login').addEventListener('click', startOpenAPILogin);
    $.get('openapi-logout').addEventListener('click', logoutOpenAPI);
    $.get('openapi-refresh-botlist').addEventListener('click', refreshBotList);
    $.get('openapi-get-notifications').addEventListener('click', getNotifications);
    $.get('openapi-close-data').addEventListener('click', closeDataSection);
}

async function checkOpenAPILoginStatus() {
    try {
        const data = await API.request('/get_login_status');
        if (data.success && data.logged_in) { showLoggedInState(data); loadBotList(); }
        else showNotLoggedInState();
    } catch (error) {
        showNotLoggedInState();
    }
}

function showLoggedInState(data) {
    const loginCard = $.get('openapi-login-card');
    const mainContent = $.get('openapi-main-content');
    const headerActions = $.get('openapi-header-actions');
    const header = $.get('openapi-header');
    const loginStatus = $.get('openapi-login-status');
    
    if (loginCard) loginCard.style.display = 'none';
    if (mainContent) mainContent.style.display = 'block';
    if (headerActions) headerActions.style.display = 'flex';
    
    // 更新顶栏颜色和状态
    if (header) {
        header.classList.remove('logged-out');
        header.classList.add('logged-in');
    }
    if (loginStatus) {
        loginStatus.innerHTML = `<i class="bi bi-check-circle"></i><span>已登录 UIN: ${data.uin || '-'}</span>`;
    }
}

function showNotLoggedInState() {
    const loginCard = $.get('openapi-login-card');
    const notLoggedIn = $.get('openapi-not-logged-in');
    const mainContent = $.get('openapi-main-content');
    const dataSection = $.get('openapi-data-section');
    const headerActions = $.get('openapi-header-actions');
    const loginProgress = $.get('openapi-login-progress');
    const header = $.get('openapi-header');
    const loginStatus = $.get('openapi-login-status');
    
    if (loginCard) loginCard.style.display = 'block';
    if (notLoggedIn) notLoggedIn.style.display = 'block';
    if (mainContent) mainContent.style.display = 'none';
    if (dataSection) dataSection.style.display = 'none';
    if (headerActions) headerActions.style.display = 'none';
    if (loginProgress) loginProgress.style.display = 'none';
    
    // 更新顶栏颜色和状态
    if (header) {
        header.classList.remove('logged-in');
        header.classList.add('logged-out');
    }
    if (loginStatus) {
        loginStatus.innerHTML = `<i class="bi bi-x-circle"></i><span>未登录</span>`;
    }
}

async function startOpenAPILogin() {
    $.toggleVisibility(['openapi-login-progress', 'openapi-login-loading'], ['openapi-qr-container']);
    try {
        const data = await API.request('/start_login');
        if (data.success) {
            generateQRCode(data.login_url);
            $.get('openapi-login-url').onclick = () => window.open(data.login_url, '_blank');
            startLoginStatusCheck();
        } else {
            alert('获取登录二维码失败：' + data.message);
            $.hide('openapi-login-progress');
        }
    } catch (error) {
        alert('开始登录失败');
        $.hide('openapi-login-progress');
    }
}

function generateQRCode(loginUrl) {
    const qrImage = $.get('openapi-qr-image');
    qrImage.onload = () => $.toggleVisibility(['openapi-qr-container'], ['openapi-login-loading']);
    qrImage.onerror = () => {
        $.setHtml('openapi-login-loading', '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> 二维码生成失败，请使用下方按钮</div>');
        $.show('openapi-qr-container');
    };
    qrImage.src = `https://api.2dcode.biz/v1/create-qr-code?data=${encodeURIComponent(loginUrl)}`;
}

function startLoginStatusCheck() {
    if (openApiLoginCheckInterval) clearInterval(openApiLoginCheckInterval);
    openApiLoginCheckInterval = setInterval(async () => {
        try {
            const data = await API.request('/check_login');
            if (data.success && data.status === 'logged_in') {
                clearInterval(openApiLoginCheckInterval);
                $.hide('openapi-login-progress');
                showLoggedInState({ success: true, logged_in: true, uin: data.uin });
                loadBotList();
            } else if (data.status === 'not_started') {
                clearInterval(openApiLoginCheckInterval);
                $.hide('openapi-login-progress');
            }
        } catch (error) {}
    }, 2000);
}

function logoutOpenAPI() {
    if (confirm('确定要重新登录吗？')) {
        API.request('/logout').then(() => {
            showNotLoggedInState();
            if (openApiLoginCheckInterval) clearInterval(openApiLoginCheckInterval);
        });
    }
}

async function loadBotList() {
    $.toggleVisibility(['openapi-botlist-loading'], ['openapi-botlist-container']);
    try {
        const data = await API.request('/get_botlist');
        $.hide('openapi-botlist-loading');
        if (data.success) { displayBotList(data.data); $.show('openapi-botlist-container'); }
        else {
            if (data.message && data.message.includes('登录状态失效')) {
                showNotLoggedInState();
            } else {
                $.setHtml('openapi-botlist-table', '<div class="text-center text-muted py-4">获取失败，请刷新重试</div>');
                $.show('openapi-botlist-container');
            }
        }
    } catch (error) {
        $.hide('openapi-botlist-loading');
        $.setHtml('openapi-botlist-table', '<div class="text-center text-muted py-4">获取失败，请刷新重试</div>');
        $.show('openapi-botlist-container');
    }
}

function displayBotList(data) {
    const container = $.get('openapi-botlist-table');
    if (!data || !data.apps || !data.apps.length) {
        container.innerHTML = '<div class="text-center text-muted py-4">暂无机器人</div>';
        return;
    }
    container.innerHTML = data.apps.map(app => {
        const desc = app.app_desc || '无描述';
        const shortDesc = desc.length > 10 ? desc.substring(0, 10) + '...' : desc;
        return `
        <div class="bot-card">
            <div class="bot-card-header">
                <div class="bot-name-row">
                    <h6>${app.app_name || '未命名'}</h6>
                    <button class="openapi-btn outline tiny" onclick="importBotTemplates('${app.app_id}', '${app.app_name}')" title="导入Markdown模板"><i class="bi bi-download"></i> 导入MD模板</button>
                </div>
                <small title="${desc}">${shortDesc}</small>
            </div>
            <div class="bot-card-appid">${app.app_id}</div>
            <div class="bot-card-actions">
                <button class="openapi-btn primary small" onclick="getBotData('${app.app_id}')"><i class="bi bi-graph-up"></i> 数据</button>
                <button class="openapi-btn success small" onclick="getBotTemplates('${app.app_id}', '${app.app_name}')"><i class="bi bi-layout-text-sidebar-reverse"></i> 模板</button>
                <button class="openapi-btn info small" onclick="getBotWhitelist('${app.app_id}', '${app.app_name}')"><i class="bi bi-shield-check"></i> 白名单</button>
                <button class="openapi-btn danger small" onclick="showSubmitTemplate('${app.app_id}', '${app.app_name}')"><i class="bi bi-plus-circle"></i> 提交</button>
            </div>
        </div>
    `}).join('');
}

function refreshBotList() { loadBotList(); }
function closeDataSection() { $.hide('openapi-data-section'); }

async function getBotData(appid) {
    DataArea.show(`<i class="bi bi-table"></i> 机器人数据 - ${appid}`);
    try {
        const data = await API.request('/get_botdata', { appid, days: 30 });
        if (data.success) displayBotData(data);
        else alert('获取机器人数据失败: ' + API.handleError(data));
    } catch (error) {
        alert('获取机器人数据失败');
    } finally {
        $.hide('openapi-data-loading');
    }
}

function displayBotData(data) {
    $.setText('openapi-data-appid', data.appid);
    $.setText('openapi-data-avg-dau', data.avg_dau);
    $.setText('openapi-avg-dau-display', Number(data.avg_dau).toLocaleString('zh-CN'));
    
    const tbody = $.get('openapi-data-table');
    tbody.innerHTML = data.days_data.map(d => `
        <tr>
            <td><strong>${d.date}</strong></td>
            <td>${Number(d.up_messages).toLocaleString('zh-CN')}</td>
            <td><span class="badge bg-primary">${Number(d.up_users).toLocaleString('zh-CN')}</span></td>
            <td>${Number(d.down_messages).toLocaleString('zh-CN')}</td>
            <td><strong>${Number(d.total_messages).toLocaleString('zh-CN')}</strong></td>
            <td><span class="text-success">+${d.new_groups}</span> / ${d.current_groups}</td>
            <td><span class="text-success">+${d.new_friends}</span> / ${d.current_friends}</td>
        </tr>
    `).join('');
    DataArea.showContainer('data-table');
}

async function getNotifications() {
    DataArea.show(`<i class="bi bi-bell"></i> 通知消息`);
    try {
        const data = await API.request('/get_notifications');
        if (data.success) {
            displayNotifications(data.messages || data.notifications || []);
            DataArea.showContainer('notifications');
        } else alert('获取通知消息失败：' + API.handleError(data));
    } catch (error) {
        $.hide('openapi-data-loading');
        alert('获取通知消息失败');
    }
}

function displayNotifications(notifications) {
    const table = $.get('openapi-notifications-table');
    if (!notifications || !notifications.length) {
        table.innerHTML = '<tr><td colspan="3" class="text-center text-muted">暂无通知消息</td></tr>';
        return;
    }
    table.innerHTML = notifications.map(n => `<tr><td>${n.send_time || n.time || '-'}</td><td>${n.title || '-'}</td><td>${n.content || '-'}</td></tr>`).join('');
}


function getBotTemplates(appid, appName) { getTemplates(appid, appName); }

async function getTemplates(appid = null, appName = null) {
    currentTemplateAppId = appid;
    currentTemplateAppName = appName;
    DataArea.show('<i class="bi bi-layout-text-sidebar-reverse"></i> 模板管理');
    try {
        const data = await API.request('/get_templates', appid ? { appid } : {});
        $.hide('openapi-data-loading');
        if (data.success) { currentTemplates = data.data.templates; displayTemplates(data.data.templates, appName); }
        else alert('获取模板列表失败: ' + API.handleError(data));
    } catch (error) {
        $.hide('openapi-data-loading');
        alert('获取模板列表失败');
    }
}

function displayTemplates(templates, appName = null) {
    $.setHtml('template-list-title', `<i class="bi bi-layout-text-sidebar-reverse"></i> ${appName ? appName + ' - ' : ''}模板列表`);
    const tbody = $.get('openapi-templates-table');
    if (!templates.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">暂无模板</td></tr>';
        $.hide('submit-templates-btn');
        $.hide('delete-templates-btn');
    } else {
        tbody.innerHTML = templates.map((t, i) => `
            <tr>
                <td><input type="checkbox" class="template-checkbox" data-tpl-id="${t.id}" data-status="${t.status}" onchange="updateActionButtons()"></td>
                <td><strong>${t.name}</strong><br><small class="text-muted">ID: ${t.id}</small></td>
                <td><span class="badge ${t.type === '按钮模板' ? 'bg-info' : 'bg-secondary'}">${t.type}</span></td>
                <td><span class="badge ${getStatusBadgeClass(t.status)}">${t.status}</span></td>
                <td><button class="openapi-btn outline small" onclick="viewTemplateDetail(${i})"><i class="bi bi-eye"></i></button></td>
            </tr>
        `).join('');
        updateActionButtons();
    }
    DataArea.showContainer('templates');
}

function getStatusBadgeClass(status) {
    const classes = { '审核通过': 'bg-success', '未通过': 'bg-danger', '审核中': 'bg-primary', '未提审': 'bg-warning' };
    return classes[status] || 'bg-secondary';
}

function viewTemplateDetail(index) {
    if (index < 0 || index >= currentTemplates.length) return;
    currentTemplateIndex = index;
    const t = currentTemplates[index];
    
    $.setText('template-detail-index', `${index + 1}/${currentTemplates.length}`);
    $.setText('template-detail-id', t.id);
    $.setText('template-detail-name', t.name);
    $.setHtml('template-detail-type', `<span class="badge ${t.type === '按钮模板' ? 'bg-info' : 'bg-secondary'}">${t.type}</span>`);
    $.setHtml('template-detail-status', `<span class="badge ${getStatusBadgeClass(t.status)}">${t.status}</span>`);
    $.setText('template-detail-create-time', t.create_time || '-');
    $.setText('template-detail-content', t.content);
    
    const prevBtn = $.get('template-prev-btn'), nextBtn = $.get('template-next-btn');
    if (prevBtn) { prevBtn.style.display = index > 0 ? 'inline-flex' : 'none'; prevBtn.onclick = () => viewTemplateDetail(index - 1); }
    if (nextBtn) { nextBtn.style.display = index < currentTemplates.length - 1 ? 'inline-flex' : 'none'; nextBtn.onclick = () => viewTemplateDetail(index + 1); }
    
    if (t.type === '按钮模板') renderButtonPreview(t);
    else { const bp = $.get('template-button-preview'); if (bp) bp.style.display = 'none'; }
    
    $.show('openapi-template-detail');
}

function renderButtonPreview(template) {
    try {
        let buttonData = template.content.startsWith('@') ? JSON.parse(template.content.substring(1)) : JSON.parse(template.content);
        const rows = buttonData.rows || [];
        const container = $.get('template-button-rows');
        if (!container) return;
        
        container.innerHTML = rows.slice(0, 5).map(row => {
            const buttons = row.buttons || [];
            if (!buttons.length) return '';
            const btnHtml = buttons.slice(0, 5).map(btn => {
                const rd = btn.render_data || {}, action = btn.action || {}, actionType = action.type || 2;
                const icon = actionType === 0 ? '<i class="bi bi-box-arrow-up-right"></i> ' : actionType === 1 ? '<i class="bi bi-arrow-clockwise"></i> ' : '';
                return `<button class="btn btn-sm ${getButtonStyleClass(rd.style || 0)}" disabled>${icon}${rd.label || 'Button'}</button>`;
            }).join(' ');
            return `<div class="mb-2">${btnHtml}</div>`;
        }).join('');
        
        const bp = $.get('template-button-preview'); if (bp) bp.style.display = 'block';
    } catch (error) {
        const bp = $.get('template-button-preview'); if (bp) bp.style.display = 'none';
    }
}

function getButtonStyleClass(style) {
    const classes = ['btn-outline-dark', 'btn-outline-primary', 'btn-outline-secondary', 'btn-outline-danger', 'btn-primary'];
    return classes[style] || 'btn-outline-dark';
}

function updateActionButtons() {
    const checkboxes = document.querySelectorAll('.template-checkbox:checked');
    const hasChecked = checkboxes.length > 0;
    const hasUnsubmitted = Array.from(checkboxes).some(cb => cb.dataset.status === '未提审');
    
    $.get('delete-templates-btn').style.display = hasChecked ? 'inline-flex' : 'none';
    $.get('submit-templates-btn').style.display = hasUnsubmitted ? 'inline-flex' : 'none';
}

function toggleAllTemplates(checkbox) {
    document.querySelectorAll('.template-checkbox').forEach(cb => cb.checked = checkbox.checked);
    updateActionButtons();
}

async function getBotWhitelist(appid, appName) {
    currentWhitelistAppId = appid;
    currentWhitelistAppName = appName;
    DataArea.show(`<i class="bi bi-shield-check"></i> ${appName} - IP白名单`);
    try {
        const data = await API.request('/get_whitelist', { appid });
        if (data.success) { displayWhitelist(data.data.ip_list || []); DataArea.showContainer('whitelist'); }
        else alert('获取白名单失败：' + API.handleError(data));
    } catch (error) {
        $.hide('openapi-data-loading');
        alert('获取白名单失败');
    }
}

function displayWhitelist(ipList) {
    const table = $.get('openapi-whitelist-table');
    existingIpList = ipList ? ipList.map(ip => typeof ip === 'string' ? ip : (ip.ip || ip)) : [];
    clearAllInputs();
    
    if (!ipList || !ipList.length) {
        table.innerHTML = '<tr><td colspan="2" class="text-center text-muted">暂无IP白名单</td></tr>';
        return;
    }
    table.innerHTML = ipList.map((ip, i) => {
        const ipAddress = typeof ip === 'string' ? ip : (ip.ip || ip);
        return `<tr><td><span class="badge bg-primary me-2">已有</span><code>${ipAddress}</code></td><td><button class="openapi-btn danger small" onclick="deleteWhitelistIp('${ipAddress}', ${i}, this)"><i class="bi bi-trash"></i></button></td></tr>`;
    }).join('');
}

function addNewIpInput() {
    newIpInputCount++;
    const table = $.get('openapi-whitelist-table');
    const row = document.createElement('tr');
    row.className = 'new-ip-input-row';
    row.id = `new-ip-row-${newIpInputCount}`;
    row.innerHTML = `
        <td><input type="text" class="form-control new-ip-input" placeholder="请输入IP地址" id="new-ip-${newIpInputCount}" onkeypress="handleIpInputKeypress(event)"></td>
        <td><button class="openapi-btn outline small" onclick="removeIpInput(${newIpInputCount})"><i class="bi bi-x-lg"></i></button></td>
    `;
    table.insertBefore(row, table.firstChild);
    setTimeout(() => $.get(`new-ip-${newIpInputCount}`).focus(), 100);
    updateBatchAddButtonVisibility();
}

function removeIpInput(inputId) {
    const row = $.get(`new-ip-row-${inputId}`);
    if (row) row.remove();
    updateBatchAddButtonVisibility();
}

function handleIpInputKeypress(event) {
    if (event.key === 'Enter') addNewIpInput();
}

function updateBatchAddButtonVisibility() {
    $.get('batch-add-ips-btn').style.display = document.querySelectorAll('.new-ip-input-row').length > 0 ? 'inline-flex' : 'none';
}

function clearAllInputs() {
    document.querySelectorAll('.new-ip-input-row').forEach(row => row.remove());
    newIpInputCount = 0;
    updateBatchAddButtonVisibility();
}

function batchAddIps() {
    const { validIps: newIps, invalidIps } = IPValidator.getValidIps();
    if (!newIps.length) return alert('请至少输入一个有效的IP地址');
    if (invalidIps.length) return alert(`以下IP地址格式无效：\n${invalidIps.join('\n')}`);
    
    const finalIpList = newIps.filter(ip => !existingIpList.includes(ip));
    if (!finalIpList.length) return alert('没有新的IP地址需要添加');
    if (!confirm(`确认批量添加 ${finalIpList.length} 个IP地址吗？`)) return;
    
    startBatchAddProcess(finalIpList);
}

function startBatchAddProcess(newIpList) {
    deleteIpData.batchIpList = newIpList;
    alert('批量添加功能需要二维码授权，请稍后...');
    getBatchAddQrCode();
}

async function getBatchAddQrCode() {
    try {
        const data = await API.request('/get_delete_qr', { appid: currentWhitelistAppId });
        if (data.success) { deleteIpData.qrcode = data.qrcode; startBatchAddAuthCheck(); }
    } catch (error) {}
}

function startBatchAddAuthCheck() {
    if (deleteIpData.authCheckInterval) clearInterval(deleteIpData.authCheckInterval);
    deleteIpData.authCheckInterval = setInterval(checkBatchAddAuthStatus, 3000);
}

async function checkBatchAddAuthStatus() {
    if (!deleteIpData.qrcode) return;
    try {
        const data = await API.request('/check_delete_auth', { appid: currentWhitelistAppId, qrcode: deleteIpData.qrcode });
        if (data.success && data.authorized) {
            clearInterval(deleteIpData.authCheckInterval);
            executeBatchAddIp();
        }
    } catch (error) {}
}

async function executeBatchAddIp() {
    const allIpList = [...existingIpList, ...deleteIpData.batchIpList];
    try {
        const data = await API.request('/batch_add_whitelist', { appid: currentWhitelistAppId, ip_list: allIpList, qrcode: deleteIpData.qrcode });
        if (data.success) {
            alert(`成功添加 ${deleteIpData.batchIpList.length} 个IP地址！`);
            clearAllInputs();
            getBotWhitelist(currentWhitelistAppId, currentWhitelistAppName);
        }
    } catch (error) {}
}

function deleteWhitelistIp(ipAddress, index, buttonElement) {
    if (!confirm(`确定要删除IP "${ipAddress}" 吗？`)) return;
    deleteIpData.ip = ipAddress;
    getDeleteQrCode();
}

async function getDeleteQrCode() {
    try {
        const data = await API.request('/get_delete_qr', { appid: currentWhitelistAppId });
        if (data.success) { deleteIpData.qrcode = data.qrcode; startDeleteAuthCheck(); }
    } catch (error) {}
}

function startDeleteAuthCheck() {
    if (deleteIpData.authCheckInterval) clearInterval(deleteIpData.authCheckInterval);
    deleteIpData.authCheckInterval = setInterval(checkDeleteAuthStatus, 3000);
}

async function checkDeleteAuthStatus() {
    if (!deleteIpData.qrcode) return;
    try {
        const data = await API.request('/check_delete_auth', { appid: currentWhitelistAppId, qrcode: deleteIpData.qrcode });
        if (data.success && data.authorized) {
            clearInterval(deleteIpData.authCheckInterval);
            executeDeleteIp();
        }
    } catch (error) {}
}

async function executeDeleteIp() {
    const newIpList = existingIpList.filter(ip => ip !== deleteIpData.ip);
    try {
        const data = await API.request('/batch_add_whitelist', { appid: currentWhitelistAppId, ip_list: newIpList, qrcode: deleteIpData.qrcode });
        if (data.success) {
            alert('IP删除成功！');
            getBotWhitelist(currentWhitelistAppId, currentWhitelistAppName);
        }
    } catch (error) {}
}

function showSubmitTemplate(appid, appName) {
    currentTemplateAppId = appid;
    currentTemplateAppName = appName;
    DataArea.show(`<i class="bi bi-plus-circle"></i> 提交模板 - ${appName}`);
    DataArea.showContainer('submit-template');
}

function backToTemplateList() {
    getTemplates(currentTemplateAppId, currentTemplateAppName);
}

function onTemplateTypeChange() {
    const type = $.get('template-type-select').value;
    $.get('markdown-template-inputs').style.display = type === '2' ? 'block' : 'none';
    $.get('button-template-inputs').style.display = type === '1' ? 'block' : 'none';
}

function extractTemplateParams() {
    const content = $.get('template-content-input').value;
    const paramRegex = /\{\{\s*\.(\w+)\s*\}\}/g;
    const params = [];
    let match;
    while ((match = paramRegex.exec(content)) !== null) {
        if (!params.includes(match[1])) params.push(match[1]);
    }
    const container = $.get('template-params-container');
    const inputsDiv = $.get('template-params-inputs');
    if (params.length > 0) {
        inputsDiv.innerHTML = params.map(p => `
            <div class="form-group">
                <label>${p}</label>
                <input type="text" class="form-control template-param-input" data-param="${p}" placeholder="请输入 ${p} 的测试值">
            </div>
        `).join('');
        container.style.display = 'block';
    } else {
        container.style.display = 'none';
        inputsDiv.innerHTML = '';
    }
}

let pendingTemplateData = null;

function getTemplateParams() {
    const params = [];
    document.querySelectorAll('.template-param-input').forEach(input => {
        const key = input.dataset.param;
        const value = input.value.trim();
        if (key) params.push({ key, value });
    });
    return params;
}

async function startTemplateSubmit() {
    const type = $.get('template-type-select').value;
    const name = $.get('template-name-input').value.trim();
    const scene = $.get('template-scene-input').value.trim();
    if (!name) return alert('请输入模板名称');
    if (!scene) return alert('请输入使用场景');
    
    let templateData = {
        tpl_name: name,
        scene: scene,
        tpl_type: parseInt(type)
    };
    
    if (type === '2') {
        const content = $.get('template-content-input').value.trim();
        if (!content) return alert('请输入模板内容');
        templateData.text = content;
        templateData.tpl_fields = getTemplateParams();
    } else {
        const buttonConfig = $.get('button-config-input').value.trim();
        if (!buttonConfig) return alert('请输入按钮配置');
        try {
            const config = JSON.parse(buttonConfig);
            templateData.text = JSON.stringify(config);
            templateData.tpl_fields = [];
        } catch (e) { return alert('按钮配置JSON格式错误'); }
    }
    
    pendingTemplateData = templateData;
    
    const modal = new bootstrap.Modal($.get('templateSubmitQrModal'));
    modal.show();
    $.show('template-qr-loading');
    $.hide('template-qr-display');
    
    try {
        const data = await API.request('/create_template_qr', {});
        if (data.success && data.qrcode) {
            $.get('template-qr-image').src = data.url;
            $.hide('template-qr-loading');
            $.show('template-qr-display');
            $.setHtml('template-submit-status', '<i class="bi bi-hourglass-split"></i> 等待扫码授权...');
            startTemplateSubmitCheck(data.qrcode);
        } else {
            modal.hide();
            alert('获取授权二维码失败: ' + (data.message || '未知错误'));
        }
    } catch (error) {
        modal.hide();
        alert('获取二维码失败');
    }
}

let templateSubmitCheckInterval = null;
function startTemplateSubmitCheck(qrcode) {
    if (templateSubmitCheckInterval) clearInterval(templateSubmitCheckInterval);
    templateSubmitCheckInterval = setInterval(async () => {
        try {
            const data = await API.request('/check_template_qr', { qrcode });
            if (data.success && data.authorized) {
                clearInterval(templateSubmitCheckInterval);
                $.setHtml('template-submit-status', '<i class="bi bi-hourglass-split"></i> 授权成功，正在提交模板...');
                const submitData = await API.request('/submit_template', {
                    appid: currentTemplateAppId,
                    template_data: pendingTemplateData,
                    qrcode: qrcode
                });
                if (submitData.success) {
                    $.setHtml('template-submit-status', '<div class="alert alert-success"><i class="bi bi-check-circle"></i> 模板提交成功！</div>');
                    setTimeout(() => {
                        bootstrap.Modal.getInstance($.get('templateSubmitQrModal')).hide();
                        getBotTemplates(currentTemplateAppId, currentTemplateAppName);
                    }, 1500);
                } else {
                    $.setHtml('template-submit-status', `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> 提交失败: ${submitData.message || '未知错误'}</div>`);
                }
            }
        } catch (error) {}
    }, 2000);
}

let pendingDeleteTemplateIds = [];

async function deleteSelectedTemplates() {
    const checkboxes = document.querySelectorAll('.template-checkbox:checked');
    if (!checkboxes.length) return alert('请选择要删除的模板');
    const templateIds = Array.from(checkboxes).map(cb => cb.dataset.tplId);
    if (!confirm(`确定要删除 ${templateIds.length} 个模板吗？`)) return;
    
    pendingDeleteTemplateIds = templateIds;
    const modal = new bootstrap.Modal($.get('deleteTemplateQrModal'));
    modal.show();
    $.show('delete-qr-loading');
    $.hide('delete-qr-display');
    
    try {
        const data = await API.request('/create_template_qr', {});
        if (data.success && data.qrcode) {
            $.get('delete-qr-image').src = data.url;
            $.hide('delete-qr-loading');
            $.show('delete-qr-display');
            $.setHtml('delete-status', '<i class="bi bi-hourglass-split"></i> 等待扫码授权...');
            startDeleteTemplateCheck(data.qrcode);
        } else {
            modal.hide();
            alert('获取授权二维码失败: ' + (data.message || '未知错误'));
        }
    } catch (error) {
        modal.hide();
        alert('获取二维码失败');
    }
}

let deleteTemplateCheckInterval = null;
function startDeleteTemplateCheck(qrcode) {
    if (deleteTemplateCheckInterval) clearInterval(deleteTemplateCheckInterval);
    deleteTemplateCheckInterval = setInterval(async () => {
        try {
            const data = await API.request('/check_template_qr', { qrcode });
            if (data.success && data.authorized) {
                clearInterval(deleteTemplateCheckInterval);
                $.setHtml('delete-status', '<i class="bi bi-hourglass-split"></i> 授权成功，正在删除模板...');
                const deleteData = await API.request('/delete_templates', {
                    appid: currentTemplateAppId,
                    tpl_ids: pendingDeleteTemplateIds,
                    qrcode: qrcode
                });
                if (deleteData.success) {
                    $.setHtml('delete-status', '<div class="alert alert-success"><i class="bi bi-check-circle"></i> 模板删除成功！</div>');
                    setTimeout(() => {
                        bootstrap.Modal.getInstance($.get('deleteTemplateQrModal')).hide();
                        getBotTemplates(currentTemplateAppId, currentTemplateAppName);
                    }, 1500);
                } else {
                    $.setHtml('delete-status', `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> 删除失败: ${deleteData.message || '未知错误'}</div>`);
                }
            }
        } catch (error) {}
    }, 2000);
}

let pendingAuditTemplateIds = [];

async function submitSelectedTemplates() {
    const checkboxes = document.querySelectorAll('.template-checkbox:checked');
    const unsubmitted = Array.from(checkboxes).filter(cb => cb.dataset.status === '未提审');
    if (!unsubmitted.length) return alert('请选择未提审的模板');
    const templateIds = unsubmitted.map(cb => cb.dataset.tplId);
    if (!confirm(`确定要提审 ${templateIds.length} 个模板吗？`)) return;
    
    pendingAuditTemplateIds = templateIds;
    const modal = new bootstrap.Modal($.get('auditTemplateQrModal'));
    modal.show();
    $.show('audit-qr-loading');
    $.hide('audit-qr-display');
    
    try {
        const data = await API.request('/create_template_qr', {});
        if (data.success && data.qrcode) {
            $.get('audit-qr-image').src = data.url;
            $.hide('audit-qr-loading');
            $.show('audit-qr-display');
            $.setHtml('audit-status', '<i class="bi bi-hourglass-split"></i> 等待扫码授权...');
            startAuditTemplateCheck(data.qrcode);
        } else {
            modal.hide();
            alert('获取授权二维码失败: ' + (data.message || '未知错误'));
        }
    } catch (error) {
        modal.hide();
        alert('获取二维码失败');
    }
}

let auditTemplateCheckInterval = null;
function startAuditTemplateCheck(qrcode) {
    if (auditTemplateCheckInterval) clearInterval(auditTemplateCheckInterval);
    auditTemplateCheckInterval = setInterval(async () => {
        try {
            const data = await API.request('/check_template_qr', { qrcode });
            if (data.success && data.authorized) {
                clearInterval(auditTemplateCheckInterval);
                $.setHtml('audit-status', '<i class="bi bi-hourglass-split"></i> 授权成功，正在提审模板...');
                const auditData = await API.request('/audit_templates', {
                    appid: currentTemplateAppId,
                    tpl_ids: pendingAuditTemplateIds,
                    qrcode: qrcode
                });
                if (auditData.success) {
                    $.setHtml('audit-status', '<div class="alert alert-success"><i class="bi bi-check-circle"></i> 模板提审成功！</div>');
                    setTimeout(() => {
                        bootstrap.Modal.getInstance($.get('auditTemplateQrModal')).hide();
                        getBotTemplates(currentTemplateAppId, currentTemplateAppName);
                    }, 1500);
                } else {
                    $.setHtml('audit-status', `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> 提审失败: ${auditData.message || '未知错误'}</div>`);
                }
            }
        } catch (error) {}
    }, 2000);
}

function importBotTemplates(appid, appName) {
    if (!confirm(`确定要将机器人 "${appName}" 的模板导入吗？`)) return;
    
    API.request('/import_templates', { appid }).then(data => {
        if (data.success) {
            const r = data.data;
            alert(`模板导入完成！\n新导入: ${r.imported_count} 个\n跳过: ${r.skipped_count} 个`);
        } else {
            alert('导入模板失败: ' + data.message);
        }
    }).catch(error => {
        alert('导入模板失败');
    });
}

document.addEventListener('DOMContentLoaded', initOpenAPI);
</script>
{% endblock %}